<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prose Reader</title>
    <script>
      window.__PROSE_READER_DEBUG = true;
    </script>
    <script type="module">function bt(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Er(e){if(Array.isArray(e))return bt(e)}function Lr(e,t){return t!=null&&typeof Symbol<"u"&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function Tr(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function Mr(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Or(e){return Er(e)||Tr(e)||Ar(e)||Mr()}function bn(e){"@swc/helpers - typeof";return e&&typeof Symbol<"u"&&e.constructor===Symbol?"symbol":typeof e}function Ar(e,t){if(e){if(typeof e=="string")return bt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return bt(e,t)}}var _r=function(){return{events:{},emit:function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=this.events[t]||[],s=0,a=o.length;s<a;s++){var u;(u=o)[s].apply(u,Or(i))}},on:function(t,n){var i=this;if(!this.events[t])this.events[t]=[n];else{var r;(r=this.events[t])===null||r===void 0||r.push(n)}return function(){var o;i.events[t]=(o=i.events[t])===null||o===void 0?void 0:o.filter(function(s){return n!==s})}}}},Rr=function(e){var t=e.emitter,n=e.evaluate,i=e.eventId,r=e.failHandler,o=r===void 0?!1:r,s=e.methodName,a=e.onFallback;return new Promise(function(u,l){var c=t.on("".concat(s,"-").concat(i),function(d,p){c(),p?Lr(o,Error)?(a==null||a(),l(o)):u(void 0):u(d)});n()})},wn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Fr=21,Kn=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Fr,t=Array.from({length:e},function(){return wn[Math.floor(Math.random()*wn.length)]});return t.join("")},wt=function(e,t){if(e===t)return!0;if(e&&t&&(typeof e>"u"?"undefined":bn(e))==="object"&&(typeof t>"u"?"undefined":bn(t))==="object"){var n=Array.isArray(e),i=Array.isArray(t),r,o,s;if(n&&i){if(o=e.length,o!==t.length)return!1;for(r=o;r--!==0;)if(!wt(e[r],t[r]))return!1;return!0}if(n!==i)return!1;var a=Object.keys(e);if(o=a.length,o!==Object.keys(t).length)return!1;for(r=o;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,a[r]))return!1;for(r=o;r--!==0;)if(s=a[r],!wt(e[s],t[s]))return!1;return!0}return e!==e&&t!==t},jr=function(e){var t=!0,n=!1,i=void 0;try{for(var r=Object.keys(e)[Symbol.iterator](),o;!(t=(o=r.next()).done);t=!0){var s=o.value;e[s]===void 0&&delete e[s]}}catch(a){n=!0,i=a}finally{try{!t&&r.return!=null&&r.return()}finally{if(n)throw i}}return e},Cr=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return new Promise(function(n,i){setTimeout(function(){t?i(new Error("Timeout")):n(void 0)},e)})};function It(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Qn(e){if(Array.isArray(e))return e}function Dr(e){if(Array.isArray(e))return It(e)}function Nr(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ei(e,t,n){return t=Ae(t),qr(e,Bt()?Reflect.construct(t,n||[],Ae(e).constructor):t.apply(e,n))}function zt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Xe(e,t,n){return Bt()?Xe=Reflect.construct:Xe=function(r,o,s){var a=[null];a.push.apply(a,o);var u=Function.bind.apply(r,a),l=new u;return s&&_e(l,s.prototype),l},Xe.apply(null,arguments)}function Wr(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function kr(e,t,n){return t&&Wr(e.prototype,t),e}function Ut(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ae(e){return Ae=Object.setPrototypeOf?Object.getPrototypeOf:function(n){return n.__proto__||Object.getPrototypeOf(n)},Ae(e)}function ti(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_e(e,t)}function Vr(e){return Function.toString.call(e).indexOf("[native code]")!==-1}function ni(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function zr(e,t){var n=e==null?null:typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(n!=null){var i=[],r=!0,o=!1,s,a;try{for(n=n.call(e);!(r=(s=n.next()).done)&&(i.push(s.value),!(t&&i.length===t));r=!0);}catch(u){o=!0,a=u}finally{try{!r&&n.return!=null&&n.return()}finally{if(o)throw a}}return i}}function ii(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Ur(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function it(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{},i=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable}))),i.forEach(function(r){Ut(e,r,n[r])})}return e}function Hr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n.push.apply(n,i)}return n}function Br(e,t){return t=t??{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Hr(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}function qr(e,t){return t&&(ri(t)==="object"||typeof t=="function")?t:Nr(e)}function _e(e,t){return _e=Object.setPrototypeOf||function(i,r){return i.__proto__=r,i},_e(e,t)}function Me(e,t){return Qn(e)||zr(e,t)||Ht(e,t)||ii()}function Yr(e){return Qn(e)||ni(e)||Ht(e)||ii()}function dt(e){return Dr(e)||ni(e)||Ht(e)||Ur()}function ri(e){"@swc/helpers - typeof";return e&&typeof Symbol<"u"&&e.constructor===Symbol?"symbol":typeof e}function Ht(e,t){if(e){if(typeof e=="string")return It(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return It(e,t)}}function rt(e){var t=typeof Map=="function"?new Map:void 0;return rt=function(i){if(i===null||!Vr(i))return i;if(typeof i!="function")throw new TypeError("Super expression must either be null or a function");if(typeof t<"u"){if(t.has(i))return t.get(i);t.set(i,r)}function r(){return Xe(i,arguments,Ae(this).constructor)}return r.prototype=Object.create(i.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),_e(r,i)},rt(e)}function Bt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Bt=function(){return!!e})()}var Gr=Object.defineProperty,Xr=function(e,t,n){return t in e?Gr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Ue=function(e,t,n){return Xr(e,(typeof t>"u"?"undefined":ri(t))!=="symbol"?t+"":t,n)},Zr=function(e){ti(t,e);function t(n){zt(this,t);var i;return i=ei(this,t,["Method ".concat(n," is not defined")]),i.name="MethodNotFoundError",i}return t}(rt(Error)),Jr=function(e){ti(t,e);function t(n){zt(this,t);var i;return i=ei(this,t,["An error occurred in the native bridge: ".concat(n)]),i.name="NativeMethodError",i}return t}(rt(Error)),Kr=function(){return new Proxy({},{get:function(){return function(){return Promise.resolve()}}})},Qr=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=function(){return r},i=function(u){var l=it({},r,jr(u));if(!wt(r,l)){var c=r;r=l,s(r,c)}};e.on("bridgeStateChange",function(u){i(u)});var r=it({},t),o=new Set,s=function(u,l){var c=!0,d=!1,p=void 0;try{for(var f=o[Symbol.iterator](),h;!(c=(h=f.next()).done);c=!0){var g=h.value;g(u,l)}}catch(v){d=!0,p=v}finally{try{!c&&f.return!=null&&f.return()}finally{if(d)throw p}}},a=function(u){return o.add(u),function(){return o.delete(u)}};return{getState:n,subscribe:a}},oi=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e,n=function(){return t},i=function(){return function(){}};return{getState:n,subscribe:i}},eo=function(){function e(t,n,i,r,o){zt(this,e),this._bridgeId=t,this._options=n,this._emitter=i,this._bridgeMethods=r,this._nativeInitialState=o,Ue(this,"_defaultTimeoutMs",2e3),Ue(this,"_isListenerRegistered",!1),Ue(this,"store",oi()),Ue(this,"loose",Kr()),this._hydrate(r,o)}return kr(e,[{key:"isReactNativeWebView",get:function(){return!!window.ReactNativeWebView}},{key:"isWebViewBridgeAvailable",get:function(){return this._bridgeMethods.length>0}},{key:"isNativeMethodAvailable",value:function(n){return typeof n=="string"&&this._bridgeMethods.includes(n)}},{key:"addEventListener",value:function(n,i){return this._emitter.on("postMessage/".concat(String(n)),i)}},{key:"_postMessage",value:function(n,i){var r;(r=window.ReactNativeWebView)===null||r===void 0||r.postMessage(JSON.stringify(i?{type:n,body:i,bridgeId:this._bridgeId}:{type:n,bridgeId:this._bridgeId}))}},{key:"_createNativeMethod",value:function(n,i,r,o){var s=this;return function(){for(var a=arguments.length,u=new Array(a),l=0;l<a;l++)u[l]=arguments[l];var c=Kn();return Promise.race([Rr({emitter:s._emitter,methodName:n,eventId:c,evaluate:function(){s._postMessage("bridge",{method:n,eventId:c,args:u})},onFallback:function(){o==null||o(n,u)},failHandler:i&&new Jr(n)}),r>0&&Cr(r,i)].filter(Boolean))}}},{key:"_willMethodThrowOnError",value:function(n){var i=this._options.throwOnError;return i===!0||Array.isArray(i)&&i.includes(n)}},{key:"_createLoose",value:function(n){var i=this,r=this._options,o=r.timeout,s=o===void 0?this._defaultTimeoutMs:o,a=r.onFallback;return new Proxy(n,{get:function(u,l){return l in u&&!["isWebViewBridgeAvailable","isNativeMethodAvailable"].includes(l)?u[l]:i._createNativeMethod(l,i._willMethodThrowOnError(l),s,a)}})}},{key:"_hydrate",value:function(n){var i=this,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=this._options,s=o.timeout,a=s===void 0?this._defaultTimeoutMs:s,u=o.onFallback,l=o.initialBridge,c=l===void 0?{}:l,d=Object.entries(c).filter(function(D){var X=Me(D,2);X[0];var te=X[1];return typeof te=="function"}),p=d.map(function(D){var X=Me(D,1),te=X[0];return te});Object.defineProperties(this,Object.fromEntries(d.map(function(D){var X=Me(D,2),te=X[0],$r=X[1];return[te,{value:$r,writable:!0}]}))),this._bridgeMethods=dt(n).concat(dt(p)),this._nativeInitialState=r;var f=n.reduce(function(D,X){if(!i.isReactNativeWebView)return D;var te=i._createNativeMethod(X,i._willMethodThrowOnError(X),a,u);return Object.defineProperty(i,X,{value:te,writable:!1}),Object.assign(D,Ut({},X,te))},c);if(this.loose=this._createLoose(f),this.store=Qr(this._emitter,it({},f,r)),!this._isListenerRegistered){var h=function(){document.visibilityState==="visible"&&i._postMessage("getBridgeState")};document.addEventListener("visibilitychange",h),this._isListenerRegistered=!0}this._postMessage("getBridgeState");var g,v=!0,m=!1,y=void 0;try{for(var w=((g=window.nativeBatchedEvents)!==null&&g!==void 0?g:[])[Symbol.iterator](),S;!(v=(S=w.next()).done);v=!0){var $=Yr(S.value),T=$[0],W=$.slice(1),F;(F=this._emitter).emit.apply(F,[T].concat(dt(W)))}}catch(D){m=!0,y=D}finally{try{!v&&w.return!=null&&w.return()}finally{if(m)throw y}}return window.nativeBatchedEvents=[],!0}}]),e}(),to=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{timeout:2e3,throwOnError:!1,debug:!1};if(typeof window>"u"){var t,n=(t=e==null?void 0:e.initialBridge)!==null&&t!==void 0?t:{},i=Object.entries(n).filter(function(v){var m=Me(v,2);m[0];var y=m[1];return typeof y=="function"}),r=i.map(function(v){var m=Me(v,1),y=m[0];return y});return{addEventListener:function(v,m){return function(){}},loose:{},isWebViewBridgeAvailable:r.length>0,isNativeMethodAvailable:function(v){return r.includes(v)},store:oi(e==null?void 0:e.initialBridge)}}e.debug&&!window.ReactNativeWebView&&console.warn("[WebViewBridge] Not in a WebView environment");var o=Kn(),s=_r();window.nativeEmitterMap=Br(it({},window.nativeEmitterMap||{}),Ut({},o,s)),window.nativeEmitter||(window.nativeEmitter=s);var a,u=(a=window.__bridgeMethods__)!==null&&a!==void 0?a:[],l,c=(l=window.__bridgeInitialState__)!==null&&l!==void 0?l:{},d=new eo(o,e,s,u,c);if(u.length===0)var p=s.on("hydrate",function(v){var m=v.bridgeMethods,y=v.nativeInitialState;d._hydrate(m,y),p()});var f=e.onFallback,h=e.onReady,g=new Proxy(d,{get:function(v,m,y){return m in v?v[m]:(y._postMessage("fallback",{method:m}),y._willMethodThrowOnError(m)?function(){for(var w=arguments.length,S=new Array(w),$=0;$<w;$++)S[$]=arguments[$];return f==null||f(m,S),Promise.reject(new Zr(m))}:(e.debug&&console.warn("[WebViewBridge] ".concat(m," is not defined, using fallback.")),function(){return Promise.resolve()}))}});return h==null||h(g),g};const no=()=>to({onReady:async()=>{}}),io=({bridge:e,reader:t,containerElement:n})=>(e.addEventListener("load",i=>{t.load({containerElement:n,manifest:i.manifest})}),e.addEventListener("turnRight",()=>{t.navigation.turnRight()}),e.addEventListener("turnLeft",()=>{t.navigation.turnLeft()}),t.pagination.state$.subscribe(i=>{e.setPagination(i)}),t);var St=function(e,t){return St=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(n[r]=i[r])},St(e,t)};function oe(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");St(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}function ro(e,t,n,i){function r(o){return o instanceof n?o:new n(function(s){s(o)})}return new(n||(n=Promise))(function(o,s){function a(c){try{l(i.next(c))}catch(d){s(d)}}function u(c){try{l(i.throw(c))}catch(d){s(d)}}function l(c){c.done?o(c.value):r(c.value).then(a,u)}l((i=i.apply(e,t||[])).next())})}function si(e,t){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,r,o,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(l){return function(c){return u([l,c])}}function u(l){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,l[0]&&(n=0)),n;)try{if(i=1,r&&(o=l[0]&2?r.return:l[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,l[1])).done)return o;switch(r=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return n.label++,{value:l[1],done:!1};case 5:n.label++,r=l[1],l=[0];continue;case 7:l=n.ops.pop(),n.trys.pop();continue;default:if(o=n.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){n=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){n.label=l[1];break}if(l[0]===6&&n.label<o[1]){n.label=o[1],o=l;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(l);break}o[2]&&n.ops.pop(),n.trys.pop();continue}l=t.call(e,n)}catch(c){l=[6,c],r=0}finally{i=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Se(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function re(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var i=n.call(e),r,o=[],s;try{for(;(t===void 0||t-- >0)&&!(r=i.next()).done;)o.push(r.value)}catch(a){s={error:a}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(s)throw s.error}}return o}function ae(e,t,n){if(n||arguments.length===2)for(var i=0,r=t.length,o;i<r;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}function be(e){return this instanceof be?(this.v=e,this):new be(e)}function oo(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(e,t||[]),r,o=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",s),r[Symbol.asyncIterator]=function(){return this},r;function s(f){return function(h){return Promise.resolve(h).then(f,d)}}function a(f,h){i[f]&&(r[f]=function(g){return new Promise(function(v,m){o.push([f,g,v,m])>1||u(f,g)})},h&&(r[f]=h(r[f])))}function u(f,h){try{l(i[f](h))}catch(g){p(o[0][3],g)}}function l(f){f.value instanceof be?Promise.resolve(f.value.v).then(c,d):p(o[0][2],f)}function c(f){u("next",f)}function d(f){u("throw",f)}function p(f,h){f(h),o.shift(),o.length&&u(o[0][0],o[0][1])}}function so(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],n;return t?t.call(e):(e=typeof Se=="function"?Se(e):e[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(o){n[o]=e[o]&&function(s){return new Promise(function(a,u){s=e[o](s),r(a,u,s.done,s.value)})}}function r(o,s,a,u){Promise.resolve(u).then(function(l){o({value:l,done:a})},s)}}function A(e){return typeof e=="function"}function qt(e){var t=function(i){Error.call(i),i.stack=new Error().stack},n=e(t);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var pt=qt(function(e){return function(n){e(this),this.message=n?n.length+` errors occurred during unsubscription:
`+n.map(function(i,r){return r+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=n}});function ot(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var $e=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,n,i,r,o;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=Se(s),u=a.next();!u.done;u=a.next()){var l=u.value;l.remove(this)}}catch(g){t={error:g}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}else s.remove(this);var c=this.initialTeardown;if(A(c))try{c()}catch(g){o=g instanceof pt?g.errors:[g]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var p=Se(d),f=p.next();!f.done;f=p.next()){var h=f.value;try{In(h)}catch(g){o=o??[],g instanceof pt?o=ae(ae([],re(o)),re(g.errors)):o.push(g)}}}catch(g){i={error:g}}finally{try{f&&!f.done&&(r=p.return)&&r.call(p)}finally{if(i)throw i.error}}}if(o)throw new pt(o)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)In(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(t)}},e.prototype._hasParent=function(t){var n=this._parentage;return n===t||Array.isArray(n)&&n.includes(t)},e.prototype._addParent=function(t){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(t),n):n?[n,t]:t},e.prototype._removeParent=function(t){var n=this._parentage;n===t?this._parentage=null:Array.isArray(n)&&ot(n,t)},e.prototype.remove=function(t){var n=this._finalizers;n&&ot(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),ai=$e.EMPTY;function ui(e){return e instanceof $e||e&&"closed"in e&&A(e.remove)&&A(e.add)&&A(e.unsubscribe)}function In(e){A(e)?e():e.unsubscribe()}var ao={Promise:void 0},uo={setTimeout:function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout.apply(void 0,ae([e,t],re(n)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function li(e){uo.setTimeout(function(){throw e})}function Re(){}function Ze(e){e()}var Yt=function(e){oe(t,e);function t(n){var i=e.call(this)||this;return i.isStopped=!1,n?(i.destination=n,ui(n)&&n.add(i)):i.destination=po,i}return t.create=function(n,i,r){return new Fe(n,i,r)},t.prototype.next=function(n){this.isStopped||this._next(n)},t.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(n){this.destination.next(n)},t.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}($e),lo=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var n=this.partialObserver;if(n.next)try{n.next(t)}catch(i){He(i)}},e.prototype.error=function(t){var n=this.partialObserver;if(n.error)try{n.error(t)}catch(i){He(i)}else He(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(n){He(n)}},e}(),Fe=function(e){oe(t,e);function t(n,i,r){var o=e.call(this)||this,s;return A(n)||!n?s={next:n??void 0,error:i??void 0,complete:r??void 0}:s=n,o.destination=new lo(s),o}return t}(Yt);function He(e){li(e)}function co(e){throw e}var po={closed:!0,next:Re,error:co,complete:Re},Gt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ne(e){return e}function fo(e){return e.length===0?ne:e.length===1?e[0]:function(n){return e.reduce(function(i,r){return r(i)},n)}}var R=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(t,n,i){var r=this,o=go(t)?t:new Fe(t,n,i);return Ze(function(){var s=r,a=s.operator,u=s.source;o.add(a?a.call(o,u):u?r._subscribe(o):r._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(n){t.error(n)}},e.prototype.forEach=function(t,n){var i=this;return n=Sn(n),new n(function(r,o){var s=new Fe({next:function(a){try{t(a)}catch(u){o(u),s.unsubscribe()}},error:o,complete:r});i.subscribe(s)})},e.prototype._subscribe=function(t){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(t)},e.prototype[Gt]=function(){return this},e.prototype.pipe=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return fo(t)(this)},e.prototype.toPromise=function(t){var n=this;return t=Sn(t),new t(function(i,r){var o;n.subscribe(function(s){return o=s},function(s){return r(s)},function(){return i(o)})})},e.create=function(t){return new e(t)},e}();function Sn(e){var t;return(t=e??ao.Promise)!==null&&t!==void 0?t:Promise}function ho(e){return e&&A(e.next)&&A(e.error)&&A(e.complete)}function go(e){return e&&e instanceof Yt||ho(e)&&ui(e)}function mo(e){return A(e==null?void 0:e.lift)}function C(e){return function(t){if(mo(t))return t.lift(function(n){try{return e(n,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function j(e,t,n,i,r){return new vo(e,t,n,i,r)}var vo=function(e){oe(t,e);function t(n,i,r,o,s,a){var u=e.call(this,n)||this;return u.onFinalize=s,u.shouldUnsubscribe=a,u._next=i?function(l){try{i(l)}catch(c){n.error(c)}}:e.prototype._next,u._error=o?function(l){try{o(l)}catch(c){n.error(c)}finally{this.unsubscribe()}}:e.prototype._error,u._complete=r?function(){try{r()}catch(l){n.error(l)}finally{this.unsubscribe()}}:e.prototype._complete,u}return t.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;e.prototype.unsubscribe.call(this),!i&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},t}(Yt),xn={schedule:function(e){var t=requestAnimationFrame,n=cancelAnimationFrame,i=t(function(r){n=void 0,e(r)});return new $e(function(){return n==null?void 0:n(i)})},requestAnimationFrame:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return requestAnimationFrame.apply(void 0,ae([],re(e)))},cancelAnimationFrame:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return cancelAnimationFrame.apply(void 0,ae([],re(e)))},delegate:void 0},yo=qt(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),V=function(e){oe(t,e);function t(){var n=e.call(this)||this;return n.closed=!1,n.currentObservers=null,n.observers=[],n.isStopped=!1,n.hasError=!1,n.thrownError=null,n}return t.prototype.lift=function(n){var i=new Pn(this,this);return i.operator=n,i},t.prototype._throwIfClosed=function(){if(this.closed)throw new yo},t.prototype.next=function(n){var i=this;Ze(function(){var r,o;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var s=Se(i.currentObservers),a=s.next();!a.done;a=s.next()){var u=a.value;u.next(n)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(r)throw r.error}}}})},t.prototype.error=function(n){var i=this;Ze(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=n;for(var r=i.observers;r.length;)r.shift().error(n)}})},t.prototype.complete=function(){var n=this;Ze(function(){if(n._throwIfClosed(),!n.isStopped){n.isStopped=!0;for(var i=n.observers;i.length;)i.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var n;return((n=this.observers)===null||n===void 0?void 0:n.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(n){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,n)},t.prototype._subscribe=function(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)},t.prototype._innerSubscribe=function(n){var i=this,r=this,o=r.hasError,s=r.isStopped,a=r.observers;return o||s?ai:(this.currentObservers=null,a.push(n),new $e(function(){i.currentObservers=null,ot(a,n)}))},t.prototype._checkFinalizedStatuses=function(n){var i=this,r=i.hasError,o=i.thrownError,s=i.isStopped;r?n.error(o):s&&n.complete()},t.prototype.asObservable=function(){var n=new R;return n.source=this,n},t.create=function(n,i){return new Pn(n,i)},t}(R),Pn=function(e){oe(t,e);function t(n,i){var r=e.call(this)||this;return r.destination=n,r.source=i,r}return t.prototype.next=function(n){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,n)},t.prototype.error=function(n){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,n)},t.prototype.complete=function(){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.complete)===null||i===void 0||i.call(n)},t.prototype._subscribe=function(n){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(n))!==null&&r!==void 0?r:ai},t}(V),Y=function(e){oe(t,e);function t(n){var i=e.call(this)||this;return i._value=n,i}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(n){var i=e.prototype._subscribe.call(this,n);return!i.closed&&n.next(this._value),i},t.prototype.getValue=function(){var n=this,i=n.hasError,r=n.thrownError,o=n._value;if(i)throw r;return this._throwIfClosed(),o},t.prototype.next=function(n){e.prototype.next.call(this,this._value=n)},t}(V),Xt={now:function(){return(Xt.delegate||Date).now()},delegate:void 0},xt=function(e){oe(t,e);function t(n,i,r){n===void 0&&(n=1/0),i===void 0&&(i=1/0),r===void 0&&(r=Xt);var o=e.call(this)||this;return o._bufferSize=n,o._windowTime=i,o._timestampProvider=r,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=i===1/0,o._bufferSize=Math.max(1,n),o._windowTime=Math.max(1,i),o}return t.prototype.next=function(n){var i=this,r=i.isStopped,o=i._buffer,s=i._infiniteTimeWindow,a=i._timestampProvider,u=i._windowTime;r||(o.push(n),!s&&o.push(a.now()+u)),this._trimBuffer(),e.prototype.next.call(this,n)},t.prototype._subscribe=function(n){this._throwIfClosed(),this._trimBuffer();for(var i=this._innerSubscribe(n),r=this,o=r._infiniteTimeWindow,s=r._buffer,a=s.slice(),u=0;u<a.length&&!n.closed;u+=o?1:2)n.next(a[u]);return this._checkFinalizedStatuses(n),i},t.prototype._trimBuffer=function(){var n=this,i=n._bufferSize,r=n._timestampProvider,o=n._buffer,s=n._infiniteTimeWindow,a=(s?1:2)*i;if(i<1/0&&a<o.length&&o.splice(0,o.length-a),!s){for(var u=r.now(),l=0,c=1;c<o.length&&o[c]<=u;c+=2)l=c;l&&o.splice(0,l+1)}},t}(V),bo=function(e){oe(t,e);function t(n,i){return e.call(this)||this}return t.prototype.schedule=function(n,i){return this},t}($e),$n={setInterval:function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setInterval.apply(void 0,ae([e,t],re(n)))},clearInterval:function(e){return clearInterval(e)},delegate:void 0},ci=function(e){oe(t,e);function t(n,i){var r=e.call(this,n,i)||this;return r.scheduler=n,r.work=i,r.pending=!1,r}return t.prototype.schedule=function(n,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=n;var o=this.id,s=this.scheduler;return o!=null&&(this.id=this.recycleAsyncId(s,o,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(s,this.id,i),this},t.prototype.requestAsyncId=function(n,i,r){return r===void 0&&(r=0),$n.setInterval(n.flush.bind(n,this),r)},t.prototype.recycleAsyncId=function(n,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&$n.clearInterval(i)},t.prototype.execute=function(n,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(n,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(n,i){var r=!1,o;try{this.work(n)}catch(s){r=!0,o=s||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),o},t.prototype.unsubscribe=function(){if(!this.closed){var n=this,i=n.id,r=n.scheduler,o=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,ot(o,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(bo),En=function(){function e(t,n){n===void 0&&(n=e.now),this.schedulerActionCtor=t,this.now=n}return e.prototype.schedule=function(t,n,i){return n===void 0&&(n=0),new this.schedulerActionCtor(this,t).schedule(i,n)},e.now=Xt.now,e}(),di=function(e){oe(t,e);function t(n,i){i===void 0&&(i=En.now);var r=e.call(this,n,i)||this;return r.actions=[],r._active=!1,r}return t.prototype.flush=function(n){var i=this.actions;if(this._active){i.push(n);return}var r;this._active=!0;do if(r=n.execute(n.state,n.delay))break;while(n=i.shift());if(this._active=!1,r){for(;n=i.shift();)n.unsubscribe();throw r}},t}(En),ut=new di(ci),wo=ut,Io=function(e){oe(t,e);function t(n,i){var r=e.call(this,n,i)||this;return r.scheduler=n,r.work=i,r}return t.prototype.requestAsyncId=function(n,i,r){return r===void 0&&(r=0),r!==null&&r>0?e.prototype.requestAsyncId.call(this,n,i,r):(n.actions.push(this),n._scheduled||(n._scheduled=xn.requestAnimationFrame(function(){return n.flush(void 0)})))},t.prototype.recycleAsyncId=function(n,i,r){var o;if(r===void 0&&(r=0),r!=null?r>0:this.delay>0)return e.prototype.recycleAsyncId.call(this,n,i,r);var s=n.actions;i!=null&&i===n._scheduled&&((o=s[s.length-1])===null||o===void 0?void 0:o.id)!==i&&(xn.cancelAnimationFrame(i),n._scheduled=void 0)},t}(ci),So=function(e){oe(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t.prototype.flush=function(n){this._active=!0;var i;n?i=n.id:(i=this._scheduled,this._scheduled=void 0);var r=this.actions,o;n=n||r.shift();do if(o=n.execute(n.state,n.delay))break;while((n=r[0])&&n.id===i&&r.shift());if(this._active=!1,o){for(;(n=r[0])&&n.id===i&&r.shift();)n.unsubscribe();throw o}},t}(di),fe=new So(Io),ie=new R(function(e){return e.complete()});function pi(e){return e&&A(e.schedule)}function Zt(e){return e[e.length-1]}function Jt(e){return A(Zt(e))?e.pop():void 0}function ke(e){return pi(Zt(e))?e.pop():void 0}function xo(e,t){return typeof Zt(e)=="number"?e.pop():t}var Kt=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function fi(e){return A(e==null?void 0:e.then)}function hi(e){return A(e[Gt])}function gi(e){return Symbol.asyncIterator&&A(e==null?void 0:e[Symbol.asyncIterator])}function mi(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Po(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var vi=Po();function yi(e){return A(e==null?void 0:e[vi])}function bi(e){return oo(this,arguments,function(){var n,i,r,o;return si(this,function(s){switch(s.label){case 0:n=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,be(n.read())];case 3:return i=s.sent(),r=i.value,o=i.done,o?[4,be(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,be(r)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function wi(e){return A(e==null?void 0:e.getReader)}function G(e){if(e instanceof R)return e;if(e!=null){if(hi(e))return $o(e);if(Kt(e))return Eo(e);if(fi(e))return Lo(e);if(gi(e))return Ii(e);if(yi(e))return To(e);if(wi(e))return Mo(e)}throw mi(e)}function $o(e){return new R(function(t){var n=e[Gt]();if(A(n.subscribe))return n.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Eo(e){return new R(function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()})}function Lo(e){return new R(function(t){e.then(function(n){t.closed||(t.next(n),t.complete())},function(n){return t.error(n)}).then(null,li)})}function To(e){return new R(function(t){var n,i;try{for(var r=Se(e),o=r.next();!o.done;o=r.next()){var s=o.value;if(t.next(s),t.closed)return}}catch(a){n={error:a}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}t.complete()})}function Ii(e){return new R(function(t){Oo(e,t).catch(function(n){return t.error(n)})})}function Mo(e){return Ii(bi(e))}function Oo(e,t){var n,i,r,o;return ro(this,void 0,void 0,function(){var s,a;return si(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,11]),n=so(e),u.label=1;case 1:return[4,n.next()];case 2:if(i=u.sent(),!!i.done)return[3,4];if(s=i.value,t.next(s),t.closed)return[2];u.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=u.sent(),r={error:a},[3,11];case 6:return u.trys.push([6,,9,10]),i&&!i.done&&(o=n.return)?[4,o.call(n)]:[3,8];case 7:u.sent(),u.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function he(e,t,n,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var o=t.schedule(function(){n(),r?e.add(this.schedule(null,i)):this.unsubscribe()},i);if(e.add(o),!r)return o}function Si(e,t){return t===void 0&&(t=0),C(function(n,i){n.subscribe(j(i,function(r){return he(i,e,function(){return i.next(r)},t)},function(){return he(i,e,function(){return i.complete()},t)},function(r){return he(i,e,function(){return i.error(r)},t)}))})}function xi(e,t){return t===void 0&&(t=0),C(function(n,i){i.add(e.schedule(function(){return n.subscribe(i)},t))})}function Ao(e,t){return G(e).pipe(xi(t),Si(t))}function _o(e,t){return G(e).pipe(xi(t),Si(t))}function Ro(e,t){return new R(function(n){var i=0;return t.schedule(function(){i===e.length?n.complete():(n.next(e[i++]),n.closed||this.schedule())})})}function Fo(e,t){return new R(function(n){var i;return he(n,t,function(){i=e[vi](),he(n,t,function(){var r,o,s;try{r=i.next(),o=r.value,s=r.done}catch(a){n.error(a);return}s?n.complete():n.next(o)},0,!0)}),function(){return A(i==null?void 0:i.return)&&i.return()}})}function Pi(e,t){if(!e)throw new Error("Iterable cannot be null");return new R(function(n){he(n,t,function(){var i=e[Symbol.asyncIterator]();he(n,t,function(){i.next().then(function(r){r.done?n.complete():n.next(r.value)})},0,!0)})})}function jo(e,t){return Pi(bi(e),t)}function $i(e,t){if(e!=null){if(hi(e))return Ao(e,t);if(Kt(e))return Ro(e,t);if(fi(e))return _o(e,t);if(gi(e))return Pi(e,t);if(yi(e))return Fo(e,t);if(wi(e))return jo(e,t)}throw mi(e)}function N(e,t){return t?$i(e,t):G(e)}function P(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ke(e);return N(e,n)}var Qt=qt(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function Co(e,t){return new Promise(function(n,i){var r=!1,o;e.subscribe({next:function(s){o=s,r=!0},error:i,complete:function(){r?n(o):i(new Qt)}})})}function Do(e){return e instanceof Date&&!isNaN(e)}function b(e,t){return C(function(n,i){var r=0;n.subscribe(j(i,function(o){i.next(e.call(t,o,r++))}))})}var No=Array.isArray;function Wo(e,t){return No(t)?e.apply(void 0,ae([],re(t))):e(t)}function en(e){return b(function(t){return Wo(e,t)})}var ko=Array.isArray,Vo=Object.getPrototypeOf,zo=Object.prototype,Uo=Object.keys;function Ei(e){if(e.length===1){var t=e[0];if(ko(t))return{args:t,keys:null};if(Ho(t)){var n=Uo(t);return{args:n.map(function(i){return t[i]}),keys:n}}}return{args:e,keys:null}}function Ho(e){return e&&typeof e=="object"&&Vo(e)===zo}function Li(e,t){return e.reduce(function(n,i,r){return n[i]=t[r],n},{})}function K(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ke(e),i=Jt(e),r=Ei(e),o=r.args,s=r.keys;if(o.length===0)return N([],n);var a=new R(Bo(o,n,s?function(u){return Li(s,u)}:ne));return i?a.pipe(en(i)):a}function Bo(e,t,n){return n===void 0&&(n=ne),function(i){Ln(t,function(){for(var r=e.length,o=new Array(r),s=r,a=r,u=function(c){Ln(t,function(){var d=N(e[c],t),p=!1;d.subscribe(j(i,function(f){o[c]=f,p||(p=!0,a--),a||i.next(n(o.slice()))},function(){--s||i.complete()}))},i)},l=0;l<r;l++)u(l)},i)}}function Ln(e,t,n){e?he(n,e,t):t()}function qo(e,t,n,i,r,o,s,a){var u=[],l=0,c=0,d=!1,p=function(){d&&!u.length&&!l&&t.complete()},f=function(g){return l<i?h(g):u.push(g)},h=function(g){l++;var v=!1;G(n(g,c++)).subscribe(j(t,function(m){t.next(m)},function(){v=!0},void 0,function(){if(v)try{l--;for(var m=function(){var y=u.shift();s||h(y)};u.length&&l<i;)m();p()}catch(y){t.error(y)}}))};return e.subscribe(j(t,f,function(){d=!0,p()})),function(){}}function ue(e,t,n){return n===void 0&&(n=1/0),A(t)?ue(function(i,r){return b(function(o,s){return t(i,o,r,s)})(G(e(i,r)))},n):(typeof t=="number"&&(n=t),C(function(i,r){return qo(i,r,e,n)}))}function Ti(e){return e===void 0&&(e=1/0),ue(ne,e)}function Yo(){return Ti(1)}function Pt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Yo()(N(e,ke(e)))}function $t(e){return new R(function(t){G(e()).subscribe(t)})}function Go(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Jt(e),i=Ei(e),r=i.args,o=i.keys,s=new R(function(a){var u=r.length;if(!u){a.complete();return}for(var l=new Array(u),c=u,d=u,p=function(h){var g=!1;G(r[h]).subscribe(j(a,function(v){g||(g=!0,d--),l[h]=v},function(){return c--},void 0,function(){(!c||!g)&&(d||a.next(o?Li(o,l):l),a.complete())}))},f=0;f<u;f++)p(f)});return n?s.pipe(en(n)):s}var Xo=["addListener","removeListener"],Zo=["addEventListener","removeEventListener"],Jo=["on","off"];function J(e,t,n,i){if(A(n)&&(i=n,n=void 0),i)return J(e,t,n).pipe(en(i));var r=re(es(e)?Zo.map(function(a){return function(u){return e[a](t,u,n)}}):Ko(e)?Xo.map(Tn(e,t)):Qo(e)?Jo.map(Tn(e,t)):[],2),o=r[0],s=r[1];if(!o&&Kt(e))return ue(function(a){return J(a,t,n)})(G(e));if(!o)throw new TypeError("Invalid event target");return new R(function(a){var u=function(){for(var l=[],c=0;c<arguments.length;c++)l[c]=arguments[c];return a.next(1<l.length?l:l[0])};return o(u),function(){return s(u)}})}function Tn(e,t){return function(n){return function(i){return e[n](t,i)}}}function Ko(e){return A(e.addListener)&&A(e.removeListener)}function Qo(e){return A(e.on)&&A(e.off)}function es(e){return A(e.addEventListener)&&A(e.removeEventListener)}function st(e,t,n){e===void 0&&(e=0),n===void 0&&(n=wo);var i=-1;return t!=null&&(pi(t)?n=t:i=t),new R(function(r){var o=Do(e)?+e-n.now():e;o<0&&(o=0);var s=0;return n.schedule(function(){r.closed||(r.next(s++),0<=i?this.schedule(void 0,i):r.complete())},o)})}function E(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ke(e),i=xo(e,1/0),r=e;return r.length?r.length===1?G(r[0]):Ti(i)(N(r,n)):ie}var xe=new R(Re);function M(e,t){return C(function(n,i){var r=0;n.subscribe(j(i,function(o){return e.call(t,o,r++)&&i.next(o)}))})}function je(e){return C(function(t,n){var i=null,r=!1,o;i=t.subscribe(j(n,void 0,void 0,function(s){o=G(e(s,je(e)(t))),i?(i.unsubscribe(),i=null,o.subscribe(n)):r=!0})),r&&(i.unsubscribe(),i=null,o.subscribe(n))})}function ts(e,t,n,i,r){return function(o,s){var a=n,u=t,l=0;o.subscribe(j(s,function(c){var d=l++;u=a?e(u,c,d):(a=!0,c)},function(){a&&s.next(u),s.complete()}))}}function ns(e,t){return C(ts(e,t,arguments.length>=2,!1,!0))}function Mn(e,t){return A(t)?ue(e,t,1):ue(e,1)}function Ee(e,t){return t===void 0&&(t=ut),C(function(n,i){var r=null,o=null,s=null,a=function(){if(r){r.unsubscribe(),r=null;var l=o;o=null,i.next(l)}};function u(){var l=s+e,c=t.now();if(c<l){r=this.schedule(void 0,l-c),i.add(r);return}a()}n.subscribe(j(i,function(l){o=l,s=t.now(),r||(r=t.schedule(u,e),i.add(r))},function(){a(),i.complete()},void 0,function(){o=r=null}))})}function is(e){return C(function(t,n){var i=!1;t.subscribe(j(n,function(r){i=!0,n.next(r)},function(){i||n.next(e),n.complete()}))})}function Ve(e){return e<=0?function(){return ie}:C(function(t,n){var i=0;t.subscribe(j(n,function(r){++i<=e&&(n.next(r),e<=i&&n.complete())}))})}function rs(e){return b(function(){return e})}function os(e,t){return ue(function(n,i){return G(e(n,i)).pipe(Ve(1),rs(n))})}function Je(e,t){t===void 0&&(t=ut);var n=st(e,t);return os(function(){return n})}function O(e,t){return t===void 0&&(t=ne),e=e??ss,C(function(n,i){var r,o=!0;n.subscribe(j(i,function(s){var a=t(s);(o||!e(r,a))&&(o=!1,r=a,i.next(s))}))})}function ss(e,t){return e===t}function as(e){return e===void 0&&(e=us),C(function(t,n){var i=!1;t.subscribe(j(n,function(r){i=!0,n.next(r)},function(){return i?n.complete():n.error(e())}))})}function us(){return new Qt}function Oe(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(n){return Pt(n,P.apply(void 0,ae([],re(e))))}}function Et(e,t){return C(function(n,i){var r=0,o=null,s=!1;n.subscribe(j(i,function(a){o||(o=j(i,void 0,function(){o=null,s&&i.complete()}),G(e(a,r++)).subscribe(o))},function(){s=!0,!o&&i.complete()}))})}function ve(e){return C(function(t,n){try{t.subscribe(n)}finally{n.add(e)}})}function B(e,t){var n=arguments.length>=2;return function(i){return i.pipe(ne,Ve(1),n?is(t):as(function(){return new Qt}))}}function ls(){return C(function(e,t){var n,i=!1;e.subscribe(j(t,function(r){var o=n;n=r,i&&t.next([o,r]),i=!0}))})}function U(e){e===void 0&&(e={});var t=e.connector,n=t===void 0?function(){return new V}:t,i=e.resetOnError,r=i===void 0?!0:i,o=e.resetOnComplete,s=o===void 0?!0:o,a=e.resetOnRefCountZero,u=a===void 0?!0:a;return function(l){var c,d,p,f=0,h=!1,g=!1,v=function(){d==null||d.unsubscribe(),d=void 0},m=function(){v(),c=p=void 0,h=g=!1},y=function(){var w=c;m(),w==null||w.unsubscribe()};return C(function(w,S){f++,!g&&!h&&v();var $=p=p??n();S.add(function(){f--,f===0&&!g&&!h&&(d=ft(y,u))}),$.subscribe(S),!c&&f>0&&(c=new Fe({next:function(T){return $.next(T)},error:function(T){g=!0,v(),d=ft(m,r,T),$.error(T)},complete:function(){h=!0,v(),d=ft(m,s),$.complete()}}),G(w).subscribe(c))})(l)}}function ft(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(t===!0){e();return}if(t!==!1){var r=new Fe({next:function(){r.unsubscribe(),e()}});return G(t.apply(void 0,ae([],re(n)))).subscribe(r)}}function Q(e,t,n){var i,r,o,s,a=!1;return e&&typeof e=="object"?(i=e.bufferSize,s=i===void 0?1/0:i,r=e.windowTime,t=r===void 0?1/0:r,o=e.refCount,a=o===void 0?!1:o,n=e.scheduler):s=e??1/0,U({connector:function(){return new xt(s,t,n)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}function tn(e){return M(function(t,n){return e<=n})}function se(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ke(e);return C(function(i,r){(n?Pt(e,i,n):Pt(e,i)).subscribe(r)})}function I(e,t){return C(function(n,i){var r=null,o=0,s=!1,a=function(){return s&&!r&&i.complete()};n.subscribe(j(i,function(u){r==null||r.unsubscribe();var l=0,c=o++;G(e(u,c)).subscribe(r=j(i,function(d){return i.next(t?t(u,d,c,l++):d)},function(){r=null,a()}))},function(){s=!0,a()}))})}function cs(e,t){return C(function(n,i){var r=t;return I(function(o,s){return e(r,o,s)},function(o,s){return r=s,s})(n).subscribe(i),function(){r=null}})}function L(e){return C(function(t,n){G(e).subscribe(j(n,function(){return n.complete()},Re)),!n.closed&&t.subscribe(n)})}function x(e,t,n){var i=A(e)||t||n?{next:e,error:t,complete:n}:e;return i?C(function(r,o){var s;(s=i.subscribe)===null||s===void 0||s.call(i);var a=!0;r.subscribe(j(o,function(u){var l;(l=i.next)===null||l===void 0||l.call(i,u),o.next(u)},function(){var u;a=!1,(u=i.complete)===null||u===void 0||u.call(i),o.complete()},function(u){var l;a=!1,(l=i.error)===null||l===void 0||l.call(i,u),o.error(u)},function(){var u,l;a&&((u=i.unsubscribe)===null||u===void 0||u.call(i)),(l=i.finalize)===null||l===void 0||l.call(i)}))}):ne}function ds(e,t){return C(function(n,i){var r=t??{},o=r.leading,s=o===void 0?!0:o,a=r.trailing,u=a===void 0?!1:a,l=!1,c=null,d=null,p=!1,f=function(){d==null||d.unsubscribe(),d=null,u&&(v(),p&&i.complete())},h=function(){d=null,p&&i.complete()},g=function(m){return d=G(e(m)).subscribe(j(i,f,h))},v=function(){if(l){l=!1;var m=c;c=null,i.next(m),!p&&g(m)}};n.subscribe(j(i,function(m){l=!0,c=m,!(d&&!d.closed)&&(s?v():g(m))},function(){p=!0,!(u&&l&&d&&!d.closed)&&i.complete()}))})}function ps(e,t,n){t===void 0&&(t=ut);var i=st(e,t);return ds(function(){return i},n)}function z(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Jt(e);return C(function(i,r){for(var o=e.length,s=new Array(o),a=e.map(function(){return!1}),u=!1,l=function(d){G(e[d]).subscribe(j(r,function(p){s[d]=p,!u&&!a[d]&&(a[d]=!0,(u=a.every(ne))&&(a=null))},Re))},c=0;c<o;c++)l(c);i.subscribe(j(r,function(d){if(u){var p=ae([d],re(s));r.next(n?n.apply(void 0,ae([],re(p))):p)}}))})}const fs=e=>{var t,n;return((n=(t=e.split(/[#?]/)[0])==null?void 0:t.split(".").pop())==null?void 0:n.trim())||""};function hs(e){const t=e.split("/");return t.pop(),t.join("/")}const lt=e=>{switch(fs(e)){case"png":return"image/png";case"jpg":return"image/jpg";case"jpeg":return"image/jpeg";case"txt":return"text/plain";case"webp":return"image/webp";case"xhtml":return"application/xhtml+xml"}},gs=e=>e.length?e.indexOf(";")?e.substring(0,e.indexOf(";")):e:void 0,ms=Object.prototype.hasOwnProperty,vs=(e,t)=>e===t?e!==0||t!==0||1/e===1/t:!1,H=(e,t,n)=>{if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;const o=n&&typeof n.customEqual=="function"?n.customEqual:vs;for(let s=0;s<i.length;s++){const a=i[s]||"";if(!ms.call(t,a)||!o(e[a],t[a]))return!1}return!0};function Ke(e,t){const n={...e};for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const r=t[i];(r!==void 0||!(i in e))&&(n[i]=r)}return n}const ys=()=>{if(!(typeof window>"u"))return window};function bs(){var e;const t=(e=ys())==null?void 0:e.__PROSE_READER_DEBUG;return t===!0||t==="true"}const Te=e=>`[${e}]`,Lt=(e,t=bs())=>({namespace:(n,i)=>Lt(`${e} ${n}`,i),debug:t?e?Function.prototype.bind.call(console.debug,console,Te(e)):Function.prototype.bind.call(console.debug,console):()=>{},info:t?e?Function.prototype.bind.call(console.info,console,Te(e)):Function.prototype.bind.call(console.info,console):()=>{},log:t?e?Function.prototype.bind.call(console.log,console,Te(e)):Function.prototype.bind.call(console.log,console):()=>{},warn:t?e?Function.prototype.bind.call(console.warn,console,Te(e)):Function.prototype.bind.call(console.warn,console):()=>{},error:t?e?Function.prototype.bind.call(console.error,console,Te(e)):Function.prototype.bind.call(console.error,console):()=>{}}),ws={...Lt(),namespace:(e,t)=>Lt(e,t)},Is=(e,t)=>e===t?!0:e.length!==t.length?!1:e.every((n,i)=>n===t[i]);function Ss(e){const t=[e];let n=e;for(;n.parentNode;)t.push(n.parentNode),n=n.parentNode;return t}function xs(e,t){if(e===t)return e;const n=Ss(e),i=new Set(n);let r=t;for(;r;){if(i.has(r))return r;r=r.parentNode}return null}const Ps=/[\[\]\^,();]/g;function Pe(e){return e.replace(Ps,"^$&")}const $s=/^epubcfi\((.*)\)$/,Qe=e=>e.nodeType===Node.ELEMENT_NODE,et=e=>typeof e=="object"&&e!==null&&"nodeType"in e&&(e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.TEXT_NODE),Es=e=>e.nodeType===Node.TEXT_NODE;function Mi(e){if(nn(e))return!1;const t=e[e.length-1];return e.length>1&&(t===void 0||t.length===0)}function nn(e){return e!==null&&typeof e=="object"&&"parent"in e&&"start"in e&&"end"in e}function Ls(e){const t=e.match($s);return t&&t[1]||e}function Ts(e){const t=[];let n=null,i=!1,r="";const o=l=>{t.push(l),n=null,r=""},s=l=>{r+=l,i=!1},a=Ls(e).trim(),u=Array.from(a).concat("");for(let l=0;l<u.length;l++){const c=u[l];if(!c){n==="/"||n===":"?o([n,parseInt(r,10)]):n==="~"?o(["~",parseFloat(r)]):n==="@"?o(["@",parseFloat(r)]):n==="["?o(["[",r]):n===";"||n!=null&&n.startsWith(";")?o([n,r]):n==="!"&&o(["!",0]);break}if(c==="^"&&!i){i=!0;continue}if(n==="!")o(["!",0]);else if(n===",")o([",",0]);else if(n==="/"||n===":"){if(/^\d$/.test(c)){s(c);continue}o([n,parseInt(r,10)])}else if(n==="~"){if(/^\d$/.test(c)||c==="."){s(c);continue}o(["~",parseFloat(r)])}else if(n==="@"){if(c===":"){o(["@",parseFloat(r)]),n="@";continue}if(/^\d$/.test(c)||c==="."){s(c);continue}o(["@",parseFloat(r)])}else if(n==="[")if(c===";"&&!i)o(["[",r]),n=";";else if(c==="]"&&!i)o(["[",r]);else{s(c);continue}else if(n===";")if(c==="="&&!i)n=`;${r}`,r="";else if(c===";"&&!i)o([n,r]),n=";";else if(c==="]"&&!i)o([n,r]);else{s(c);continue}else if(n!=null&&n.startsWith(";"))if(c===";"&&!i)o([n,r]),n=";";else if(c==="]"&&!i)o([n,r]);else{s(c);continue}else n===null&&c===";"&&(n=";");(c==="/"||c===":"||c==="~"||c==="@"||c==="["||c==="!"||c===",")&&(n=c)}return t}function Oi(e,t){return e?e.map((n,i)=>n[0]===t?i:null).filter(n=>n!==null):[]}function Ai(e,t){const n=[];let i=0;for(const r of t)n.push(e.slice(i,r)),i=r;return n.push(e.slice(i)),n}function Ms(e){var t;const n=[],i={};let r=-1;for(let o=0;o<e.length;o++){const s=e[o];if(!s)continue;const[a,u]=s;a==="/"?(r++,n[r]={index:u},i[r]=[]):r>=0&&((t=i[r])==null||t.push(s))}for(let o=0;o<n.length;o++){const s=n[o];if(!s)continue;const a=i[o]||[];for(let u=0;u<a.length;u++){const l=a[u];if(!l)continue;const[c,d]=l;if(c===":")s.offset=d;else if(c==="~")s.temporal=d;else if(c==="@")s.spatial=(s.spatial||[]).concat(d);else if(c===";s")s.side=d;else if(c.startsWith(";")&&c!==";s"){const p=c.substring(1);s.extensions||(s.extensions={}),s.extensions[p]=d}else if(c==="["){const p=typeof d=="string"&&!d.includes(" ")&&d.length<50;if(u===0&&p&&!s.id)s.id=d;else if(d!==""){const f=d.split(",").map(h=>h.trim());s.text=f}}}}return n}function Be(e){const t=Oi(e,"!");return Ai(e,t).map(Ms)}function rn(e){if(!e)throw new Error("CFI string cannot be empty");const t=Ts(e);if(!t||t.length===0)throw new Error("Failed to tokenize CFI string");const n=Oi(t,",");if(n.length===0)return Be(t);const[i,r,o]=Ai(t,n);return{parent:Be(i||[]),start:Be(r||[]),end:Be(o||[])}}function Os(e,t,n={}){try{const i=typeof e!="string"?e:rn(e);return As(i,t,n)}catch(i){if(n.throwOnError)throw i;return{node:null,isRange:!1}}}function As(e,t,n={asRange:!1}){if(nn(e))return _s(e,t);if(Mi(e))return ye(null);const i=e.at(-1);if(i)return tt(i,t,n);throw new Error("Invalid CFI structure")}function _s(e,t){const n=e.parent[0]||[],i=e.start[0]||[],r=e.end[0]||[];let o=t.documentElement;if(n.length>0){const d=tt(n,t);et(d.node)&&(o=d.node)}if(!o)throw new Error("Failed to resolve parent node in CFI range");const s=tt(i,t),a=tt(r,t);if(!et(s.node)||!et(a.node))throw new Error("Failed to resolve start or end node in CFI range");const u=s.node,l=a.node,c=t.createRange();return c.setStart(u,(Array.isArray(s.offset)?s.offset[0]:s.offset)??0),c.setEnd(l,(Array.isArray(a.offset)?a.offset[0]:a.offset)??0),{...s,node:c,isRange:!0}}function Rs(e){if(e!=null&&e.side)return e.side;if(e!=null&&e.text&&e.text.length>0){const t=e.text[0];if(t){const n=t.match(/^([ab])$/);if(n)return n[1]}}}function Tt(e){return e.index%2!==0}function _i(e){const t=Rs(e),n=e==null?void 0:e.extensions;return{offset:e==null?void 0:e.offset,temporal:e==null?void 0:e.temporal,spatial:e==null?void 0:e.spatial,side:t,extensions:n}}function ye(e,t){return{node:e,isRange:!1,..._i(t)}}function qe(e,t){return{node:e,isRange:!0,..._i(t)}}function On(e,t,n){const i=e.createRange();if(i.selectNodeContents(t),n!==void 0){const r=Array.isArray(n)?n[0]:n;Es(t)&&i.setStart(t,r||0)}return i}function An(e,t,n,i){let r=e;for(let o=n;o<t.length;o++){const s=t[o];if(!r||!s)break;if(Tt(s)){const a=s.index-1;if(a>=0&&a<r.childNodes.length)r=r.childNodes[a];else{if(i)throw new Error(`Invalid text node index: ${s.index}`);r=null;break}}else{const a=Array.from(r.childNodes).filter(l=>l.nodeType===Node.ELEMENT_NODE),u=Math.floor(s.index/2)-1;if(u>=0&&u<a.length){const l=a[u];l&&(r=l)}else{if(i)throw new Error(`Invalid element step index: ${s.index}`);r=null;break}}}return r}function tt(e,t,n={}){const{throwOnError:i=!1,asRange:r=!1}=n;if(!t){if(i)throw new Error("Document is not available");return ye(null)}const{node:o,remainingPathIndex:s}=Fs(t,e);if(o&&s>=e.length){const c=e.at(-1);if(c&&Tt(c)){const d=c.index-1;if(d>=0&&d<o.childNodes.length){const p=o.childNodes[d];return ye(p,c)}}if(r){const d=On(t,o,c==null?void 0:c.offset);return qe(d,c)}return ye(o,c)}let a=o||t.documentElement;const u=o?s:0;if(r&&e.length>0){const c=e[e.length-1];if(c&&!Tt(c)){if(c.index===0&&a){const p=t.createRange();return p.setStart(a,0),p.setEnd(a,0),qe(p,c)}const d=An(a,e.slice(0,-1),u,i);if(d){const p=Array.from(d.childNodes).filter(f=>f.nodeType===Node.ELEMENT_NODE);if(Math.floor(c.index/2)-1===p.length){const f=t.createRange();return f.selectNodeContents(d),f.collapse(!1),qe(f,c)}}}}if(a=An(a,e,u,i),!a){if(i)throw new Error("Failed to resolve CFI path");return ye(null)}const l=e.at(-1);if(r){const c=On(t,a,l==null?void 0:l.offset);return qe(c,l)}return ye(a,l)}function Fs(e,t){for(let n=t.length-1;n>=0;n--){const i=t[n];if(i!=null&&i.id){const r=e.getElementById(i.id);if(r)return{node:r,remainingPathIndex:n+1}}}return{node:null,remainingPathIndex:0}}function Ri(e,t,n={}){if(!e.textContent||e.textContent.trim()==="")return null;const i=e.textContent,r=n.textAssertionLength||10;if(t!==void 0&&t<=i.length){const o=Math.floor(r/2),s=Math.max(0,t-o),a=Math.min(i.length,t+o);return i.substring(s,a)}return i.substring(0,Math.min(i.length,r))}function js(e){const[t,n]=e,i=Math.max(0,Math.min(100,t)),r=Math.max(0,Math.min(100,n));return`@${i}:${r}`}function Mt(e,t,n){let i=e;return t!==void 0&&(i+=`~${t}`),n!==void 0&&(i+=js(n)),i}function Fi(e,t,n){let i=e;if(t&&(i+=`[${Pe(t)}]`),n){const r=n==="before"?"b":"a";t?i=`${i.substring(0,i.length-1)};s=${r}]`:i+=`[;s=${r}]`}return i}function Ot(e,t,n={},i){var r;let o="",s=e,a=null;if((e==null?void 0:e.nodeType)===Node.TEXT_NODE){a=e;const l=e.parentNode;if(!l)throw new Error("Text node doesn't have a parent");const c=Array.from(l.childNodes).indexOf(e);if(c===-1)throw new Error("Node not found in parent's children");if(o=`/${c+1}`,Qe(l)&&l.id){const d=l.id,p=Array.from(((r=l.parentNode)==null?void 0:r.childNodes)||[]);o=`/${p.slice(0,p.indexOf(l)+1).filter(f=>f.nodeType===Node.ELEMENT_NODE).length*2}[${Pe(d)}]${o}`,s=l.parentNode}else s=l}let u=null;for(a&&n.includeTextAssertions&&(u=Ri(a,t,n));s!=null&&s.parentNode;){if(!(a&&s===a.parentNode&&o.includes(`[${Qe(s)?s.id:""}]`))){const l=s.parentNode,c=Array.from(l.childNodes),d=c.indexOf(s);if(d===-1)throw new Error("Node not found in parent's children");const p=c.slice(0,d+1).filter(g=>g.nodeType===Node.ELEMENT_NODE);let f;s.nodeType,f=p.length;const h=f*2;Qe(s)&&s.id?o=`/${h}[${Pe(s.id)}]${o}`:o=`/${h}${o}`}if(s.parentNode.nodeName.toLowerCase()==="html")break;s=s.parentNode}return t!==void 0&&(o+=`:${t}`),o=Mt(o,i==null?void 0:i.temporal,(i==null?void 0:i.spatial)||n.spatialOffset),o=Fi(o,u,n.includeSideBias),o=we(o,n.extensions),o}function _n(e,t,n,i={},r){if(e===t){let u=n!==void 0?`:${n}`:"";return u=Mt(u,r==null?void 0:r.temporal,r==null?void 0:r.spatial),u}const o=[];let s=t;for(;s&&s!==e;){const u=s.parentNode;if(!u)break;const l=u.childNodes;let c=-1;for(let p=0;p<l.length;p++)if(l[p]===s){c=p;break}if(c===-1)throw new Error("Node not found in parent's children");const d=c+1;Qe(s)&&s.id?o.unshift(`/${d}[${Pe(s.id)}]`):o.unshift(`/${d}`),s=u}let a=o.join("");if(n!==void 0&&(a+=`:${n}`),a=Mt(a,r==null?void 0:r.temporal,r==null?void 0:r.spatial),i.includeTextAssertions&&t.nodeType===Node.TEXT_NODE){const u=Ri(t,n,i);a=Fi(a,u,i.includeSideBias)}return a=we(a,i.extensions),a}const Cs=e=>Object.entries(e).map(([t,n])=>{const i=Pe(n);return`${t}=${encodeURIComponent(i)}`}).join(";");function we(e,t){if(!t||Object.keys(t).length===0)return e;const n=Cs(t);if(e.endsWith("]")){const i=e.lastIndexOf("["),r=e.substring(i+1,e.length-1);return r.includes(n)?e:`${e.substring(0,e.length-1)}${r.includes(";"),";"}${n}]`}return e.endsWith("!")?e:`${e}[;${n}]`}function Ds(e,t,n,i,r={},o,s){const a=xs(e,n);if(!a)throw new Error("No common ancestor found");const u=Ot(a,void 0,r),l=_n(a,e,t,r,o),c=_n(a,n,i,r,s);if(r.extensions&&Object.keys(r.extensions).length>0){const d=we(u,r.extensions),p=we(l,r.extensions),f=we(c,r.extensions);return`${d},${p},${f}`}return`${u},${l},${c}`}const Rn=(e,t,n={},i)=>{const r="";let o=`/6/${(e+1)*2}`;return t&&(o+=`[${Pe(t)}]`),o=i?we(o,n.extensions):o,`${o}${r}!`};function ji(e,t={}){if(et(e))return`epubcfi(${Ot(e,void 0,t)})`;let n="";if(!("start"in e))return e.spineIndex!==void 0&&(n=Rn(e.spineIndex,e.spineId,t,!e.node),!e.node)?`epubcfi(${n})`:(n+=Ot(e.node??null,e.offset,t,e),`epubcfi(${n})`);const{start:i,end:r}=e;return i.spineIndex!==void 0&&(n=Rn(i.spineIndex,i.spineId,t,!i.node)),i.node&&r.node&&(n+=Ds(i.node,i.offset??0,r.node,r.offset??0,t,i,r)),`epubcfi(${n})`}const Fn=(e,t)=>{const n=new RegExp(`${t}\\s*=\\s*([0-9.]+)`,"i"),i=e.match(n)||[],r=i[1]||"0";return i&&Number.parseFloat(r)||0},Ns=(e,t,n,i)=>{var r;if((r=e==null?void 0:e.contentDocument)!=null&&r.head){const o=e.contentDocument.createElement("style");o.id=t,o.innerHTML=n,i?e.contentDocument.head.prepend(o):e.contentDocument.head.appendChild(o)}},Ws=(e,t)=>{var n;if((n=e==null?void 0:e.contentDocument)!=null&&n.head){const i=e.contentDocument.getElementById(t);i&&i.remove()}},ce=(e,t,n,i)=>{e&&(Ws(e,t),Ns(e,t,n,i))},on=e=>{if(e!=null&&e.contentDocument){const t=e.contentDocument.querySelector("meta[name='viewport']");if(t){const n=t.getAttribute("content");if(n){const i=Fn(n,"width"),r=Fn(n,"height");return i>0&&r>0?{hasViewport:!0,width:i,height:r}:{hasViewport:!0}}}}return{hasViewport:!1}},ks=e=>e.pipe(I(t=>{var n;return t.src==="about:blank"&&((n=t.contentDocument)==null?void 0:n.readyState)==="complete"&&t.contentDocument.body?P(t):J(t,"load").pipe(Ve(1),b(()=>t))})),Vs=e=>e.pipe(I(t=>{var n;return N(((n=t==null?void 0:t.contentDocument)==null?void 0:n.fonts.ready)||P(void 0)).pipe(b(()=>t))})),zs=e=>t=>{const n=e(t),i=new IntersectionObserver(r=>{r.forEach(o=>{o.isIntersecting?o.target.removeAttribute("tab-index"):o.target.setAttribute("tab-index","-1")})},{});return n.hookManager.register("item.onDocumentLoad",({itemId:r,destroy:o})=>{var s;const a=n.spineItemsManager.get(r);if(!a)return;const u=a.renderer.getDocumentFrame();if(!u)return;ce(u,"prose-reader-accessibility",`
              :focus-visible {
                
                outline: -webkit-focus-ring-color auto 1px;
              }
            `);const l=(s=u.contentDocument)==null?void 0:s.body.querySelectorAll("a");l==null||l.forEach(c=>{i.observe(c)}),o(()=>{l==null||l.forEach(c=>{i.unobserve(c)})})}),{...n}},Us=e=>t=>{const n=e(t);return n.context.state$.pipe(L(n.$.destroy$)).subscribe(({containerElement:i})=>{if(!i)return;const r=()=>{n.settings.values.computedPageTurnMode==="controlled"&&i.scrollTo(0,0)};i.addEventListener("scroll",r)}),n.hookManager.register("item.onDocumentLoad",({itemId:i})=>{var r;const o=n.spineItemsManager.get(i),s=o==null?void 0:o.renderer.getDocumentFrame();s&&((r=s.contentDocument)==null||r.body.setAttribute("tabindex","-1"))}),n},Hs="@prose-reader/core",q=ws.namespace(Hs),Bs=["pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup"],Ci=e=>typeof e=="object"&&!!e&&"nodeType"in e&&(e==null?void 0:e.nodeType)===Node.ELEMENT_NODE;function qs(e,t,n){if("caretPositionFromPoint"in e)return e.caretPositionFromPoint(t,n);if("caretRangeFromPoint"in e&&typeof e.caretRangeFromPoint<"u")return e.caretRangeFromPoint(t,n)}const Ys=(e,t)=>{const n="body"in e?At(e.body,t):At(e,t),i="createRange"in e?e:e.ownerDocument;if(n){let r,o=0;const s=i.createRange();return Array.from(n.childNodes).some(a=>{s.selectNodeContents(a);const u=s.getClientRects(),l=Gs(u,t);if(l){r=s.cloneRange();const c=qs(i,Math.ceil(l.left),Math.ceil(l.top));return c&&"startContainer"in c&&c.startContainer===r.startContainer&&(o=c.startOffset),c&&"offsetNode"in c&&c.offsetNode===r.startContainer&&(o=c.offset),!0}return!1}),r?{node:r.startContainer,offset:o}:{node:n,offset:0}}},At=(e,t)=>{let n;const i=Di(e.getBoundingClientRect(),t);return i!=="before"&&i!=="after"&&(n=e),Array.from(e.children).some(r=>{const o=At(r,t);return o?(n=o,!0):!1}),n};function Di(e,{left:t,right:n}){return e.left<=t&&e.right<=t?"before":e.left<=t&&e.right>t&&e.right<=n?"partially-before":e.left<=n&&e.right>n?"partially-after":e.left>n?"after":"within"}function Gs(e,t){return Array.from(e).find(n=>{const i=Di(n,t);return i!=="before"&&i!=="after"})}const Xs=(e,t)=>{var n;if(e.nodeType!==Node.CDATA_SECTION_NODE&&e.nodeType!==Node.DOCUMENT_TYPE_NODE){const i=(n=e.ownerDocument)==null?void 0:n.createRange();i==null||i.selectNodeContents(e);try{t<=((i==null?void 0:i.endOffset)||0)&&(i==null||i.setStart(e,t||0))}catch(r){q.error(r)}return i}},sn=e=>{var t,n,i,r,o;if(e!=null&&e.target&&(n=(t=e==null?void 0:e.target)==null?void 0:t.ownerDocument)!=null&&n.defaultView){const s=(r=(i=e==null?void 0:e.target)==null?void 0:i.ownerDocument)==null?void 0:r.defaultView;if(s.PointerEvent&&e instanceof s.PointerEvent)return!0}if((o=e==null?void 0:e.view)!=null&&o.window){const s=e==null?void 0:e.view;if(s.PointerEvent&&e instanceof s.PointerEvent)return!0}return!!Bs.includes(e.type)},Zs=e=>{var t,n,i,r,o;if(sn(e))return!1;if(e!=null&&e.target&&(n=(t=e==null?void 0:e.target)==null?void 0:t.ownerDocument)!=null&&n.defaultView){const s=(r=(i=e==null?void 0:e.target)==null?void 0:i.ownerDocument)==null?void 0:r.defaultView;if(s.MouseEvent)return e instanceof s.MouseEvent}if((o=e==null?void 0:e.view)!=null&&o.window){const s=e==null?void 0:e.view;if(s.MouseEvent)return e instanceof s.MouseEvent}return!1},Js=e=>{var t,n,i,r,o;if(e!=null&&e.target&&(n=(t=e==null?void 0:e.target)==null?void 0:t.ownerDocument)!=null&&n.defaultView){const s=(r=(i=e==null?void 0:e.target)==null?void 0:i.ownerDocument)==null?void 0:r.defaultView;if(s.TouchEvent)return e instanceof s.TouchEvent}if((o=e==null?void 0:e.view)!=null&&o.window){const s=e==null?void 0:e.view;if(s.TouchEvent)return e instanceof s.TouchEvent}return!1},Ks=()=>document.createElement("div"),Ni=e=>{const t=["img","video","audio","source","link","script"].join(",");return Array.from((e==null?void 0:e.querySelectorAll(t))||[])},Qs=e=>{if(Ni(e).forEach(t=>{var n;const i=t.getAttribute("src")||t.getAttribute("href");i!=null&&i.startsWith("blob:")&&((n=e==null?void 0:e.defaultView)==null||n.URL.revokeObjectURL(i))}),e){const t=Array.from(e.styleSheets||[]);for(const n of t){const i=Array.from(n.cssRules||[]);for(const r of i)if(e.defaultView&&r instanceof e.defaultView.CSSFontFaceRule){const o=r.style.getPropertyValue("src").match(/blob:[^,\s'")]+/g);o&&o.forEach(s=>{var a;(a=e==null?void 0:e.defaultView)==null||a.URL.revokeObjectURL(s)})}}}};function ea(e,t){return Ci(e)&&e.tagName.toLowerCase()===t.toLowerCase()}const ht=({position:e,frameElement:t})=>{const n=t.getBoundingClientRect(),i=n.width/t.offsetWidth,r=n.height/t.offsetHeight,{left:o=0,top:s=0}=n,a=e.clientX*i+o,u=e.clientY*r+s;return{clientX:a,clientY:u}},ta=(e,t,n,i)=>{var r;const o=(r=t==null?void 0:t.view)==null?void 0:r.frameElement;if(!t||!o)return e;const s=n.getSpineItemFromIframe(o),a=o,{height:u,width:l}=i.getPageSize();if(!s||!(a instanceof HTMLIFrameElement))return e;if(sn(e)){const{clientX:c,clientY:d}=ht({position:e,frameElement:a}),p=new PointerEvent(e.type,{...e,pointerId:e.pointerId,clientX:c,clientY:d});return Object.defineProperty(p,"target",{value:t.target,enumerable:!0}),p}if(Zs(e)){const{clientX:c,clientY:d}=ht({position:e,frameElement:a}),p=new MouseEvent(e.type,{...e,clientX:c,clientY:d});return Object.defineProperty(p,"target",{value:t.target,enumerable:!0}),p}if(Js(e)){const c=Array.from(e.touches).map(p=>{const{clientX:f,clientY:h}=ht({position:p,frameElement:a});return new Touch({identifier:p.identifier,target:p.target,clientX:f,clientY:h})}),d=new TouchEvent(e.type,{touches:c,changedTouches:c,targetTouches:c});return Object.defineProperty(d,"target",{value:t.target,enumerable:!0}),d}return e},na=["pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup"],ia=[...na],ra=e=>t=>{const n=e(t);return n.hookManager.register("item.onDocumentLoad",({destroy:i,itemId:r})=>{const o=n.spineItemsManager.get(r),s=o==null?void 0:o.renderer.getDocumentFrame();if(!s||!o)return;const a=ia.map(u=>{var l;const c=d=>{var p;let f=d;if(sn(d)&&(f=new PointerEvent(d.type,d)),f!==d){const h=ta(f,d,n.spine.locator,n.context);(p=n.context.state.containerElement)==null||p.dispatchEvent(h)}};return(l=s.contentDocument)==null||l.addEventListener(u,c),()=>{var d;(d=s.contentDocument)==null||d.removeEventListener(u,c)}});i(()=>{a.forEach(u=>u())})}),n},Wi=e=>b(t=>Object.entries(t).reduce((n,[i,r])=>e.includes(i)?{...n,[i]:r}:n,{})),an=e=>t=>t.pipe(Wi(e),O(H));function ki(e){return new R(t=>{const n=new ResizeObserver(i=>{t.next(i)});return n.observe(e),()=>{n.disconnect()}})}const ct=e=>t=>t.pipe(I(n=>e.pipe(B(),b(()=>n)))),oa=e=>{let t;const n=e.subscribe(i=>{t={result:i}});return()=>(n.unsubscribe(),t?P(t.result):e)};function Vi(){return new R(e=>{if(window.requestIdleCallback){const n=window.requestIdleCallback(()=>{e.next(),e.complete()});return()=>cancelIdleCallback(n)}const t=setTimeout(()=>{e.next(),e.complete()},1);return()=>clearTimeout(t)})}function jn(e){return $t(()=>Vi().pipe(I(e)))}const Cn=(e,t)=>new R(n=>{const i=new MutationObserver(r=>{n.next(r)});return i.observe(e,t),()=>i.disconnect()});class zi{constructor(t,n){this.settingsManager=n;const i=Ke(this.getDefaultSettings(),t);this.outputSettings=this.computeOutputSettings(i),this.inputSettings=Ke(this.getDefaultSettings(),t),this.outputSettingsUpdateSubject=new V,this.values$=K([this.settingsManager.values$,this.outputSettingsUpdateSubject.pipe(se(this.outputSettings))]).pipe(b(([r,o])=>({...r,...o})),Q(1)),this.values$.subscribe()}_prepareUpdate(t){const n=this.getCleanedParentInputSettings(t),i=this.settingsManager._prepareUpdate(n),r=Ke(this.inputSettings,t),o=this.computeOutputSettings(r),s=this.hasSettingsChanged(o);return{hasChanged:s||i.hasChanged,commit:()=>(this.inputSettings=r,this.outputSettings=o,!i.hasChanged&&s&&this.outputSettingsUpdateSubject.next(o),{...i.commit(),...o})}}update(t){const{commit:n}=this._prepareUpdate(t);n()}get values(){return{...this.settingsManager.values,...this.outputSettings}}watch(t){return Array.isArray(t)?this.values$.pipe(an(t)):this.values$.pipe(b(n=>n[t]),O(H))}destroy(){this.outputSettingsUpdateSubject.complete()}}const sa=e=>{const t=new FileReader;return new Promise(n=>{t.addEventListener("load",()=>{n(t.result)},!1),t.readAsDataURL(e)})};let aa=class extends zi{computeOutputSettings(e){return e}hasSettingsChanged(e){return!H(this.outputSettings,e)}getCleanedParentInputSettings(e){const{fontJustification:t,fontScale:n,fontWeight:i,lineHeight:r,...o}=e;return o}getDefaultSettings(){return{fontScale:1,fontWeight:"publisher",lineHeight:"publisher",fontJustification:"publisher"}}};const ua=e=>t=>{const{fontScale:n,lineHeight:i,fontWeight:r,fontJustification:o}=t,s=new V,a=e(t),u=new aa({fontScale:n,lineHeight:i,fontWeight:r,fontJustification:o},a.settings),l=()=>`
    
    body {
      ${u.values.fontScale!==1?`font-size: ${u.values.fontScale}em !important;`:""}
      ${u.values.lineHeight!=="publisher"?`line-height: ${u.values.lineHeight} !important;`:""}
      ${u.values.fontWeight!=="publisher"?`font-weight: ${u.values.fontWeight} !important;`:""}
      ${u.values.fontJustification!=="publisher"?`text-align: ${u.values.fontJustification} !important;`:""}
    }
  `,c=p=>{a.spineItemsManager.items.forEach(f=>{if(f.renditionLayout!=="pre-paginated"){const h=f.renderer.getDocumentFrame();h&&ce(h,"prose-reader-fonts",l())}}),p&&a.layout()};a.hookManager.register("item.onDocumentLoad",({itemId:p})=>{const f=a.spineItemsManager.get(p);if((f==null?void 0:f.renditionLayout)!=="pre-paginated"){const h=f==null?void 0:f.renderer.getDocumentFrame();h&&ce(h,"prose-reader-fonts",l())}});const d=p=>p.pipe(ls(),b(([f,h])=>h.fontScale!==f.fontScale||h.lineHeight!==f.lineHeight));return u.values$.pipe(d,x(c),L(a.$.destroy$)).subscribe(),{...a,destroy:()=>{s.complete(),u.destroy(),a.destroy()},settings:u}},la=e=>t=>{const n=e(t),i=r=>J(r,"keyup").pipe(z(n.settings.values$),b(([o,{pageTurnDirection:s}])=>{if(s==="horizontal"){if(o.key==="ArrowRight")return n.navigation.turnRight();if(o.key==="ArrowLeft")return n.navigation.turnLeft()}if(s==="vertical"){if(o.key==="ArrowDown")return n.navigation.turnRight();if(o.key==="ArrowUp")return n.navigation.turnLeft()}return o}));return i(document).pipe(L(n.$.destroy$)).subscribe(),n.spineItemsManager.items$.pipe(I(r=>E(...r.map(o=>o.loaded$.pipe(I(()=>{const s=o.renderer.getDocumentFrame();return s instanceof HTMLIFrameElement&&s!=null&&s.contentDocument?i(s.contentDocument):ie}))))),L(n.$.destroy$)).subscribe(),n},ca=e=>e.spine.spineItemsManager.items$.pipe(I(t=>E(...t.map(n=>n.loaded$.pipe(I(()=>{const i=n.renderer.getDocumentFrame();if(!i||!(i!=null&&i.contentDocument))return xe;const r=Array.from(i.contentDocument.querySelectorAll("a")).map(o=>J(o,"click"));return E(...r)}))))),x(t=>{t.preventDefault()}),U());class ee{constructor(){this.isDestroyed=!1,this.destroySubject=new V,this.destroy$=this.destroySubject.asObservable()}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.destroySubject.next(),this.destroySubject.complete())}}const Ui=class Hi extends ee{constructor(t){super(),this.triggerSubject=new V,this.stateSubject=new Y("idle"),this.unload$=this.triggerSubject.pipe(z(this.stateSubject),M(([r,o])=>r.type==="unload"&&o!=="idle"&&o!=="unloading"),b(()=>{}),U()),this.load$=this.triggerSubject.pipe(z(this.stateSubject),M(([r,o])=>r.type==="load"&&o!=="loaded"&&o!=="loading"),b(()=>{}),U()),this.context=t.context,this.settings=t.settings,this.hookManager=t.hookManager,this.item=t.item,this.containerElement=t.containerElement,this.resourcesHandler=t.resourcesHandler;const n=this.triggerSubject.pipe(z(this.stateSubject),M(([r,o])=>r.type==="unload"&&o!=="idle"&&o!=="unloading"),b(()=>{}),U());this.load$.pipe(I(()=>(this.stateSubject.next("loading"),this.onCreateDocument().pipe(B()).pipe(ue(r=>(this.hookManager.execute("item.onDocumentCreated",this.item.id,{itemId:this.item.id,documentContainer:r}),this.onLoadDocument().pipe(Oe(null),B()).pipe(ct(this.context.bridgeEvent.viewportFree$),I(()=>{const o=this.hookManager.execute("item.onDocumentLoad",this.item.id,{itemId:this.item.id,documentContainer:r}).filter(s=>s instanceof R);return K([P(null),...o]).pipe(B())})))),x(()=>{this.stateSubject.next("loaded")}),L(E(this.destroy$,n)))))).subscribe();const i=n.pipe(I(()=>(this.stateSubject.next("unloading"),this.context.bridgeEvent.viewportFree$.pipe(B(),x(()=>{this.hookManager.destroy("item.onDocumentLoad",this.item.id)}),I(()=>this.onUnload().pipe(Oe(null),B())),x(()=>{this.stateSubject.next("idle")}),L(this.load$)))));E(i).pipe(L(this.destroy$)).subscribe()}setDocumentContainer(t){this._documentContainer=t,this._documentContainer.classList.add(Hi.DOCUMENT_CONTAINER_CLASS_NAME)}attach(){this.documentContainer&&this.containerElement.appendChild(this.documentContainer)}detach(){var t;(t=this._documentContainer)==null||t.remove(),this._documentContainer=void 0}get state$(){return this.stateSubject}get isLoaded$(){return this.state$.pipe(b(t=>t==="loaded"))}load(){this.triggerSubject.next({type:"load"})}unload(){this.triggerSubject.next({type:"unload"})}renderHeadless(){const t=new V;return $t(()=>this.onRenderHeadless({release:t})).pipe(Oe(void 0),B(),b(n=>{if(n)return{doc:n,release:()=>{t.next(void 0)}}}),ve(()=>{t.complete()}),je(n=>(q.error(n),P(void 0))))}layout(t){return $t(()=>this.onLayout(t))}destroy(){this.unload(),this.stateSubject.complete(),super.destroy()}get documentContainer(){return this._documentContainer}get writingMode(){}get readingDirection(){}get renditionLayout(){var t;const n=this.item.renditionLayout;if(n)return n;const i=this.getDocumentFrame();if(i){const{hasViewport:r}=on(i);if(r)return"pre-paginated"}return((t=this.context.manifest)==null?void 0:t.renditionLayout)??"reflowable"}};Ui.DOCUMENT_CONTAINER_CLASS_NAME="prose-reader-document-container";let un=Ui;const da=e=>new URL(e.href);class ln{constructor(t,n){this.item=t,this.settings=n}async getResource(){var t,n;return await Co(((n=(t=this.settings.values).getResource)==null?void 0:n.call(t,this.item))??P(void 0))??da(this.item)}async fetchResource(){const t=await this.getResource();return t instanceof Response?t:t instanceof URL?fetch(t):t}}const Bi=(e,t)=>{const n=e.startsWith("file://"),i=n?e.replace("file://","http://"):e,r=new URL(t,i).toString();return n?r.replace("http://","file://"):r},pa=async(e,t,n,i,r)=>{if(!e||!e.defaultView)return;const o=t.sheet;if(o)try{const s=Array.from(o.cssRules||[]);for(let a=0;a<s.length;a++){const u=s[a];if(e.defaultView&&u instanceof e.defaultView.CSSFontFaceRule){const l=u.style.getPropertyValue("src");if(l.match(/url\(['"]?([^'"]+)['"]?\)/g)){const c=l.split(",").map(f=>f.trim()),d=await Promise.all(c.map(async f=>{var h,g;if(f.startsWith("local("))return f;const v=f.match(/url\(['"]?([^'"]+)['"]?\)/);if(!v)return f;const m=v[1]??"",y=(h=i.manifest)==null?void 0:h.items.find(({href:w})=>`${Bi(n,m).toLowerCase()}`.endsWith(`${w.toLowerCase()}`));if(y){const w=new ln(y,r);try{const S=await w.getResource();if(S instanceof Response){const $=await S.blob(),T=(g=e.defaultView)==null?void 0:g.URL.createObjectURL($);return f.replace(v[0],`url("${T}")`)}}catch(S){console.error("Error loading font:",S)}}return f})),p=u.cssText.replace(/src:\s*[^;]+;/,`src: ${d.join(", ")};`);o.deleteRule(a),o.insertRule(p,a)}}}}catch(s){console.error("Could not access stylesheet rules:",s)}},fa=(e,t,n,i,r)=>{var o;const s=t.getAttribute("src")||t.getAttribute("href");if(!s)return P(null);const a=(o=i.manifest)==null?void 0:o.items.find(({href:l})=>`${Bi(n,s).toLowerCase()}`.endsWith(`${l.toLowerCase()}`));if(!a)return P(null);const u=new ln(a,r);return N(u.getResource()).pipe(ue(l=>l instanceof Response?N(l.blob()):P(void 0)),ue(l=>{var c;if(!l)return P(null);const d=((c=e==null?void 0:e.defaultView)==null?void 0:c.URL.createObjectURL(l))??"";if(t.hasAttribute("src"))t.setAttribute("src",d);else if(t.hasAttribute("href")&&(t.setAttribute("href",d),e!=null&&e.defaultView&&t instanceof e.defaultView.HTMLLinkElement))return new R(p=>{t.onload=async()=>{try{t.sheet&&await pa(e,t,n,i,r),p.next(),p.complete()}catch(f){p.error(f)}},t.onerror=p.error});return P(null)}))},ha=({settings:e,item:t,context:n})=>i=>i.pipe(I(r=>{const o=Ni(r.contentDocument),s=hs(t.href),a=o.map(u=>fa(r.contentDocument,u,s,n,e));return K(a).pipe(b(()=>r))})),ga=e=>{Qs(e==null?void 0:e.contentDocument)},ma=[".xhtml",".html",".htm"],Le="prose-reader",va=e=>new Promise((t,n)=>{const i=new Image;i.src=e,i.onload=()=>{t({height:i.naturalHeight,width:i.naturalWidth})},i.onerror=n}),ya=async(e,t)=>{if(typeof e=="string")return e;const n=gs(e.headers.get("Content-Type")||"")||lt(t.href);if(["image/jpg","image/jpeg","image/png","image/webp"].some(i=>i===n)){const i=await sa(await e.blob()),{height:r,width:o}=await va(i);return`
      <html>
        <head>
          ${t.renditionLayout==="pre-paginated"?`<meta name="viewport" content="width=${o}, height=${r}">`:""}
        </head>
        <body style="margin: 0px;" tab-index="-1;">
          <img
            src="${i}"
            style="max-width: 100%;height:100%;object-fit:contain;"
          >
        </body>
      </html>
        `}return["text/plain"].some(i=>i===n)?`
      <!DOCTYPE html>
      <html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en" lang="en">
        <head>
          <style>
            pre {
              white-space: pre;
              white-space: pre-wrap;
              word-wrap: break-word;
            }
          </style>
        </head>
        <body>
          <pre>${await e.text()}</pre>
        </body>
      </html>
    `:await e.text()},ba=({item:e,resourcesHandler:t})=>{const n=i=>ya(i,e);return i=>i.pipe(I(r=>N(t.getResource()).pipe(I(o=>o instanceof URL&&e.href.startsWith(window.location.origin)&&(e.mediaType&&["application/xhtml+xml","application/xml","text/html","text/xml"].includes(e.mediaType)||!e.mediaType&&ma.some(s=>e.href.endsWith(s)))?(r==null||r.setAttribute("src",e.href),P(r)):(o instanceof URL?N(t.fetchResource()):P(o)).pipe(I(s=>{if(!(s instanceof Response))throw new Error("Invalid resource");return N(n(s))}),x(s=>{if(s){const a=new Blob([s],{type:"text/html"}),u=URL.createObjectURL(a);r==null||r.setAttribute("src",u)}}),b(()=>r),je(s=>(q.error(`Error while trying to fetch or load resource for item ${e.id}`,o),q.error(s),P(r))))))))},wa=()=>{const e=document.createElement("iframe");return e.frameBorder="no",e.tabIndex=0,e.setAttribute("sandbox",`
  allow-same-origin 
  allow-scripts 
  allow-top-navigation-to-custom-protocols
`),e.style.cssText=`
  overflow: hidden;
  background-color: transparent;
  border: 0px none transparent;
  padding: 0px;
`,e.setAttribute("role","main"),e},qi=()=>`
    body {
        margin: 0;
        }
      }
    `,Yi=({pageHeight:e,pageWidth:t,frameElement:n})=>{const i=on(n);if(n!=null&&n.contentDocument&&n.contentWindow&&i){const r=t/(i.width??1);return{computedScale:Math.min(r,e/(i.height??1)),computedWidthScale:r,viewportDimensions:i}}},Ia=({columnWidth:e,enableTouch:t,spreadPosition:n},i)=>`
      ${qi()}
      body {
        ${i?"":`
          display: flex;
          justify-content: ${n==="left"?"flex-end":n==="right"?"flex-start":"center"};
        `}
      }
      
      html, body {
        height: 100%;
        width: 100%;
      }
      
      html, body {
        -max-width: ${e}px !important;
      }
      
      html, body {
        ${t?`
          touch-action: none
        `:""}
      }
      
      img {
        user-select: none;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        user-drag: none;
        
        display: flex;
        
        ${i?"":`
          -width: 100%;
          max-width: 100%;
          height:100%;
          object-fit:contain;
        `}
      }
    `,Sa=({pageHeight:e,pageWidth:t})=>({columnHeight:e,columnWidth:t}),Dn=(e,t)=>{e.style.width=`${t.width}px`,e.style.height=`${t.height}px`},xa=({minPageSpread:e,blankPagePosition:t,spreadPosition:n,pageHeight:i,pageWidth:r,frameElement:o,isRTL:s,enableTouch:a})=>{const u=e*r;if(o!=null&&o.contentDocument&&o!=null&&o.contentWindow){const{viewportDimensions:l,computedScale:c=1}=Yi({frameElement:o,pageHeight:i,pageWidth:r})??{},d=r,p=i,f=Ia({...Sa({pageHeight:i,pageWidth:r}),enableTouch:a,spreadPosition:n},l);if(ce(o,"prose-reader-css",f),l?Dn(o,{width:l.width??1,height:l.height??1}):Dn(o,{width:d,height:p}),l){o==null||o.style.setProperty("position","absolute"),o==null||o.style.setProperty("top","50%"),n==="left"?(o==null||o.style.setProperty("right","0"),o==null||o.style.removeProperty("left")):t==="before"&&s?(o==null||o.style.setProperty("right","50%"),o==null||o.style.removeProperty("left")):n==="right"?(o==null||o.style.setProperty("left","0"),o==null||o.style.removeProperty("right")):(o==null||o.style.setProperty("left",t==="before"?s?"25%":"75%":t==="after"?s?"75%":"25%":"50%"),o==null||o.style.removeProperty("right"));const h=n!=="none"?"0":"-50%",g=n==="right"&&t!=="before"?"left":n==="left"||t==="before"&&s?"right":"center";o==null||o.style.setProperty("transform",`translate(${h}, -50%) scale(${c})`),o==null||o.style.setProperty("transform-origin",`${g} center`)}else t==="before"?s?o==null||o.style.setProperty("margin-right",`${r}px`):o==null||o.style.setProperty("margin-left",`${r}px`):(o==null||o.style.removeProperty("margin-left"),o==null||o.style.removeProperty("margin-right"));return{width:u,height:p}}return{width:u,height:i}},Pa=()=>`
      ${qi()}
      html {
        width: 100%;
        height: 100%;
      }
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      
      html, body {
        touch-action: none;
      }
    `,$a=({isScrollable:e,enableTouch:t})=>`
      
      html, body {
        width: 100%;
        margin: 0;
        padding: 0;
        ${t?`
          touch-action: none
        `:""}
      }
      ${e?`
        img {
          height: auto !important;
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          
          width: 100%;
          
          display: block;
        }
      `:""}
    `,Ea=({width:e,columnHeight:t,columnWidth:n})=>`
      parsererror {
        display: none !important;
      }
      
      html, body {
        margin: 0;
        padding: 0 !important;
        -max-width: ${n}px !important;
      }
      
      body {
        padding: 0 !important;
        width: ${e}px !important;
        height: ${t}px !important;
        overflow-y: hidden;
        column-gap: 0px !important;
        column-width: ${n}px !important;
        column-fill: auto !important;
        word-wrap: break-word;
        box-sizing: border-box;
      }
      body {
        margin: 0;
      }
      body:focus-visible {
        
        outline: none;
      }
      
      html, body {
        touch-action: none;
      }
      
      * {
        -max-width: ${n}px !important;
      }
      
      img, video, audio, object, svg {
        max-width: 100%;
        -max-width: ${n}px !important;
        -max-height: ${t}px !important;
        -pointer-events: none;
        -webkit-column-break-inside: avoid;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      figure {
        d-max-width: ${n}px !important;
      }
      img {
        object-fit: contain;
        break-inside: avoid;
        box-sizing: border-box;
        d-max-width: ${n}px !important;
      }
      
      table {
        max-width: ${n}px !important;
        table-layout: fixed;
      }
      td {
        max-width: ${n}px;
      }
    `,La=({isUsingVerticalWriting:e,minimumWidth:t,pageHeight:n,pageWidth:i})=>{let r=i-0;const o=n-0*2;let s=i-0*2;return e&&(s=t-0*2,r=o),{columnHeight:o,columnWidth:r,width:s}},Ye=(e,t)=>{e.style.width=`${t.width}px`,e.style.height=`${t.height}px`},Ta=({pageHeight:e,pageWidth:t,frameElement:n,manifest:i,latestContentHeightWhenLoaded:r,minPageSpread:o,isRTL:s,blankPagePosition:a,isImageType:u,enableTouch:l,isUsingVerticalWriting:c})=>{const d=o*t;let p=r;const f=(i==null?void 0:i.renditionLayout)==="reflowable"&&(i==null?void 0:i.renditionFlow)==="scrolled-continuous",h=f?Math.min(400,e):e;n==null||n.style.setProperty("width",`${t}px`),f||n==null||n.style.setProperty("height",`${h}px`);const{viewportDimensions:g,computedScale:v=1}=Yi({frameElement:n,pageHeight:h,pageWidth:t})??{},m=(i==null?void 0:i.renditionLayout)==="pre-paginated";if(n!=null&&n.contentDocument&&n!=null&&n.contentWindow){let y=t,w=h;if(g!=null&&g.hasViewport)ce(n,"prose-reader-html-renderer-framce-css",Pa()),Ye(n,{width:g.width??1,height:g.height??1}),n==null||n.style.setProperty("position","absolute"),n==null||n.style.setProperty("top","50%"),n==null||n.style.setProperty("left",a==="before"?s?"25%":"75%":a==="after"?s?"75%":"25%":"50%"),n==null||n.style.setProperty("transform",`translate(-50%, -50%) scale(${v})`),n==null||n.style.setProperty("transform-origin","center center");else{const S=u?$a({isScrollable:(i==null?void 0:i.renditionFlow)==="scrolled-continuous",enableTouch:l}):Ea(La({isUsingVerticalWriting:c,minimumWidth:d,pageHeight:h,pageWidth:t}));if(ce(n,"prose-reader-css",S,!0),c)w=Math.ceil(n.contentDocument.documentElement.scrollHeight/h)*h,Ye(n,{width:d,height:w});else if((i==null?void 0:i.renditionFlow)==="scrolled-continuous")w=n.contentDocument.body.scrollHeight,p=w,Ye(n,{width:d,height:w});else{const $=Math.ceil(n.contentDocument.documentElement.scrollWidth/t);m?y=t:y=$*t,Ye(n,{width:y,height:w})}}return y%d===0?n==null||n.style.setProperty("margin-left","0px"):(y=y+t,s&&!c&&(n==null||n.style.setProperty("margin-left",`${t}px`))),{width:y,height:w}}return{width:d,height:p||h,latestContentHeightWhenLoaded:p}};class Ma extends un{constructor(){super(...arguments),this.isImageType=()=>{const t=this.item.mediaType??lt(this.item.href);return!!(t!=null&&t.startsWith("image/"))}}onCreateDocument(){const t=wa();return this.setDocumentContainer(t),P(t)}onLoadDocument(){const t=this.getFrameElement();if(!t)throw new Error("invalid frame");return P(t).pipe(ba({item:this.item,resourcesHandler:this.resourcesHandler,settings:this.settings}),ct(this.context.bridgeEvent.viewportFree$),x(()=>{this.attach()}),ks,ha({context:this.context,item:this.item,settings:this.settings}),Vs)}onUnload(){return ga(this.getFrameElement()),this.detach(),ie}onLayout({minPageSpread:t,blankPagePosition:n,spreadPosition:i}){var r,o;const{width:s,height:a}=this.context.getPageSize(),u=this.getFrameElement();if(!u)return P(void 0);const l=!!((r=this.writingMode)!=null&&r.startsWith("vertical"));if(this.item.renditionLayout==="pre-paginated"||!this.item.renditionLayout&&((o=this.context.manifest)==null?void 0:o.renditionLayout)==="pre-paginated"){const p=xa({blankPagePosition:n,enableTouch:this.settings.values.computedPageTurnMode!=="scrollable",frameElement:u,isRTL:this.context.isRTL(),minPageSpread:t,pageHeight:a,pageWidth:s,spreadPosition:i});return P(p)}const{latestContentHeightWhenLoaded:c,...d}=Ta({pageHeight:a,pageWidth:s,frameElement:u,manifest:this.context.manifest,blankPagePosition:n,isUsingVerticalWriting:l,isRTL:this.context.isRTL(),latestContentHeightWhenLoaded:this.latestContentHeightWhenLoaded,minPageSpread:t,isImageType:this.isImageType(),enableTouch:this.settings.values.computedPageTurnMode!=="scrollable"});return this.latestContentHeightWhenLoaded=c,P(d)}onRenderHeadless(){return N(this.resourcesHandler.fetchResource()).pipe(I(t=>{if(t instanceof Response){const n=t.headers.get("content-type")??"";if(["application/xhtml+xml","application/xml","text/html","text/xml"].includes(n))return N(t.text()).pipe(b(i=>new DOMParser().parseFromString(i,n)))}return P(void 0)}))}getFrameElement(){const t=this.documentContainer;if(t instanceof HTMLIFrameElement)return t}getComputedStyleAfterLoad(){var t,n;const i=this.getFrameElement(),r=(t=i==null?void 0:i.contentDocument)==null?void 0:t.body;if(r)return(n=i==null?void 0:i.contentWindow)==null?void 0:n.getComputedStyle(r)}get writingMode(){var t;return(t=this.getComputedStyleAfterLoad())==null?void 0:t.writingMode}get readingDirection(){var t;if(this.writingMode==="vertical-rl")return"rtl";switch((t=this.getComputedStyleAfterLoad())==null?void 0:t.direction){case"ltr":case"inherit":case"initial":return"ltr";case"rtl":return"rtl";default:return}}getDocumentFrame(){return this.getFrameElement()}}const Oa=e=>t=>{const n=e({...t,getRenderer(r){var o;return((o=t.getRenderer)==null?void 0:o.call(t,r))??(s=>new Ma(s))}}),i=ca(n);return i.pipe(L(n.$.destroy$)).subscribe(),{...n,links$:i}};function ge(e){return e!=null}let Aa=class extends zi{computeOutputSettings(e){return e}hasSettingsChanged(e){return!H(this.outputSettings,e)}getCleanedParentInputSettings(e){const{layoutAutoResize:t,pageHorizontalMargin:n,pageVerticalMargin:i,layoutLayerTransition:r,viewportMode:o,...s}=e;return s}getDefaultSettings(){return{layoutAutoResize:"container",pageHorizontalMargin:24,pageVerticalMargin:24,layoutLayerTransition:!0,viewportMode:"normal"}}};const _a=e=>{let t;const n=e.context.state$.pipe(I(({containerElement:a})=>a?new R(()=>(t=a.ownerDocument.createElement("div"),t.style.cssText=`
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: hidden;
      `,a.appendChild(t),()=>{t==null||t.remove(),t=void 0})):xe)),i=a=>$i(a,fe).pipe(x(()=>{t==null||t.style.setProperty("visibility","hidden")})),r=e.context.bridgeEvent.viewportBusy$.pipe(x(()=>{t==null||t.style.setProperty("visibility","visible")})),o=i(e.viewportFree$).pipe(Ve(1)),s=e.settings.values$.pipe(b(()=>e.settings.values.computedPageTurnMode),O()).pipe(I(a=>a==="controlled"?r.pipe(I(()=>o)):i(P(void 0))),L(e.$.destroy$));return E(n,s)},Ra=e=>{e.hookManager.register("item.onAfterLayout",({item:t,blankPagePosition:n,minimumWidth:i})=>{const r=e.spineItemsManager.get(t.id),o=r==null?void 0:r.renderer.getDocumentFrame();if((r==null?void 0:r.renditionLayout)!=="reflowable"||!(o instanceof HTMLIFrameElement))return;const{hasViewport:s}=on(o),{width:a}=e.context.getPageSize(),u=r==null?void 0:r.renderer.getDocumentFrame();if(s){const l=a<i;n==="none"&&l&&u instanceof HTMLIFrameElement&&(u==null||u.style.setProperty("left",e.context.isRTL()?"75%":"25%"))}})};class Gi{constructor(t){this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y}}class _t extends Gi{constructor(){super(...arguments),this.__symbol="SpineItemSpineLayout"}}class Fa extends Gi{constructor(){super(...arguments),this.__symbol="SpineItemPageSpineLayout"}}class _{constructor(t){this.__symbol="SpinePosition",this.x=t.x,this.y=t.y}}class cn{constructor(t){this.__symbol="UnsafeSpinePosition",this.x=t.x,this.y=t.y}static from(t){return new cn(t)}}const ja=({position:e,pageSize:t})=>new Fa({x:e.x,y:e.y,left:e.x,top:e.y,width:t.width,height:t.height,bottom:e.y+t.height,right:e.x+t.width}),Ca=e=>{const t=e.spine.spineLayout.layout$.pipe(b(()=>({pages:e.spine.spineItemsManager.items.reduce((i,r,o)=>{const s=new Array(r.numberOfPages).fill(void 0).map((a,u)=>{const l=e.spine.spineItemLocator.getSpineItemPositionFromPageIndex({spineItem:r,pageIndex:u}),c=e.spine.locator.getSpinePositionFromSpineItemPosition({spineItem:r,spineItemPosition:l});return ja({pageSize:e.context.getPageSize(),position:c})}).map((a,u)=>({itemIndex:o,absolutePageIndex:o+u,absolutePosition:a}));return[...i,...s]},[])})),x(i=>{q.debug("layout:info",i)}),U()),n=t.pipe(Q({refCount:!0,bufferSize:1}));return n.pipe(L(e.$.destroy$)).subscribe(),{layout$:t,info$:n}},Da=(e,t)=>t.pipe(x(n=>{e.viewport.value.element.style.transition="transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)",e.settings.values.computedPageTurnMode==="scrollable"?e.viewport.value.element.style.transformOrigin="top":e.viewport.value.element.style.transformOrigin="center",n==="thumbnails"?e.viewport.value.element.style.transform="scale(0.5)":e.viewport.value.element.style.transform="scale(1)",e.layout()})),Na=e=>t=>{const{pageHorizontalMargin:n,pageVerticalMargin:i,layoutAutoResize:r,layoutLayerTransition:o}=t,s=e(t),a=new Aa({pageHorizontalMargin:n,pageVerticalMargin:i,layoutAutoResize:r,layoutLayerTransition:o},s.settings);s.hookManager.register("onViewportOffsetAdjust",()=>{let v=!1;s.spineItemsManager.items.forEach(m=>{const y=m.renderer.getDocumentFrame();!v&&y&&(y.getBoundingClientRect().left,v=!0)})}),s.hookManager.register("item.onBeforeLayout",({item:v})=>{const m=s.spineItemsManager.get(v.id),y=v.mediaType??lt(v.href),w=!!(y!=null&&y.startsWith("image/")),{pageHorizontalMargin:S=0,pageVerticalMargin:$=0}=a.values,T=s.context.getPageSize();if((m==null?void 0:m.renditionLayout)==="reflowable"&&!w){let W=T.width-S*2;const F=T.height-$*2;let D=T.width-S*2,X=S*2;m.isUsingVerticalWriting()&&(D=T.width-S*2,W=F,X=$*2);const te=m==null?void 0:m.renderer.getDocumentFrame();te&&ce(te,"prose-layout-enhancer-css",`
              body {
                width: ${D}px !important;
                margin: ${$}px ${S}px !important;
                column-gap: ${X}px !important;
                column-width: ${W}px !important;
                height: ${F}px !important;
              }
              img, video, audio, object, svg {
                -max-width: ${W}px !important;
                -max-height: ${F}px !important;
              }
              table {
                max-width: ${W}px !important;
              }
              td {
                max-width: ${W}px;
              }
            `)}}),Ra(s),s.hookManager.register("item.onDocumentCreated",({documentContainer:v})=>{v.style.opacity="0",a.values.layoutLayerTransition&&(v.style.transition="opacity 300ms")}),s.hookManager.register("item.onBeforeLayout",({item:v})=>{const m=s.spineItemsManager.get(v.id),y=m==null?void 0:m.renderer.documentContainer;s.settings.values.computedPageTurnMode!=="scrollable"&&(y==null||y.setAttribute("tab-index","0"))});const u=s.spineItemsObserver.itemIsReady$.pipe(M(({isReady:v})=>v),x(({item:v})=>{const m=v.renderer.documentContainer;m&&(m.style.opacity="1")})),l=v=>new R(m=>{const y=new ResizeObserver(()=>{m.next()});return y.observe(v),()=>{y.disconnect()}}),c=a.values$.pipe(M(({layoutAutoResize:v})=>v==="container"),I(()=>s.context.containerElement$),M(ge),I(v=>l(v)),Ee(100),x(()=>{s==null||s.layout()})),d=_a(s);a.watch(["pageHorizontalMargin","pageVerticalMargin"]).pipe(tn(1),x(()=>{s.layout()}),L(s.$.destroy$)).subscribe();const p=s.spineItemsObserver.itemIsReady$.pipe(x(({item:v,isReady:m})=>{const y="prose-spineItem-ready";m?v.containerElement.classList.add(y):v.containerElement.classList.remove(y)})),{layout$:f,info$:h}=Ca(s),g=Da(s,a.watch("viewportMode"));return E(p,u,d,c,g).pipe(L(s.$.destroy$)).subscribe(),{...s,destroy:()=>{a.destroy(),s.destroy()},settings:a,layout$:f,layoutInfo$:h}},Wa=`${Le}-enhancer-loading`,Xi=`${Wa}-container`,ka=(e,t)=>{const n=e.ownerDocument.createElement("div");return n.classList.add(Xi),n.style.cssText=`
      height: 100%;
      width: 100%;
      max-width: ${t.state.visibleAreaRect.width}px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      position: absolute;
      left: 0;
      top: 0;
      color: rgb(202, 202, 202);
      background-color: white;
      z-index: 1;
    `,n},Va=({container:e,item:t})=>{const n=e.ownerDocument.createElement("div");n.innerText="prose",n.style.cssText=`
      font-size: 4em;
    `;const i=e.ownerDocument.createElement("div");return i.innerText=`loading ${t.id}`,i.style.cssText=`
      font-size: 1.2em;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      max-width: 300px;
      width: 80%;
    `,e.appendChild(n),e.appendChild(i),e},za=e=>t=>{const{loadingElementCreate:n=Va}=t,i=e(t),r=u=>P(u.reduce((l,{item:c,element:d})=>{d.style.zIndex="0";const p=d.querySelector(`.${Xi}`);if(p instanceof HTMLElement)return l[c.id]=p,l;const f=n({container:ka(d,i.context),item:c});return d.appendChild(f),l[c.id]=f,l},{})),o=u=>K([i.spine.spineLayout.layout$,i.theme.$.theme$]).pipe(b(([,l])=>({width:i.context.state.visibleAreaRect.width,theme:l})),O(H),x(({width:l,theme:c})=>{Object.values(u).forEach(d=>{d.style.setProperty("max-width",`${l}px`),d.style.setProperty("color",c==="sepia"?"#939393":"rgb(202, 202, 202)")})})),s=u=>i.spineItemsObserver.itemIsReady$.pipe(x(({item:l,isReady:c})=>{var d,p;(d=u[l.item.id])==null||d.style.setProperty("visibility",c?"hidden":"visible"),(p=u[l.item.id])==null||p.style.setProperty("z-index",c?"0":"1")})),a=i.spineItemsManager.items$.pipe(I(u=>r(u)),Q(1),L(i.context.destroy$));return a.pipe(I(u=>E(o(u),s(u))),L(i.$.destroy$)).subscribe(),{...i,loading:{$:{items$:a}}}};class Ua extends un{getImageElement(){const t=this.documentContainer;if(t instanceof HTMLImageElement)return t}onCreateDocument(){const t=this.containerElement.ownerDocument.createElement("img");return N(this.resourcesHandler.getResource()).pipe(I(n=>{if(this.setDocumentContainer(t),t.style.objectFit="contain",t.style.userSelect="none",n instanceof URL)return P(n.href);if(n instanceof Response)return N(n.blob()).pipe(b(i=>URL.createObjectURL(i)));throw new Error("Invalid resource")}),b(n=>{const i=this.getImageElement();return i&&(i.src=n),t}))}onLoadDocument(){const t=this.getImageElement();if(!t)throw new Error("invalid element");return this.attach(),J(t,"load")}onUnload(){const t=this.getImageElement();return t&&URL.revokeObjectURL(t.src),this.detach(),ie}onLayout({spreadPosition:t}){const n=this.getImageElement(),{height:i,width:r}=this.context.getPageSize();let o=i;const s=r;if(!n)return P(void 0);const a=n.naturalWidth||1,u=n.naturalHeight||1,l=a/u;return this.settings.values.computedPageTurnDirection==="vertical"&&this.settings.values.computedPageTurnMode==="scrollable"&&!this.context.state.isUsingSpreadMode&&(o=Math.ceil(r/l)),n.style.height=`${o}px`,n.style.width=`${s}px`,n.style.objectPosition=t==="left"?"right":t==="right"?"left":"center",P({width:s,height:o})}onRenderHeadless(){return ie}getDocumentFrame(){}}const Ha=e=>t=>{const n=e({...t,getRenderer(o){var s;const a=(s=t.getRenderer)==null?void 0:s.call(t,o),u=o.mediaType??lt(o.href),l=!!(u!=null&&u.startsWith("image/"));return!a&&l?c=>new Ua(c):a}}),i=new IntersectionObserver(o=>{o.forEach(s=>{var a;const u=s.target,l=Array.from(((a=u.contentDocument)==null?void 0:a.body.getElementsByTagName("audio"))||[]);s.isIntersecting?l.forEach(c=>{c.hasAttribute("autoplay")&&c.paused&&c.readyState>=2&&c.play().catch(console.error)}):l.forEach(c=>{c.pause(),c.currentTime=0})})},{threshold:.01}),r=new IntersectionObserver(o=>{o.forEach(s=>{if(s.target.tagName==="video"){const a=s.target;s.isIntersecting?a.hasAttribute("autoplay")&&a.paused&&a.readyState>=2&&a.play().catch(console.error):(a.pause(),a.currentTime=0)}})},{threshold:.5});return n.hookManager.register("item.onDocumentLoad",({destroy:o,itemId:s})=>{var a,u;const l=(a=n.spineItemsManager.get(s))==null?void 0:a.renderer.getDocumentFrame();if(!l)return;i.observe(l);const c=(u=l.contentDocument)==null?void 0:u.body.getElementsByTagName("video"),d=Array.from(c||[]).map(p=>(r.observe(p),()=>r.unobserve(p)));o(()=>{i.unobserve(l),d.forEach(p=>p())})}),{...n,destroy:()=>{i.disconnect(),r.disconnect(),n.destroy()}}},Ba=(e,t)=>e.links$.pipe(x(n=>{var i;if(!ea(n.target,"a")||n.type!=="click")return;const r=new URL(n.target.href),o=`${r.origin}${r.pathname}`;(i=e.context.manifest)!=null&&i.spineItems.some(s=>s.href===o)&&t.goToUrl(r)})),pe=q.namespace("navigation");class k{constructor(t){this.__symbol=Symbol("SpineItemPosition"),this.x=t.x,this.y=t.y}}const qa=({position:e,spineItem:t,pageHeight:n,pageWidth:i,spineItemLocator:r})=>{let o=new k({x:e.x-i,y:e.y});return t.isUsingVerticalWriting()&&(o=new k({x:e.x,y:e.y+n})),r.getSpineItemClosestPositionFromUnsafePosition(o,t)},Nn=({position:e,navigationResolver:t,computedPageTurnDirection:n,spineItemsManager:i,spineLocator:r,context:o})=>{const s=n,a=r.getSpineItemFromPosition(e)||i.get(0),u=e;if(!a)return u;const l=r.getSpineItemPositionFromSpinePosition(e,a),c=qa({position:l,spineItem:a,pageHeight:o.getPageSize().height,pageWidth:o.getPageSize().width,spineItemLocator:r.spineItemLocator});return t.arePositionsDifferent(c,l)?r.getSpinePositionFromSpineItemPosition({spineItemPosition:c,spineItem:a}):t.getAdjustedPositionWithSafeEdge(s==="horizontal"?new _({x:e.x-o.getPageSize().width,y:0}):new _({y:e.y-o.getPageSize().height,x:0}))},Ya=({position:e,spineItem:t,context:n,navigationResolver:i,spineItemsManager:r,spineLocator:o,computedPageTurnDirection:s})=>{const a=Nn({position:e,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:r,spineLocator:o});if(t!=null&&t.isUsingVerticalWriting()&&e.x===a.x)return i.getAdjustedPositionForSpread(a);if(n.state.isUsingSpreadMode){if(t!=null&&t.isUsingVerticalWriting()&&e.x!==a.x)return i.getAdjustedPositionForSpread(i.getAdjustedPositionWithSafeEdge(n.isRTL()?{...a,x:a.x+n.getPageSize().width}:{...a,x:a.x-n.getPageSize().width}));if(s==="vertical"&&e.y!==a.y)return i.getAdjustedPositionForSpread(a);const u=Nn({position:a,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:r,spineLocator:o});return i.getAdjustedPositionForSpread(u)}return i.getAdjustedPositionForSpread(a)},Ga=({position:e,spineItem:t,pageHeight:n,pageWidth:i,spineItemLocator:r})=>{let o=new k({x:e.x+i,y:e.y});return t.isUsingVerticalWriting()&&(o=new k({x:e.x,y:e.y-n})),r.getSpineItemClosestPositionFromUnsafePosition(o,t)},Wn=({position:e,navigationResolver:t,computedPageTurnDirection:n,spineItemsManager:i,spineLocator:r,context:o})=>{const s=n,a=r.getSpineItemFromPosition(e)||i.get(0),u=e;if(!a)return u;const l=r.getSpineItemPositionFromSpinePosition(e,a),c=Ga({position:l,spineItem:a,pageHeight:o.getPageSize().height,pageWidth:o.getPageSize().width,spineItemLocator:r.spineItemLocator});return t.arePositionsDifferent(c,l)?r.getSpinePositionFromSpineItemPosition({spineItemPosition:c,spineItem:a}):t.getAdjustedPositionWithSafeEdge(s==="horizontal"?new _({x:e.x+o.getPageSize().width,y:0}):new _({y:e.y+o.getPageSize().height,x:0}))},Xa=({position:e,spineItem:t,context:n,navigationResolver:i,spineItemsManager:r,spineLocator:o,computedPageTurnDirection:s})=>{const a=Wn({position:e,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:r,spineLocator:o});if(t!=null&&t.isUsingVerticalWriting()&&e.x===a.x)return i.getAdjustedPositionForSpread(a);if(n.state.isUsingSpreadMode){if(t!=null&&t.isUsingVerticalWriting()&&e.x!==a.x)return i.getAdjustedPositionForSpread(i.getAdjustedPositionWithSafeEdge(n.isRTL()?{...a,x:a.x-n.getPageSize().width}:{...a,x:a.x+n.getPageSize().width}));if(s==="vertical"&&e.y!==a.y)return i.getAdjustedPositionForSpread(a);const u=Wn({position:a,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:r,spineLocator:o});return i.getAdjustedPositionForSpread(u)}return i.getAdjustedPositionForSpread(a)};class Za{constructor(t){this.reader=t,this.movingLastDelta={x:0,y:0},this.movingLastPosition=new _({x:0,y:0}),this.unlock=void 0}turnRight(){return this.turnRightOrBottom()}turnLeft(){return this.turnLeftOrTop()}turnTop(){return this.turnLeftOrTop()}turnBottom(){return this.turnRightOrBottom()}turnRightOrBottom(){const t=this.reader.navigation.getNavigation(),n=this.reader.spineItemsManager.get(t.spineItem);if(!n)return;const i=Xa({context:this.reader.context,navigationResolver:this.reader.navigation.navigationResolver,position:t.position,computedPageTurnDirection:this.reader.settings.values.computedPageTurnDirection,spineItem:n,spineItemsManager:this.reader.spineItemsManager,spineLocator:this.reader.spine.locator});return this.reader.navigation.navigate({position:i})}turnLeftOrTop(){const t=this.reader.navigation.getNavigation(),n=this.reader.spineItemsManager.get(t.spineItem);if(!n)return;const i=Ya({context:this.reader.context,navigationResolver:this.reader.navigation.navigationResolver,position:t.position,computedPageTurnDirection:this.reader.settings.values.computedPageTurnDirection,spineItem:n,spineItemsManager:this.reader.spineItemsManager,spineLocator:this.reader.spine.locator});return this.reader.navigation.navigate({position:i})}goToCfi(t,n={animate:!0}){return this.reader.navigation.navigate({animation:n.animate?"turn":!1,cfi:t})}goToSpineItem({indexOrId:t,...n}){const i=this.reader.spineItemsManager.get(t);if(i===void 0){pe.warn("goToSpineItem",`Ignore navigation to ${t} since the item does not exist`);return}this.reader.navigation.navigate({spineItem:i.index,...n})}goToNextSpineItem(){const{endIndex:t=0}=this.reader.spine.locator.getVisibleSpineItemsFromPosition({position:this.reader.navigation.getNavigation().position,threshold:.5})||{};this.goToSpineItem({indexOrId:t+1})}goToPreviousSpineItem(){const{beginIndex:t=0}=this.reader.spine.locator.getVisibleSpineItemsFromPosition({position:this.reader.navigation.getNavigation().position,threshold:.5})??{};this.goToSpineItem({indexOrId:t-1})}goToUrl(t){this.reader.navigation.navigate({url:t,animation:!1})}goToRightSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="vertical"){pe.warn("You cannot call this navigation method on vertical direction");return}return this.reader.context.isRTL()?this.goToPreviousSpineItem():this.goToNextSpineItem()}goToRightOrBottomSpineItem(){return this.reader.settings.values.computedPageTurnDirection==="vertical"?this.goToBottomSpineItem():this.goToRightSpineItem()}goToLeftOrTopSpineItem(){return this.reader.settings.values.computedPageTurnDirection==="vertical"?this.goToTopSpineItem():this.goToLeftSpineItem()}goToLeftSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="vertical"){pe.warn("You cannot call this navigation method on vertical direction");return}return this.reader.context.isRTL()?this.goToNextSpineItem():this.goToPreviousSpineItem()}goToTopSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="horizontal"){pe.warn("You cannot call this navigation method on horizontal direction");return}return this.goToPreviousSpineItem()}goToBottomSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="horizontal"){pe.warn("You cannot call this navigation method on horizontal direction");return}return this.goToNextSpineItem()}goToPageOfSpineItem({pageIndex:t,spineItemId:n,...i}){const r=this.reader.navigation.navigationResolver.getNavigationForSpineItemPage({pageIndex:t,spineItemId:n});pe.debug(".goToPageOfSpineItem()",{pageIndex:t,spineItemId:n,...i,position:r}),this.reader.navigation.navigate({position:r,...i})}goToAbsolutePageIndex({absolutePageIndex:t,...n}){const i=this.reader.spine.locator.getSpineInfoFromAbsolutePageIndex({absolutePageIndex:t});if(pe.debug(".goToAbsolutePageIndex()",{absolutePageIndex:t,...n,foundInfo:i}),i){const r=this.reader.navigation.navigationResolver.getNavigationForSpineItemPage({pageIndex:i.pageIndex,spineItemId:i.itemIndex});return this.reader.navigation.navigate({position:r,...n})}}}class Ja{constructor(t){this.reader=t,this.lastDelta={x:0,y:0},this.lastPosition=new _({x:0,y:0}),this.lastStartPosition=new _({x:0,y:0}),this.unlock=void 0}moveTo(t,{final:n,start:i}={}){var r,o,s,a;if(this.reader.settings.values.computedPageTurnMode==="scrollable"){pe.warn("pan control is not available on free page turn mode");return}const u=this.reader.settings.values.computedPageTurnDirection;i&&((r=this.unlock)==null||r.call(this),this.unlock=this.reader.navigation.lock(),this.lastDelta={x:0,y:0},this.lastStartPosition=this.reader.navigation.controlledNavigationController.viewportPosition,this.lastPosition=this.lastStartPosition);let l=this.reader.navigation.getNavigation().position;if(t){const c=this.reader.viewport.absoluteViewport.width/this.reader.viewport.relativeViewport.width,d=Math.floor(t.x)-(((o=this.lastDelta)==null?void 0:o.x)||0),p=Math.floor(t.y)-(((s=this.lastDelta)==null?void 0:s.y)||0),f=Math.floor(u==="horizontal"?this.lastPosition.x-d/c:0),h=Math.floor(u==="horizontal"?0:this.lastPosition.y-p/c);l=new _({x:f,y:h}),this.lastDelta=t}else l=this.lastPosition;if(this.lastPosition=l,n){this.lastDelta={x:0,y:0},this.reader.navigation.navigate({position:l,animation:!1}),(a=this.unlock)==null||a.call(this);return}this.reader.navigation.navigate({position:l,animation:!1})}}const Ka=e=>e.pagination.state$.pipe(z(e.context.manifest$,e.settings.values$),b(([t,{spineItems:n,readingDirection:i},{computedPageTurnDirection:r}])=>{const o=n.length??0,s=t.beginSpineItemIndex===0,a=t.endSpineItemIndex===Math.max(o-1,0),u=t.endSpineItemIndex===Math.max(o-1,0),l=t.beginSpineItemIndex===0,c=t.beginPageIndexInSpineItem===0,d=t.endPageIndexInSpineItem===t.endNumberOfPagesInSpineItem-1;return{canTurnLeft:r==="vertical"?!1:!c,canTurnRight:r==="vertical"?!1:!d,canGoTopSpineItem:r==="vertical"&&!s,canGoBottomSpineItem:r==="vertical"&&!a,canGoLeftSpineItem:r!=="vertical"&&(i==="ltr"&&!s||i==="rtl"&&!u),canGoRightSpineItem:r!=="vertical"&&(i==="ltr"&&!a||i==="rtl"&&!l)}}),O(H)),Qa=({reader:e,duration:t})=>n=>{let i;const r=()=>{i==null||i(),i=void 0};return n.pipe(x(()=>{i||(i=e==null?void 0:e.navigation.lock())}),ps(t,fe,{trailing:!0,leading:!0}),x(r),ve(r))},eu=e=>t=>{const n=e(t),i=Ka(n),r=new Za(n),o=new Ja(n),s=a=>{const{cfi:u,...l}=a;n.load(l),u&&r.goToCfi(u,{animate:!1})};return Ba(n,r).pipe(L(n.$.destroy$)).subscribe(),{...n,load:s,navigation:{...n.navigation,state$:i,throttleLock:({duration:a,trigger:u})=>u.pipe(Qa({duration:a,reader:n})),moveTo:o.moveTo.bind(o),turnBottom:r.turnBottom.bind(r),turnTop:r.turnTop.bind(r),turnLeftOrTop:r.turnLeftOrTop.bind(r),turnRightOrBottom:r.turnRightOrBottom.bind(r),turnLeft:r.turnLeft.bind(r),turnRight:r.turnRight.bind(r),goToCfi:r.goToCfi.bind(r),goToUrl:r.goToUrl.bind(r),goToSpineItem:r.goToSpineItem.bind(r),goToNextSpineItem:r.goToNextSpineItem.bind(r),goToPreviousSpineItem:r.goToPreviousSpineItem.bind(r),goToLeftOrTopSpineItem:r.goToLeftOrTopSpineItem.bind(r),goToRightOrBottomSpineItem:r.goToRightOrBottomSpineItem.bind(r),goToTopSpineItem:r.goToTopSpineItem.bind(r),goToBottomSpineItem:r.goToBottomSpineItem.bind(r),goToLeftSpineItem:r.goToLeftSpineItem.bind(r),goToRightSpineItem:r.goToRightSpineItem.bind(r),goToPageOfSpineItem:r.goToPageOfSpineItem.bind(r),goToAbsolutePageIndex:r.goToAbsolutePageIndex.bind(r)}}},Ce=e=>ji({spineIndex:e.index,spineId:e.id}),De=(e,t,n)=>{var i;return!e.ownerDocument||!((i=e.ownerDocument)!=null&&i.documentElement)||e===e.ownerDocument?Ce(n):ji({node:e,offset:t,spineIndex:n.index,spineId:n.id})},Rt=({pageIndex:e,spineItem:t,spineItemLocator:n})=>{var i;const r=n.getFirstNodeOrRangeAtPage(e,t),o=t.renderer.getDocumentFrame();return r&&o instanceof HTMLIFrameElement&&(i=o.contentWindow)!=null&&i.document?De(r.node,r.offset,t.item).trim():Ce(t.item)},tu=(e,t)=>{const n=De(e.startContainer,e.startOffset,t),i=De(e.endContainer,e.endOffset,t);return{start:n,end:i}},nu=({item:e,selection:t})=>{const n=t.anchorNode?De(t.anchorNode,t.anchorOffset,e):void 0,i=t.focusNode?De(t.focusNode,t.focusOffset,e):void 0;return{anchorCfi:n,focusCfi:i}},kn=e=>{var t;return((t=e[0])==null?void 0:t.index)===6&&e.length>1},Ft=e=>{const t=rn(e);return Mi(t)},iu=e=>Array.isArray(e)?e[0]&&kn(e[0])?e[0]:void 0:e.parent[0]&&kn(e.parent[0])?e.parent[0]:void 0,dn=e=>{var t,n,i,r;const o=rn(e),s=(iu(o)??[])[1],a=((s==null?void 0:s.index)??2)/2-1,u=nn(o)?(n=(t=o.end.at(-1))==null?void 0:t.at(-1))==null?void 0:n.offset:(r=(i=o.at(-1))==null?void 0:i.at(-1))==null?void 0:r.offset;return{cleanedCfi:e,itemIndex:a,offset:u??0}},Zi=({cfi:e,spineItemsManager:t})=>{var n,i;if(!e)return;const{itemIndex:r}=dn(e),o=t.get(r);if(!o)return;const s=o.renderer.getDocumentFrame();if(s instanceof HTMLIFrameElement){console.log("FIII",e);const a=(n=s.contentWindow)==null?void 0:n.document;if(a)try{const u=Os(e,a,{throwOnError:!0});return{node:u.isRange?(i=u.node)==null?void 0:i.startContainer:u.node,offset:Array.isArray(u.offset)?u.offset.at(-1):u.offset,spineItem:o}}catch(u){return q.error(u),{spineItem:o}}}return{spineItem:o}},ru=(e,t)=>{if("cfi"in t)return t;const n=e.spineItemsManager.get(t);if(!n)throw new Error("Spine item not found");return{cfi:Ce(n.item)}},ou=(e,t)=>{let n=e==null?void 0:e.itemPageIndex;const{itemIndex:i}=t.cfi.parseCfi(e.cfi),r=t.spineItemsManager.get(i);return r?Vi().pipe(z(r.isReady$),b(([,o])=>{var s;let a;const{node:u,offset:l}=t.cfi.resolveCfi({cfi:e.cfi})??{};if(r.renditionLayout!=="pre-paginated"&&u&&(n=t.spine.locator.spineItemLocator.getSpineItemPageIndexFromNode(u,l??0,r)??n),u&&e.endCfi){const{node:d,offset:p}=t.cfi.resolveCfi({cfi:e.cfi})??{};d&&o&&(a=(s=u==null?void 0:u.ownerDocument)==null?void 0:s.createRange(),a==null||a.setStart(u,l??0),a==null||a.setEnd(d,p??0))}let c=e==null?void 0:e.absolutePageIndex;return n===void 0&&(n=0),c=t.spine.locator.getAbsolutePageIndexFromPageIndex({pageIndex:n,spineItemOrId:r})??(e==null?void 0:e.absolutePageIndex),{...e,range:a,itemIndex:i,startNode:u??void 0,startOffset:l,absolutePageIndex:c,itemPageIndex:n}})):P({...e,itemIndex:i})};class su{constructor(t){this.reader=t,this.locate=(n,i)=>{const r={resource:n,meta:ru(this.reader,n)};return jn(()=>{var o;const s=this.reader.spine.spineLayout.layout$.pipe(Ee(10),se(r),cs(d=>ou(d.meta,this.reader).pipe(b(p=>({...d,meta:p}))),r)),a=(o=this.reader.cfi.parseCfi(r.meta.cfi))==null?void 0:o.itemIndex,u=this.reader.spineItemsManager.get(a),l=(u==null?void 0:u.renditionLayout)==="reflowable",c=i.mode==="shallow"||!l||!u?()=>{}:this.reader.spine.spineItemsLoader.forceOpen([u.index]);return s.pipe(ve(()=>{setTimeout(()=>{c()},1e3)}))})}}locateResource(t,n){return Array.isArray(t)?jn(()=>K(t.map(i=>this.locate(i,n??{})))):this.locate(t,n??{})}}const Ji=(e,t,n)=>{const i=n.spineItems.findIndex(r=>r.href===e);return t.reduce((r,o)=>{const s=o.href.indexOf("#"),a=s>0?o.href.substr(0,s):o.href,u=a.substring(0,a.lastIndexOf("/")),l=e.substring(0,e.lastIndexOf("/")),c=e.endsWith(a),d=l!==""&&l.endsWith(u);if(c||d){const p=n.spineItems.findIndex(g=>g.href===o.href);if(i<p)return r;const f={title:o.title,path:o.path},h=Ji(e,o.contents,n);return h?{...f,subChapter:h}:f}return r},void 0)},au=(e,t)=>{var n;const{href:i}=t;return Ji(i,((n=e.nav)==null?void 0:n.toc)??[],e)},uu=e=>{const t=e.context.manifest,n=e.spineItemsManager.items;return t?n.reduce((i,{item:r})=>(i[r.id]=au(t,r),i),{}):{}},lu=e=>e.spineItemsManager.items$.pipe(se([]),b(()=>uu(e))),cu=(e,t,n)=>e+t*n,du=(e,t,n)=>{const i=e.context,{height:r,width:o}=n.layout.layoutInfo,{top:s,left:a}=e.spine.spineLayout.getSpineItemSpineLayoutInfo(n);return e.settings.values.computedPageTurnDirection==="vertical"?Math.max(0,Math.min(1,(t.y-s+i.state.visibleAreaRect.height)/r)):Math.max(0,Math.min(1,(t.x-a+i.state.visibleAreaRect.width)/o))},pu=(e,t,n,i,r)=>r.isReady$.pipe(B(),z(e.layoutInfo$),b(([o,s])=>{var a,u,l,c,d,p,f;const h=e.context,g=((a=h.manifest)==null?void 0:a.renditionLayout)==="pre-paginated",v=((u=h.manifest)==null?void 0:u.spineItems.length)||0,m=((l=h.manifest)==null?void 0:l.spineItems.slice(0,t).reduce((F,D)=>F+(D.progressionWeight??0),0))||0,y=e.spineItemsManager.getSpineItemIndex(r)??0,w=((c=e.context.manifest)==null?void 0:c.spineItems.length)??0,S=s.pages.filter(F=>F.itemIndex===y).length??0,$=((p=(d=h.manifest)==null?void 0:d.spineItems[t])==null?void 0:p.progressionWeight)??(y+1)/w;let T=(n+1)*($/S);!g&&r.renditionLayout==="reflowable"&&!o&&(T=0);let W=m+T;return((f=h.manifest)==null?void 0:f.renditionFlow)==="scrolled-continuous"&&(o?T=du(e,i,r):T=0,W=cu(m,$,T)),t===v-1&&n===S-1&&W>.99?1:W})),fu=e=>e.spine.spineLayout.layout$.pipe(Ee(10,fe),z(e.pagination.state$),b(()=>({numberOfPagesPerItems:e.spineItemsManager.items.reduce((t,n)=>[...t,n.numberOfPages],[]),numberOfTotalPages:e.spine.spineLayout.numberOfPages})),O(H),se({numberOfPagesPerItems:[],numberOfTotalPages:0})),hu=(e,t,n,i)=>{const r=e.context,o=t.beginSpineItemIndex!==void 0?e.spineItemsManager.get(t.beginSpineItemIndex):void 0,s=t.endSpineItemIndex!==void 0?e.spineItemsManager.get(t.endSpineItemIndex):void 0;return P({...t,beginChapterInfo:o?n[o.item.id]:void 0,beginSpineItemReadingDirection:o==null?void 0:o.readingDirection,endChapterInfo:s?n[s.item.id]:void 0,endSpineItemReadingDirection:s==null?void 0:s.readingDirection,percentageEstimateOfBook:i,isUsingSpread:r.state.isUsingSpreadMode??!1})},gu=e=>K([e.pagination.state$,e.layout$]).pipe(I(([t])=>{const n=t.endSpineItemIndex!==void 0?e.spineItemsManager.get(t.endSpineItemIndex):void 0;return n?pu(e,t.endSpineItemIndex??0,t.endPageIndexInSpineItem||0,e.navigation.getNavigation().position,n):P(0)})),mu=e=>{const t=lu(e),n=fu(e),i=new Y({...e.pagination.state,beginChapterInfo:void 0,beginCfi:void 0,beginPageIndexInSpineItem:void 0,isUsingSpread:!1,beginAbsolutePageIndex:0,endAbsolutePageIndex:0,numberOfTotalPages:0,beginSpineItemReadingDirection:void 0,beginSpineItemIndex:void 0,endCfi:void 0,endChapterInfo:void 0,endSpineItemReadingDirection:void 0,percentageEstimateOfBook:0}),r=K([e.pagination.state$,t,gu(e)]).pipe(I(([o,s,a])=>hu(e,o,s,a).pipe(b(u=>({...o,...u})))),O(H));return{paginationInfo$:K([r,n]).pipe(b(([o,s])=>({...o,...s,beginAbsolutePageIndex:s.numberOfPagesPerItems.slice(0,o.beginSpineItemIndex).reduce((a,u)=>a+u,o.beginPageIndexInSpineItem??0),endAbsolutePageIndex:s.numberOfPagesPerItems.slice(0,o.endSpineItemIndex).reduce((a,u)=>a+u,o.endPageIndexInSpineItem??0)})),x(o=>{i.next(o)}),Q(1)),getPaginationInfo:()=>i.value}},vu=e=>t=>{const n=e(t),{paginationInfo$:i,getPaginationInfo:r}=mu(n);i.pipe(L(n.$.destroy$)).subscribe();const o=new su(n);return{...n,locateResource:o.locateResource.bind(o),pagination:{...n.pagination,get state(){return r()},get state$(){return i}}}},yu=e=>({put:(t,n)=>new Promise((i,r)=>{const o=e.transaction(["store"],"readwrite");o.onerror=a=>{r(a)},o.oncomplete=()=>{i()};const s=o.objectStore("store").put(n,t);s.onsuccess=()=>{i()},s.onerror=a=>{r(a)}}),keys:()=>new Promise((t,n)=>{const i=e.transaction(["store"],"readonly");i.onerror=s=>{n(s)};const r=i.objectStore("store").openKeyCursor(),o=[];r.onsuccess=()=>{const s=r.result;if(!s){t(o);return}o.push(s.key),s.continue()},r.onerror=()=>{n(r.error)}}),get:t=>new Promise((n,i)=>{const r=e.transaction(["store"],"readwrite"),o=r.objectStore("store").get(t);o.onsuccess=()=>{let s=o.result;s===void 0&&(s=null),n(s)},r.onerror=()=>{i(o.error)}}),remove:t=>new Promise((n,i)=>{const r=e.transaction(["store"],"readwrite"),o=r.objectStore("store").delete(t);r.onerror=()=>{i(o.error)},r.oncomplete=()=>{n()},r.onabort=()=>{var s;const a=o.error?o.error:(s=o.transaction)==null?void 0:s.error;i(a)}})}),gt=async e=>new Promise((t,n)=>{const i=window.indexedDB.open(e);i.onerror=r=>{n(r)},i.onsuccess=()=>{t(yu(i.result))},i.onupgradeneeded=()=>{i.result.createObjectStore("store")}}),bu=e=>{let t=Date.now().toString();const n=new V,i=a=>{var u,l;if(typeof a=="string"||typeof a=="object"){const c=typeof a=="object"?a.id:a;return(u=e.manifest)==null?void 0:u.spineItems.find(d=>d.id===c)}return(l=e.manifest)==null?void 0:l.spineItems[a]},r=async(a,u)=>{const l=i(a);if(!l)return new Response("Item not found",{status:404});const c=await(await gt("prose-reader")).get(`${t}_${l.id}`);if(c)return new Response(c,{status:200});const d=u&&await u(l)||await fetch(l.href);return o(l,d.clone()),d},o=(a,u)=>{n.next({id:a,data:u})};n.asObservable().pipe(ue(({id:a,data:u})=>{const l=i(a);return l?N(Go([gt("prose-reader"),N(u.blob())])).pipe(I(([c,d])=>N(c.put(`${t}_${l.id}`,d))),je(c=>(q.error(c),ie))):ie}),L(e.destroy$)).subscribe();const s=e.manifest$.pipe(x(()=>{t=Date.now().toString()}));return E(s).pipe(I(()=>(q.debug("Cleanup up old cache..."),N(gt("prose-reader")).pipe(I(a=>N(a.keys()).pipe(b(u=>u.filter(l=>!l.toString().startsWith(t))),I(u=>{const l=u.map(c=>a.remove(c));return N(Promise.all(l))}))),je(a=>(q.error(a),ie))))),L(e.destroy$)).subscribe(),{get:r,destroy:()=>{n.complete()}}},wu=e=>t=>{const n=e(t),i=bu(n.context);return{...n,destroy:()=>{i.destroy(),n.destroy()}}},Iu=(e,t)=>{var n;const i=(n=e.node.ownerDocument)==null?void 0:n.createRange(),r=e.node.compareDocumentPosition(t.node);if(i){try{if(r&Node.DOCUMENT_POSITION_PRECEDING)i.setStart(t.node,t.offset||0),i.setEnd(e.node,e.offset||0);else if(r&Node.DOCUMENT_POSITION_FOLLOWING)i.setStart(e.node,e.offset||0),i.setEnd(t.node,t.offset||0);else{const o=Math.min(e.offset||0,t.offset||0),s=Math.max(e.offset||0,t.offset||0);i.setStart(e.node,o),i.setEnd(e.node,s)}}catch(o){q.warn("Failed to create range from selection",o,{anchor:e,focus:t})}return i}},Su=({selection:e,spineItem:t})=>{const{anchorNode:n,anchorOffset:i,focusNode:r,focusOffset:o}=e;if(!(!n||!r))try{return Iu({node:n,offset:i},{node:r,offset:o})}catch(s){q.warn("Failed to create range from selection",s,{selection:e,spineItem:t});return}};class xu extends ee{constructor(t){var n;super();const i=t.contentDocument||((n=t.contentWindow)==null?void 0:n.document);if(!i)this.selectionChange$=xe,this.selectionOver$=xe;else{const r=Cn(i.body,{childList:!0,subtree:!0}).pipe(M(s=>!!s.find(a=>a.type==="childList"&&a.removedNodes.length))),o=t.parentElement?Cn(t.parentElement,{childList:!0}).pipe(M(s=>!!s.find(a=>Array.from(a.removedNodes).includes(t)))):P(null);this.selectionChange$=E(J(i,"selectionchange"),r).pipe(b(()=>i.getSelection()),L(E(o,this.destroy$)),Oe(null)),this.selectionOver$=J(i,"pointerdown").pipe(I(()=>E(J(i,"pointerup"),J(i,"pointercancel"),J(i,"contextmenu")).pipe(B(),Je(0),b(s=>{const a=i.getSelection();return a&&!a.isCollapsed?[s,a]:void 0}),M(ge))),L(E(o,this.destroy$)))}}}const Pu=e=>e.loaded$.pipe(I(()=>{var t;const n=e.renderer.getDocumentFrame(),i=(n==null?void 0:n.contentDocument)||((t=n==null?void 0:n.contentWindow)==null?void 0:t.document);if(!n||!i)return xe;const r=new xu(n);return E(r.selectionChange$.pipe(b(o=>{if(o!=null&&o.toString())return{type:"change",selection:o}})),r.selectionOver$.pipe(b(([o,s])=>({type:"over",event:o,selection:s})))).pipe(L(e.unloaded$),Oe(void 0),ve(()=>{r.destroy()}))}),O()),$u=e=>t=>{const n=e(t);let i;const r=n.spineItemsManager.items$.pipe(I(c=>{const d=c.map(p=>{const f=n.spineItemsManager.getSpineItemIndex(p)??0;return Pu(p).pipe(b(h=>{if(h)return{...h,itemIndex:f}}))});return E(...d)}),se(void 0),O(),x(c=>{i=c}),Q({refCount:!0,bufferSize:1})),o=r,s=r.pipe(b(c=>!!c),O(),M(c=>c),U()),a=s.pipe(I(()=>o),O(),M(c=>!c),U()),u=r.pipe(M(c=>(c==null?void 0:c.type)==="over"),U()),l=n.context.containerElement$.pipe(I(c=>J(c,"pointerdown")),z(o),b(([,c])=>c),se(void 0),Q({refCount:!0,bufferSize:1}));return E(o,l).pipe(L(n.$.destroy$)).subscribe(),{...n,selection:{selection$:o,selectionStart$:s,selectionEnd$:a,selectionOver$:u,lastSelectionOnPointerdown$:l,getSelection:()=>i,createOrderedRangeFromSelection:Su}}},Vn=[{name:"bright",backgroundColor:"white"},{name:"sepia",backgroundColor:"#eaddc7",foregroundColor:"black"},{name:"night",backgroundColor:"#191717",foregroundColor:"#f1ebeb"}],Eu=e=>t=>{const n=e(t),i=new Y(t.theme??"bright"),r=()=>{const a=Vn.find(u=>u.name===i.value);return`
      body {
        ${a!==void 0?`background-color: ${a.backgroundColor} !important;`:""}
      }
      ${a!=null&&a.foregroundColor?`
          body * {
            
            color: ${a.foregroundColor};
          }
        `:""}
    `},o=({container:a})=>{const u=Vn.find(l=>l.name===i.value);return u&&a.style.setProperty("background-color",u.backgroundColor),()=>{}},s=()=>{n.spineItemsManager.items.forEach(a=>{const u=a.renderer.getDocumentFrame();u&&ce(u,"prose-reader-theme",r()),o({container:a.element})})};return n.hookManager.register("item.onDocumentLoad",({itemId:a})=>{const u=n.spineItemsManager.get(a);if((u==null?void 0:u.renditionLayout)!=="pre-paginated"){const l=u==null?void 0:u.renderer.getDocumentFrame();l&&ce(l,"prose-reader-theme",r())}}),n.spineItemsManager.items$.pipe(x(a=>a.map(({element:u})=>o({container:u}))),L(n.$.destroy$)).subscribe(),i.pipe(x(()=>{s()}),L(n.$.destroy$)).subscribe(),{...n,theme:{set:a=>{a!==i.value&&i.next(a)},get:()=>i.value,$:{theme$:i.asObservable()}}}},Lu=e=>t=>({...e(t),utils:{isOrIsWithinValidLink:n=>{if(Ci(n)){const i=n.nodeName==="a"?n:n.closest("a");if(i!=null&&i.getAttribute("href"))return!0}return!1}}});navigator.userAgent.indexOf("")>-1&&navigator.userAgent.indexOf("Chrome")<=-1;const Tu=e=>t=>e(t);class Ki{constructor(t){this.reader=t}}class Mu extends Ki{constructor(){super(...arguments),this.isZooming$=new Y(!1),this.currentScale=1,this.currentPosition={x:0,y:0}}enter(t){if(!t){console.warn("You need an image to enter zoom");return}this.currentPosition={x:0,y:0},this.currentScale=1;const n=this.reader.context.state.containerElement;if(n){this.element=n.ownerDocument.createElement("div"),this.element.style.cssText=`
          top: 0;
          left: 0;
          display: block;
          position: absolute;
          z-index: 1;
          background: black;
          width: 100%;
          height: 100%;
          user-select: none;
        `;const i=t.cloneNode();i.src=t.src,i.style.setProperty("height","100%"),i.style.setProperty("width","100%"),i.style.setProperty("object-fit","contain"),i.style.setProperty("pointer-events","none"),this.element.appendChild(i),n.appendChild(this.element),this.isZooming$.next(!0)}}exit(){var t;(t=this.element)==null||t.remove(),this.element=void 0,this.currentPosition={x:0,y:0},this.currentScale=1,this.isZooming$.next(!1)}moveAt(t){var n;const i=(n=this.element)==null?void 0:n.querySelector("img");i==null||i.style.setProperty("transform",`translate3d(${t.x}px, ${t.y}px, 0px) scale3d(${this.currentScale}, ${this.currentScale}, 1)`),this.currentPosition=t}scaleAt(t){var n;const i=Math.max(.01,t),r=(n=this.element)==null?void 0:n.querySelector("img");r==null||r.style.setProperty("transform",`translate3d(${this.currentPosition.x}px, ${this.currentPosition.y}px, 0px) scale3d(${i}, ${i}, 1)`),this.currentScale=i}}const at=({newScale:e,oldScale:t,screenSize:n,scrollOffset:i})=>{const r=n*e/2-n+n/2,o=n*t/2-n+n/2,s=e/t,a=i-o;return Math.max(r+a*s,0)};class Ou extends Ki{constructor(){super(...arguments),this.isZooming$=new Y(!1),this.currentScale=1,this.currentPosition={x:0,y:0}}enter(){this.currentScale=1,this.currentPosition={x:0,y:0};const t=this.reader.spine.element;t&&(t.style.transformOrigin="0 0"),this.isZooming$.next(!0)}exit(){this.scaleAt(1),this.isZooming$.next(!1)}moveAt(){}scaleAt(t){const n=this.reader.spine.element,i=this.reader.navigation.scrollNavigationController.value.element;if(!n||!i)return;const r=Math.ceil(t*100)/100,o=Math.max(r,1),s=n.getBoundingClientRect().width/n.offsetWidth,a=i.scrollTop;n.style.transform=`scale(${o})`,i.scrollLeft=at({newScale:o,oldScale:s,pageSize:i.clientWidth,screenSize:n.offsetWidth,scrollOffset:i.scrollLeft}),i.scrollTop=at({newScale:o,oldScale:s,pageSize:i.clientHeight,screenSize:n.offsetHeight,scrollOffset:a}),this.currentScale=r}}const Au=e=>t=>{const n=e(t),i=new Mu(n),r=new Ou(n),o=new Y(r);return{...n,destroy:()=>{i.exit(),r.exit(),o.complete(),n.destroy()},zoom:{enter:s=>{const a=n.settings.values.computedPageTurnMode==="scrollable"?r:i;o.next(a),a.enter(s)},scaleAt:s=>o.getValue().scaleAt(s),moveAt:s=>o.getValue().moveAt(s),exit:()=>o.getValue().exit(),get currentPosition(){return o.getValue().currentPosition},get currentScale(){return o.getValue().currentScale},isZooming$:o.pipe(I(s=>s.isZooming$)),get zoomContainerElement(){return o.getValue().element},get isZooming(){return o.getValue().isZooming$.getValue()}}}},Qi=e=>(e==null?void 0:e.renditionLayout)==="pre-paginated"||(e==null?void 0:e.spineItems.every(t=>t.renditionLayout==="pre-paginated"));class ze extends R{constructor(t){super(n=>this.stateSubject.pipe(L(this.destroy$)).subscribe(n)),this.destroy$=new V,this.stateSubject=new Y(t)}next(t){this.stateSubject.next(t)}mergeCompare(t){const n={...this.value,...t};H(this.value,n)||this.stateSubject.next(n)}watch(t){return Array.isArray(t)?this.stateSubject.pipe(an(t)):this.stateSubject.pipe(b(n=>n[t]),O(H))}get value(){return this.stateSubject.value}destroy(){this.stateSubject.complete(),this.destroy$.complete()}}class _u{constructor(){this.navigationSubject=new xt(1),this.viewportStateSubject=new Y("free"),this.paginationSubject=new xt,this.navigationIsLockedSubject=new Y(!1),this.pagination$=this.paginationSubject.asObservable(),this.navigationUnlocked$=this.navigationIsLockedSubject.pipe(O(),M(t=>!t)),this.viewportState$=this.viewportStateSubject.asObservable(),this.viewportFree$=this.viewportState$.pipe(M(t=>t==="free")),this.viewportBusy$=this.viewportState$.pipe(M(t=>t==="busy")),this.navigation$=this.navigationSubject.asObservable()}}const Ru=({manifest:e,visibleAreaRect:t,forceSinglePageMode:n})=>{const{height:i,width:r}=t,o=r>i;return n||(e==null?void 0:e.renditionFlow)==="scrolled-continuous"?!1:!o&&(e==null?void 0:e.renditionSpread)==="portrait"?!0:o&&((e==null?void 0:e.renditionSpread)===void 0||(e==null?void 0:e.renditionSpread)==="auto"||(e==null?void 0:e.renditionSpread)==="landscape"||(e==null?void 0:e.renditionSpread)==="both")};class Fu extends ze{constructor(){super({marginBottom:0,marginTop:0,calculatedInnerMargin:0,assumedRenditionLayout:"reflowable",visibleAreaRect:{width:0,height:0,x:0,y:0}}),this.bridgeEvent=new _u,this.destroy$=new V,this.state$=this.pipe(O(H)),this.manifest$=this.pipe(b(t=>t.manifest),M(ge),O()),this.containerElement$=this.pipe(b(t=>t.containerElement),M(ge),O()),this.hasVerticalWriting$=this.pipe(b(t=>t.hasVerticalWriting),M(ge),O()),this.isUsingSpreadMode$=this.pipe(b(t=>t.isUsingSpreadMode),O()),this.isRTL=()=>{var t;return((t=this.value.manifest)==null?void 0:t.readingDirection)==="rtl"}}update(t){const n=this.value,i=t.manifest??n.manifest,r=t.forceSinglePageMode??n.forceSinglePageMode,o=t.visibleAreaRect??n.visibleAreaRect,s=t.marginTop??n.marginTop,a=t.marginBottom??n.marginBottom,u={...n,...t,...t.visibleAreaRect&&{...t.visibleAreaRect,height:t.visibleAreaRect.height-s-a},...t.manifest&&{isFullyPrePaginated:Qi(i),assumedRenditionLayout:(i==null?void 0:i.renditionLayout)??"reflowable"},isUsingSpreadMode:Ru({manifest:i,visibleAreaRect:o,forceSinglePageMode:r})};H(u,n)||this.next(u)}get state(){return this.value}get manifest(){return this.value.manifest}get readingDirection(){var t;return(t=this.manifest)==null?void 0:t.readingDirection}getPageSize(){const{isUsingSpreadMode:t,visibleAreaRect:n}=this.value;return{width:t?n.width/2:n.width,height:n.height}}}class ju extends ze{constructor(t,n){super({supportedPageTurnAnimation:["fade","none","slide"],supportedPageTurnMode:["controlled","scrollable"],supportedPageTurnDirection:["horizontal","vertical"],supportedComputedPageTurnDirection:["horizontal","vertical"]}),E(t.state$,n.values$).pipe(z(t.state$),b(([,{hasVerticalWriting:i}])=>{const r=t.manifest;return{hasVerticalWriting:i,renditionFlow:r==null?void 0:r.renditionFlow,renditionLayout:r==null?void 0:r.renditionLayout,computedPageTurnMode:n.values.computedPageTurnMode}}),O(H),b(({hasVerticalWriting:i,renditionFlow:r,renditionLayout:o,computedPageTurnMode:s})=>({...this.value,supportedPageTurnMode:r==="scrolled-continuous"?["scrollable"]:["controlled","scrollable"],supportedPageTurnAnimation:r==="scrolled-continuous"||s==="scrollable"?["none"]:i?["fade","none"]:["fade","none","slide"],supportedPageTurnDirection:s==="scrollable"?["vertical"]:o==="reflowable"?["horizontal"]:["horizontal","vertical"]})),L(this.destroy$)).subscribe(this.next.bind(this))}}class Cu{constructor(){this._hooks=[],this._hookExecutions=[]}deregister(t){return this._hooks=this._hooks.filter(n=>n!==t),this.destroy(t.name,void 0,t)}register(t,n){const i={name:t,runFn:n};return this._hooks.push(i),()=>{this.deregister(i)}}execute(t,n,i){return this._hooks.filter(r=>t===r.name).map(r=>{let o=()=>P(void 0);const s=new V,a=c=>{o=c},u=()=>(s.next(),s.complete(),o()??P(void 0)),l=r.runFn({...i,destroy$:s.asObservable(),destroy:a});return this._hookExecutions.push({name:t,id:n,destroyFn:u,ref:r}),l})}destroy(t,n,i){const r=this._hookExecutions.filter(s=>i&&s.ref===i||t===s.name&&(!n||n&&n===s.id));this._hookExecutions=this._hookExecutions.filter(s=>!r.includes(s));const o=r.map(({destroyFn:s})=>s());return K(o)}}class er{constructor(){this.isLockedSubject=new Y(0),this.isLocked$=this.isLockedSubject.pipe(b(t=>!!t),O())}lock(){let t=!1;return this.isLockedSubject.next(this.isLockedSubject.getValue()+1),()=>{t||(t=!0,this.isLockedSubject.next(this.isLockedSubject.getValue()-1))}}}const Du=()=>e=>e.pipe(b(({navigation:t,pagination:n,...i})=>({navigation:{...t,paginationBeginCfi:n.beginCfi},...i}))),Nu=(e,t,n)=>e.bridgeEvent.pagination$.pipe(z(t),M(([i,r])=>i.navigationId===r.id),I(([i,r])=>{const o=n.spineItemsManager.get(r.spineItem);return((o==null?void 0:o.isReady$.pipe(B()))??P(!1)).pipe(M(s=>s),b(()=>({pagination:i,navigation:r})))}),Du(),O((i,r)=>i.navigation.paginationBeginCfi===r.navigation.paginationBeginCfi),b(({navigation:i})=>({...i,meta:{triggeredBy:"pagination"}}))),Wu=e=>e.pipe(b(([t,n])=>{const i={type:"api",meta:{triggeredBy:"user"},id:Symbol(),animation:"turn",...t};return{previousNavigation:n,navigation:i}})),ku=({navigationResolver:e})=>t=>t.pipe(b(n=>{if(n.navigation.cfi){const i=e.getNavigationForCfi(n.navigation.cfi);if(i)return{...n,navigation:{...n.navigation,position:i}}}return n})),Vu=({navigation:e,previousNavigation:t,settings:n})=>e.directionFromLastNavigation?e.directionFromLastNavigation:e.url!==void 0||e.cfi!==void 0?"anchor":t.spineItem===void 0||e.spineItem||!e.position?"forward":n.values.computedPageTurnDirection==="vertical"?e.position.y>t.position.y||e.position.y===t.position.y&&t.directionFromLastNavigation!=="backward"?"forward":"backward":Math.abs(e.position.x)>Math.abs(t.position.x)||e.position.x===t.position.x&&t.directionFromLastNavigation!=="backward"?"forward":"backward",zu=({context:e,settings:t})=>n=>n.pipe(b(({navigation:i,previousNavigation:r})=>{const o=Vu({navigation:i,previousNavigation:r,settings:t}),s={...i,directionFromLastNavigation:o};return{previousNavigation:r,navigation:s,direction:o}})),Uu=({spineItemsManager:e,navigationResolver:t})=>n=>n.pipe(b(({navigation:i,...r})=>{const o=e.get(i.spineItem);return i.position?{navigation:{...i,position:t.getAdjustedPositionWithSafeEdge(i.position)},...r}:o?{navigation:{...i,position:t.getNavigationForSpineIndexOrId(o)},...r}:{navigation:{...i,position:new _({x:0,y:0})},...r}})),zn=({settings:e,spineItemsManager:t,navigationResolver:n,spineLocator:i})=>r=>{const o=s=>{const{position:a,spineItem:u,cfi:l,directionFromLastNavigation:c}=s,{navigationSnapThreshold:d,computedPageTurnMode:p}=e.values;if(u!==void 0){const f=t.get(u);if(f)return f}if(typeof u=="number")return u>t.items.length-1?t.get(t.items.length-1):t.get(0);if(l){const f=t.getSpineItemFromCfi(l);if(f)return f}if(a&&p==="controlled"){const{beginIndex:f,endIndex:h}=i.getVisibleSpineItemsFromPosition({position:a,threshold:d,restrictToScreen:!1})??{},g=(c==="forward"||c==="anchor"?h:f)??f,v=t.get(g);if(!v)return;const{endPageIndex:m,beginPageIndex:y}=i.getVisiblePagesFromViewportPosition({position:a,spineItem:v,threshold:d,restrictToScreen:!1})??{},w=(c==="forward"||c==="anchor"?m:y)??0,S=n.getNavigationForSpineItemPage({pageIndex:w,spineItemId:v}),$=i.getVisibleSpineItemsFromPosition({position:S,threshold:d,restrictToScreen:!1}),T=c==="forward"||c==="anchor"?$==null?void 0:$.beginIndex:$==null?void 0:$.endIndex;return t.get(T)}return a&&p==="scrollable"?i.getSpineItemFromPosition(a):t.get(0)};return r.pipe(b(({navigation:s,...a})=>{const u=o(s);return{navigation:{...s,spineItem:t.getSpineItemIndex(u)},...a}}))},Un=({spine:e})=>t=>t.pipe(I(({navigation:n,...i})=>{const r=e.spineLayout.getSpineItemSpineLayoutInfo(n.spineItem),o=e.spineItemsManager.get(n.spineItem);return((o==null?void 0:o.isReady$)??P(!1)).pipe(B(),b(s=>({navigation:{...n,spineItemHeight:r==null?void 0:r.height,spineItemWidth:r==null?void 0:r.width,spineItemLeft:r.left,spineItemTop:r.top,spineItemIsUsingVerticalWriting:o==null?void 0:o.isUsingVerticalWriting(),spineItemIsReady:s},...i})))})),mt=({settings:e,spineItemsManager:t,spineLocator:n,navigationResolver:i})=>r=>{const o=s=>{const{navigationSnapThreshold:a,computedPageTurnMode:u}=e.values,l=t.get(s.spineItem);if(!(!l||!s.position)){if(u==="controlled"){const{endPageIndex:c,beginPageIndex:d}=n.getVisiblePagesFromViewportPosition({position:s.position,spineItem:l,threshold:a,restrictToScreen:!1})??{},p=(s.directionFromLastNavigation==="forward"||s.directionFromLastNavigation==="anchor"?c:d)??0,f=i.getNavigationForSpineItemPage({pageIndex:p,spineItemId:l}),h=n.getVisiblePagesFromViewportPosition({position:f,spineItem:l,threshold:0,restrictToScreen:!0}),g=(s.directionFromLastNavigation==="forward"||s.directionFromLastNavigation==="anchor"?h==null?void 0:h.beginPageIndex:h==null?void 0:h.endPageIndex)??0;return n.spineItemLocator.getSpineItemPositionFromPageIndex({pageIndex:g,spineItem:l})}return n.getSpineItemPositionFromSpinePosition(s.position,l)}};return r.pipe(b(({navigation:s,...a})=>({navigation:{...s,positionInSpineItem:o(s)},...a})))},Hu=({navigationResolver:e})=>t=>t.pipe(b(n=>{if(n.navigation.url){const i=e.getNavigationForUrl(n.navigation.url);if(i)return{...n,navigation:{...n.navigation,position:i.position,spineItem:i.spineItemId}}}return n})),Bu=({spineLocator:e,navigation:t,navigationResolver:n,spineItemsManager:i,spineLayout:r})=>{const o=i.get(t.spineItem);return o?o.isReady$.pipe(B(),b(s=>{var a,u;const l=r.getSpineItemSpineLayoutInfo(o),c=e.isPositionWithinSpineItem(t.position,o),d=l.width-(t.spineItemWidth??0),p=l.height-(t.spineItemHeight??0),f=d!==0||p!==0;if(t.url!==void 0&&(d||p||s&&!t.spineItemIsReady)){const g=n.getNavigationForUrl(t.url);if(g)return g.position}const h=t.cfi??t.paginationBeginCfi;if(h!==void 0&&!Ft(h)&&(d||p||s&&!t.spineItemIsReady)){const g=n.getNavigationForCfi(h);if(g)return g}if(c&&f&&t.directionFromLastNavigation==="backward"){const g=new k({x:(((a=t.positionInSpineItem)==null?void 0:a.x)??0)+d,y:(((u=t.positionInSpineItem)==null?void 0:u.y)??0)+p});return n.getNavigationFromSpineItemPosition({spineItem:o,spineItemPosition:g})}if(t.positionInSpineItem&&t.spineItemHeight&&t.spineItemWidth){const g=e.spineItemLocator.getSpineItemPageIndexFromPosition({itemWidth:t.spineItemWidth,itemHeight:t.spineItemHeight,isUsingVerticalWriting:!!t.spineItemIsUsingVerticalWriting,position:t.positionInSpineItem});return n.getNavigationForSpineItemPage({pageIndex:g,spineItemId:o})}return c?n.getNavigationForPosition(t.position):n.getNavigationForSpineIndexOrId(o)})):P(new _({x:0,y:0}))},qu=({navigation:e,spineLocator:t,spineItemsManager:n,settings:i,navigationResolver:r,spineLayout:o})=>{const{spineItem:s}=e,a=n.get(s);if(!a)return new _({x:0,y:0});const{height:u,top:l}=o.getSpineItemSpineLayoutInfo(a),c=t.isPositionWithinSpineItem(e.position,a),d=e.positionInSpineItem??new k({y:0,x:0});if(i.values.computedPageTurnDirection==="vertical"){if(l===e.spineItemTop&&u===e.spineItemHeight&&c)return e.position;if(l===e.spineItemTop&&u===e.spineItemHeight&&!c)return r.getNavigationForSpineIndexOrId(a);if(l!==e.spineItemTop){const p=t.getSafeSpineItemPositionFromUnsafeSpineItemPosition(e.positionInSpineItem??new k({x:0,y:0}),a);return t.getSpinePositionFromSpineItemPosition({spineItemPosition:p,spineItem:a})}if(l===e.spineItemTop&&u!==e.spineItemHeight){const p=(e.spineItemHeight??d.y)-d.y,f=new k({y:e.directionFromLastNavigation==="backward"?u-p:d.y,x:e.position.x});if(c){const h=t.getSafeSpineItemPositionFromUnsafeSpineItemPosition(f,a);return t.getSpinePositionFromSpineItemPosition({spineItemPosition:h,spineItem:a})}if(!c){if(!(e.position.y<l)){const h=new k({y:u-p,x:e.position.x});return t.getSpinePositionFromSpineItemPosition({spineItemPosition:t.getSafeSpineItemPositionFromUnsafeSpineItemPosition(h,a),spineItem:a})}return r.getNavigationForSpineIndexOrId(a)}}}return e.position},Yu=({navigation:e,spineItemsManager:t,settings:n,spineLocator:i,navigationResolver:r,spineLayout:o})=>n.values.computedPageTurnMode==="scrollable"?P(qu({navigation:e,spineLocator:i,navigationResolver:r,settings:n,spineItemsManager:t,spineLayout:o})):Bu({navigation:e,spineLocator:i,navigationResolver:r,spineItemsManager:t,spineLayout:o}),Hn=({settings:e,navigationResolver:t,context:n,spine:i})=>r=>r.pipe(I(o=>Yu({spineLocator:i.locator,navigation:o.navigation,navigationResolver:t,settings:e,spineItemsManager:i.spineItemsManager,spineItemLocator:i.locator.spineItemLocator,spineLayout:i.spineLayout}).pipe(b(s=>({...o,navigation:{...o.navigation,position:s}}))))),Gu="navigation/InternalNavigator",Xu=q.namespace(Gu);class Zu extends ee{constructor(t,n,i,r,o,s,a,u){super(),this.settings=t,this.context=n,this.userNavigation$=i,this.viewportController=r,this.scrollNavigationController=o,this.navigationResolver=s,this.spine=a,this.isUserLocked$=u,this.navigationSubject=new Y({animation:!1,position:new _({x:0,y:0}),meta:{triggeredBy:"user"},spineItemIsReady:!1,type:"api",id:Symbol()}),this.navigated$=this.navigationSubject.pipe(tn(1)),this.navigation$=this.navigationSubject.pipe(b(({position:m,id:y})=>({position:m,id:y})),O(({position:m,...y},{position:w,...S})=>H(y,S)&&H(m,w)),Q(1)),this.locker=new er;const l=i.pipe(z(this.navigationSubject),Wu,Hu({navigationResolver:s}),ku({navigationResolver:s}),zu({context:n,settings:t}),zn({navigationResolver:s,settings:t,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),mt({navigationResolver:s,settings:t,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),Un({spine:a})).pipe(Uu({navigationResolver:s,spineItemsManager:a.spineItemsManager}),z(u),I(([m,y])=>{const w=m.navigation.cfi||m.navigation.url||t.values.computedPageTurnMode==="scrollable"||y;return P(m).pipe(w?ne:Hn({navigationResolver:s,settings:t,spine:a,context:n}))}),mt({spineItemsManager:a.spineItemsManager,spineLocator:a.locator,settings:t,navigationResolver:s}),b(m=>m.navigation),U()),c=l.pipe(z(u),M(([,m])=>m),I(([m])=>{const y=this.locker.lock();return u.pipe(M(w=>!w),B(),b(()=>({...m,animation:"snap"})),ve(()=>{y()}),L(l))}),U()),d=E(r.layout$,a.spineLayout.layout$).pipe(I(()=>P(null).pipe(I(()=>u.pipe(M(m=>!m),B())),b(()=>({...this.navigationSubject.getValue(),animation:!1})),L(E(c,l))))),p=E(d,c).pipe(b(m=>({navigation:m})),Hn({navigationResolver:s,settings:t,context:n,spine:a}),b(m=>{const y={...m.navigation,meta:{triggeredBy:"restoration"}};return{...m,navigation:y}}),zn({navigationResolver:s,settings:t,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),Un({spine:a}),mt({spineItemsManager:a.spineItemsManager,spineLocator:a.locator,settings:t,navigationResolver:s}),b(({navigation:m})=>m),U()),f=Nu(n,this.navigationSubject,a),h=E(p,l,f),g=m=>m.pipe(x(([y,w])=>{Xu.info(`navigation updated from ${y.meta.triggeredBy} of type ${y.type}`,{previousNavigation:w,currentNavigation:y}),this.navigationSubject.next(y)})),v=m=>m.pipe(x(([y,w])=>{const S=y.type==="scroll",$=y.meta.triggeredBy==="pagination",T=y.meta.triggeredBy==="restoration",W=H(w.position,y.position);if(S&&!T||$||W)return;const F={position:y.position,animation:y.animation};t.values.computedPageTurnMode==="scrollable"?this.scrollNavigationController.navigate(F):this.viewportController.navigate(F)}));h.pipe(z(this.navigationSubject),v,g,L(this.destroy$)).subscribe()}get navigation(){return this.navigationSubject.getValue()}}const tr=({position:{x:e,y:t},spineElement:n,element:i})=>{if(!n)throw new Error("Invalid spine element");const r=n.getBoundingClientRect().width/n.offsetWidth;return new _({x:at({newScale:1,oldScale:r,screenSize:i.clientWidth??0,pageSize:n.scrollWidth,scrollOffset:e}),y:at({newScale:1,oldScale:r,screenSize:i.clientHeight??0,pageSize:n.scrollHeight,scrollOffset:t})})},Ju=500;class Ku extends ee{constructor(t,n,i,r,o){super(),this.settings=t,this.context=n,this.spine=i,this.scrollNavigationController=r,this.locker=o,this.navigationSubject=new V,this.navigation$=this.navigationSubject.asObservable();const s=this.scrollNavigationController.userScroll$.pipe(Et(a=>{const u=this.locker.lock();return E(this.scrollNavigationController.userScroll$,P(a)).pipe(Ee(Ju,fe),B(),x(()=>{const l=a.target,c=tr({element:l,position:new _({x:l.scrollLeft??0,y:l.scrollTop??0}),spineElement:this.spine.element});this.navigationSubject.next({animation:!1,type:"scroll",position:c})}),ve(()=>{u()}))}));E(s).pipe(L(this.destroy$)).subscribe()}}const Qu=e=>({x:-e.x,y:-e.y}),el=e=>e instanceof DOMMatrix?new _({x:-e.e,y:-e.f}):new _({x:-e.x,y:-e.y}),tl="navigation/ViewportNavigator",Bn=q.namespace(tl);class nl extends ee{constructor(t,n,i,r,o){super(),this.settings=t,this.hookManager=n,this.context=i,this.spine=r,this.viewport=o,this.navigateSubject=new V,this.element$=new Y(document.createElement("div"));const s=this.spine.element$.pipe(z(this.element$),x(([c,d])=>{d.style.cssText=`
          height: 100%;
          width: 100%;
          position: relative;
        `,d.className=`${Le}-controlled-navigator`,d.innerHTML="",d.appendChild(c),this.viewport.value.element.appendChild(d),this.element$.next(d)})),a=t.watch(["computedPageTurnDirection","computedPageTurnMode","numberOfAdjacentSpineItemToPreLoad"]),u=K([a,this.element$]).pipe(x(([,c])=>{t.values.computedPageTurnMode==="scrollable"?c.style.display="contents":c.style.display="block"}));this.layout$=u.pipe(x(()=>{Bn.info("layout",t.values)}),U());const l=this.navigateSubject.pipe(x(c=>{Bn.info("Navigation requested",c)}));this.isNavigating$=l.pipe(b(({animation:c,position:d})=>({type:"manualAdjust",shouldAnimate:!(!c||c==="turn"&&t.values.computedPageTurnAnimation==="none"),animation:c,position:d})),I(c=>{const d=this.element$.getValue();return d.style.setProperty("transition","none"),d.style.setProperty("opacity","1"),E(P(!0),P(null).pipe(ue(()=>{if((c==null?void 0:c.type)!=="manualAdjust")return P(!1);const p=c.animation==="snap"?t.values.snapAnimationDuration:t.values.computedPageTurnAnimationDuration,f=c.animation==="snap"?"slide":t.values.computedPageTurnAnimation;return P(c).pipe(c.shouldAnimate?Je(1,fe):ne,x(h=>{const g=this.element$.getValue();h.shouldAnimate?f==="fade"?(g.style.setProperty("transition",`opacity ${p/2}ms`),g.style.setProperty("opacity","0")):(c.animation==="snap"||f==="slide")&&(g.style.setProperty("transition",`transform ${p}ms`),g.style.setProperty("opacity","1")):(g.style.setProperty("transition","none"),g.style.setProperty("opacity","1"))}),x(h=>{f!=="fade"&&this.setViewportPosition(h.position)}),c.shouldAnimate?Je(p/2,fe):ne,x(h=>{const g=this.element$.getValue();f==="fade"&&(this.setViewportPosition(h.position),g.style.setProperty("opacity","1"))}),c.shouldAnimate?Je(p/2,fe):ne,x(h=>{f==="fade"&&this.setViewportPosition(h.position)}))}),b(()=>!1)))}),se(!1),Q(1)),E(s,this.isNavigating$,this.layout$).pipe(L(this.destroy$)).subscribe()}setViewportPosition(t){const n=this.element$.getValue(),i=Qu(t);n.style.transform=`translate(${i.x}px, ${i.y}px)`,this.hookManager.execute("onViewportOffsetAdjust",void 0,{})}navigate(t){this.navigateSubject.next(t)}get viewportPosition(){const t=this.element$.getValue(),n=window.getComputedStyle(t),i=n.transform||n.webkitTransform;if(!i||i==="none")return new _({x:0,y:0});const r=new DOMMatrix(i);return el(r)}}class il extends ze{constructor(t,n,i,r,o){super({element:void 0}),this.viewport=t,this.settings=n,this.hookManager=i,this.spine=r,this.context=o,this.navigateSubject=new V,this.scrollingSubject=new Y(!1),this.isScrolling$=this.scrollingSubject.asObservable(),this.setViewportPosition=({position:d})=>{const p=this.value.element;this.scrollingSubject.next(!0),p==null||p.scrollTo({left:d.x,top:d.y,behavior:"instant"}),st(1).pipe(x(()=>{this.scrollingSubject.next(!1)}),L(E(this.scrollingSubject.pipe(tn(1)),this.destroy$))).subscribe(),this.hookManager.execute("onViewportOffsetAdjust",void 0,{})};const s=this.context.pipe(an(["rootElement"]),x(({rootElement:d})=>{if(!d)return;const p=document.createElement("div");p.style.cssText=`
          height: 100%;
          width: 100%;
          position: relative;
          overflow-y: scroll;
          overflow-x: hidden;
        `,p.className=`${Le}-scroll-navigator`,p.appendChild(this.viewport.value.element),d.appendChild(p),this.update({element:p})})),a=K([n.watch(["computedPageTurnMode"]),this.watch("element")]).pipe(x(([{computedPageTurnMode:d},p])=>{p&&(d==="scrollable"?p.style.display="block":p.style.display="contents")})),u=this.navigateSubject.pipe(x(this.setViewportPosition));this.isNavigating$=this.navigateSubject.pipe(se(!1),I(()=>E(P(!0),P(!1))),Q(1));const l=E(r.element$.pipe(I(d=>ki(d))),r.element$.pipe(I(d=>J(d,"scroll"))),r.spineItemsObserver.itemResize$).pipe(I(()=>st(10).pipe(b(()=>!1),se(!0))),O(),se(!1)),c=K([l,this.isScrolling$]).pipe(b(([d,p])=>d||p),Q(1));this.userScroll$=this.watch("element").pipe(M(ge),I(d=>n.watch(["computedPageTurnMode"]).pipe(I(({computedPageTurnMode:p})=>p==="controlled"?xe:J(d,"scroll").pipe(z(c),M(([,f])=>!f),b(([f])=>f))))),U()),E(s,a,u).pipe(L(this.destroy$)).subscribe()}update(t){this.mergeCompare(t)}navigate(t){this.navigateSubject.next(t)}get viewportPosition(){const t=this.value.element;return t?tr({element:t,position:new _({x:(t==null?void 0:t.scrollLeft)??0,y:(t==null?void 0:t.scrollTop)??0}),spineElement:this.spine.element}):new _({x:0,y:0})}}const qn=(e,t,n)=>{const i=n-e,r=n*(t*e)/(n||1);return Math.max(0,Math.min(i,r))},jt=(e,t)=>(t||0)===0||(e||0)===0?1:Math.floor(Math.max(1,e/t)),nt=(e,t,n)=>{const i=jt(n,t),r=[...Array(i)].map((o,s)=>s*t);return e>=i*t?r[r.length-1]||0:r.find(o=>e<o+t)||0},pn=({itemHeight:e,itemWidth:t,isUsingVerticalWriting:n,settings:i,context:r})=>{const{pageTurnDirection:o,pageTurnMode:s}=i.values;return o==="vertical"&&s==="scrollable"?1:n||o==="vertical"?jt(e,r.getPageSize().height):jt(t,r.getPageSize().width)},Ct=({pageIndex:e,itemLayout:t,context:n,isUsingVerticalWriting:i})=>{if(i){const o=qn(n.getPageSize().height,e,t.height);return new k({x:0,y:o})}const r=qn(n.getPageSize().width,e,t.width);return n.isRTL()?new k({x:t.width-r-n.getPageSize().width,y:0}):new k({x:r,y:0})},rl=({context:e,isUsingVerticalWriting:t,settings:n,itemLayout:i})=>{const r=pn({context:e,isUsingVerticalWriting:t,itemHeight:i.height,itemWidth:i.width,settings:n});return new Array(r).fill(void 0).map((o,s)=>Ct({context:e,isUsingVerticalWriting:t,itemLayout:i,pageIndex:s}))},nr=({context:e,settings:t})=>{const n=({itemWidth:l,itemHeight:c,spineItemPosition:d})=>new k({x:Math.min(l,Math.max(0,d.x)),y:Math.min(c,Math.max(0,d.y))}),i=({itemWidth:l,itemHeight:c,position:d,isUsingVerticalWriting:p})=>{const f=e.getPageSize().width,h=e.getPageSize().height,g=n({spineItemPosition:d,itemHeight:c,itemWidth:l}),v=e.isRTL()?l-g.x-e.getPageSize().width:g.x,m=pn({isUsingVerticalWriting:p,itemHeight:c,itemWidth:l,context:e,settings:t});return p?u(d.y,h,m):u(v,f,m)},r=(l,c,d)=>{var p;let f;if((l==null?void 0:l.nodeName)==="img"||(l==null?void 0:l.textContent)===""&&l.nodeType===Node.ELEMENT_NODE)f=l.getBoundingClientRect().x;else if(l){const v=l?Xs(l,c):void 0;f=(v==null?void 0:v.getBoundingClientRect().x)||f}const h=((p=d.layout.layoutInfo)==null?void 0:p.width)||0,g=e.getPageSize().width;if(f!==void 0){const v=nt(f,g,h);return new k({x:v,y:0})}},o=(l,c)=>{var d,p;const f=e.getPageSize(),h=(d=c.renderer)==null?void 0:d.getDocumentFrame();if(h&&(p=h==null?void 0:h.contentWindow)!=null&&p.document&&h.contentWindow.document.body!==null){const{x:g,y:v}=Ct({pageIndex:l,itemLayout:c.layout.layoutInfo,context:e,isUsingVerticalWriting:!!c.isUsingVerticalWriting()}),m={left:g,right:g+f.width,bottom:v+f.height};return Ys(h.contentWindow.document,m)}},s=(l,c)=>{const{width:d,height:p}=c.layout.layoutInfo;return new k({x:nt(l.x,e.getPageSize().width,d),y:nt(l.y,e.getPageSize().height,p)})},a=(l,c,d)=>{const p=r(l,c,d),{height:f,width:h}=d.layout.layoutInfo;return p?i({isUsingVerticalWriting:!!d.isUsingVerticalWriting(),position:p,itemHeight:f,itemWidth:h}):void 0},u=(l,c,d)=>{const p=[...Array(d)].map((f,h)=>h*c);return l<=0?0:l>=d*c?d-1:Math.max(0,p.findIndex(f=>l<f+c))};return{getSpineItemPositionFromNode:r,getSpineItemPositionFromPageIndex:({pageIndex:l,spineItem:c})=>Ct({context:e,isUsingVerticalWriting:!!c.isUsingVerticalWriting(),itemLayout:c.layout.layoutInfo,pageIndex:l}),getSpineItemPageIndexFromPosition:i,getSpineItemPageIndexFromNode:a,getSpineItemClosestPositionFromUnsafePosition:s,getFirstNodeOrRangeAtPage:o,getSpineItemPagesPosition:({item:l})=>rl({context:e,isUsingVerticalWriting:!!l.isUsingVerticalWriting(),settings:t,itemLayout:l.layout.layoutInfo})}},ol=({context:e,settings:t})=>{const n=nr({context:e,settings:t});return{getNavigationForLastPage:i=>{const r=i.numberOfPages;return n.getSpineItemPositionFromPageIndex({pageIndex:r-1,spineItem:i})},getNavigationForPosition:(i,r)=>n.getSpineItemClosestPositionFromUnsafePosition(r,i),getNavigationFromNode:(i,r,o)=>n.getSpineItemPositionFromNode(r,o,i)||new k({x:0,y:0})}},le=({position:{x:e,y:t},pageSizeWidth:n,visibleAreaRectWidth:i})=>{const r=e%i!==0?e-n:e;return new _({x:r,y:t})},Yn=({position:e,isRTL:t,pageSizeHeight:n,spineItemsManager:i,visibleAreaRectWidth:r,spineLayout:o})=>{const s=i.get(i.items.length-1),a=o.getSpineItemSpineLayoutInfo(s||0),u=a.bottom-n,l=Math.min(Math.max(0,e.y),u);if(t)return new _({x:Math.max(Math.min(0,e.x),a.left),y:l});const c=a.right-r;return new _({x:Math.min(Math.max(0,e.x),c),y:l})},Dt=({viewportPosition:e,spineLocator:t,context:n,spineItemNavigationResolver:i})=>{const r=t.getSpineItemFromPosition(e);if(r){const o=t.getSpineItemPositionFromSpinePosition(e,r),s=i.getNavigationForPosition(r,o),a=t.getSpinePositionFromSpineItemPosition({spineItemPosition:s,spineItem:r});return le({position:a,pageSizeWidth:n.getPageSize().width,visibleAreaRectWidth:n.state.visibleAreaRect.width})}return new _({x:0,y:0})},sl=({pageIndex:e,spineItemsManager:t,spineItemId:n,context:i,spineLocator:r,spineItemNavigationResolver:o})=>{const s=t.get(n);if(!s){const l=e*i.getPageSize().width;return Dt({viewportPosition:new _({x:l,y:0}),context:i,spineItemNavigationResolver:o,spineLocator:r})}const a=r.spineItemLocator.getSpineItemPositionFromPageIndex({pageIndex:e,spineItem:s}),u=r.getSpinePositionFromSpineItemPosition({spineItemPosition:a,spineItem:s});return le({position:u,pageSizeWidth:i.getPageSize().width,visibleAreaRectWidth:i.state.visibleAreaRect.width})},al=({anchor:e,spineItem:t,context:n})=>{var i;const r=((i=t.layout.layoutInfo)==null?void 0:i.width)||0,o=n.getPageSize().width,s=t.getBoundingRectOfElementFromSelector(e),a=(s==null?void 0:s.x)||0;return nt(a,o,r)},ul=({anchor:e,context:t,spineItem:n,spineLocator:i})=>{const r=al({anchor:e,spineItem:n,context:t});return i.getSpinePositionFromSpineItemPosition({spineItemPosition:new k({x:r,y:0}),spineItem:n})},ll=({anchor:e,spineItem:t,spineLocator:n,context:i,pageSizeWidth:r,visibleAreaRectWidth:o})=>{const s=ul({anchor:e,context:i,spineItem:t,spineLocator:n});return le({position:s,pageSizeWidth:r,visibleAreaRectWidth:o})},cl=({context:e,spineItemsManager:t,spineLocator:n,url:i,pageSizeWidth:r,visibleAreaRectWidth:o})=>{var s;try{const a=i instanceof URL?i:new URL(i),u=`${a.origin}${a.pathname}`,l=(s=e.manifest)==null?void 0:s.spineItems.find(c=>c.href===u);if(l){const c=t.get(l.id);if(c){const d=ll({anchor:a.hash,spineItem:c,context:e,spineLocator:n,pageSizeWidth:r,visibleAreaRectWidth:o});return{position:le({position:d,pageSizeWidth:r,visibleAreaRectWidth:o}),spineItemId:l.id}}}return}catch(a){console.error(a);return}},dl=({spineItem:e,spineItemPosition:t,spineLocator:n,spineItemLocator:i,context:r})=>{const o=i.getSpineItemClosestPositionFromUnsafePosition(t,e),s=n.getSpinePositionFromSpineItemPosition({spineItemPosition:o,spineItem:e});return le({position:s,pageSizeWidth:r.getPageSize().width,visibleAreaRectWidth:r.state.visibleAreaRect.width})},pl="spineNavigator",fl=({context:e,spineItemsManager:t,locator:n,settings:i,spineLayout:r})=>{const o=ol({context:e,settings:i});return{getNavigationForUrl:s=>cl({context:e,spineItemsManager:t,spineLocator:n,url:s,pageSizeWidth:e.getPageSize().width,visibleAreaRectWidth:e.state.visibleAreaRect.width}),getNavigationForSpineItemPage:s=>sl({...s,context:e,spineItemsManager:t,spineItemNavigationResolver:o,spineLocator:n}),getNavigationFromSpineItemPosition:s=>dl({...s,spineItemLocator:n.spineItemLocator,spineLocator:n,context:e}),getNavigationForCfi:s=>{const a=t.getSpineItemFromCfi(s),{node:u,offset:l=0}=Zi({cfi:s,spineItemsManager:t})||{};if(!a){q.warn(pl,`unable to detect item id from cfi ${s}`);return}const c=u?o.getNavigationFromNode(a,u,l):new k({x:0,y:0}),d=n.getSpinePositionFromSpineItemPosition({spineItemPosition:c,spineItem:a});return le({position:d,pageSizeWidth:e.getPageSize().width,visibleAreaRectWidth:e.state.visibleAreaRect.width})},getNavigationForLastPage:s=>{const a=o.getNavigationForLastPage(s),u=n.getSpinePositionFromSpineItemPosition({spineItemPosition:a,spineItem:s});return le({position:u,pageSizeWidth:e.getPageSize().width,visibleAreaRectWidth:e.state.visibleAreaRect.width})},getNavigationForSpineIndexOrId:s=>{const a=t.get(s);if(a){const u=n.getSpinePositionFromSpineItem(a);return le({position:u,pageSizeWidth:e.getPageSize().width,visibleAreaRectWidth:e.state.visibleAreaRect.width})}return new _({x:0,y:0})},getNavigationForPosition:s=>Dt({viewportPosition:s,context:e,spineItemNavigationResolver:o,spineLocator:n}),getMostPredominantNavigationForPosition:s=>{const a=i.values.computedPageTurnDirection,u=.5,l=a==="horizontal"?s.x+e.state.visibleAreaRect.width*u:0,c=a==="horizontal"?0:s.y+e.state.visibleAreaRect.height*u,d=Yn({position:new _({x:l,y:c}),isRTL:e.isRTL(),pageSizeHeight:e.getPageSize().height,visibleAreaRectWidth:e.state.visibleAreaRect.width,spineItemsManager:t,spineLayout:r});return Dt({context:e,spineItemNavigationResolver:o,spineLocator:n,viewportPosition:d})},getAdjustedPositionWithSafeEdge:s=>Yn({position:s,isRTL:e.isRTL(),pageSizeHeight:e.getPageSize().height,visibleAreaRectWidth:e.state.visibleAreaRect.width,spineItemsManager:t,spineLayout:r}),isNavigationGoingForwardFrom:(s,a)=>i.values.computedPageTurnDirection==="vertical"?s.y>a.y:s.x>a.x,arePositionsDifferent:(s,a)=>s.x!==a.x||s.y!==a.y,getAdjustedPositionForSpread:s=>le({position:s,pageSizeWidth:e.getPageSize().width,visibleAreaRectWidth:e.state.visibleAreaRect.width}),spineItemNavigator:o}},hl=({spineItemsManager:e,context:t,hookManager:n,spine:i,settings:r,viewport:o})=>{const s=new V,a=new er,u=fl({context:t,settings:r,spineItemsManager:e,locator:i.locator,spineLayout:i.spineLayout}),l=new nl(r,n,t,i,o),c=new il(o,r,n,i,t),d=new Ku(r,t,i,c,a),p=E(s,d.navigation$),f=new Zu(r,t,p,l,c,u,i,a.isLocked$),h=K([l.isNavigating$,c.isNavigating$,a.isLocked$,f.locker.isLocked$]).pipe(b(g=>g.some(v=>v)?"busy":"free"),O(),Q(1));return{destroy:()=>{d.destroy(),l.destroy(),f.destroy()},getNavigation:()=>f.navigation,internalNavigator:f,scrollNavigationController:c,controlledNavigationController:l,locker:a,viewportState$:h,navigate:g=>{s.next(g)},lock(){return a.lock()},navigationResolver:u,navigation$:f.navigation$}};class gl extends ze{constructor(t,n){super({beginPageIndexInSpineItem:void 0,beginNumberOfPagesInSpineItem:0,beginCfi:void 0,beginSpineItemIndex:void 0,endPageIndexInSpineItem:void 0,endNumberOfPagesInSpineItem:0,endCfi:void 0,endSpineItemIndex:void 0,navigationId:void 0}),this.context=t,this.spineItemsManager=n}update(t){this.mergeCompare(t)}}class ml extends ee{constructor(t,n,i,r,o){super(),this.context=t,this.pagination=n,this.spineItemsManager=i,this.spine=r,this.spineItemLocator=o;const s=E(this.context.bridgeEvent.navigation$,r.spineLayout.layout$).pipe(I(()=>{const u=({spineItem:l,position:c})=>this.spine.locator.getVisiblePagesFromViewportPosition({spineItem:l,position:c,threshold:.5});return this.context.bridgeEvent.navigationUnlocked$.pipe(Ve(1),z(this.context.bridgeEvent.navigation$),x(([,l])=>{const{position:c}=l,d=this.pagination.value,{beginIndex:p,endIndex:f}=this.spine.locator.getVisibleSpineItemsFromPosition({position:c,threshold:.5})??{},h=this.spineItemsManager.get(p),g=this.spineItemsManager.get(f);if(!h||!g)return;const v=d.beginCfi,m=d.endCfi,{beginPageIndex:y=0}=u({spineItem:h,position:c})??{},{endPageIndex:w=0}=u({spineItem:g,position:c})??{},S=v===void 0||Ft(v)||d.beginSpineItemIndex!==p,$=d.endSpineItemIndex!==f||m===void 0||Ft(m),T=S?Ce(h.item):v,W=$?Ce(g.item):m,F=h.numberOfPages,D=g.numberOfPages;this.pagination.update({beginCfi:T,beginNumberOfPagesInSpineItem:F,beginPageIndexInSpineItem:y,beginSpineItemIndex:p,endCfi:W,endNumberOfPagesInSpineItem:D,endPageIndexInSpineItem:w,endSpineItemIndex:f,navigationId:l.id})}))})),a=s.pipe(ct(this.context.bridgeEvent.viewportFree$),x(()=>{const{beginSpineItemIndex:u,endSpineItemIndex:l,beginPageIndexInSpineItem:c,endPageIndexInSpineItem:d}=this.pagination.value;if(c===void 0||d===void 0||u===void 0||l===void 0)return;const p=this.spineItemsManager.get(u),f=this.spineItemsManager.get(l);p===void 0||f===void 0||this.pagination.update({beginCfi:Rt({pageIndex:c,spineItem:p,spineItemLocator:o}),endCfi:Rt({pageIndex:d,spineItem:f,spineItemLocator:o})})}));E(s,a).pipe(L(this.destroy$)).subscribe()}}class vl extends ee{constructor(t){super();const n={...this.getDefaultSettings(),...t};this.inputSettings=n,this.outputSettingsUpdateSubject=new V,this._settings$=this.outputSettingsUpdateSubject.asObservable().pipe(Q(1)),this._settings$.subscribe()}_prepareUpdate(t){const n=Ke(this.inputSettings,t),i=this.getOutputSettings(n),r=!H(this.outputSettings,i);return{hasChanged:r,state:i,commit:()=>(this.inputSettings=n,this.outputSettings=i,r&&this.outputSettingsUpdateSubject.next(i),i)}}update(t){const{commit:n}=this._prepareUpdate(t);n()}get values(){if(!this.outputSettings){const{commit:t}=this._prepareUpdate(this.inputSettings);return t()}return this.outputSettings}get values$(){if(!this.outputSettings){const{commit:t}=this._prepareUpdate(this.inputSettings);t()}return this._settings$}watch(t){return this.values$.pipe(Wi(t),O(H))}destroy(){super.destroy(),this.outputSettingsUpdateSubject.complete()}}class yl extends vl{constructor(t,n){super(t),this.context=n;const i=K([n.hasVerticalWriting$,n.manifest$]).pipe(x(()=>{this.update(this.values)})),r=this.values$.pipe(x(({forceSinglePageMode:o})=>{n.update({forceSinglePageMode:o})}));E(i,r).pipe(L(n.destroy$)).subscribe()}getComputedSettings(t){const n=this.context.manifest,i=this.context.state.hasVerticalWriting??!1,r={computedPageTurnDirection:t.pageTurnDirection,computedPageTurnAnimation:t.pageTurnAnimation,computedPageTurnMode:t.pageTurnMode,computedPageTurnAnimationDuration:0};return(n==null?void 0:n.renditionFlow)==="scrolled-continuous"&&(r.computedPageTurnMode="scrollable"),r.computedPageTurnMode==="scrollable"&&(r.computedPageTurnDirection="vertical"),i&&r.computedPageTurnAnimation==="slide"&&(q.warn(`pageTurnAnimation ${r.computedPageTurnAnimation} incompatible with current book, switching back to default`),r.computedPageTurnAnimation="none"),r.computedPageTurnMode==="scrollable"?(r.computedPageTurnAnimationDuration=0,r.computedPageTurnAnimation="none"):r.computedPageTurnAnimationDuration=t.pageTurnAnimationDuration!==void 0?t.pageTurnAnimationDuration:300,r}getOutputSettings(t){const n=this.getComputedSettings(t);return{...this.outputSettings,...t,...n}}getDefaultSettings(){return{forceSinglePageMode:!1,pageTurnAnimation:"slide",pageTurnDirection:"horizontal",pageTurnAnimationDuration:void 0,pageTurnMode:"controlled",snapAnimationDuration:300,navigationSnapThreshold:.3,numberOfAdjacentSpineItemToPreLoad:3}}}class bl extends ee{constructor(t,n,i,r,o,s){super(),this.item=t,this.containerElement=n,this.context=i,this.hookManager=r,this.renderer=o,this.settings=s,this.layoutTriggerSubject=new V,this.lastLayout=null,this.applyDimsAfterLayout=({blankPagePosition:a,minimumWidth:u})=>l=>l.pipe(b(c=>{var d;const p=H((d=this.lastLayout)==null?void 0:d.pageSize,this.context.getPageSize())?this.lastLayout:void 0,{width:f,height:h}=p??{},{width:g=f,height:v=h}=c??{},{width:m,height:y}=this.context.getPageSize(),w=this.validateDimension(g??m,m,u),S=this.settings.values.computedPageTurnMode==="scrollable"?v??y:this.validateDimension(v??y,y,y);return this.lastLayout={width:w,height:S,pageSize:this.context.getPageSize()},this.containerElement.style.width=`${w}px`,this.containerElement.style.height=`${S}px`,this.hookManager.execute("item.onAfterLayout",void 0,{blankPagePosition:a,item:this.item,minimumWidth:u}),{width:w,height:S}})),this.layout=a=>{const u=oa(this.layout$.pipe(B()));return this.layoutTriggerSubject.next(a),u()},this.adjustPositionOfElement=({right:a,left:u,top:l})=>{a!==void 0?this.containerElement.style.right=`${a}px`:this.containerElement.style.removeProperty("right"),u!==void 0?this.containerElement.style.left=`${u}px`:this.containerElement.style.removeProperty("left"),l!==void 0?this.containerElement.style.top=`${l}px`:this.containerElement.style.removeProperty("top")},this.layoutProcess$=this.layoutTriggerSubject.pipe(I(a=>{const{blankPagePosition:u,minimumWidth:l,spreadPosition:c}=a;this.hookManager.execute("item.onBeforeLayout",void 0,{blankPagePosition:u,item:this.item,minimumWidth:l});const d=this.renderer.layout({blankPagePosition:u,minPageSpread:l/this.context.getPageSize().width,minimumWidth:l,spreadPosition:c});return E(P({type:"start"}),d.pipe(this.applyDimsAfterLayout(a),b(p=>({type:"end",data:p}))))}),U()),this.layout$=this.layoutProcess$.pipe(M(a=>a.type==="end"),b(a=>a.data),U())}validateDimension(t,n,i){if(t<=0)return i;const r=Math.max(t,i),o=Math.ceil(r/n)*n;return Math.max(o,n)}get layoutInfo(){const t=this.containerElement.style,n=t.width?parseFloat(t.width):0,i=t.height?parseFloat(t.height):0;return{width:n,height:i}}}class wl extends un{onUnload(){return ie}onCreateDocument(){return P(document.createElement("div"))}onLoadDocument(){return ie}onLayout(){return P(void 0)}onRenderHeadless(){return ie}getDocumentFrame(){}}class ir extends ee{constructor(t,n,i,r,o,s){var a,u;super(),this.item=t,this.parentElement=n,this.context=i,this.settings=r,this.hookManager=o,this.index=s,this.getBoundingRectOfElementFromSelector=d=>{var p,f,h,g;const v=this.renderer.getDocumentFrame();if(v&&v instanceof HTMLIFrameElement&&d)return d.startsWith("#")?(f=(p=v.contentDocument)==null?void 0:p.getElementById(d.replace("#","")))==null?void 0:f.getBoundingClientRect():(g=(h=v.contentDocument)==null?void 0:h.querySelector(d))==null?void 0:g.getBoundingClientRect()},this.load=()=>{this.renderer.load()},this.unload=()=>{this.renderer.unload()},this.destroy=()=>{super.destroy(),this.containerElement.remove(),this.renderer.destroy()},this.isUsingVerticalWriting=()=>{var d;return!!((d=this.renderer.writingMode)!=null&&d.startsWith("vertical"))},this.containerElement=Il(n,t,o),n.appendChild(this.containerElement);const l=(u=(a=this.settings.values).getRenderer)==null?void 0:u.call(a,t);this.resourcesHandler=new ln(t,this.settings);const c={context:i,settings:r,hookManager:o,item:t,containerElement:this.containerElement,resourcesHandler:this.resourcesHandler};this.renderer=l?l(c):new wl(c),this.layout=new bl(t,this.containerElement,i,o,this.renderer,this.settings),this.isReady$=this.layout.layoutProcess$.pipe(z(this.renderer.isLoaded$),b(([d,p])=>!!(d.type==="end"&&p)),se(!1),O(),x(d=>{this.containerElement.dataset.isReady=d.toString()}),Q({refCount:!0,bufferSize:1})),this.needsLayout$=E(this.unloaded$,this.loaded$),E(this.isReady$,this.layout.layout$).pipe(L(this.destroy$)).subscribe()}get element(){return this.containerElement}get readingDirection(){return this.renderer.readingDirection}get loaded$(){return this.renderer.state$.pipe(O(),M(t=>t==="loaded"))}get unloaded$(){return this.renderer.state$.pipe(O(),M(t=>t!=="idle"),I(()=>this.renderer.state$.pipe(M(t=>t==="idle"),B())))}get renditionLayout(){return this.renderer.renditionLayout}get numberOfPages(){return pn({isUsingVerticalWriting:!!this.isUsingVerticalWriting(),itemHeight:this.layout.layoutInfo.height,itemWidth:this.layout.layoutInfo.width,context:this.context,settings:this.settings})}}const Il=(e,t,n)=>{const i=e.ownerDocument.createElement("div");return i.classList.add("spineItem"),i.classList.add(`spineItem-${t.renditionLayout??"reflowable"}`),i.style.cssText=`
    position: absolute;
    overflow: hidden;
  `,i.dataset.isReady="false",n.execute("item.onBeforeContainerCreated",void 0,{element:i}),i};class Sl extends ee{constructor(t,n){super(),this.spineItemsManager=t,this.spineLocator=n,this.itemIsReady$=this.spineItemsManager.items$.pipe(I(i=>{const r=i.map(o=>o.isReady$.pipe(b(s=>({item:o,isReady:s}))));return E(...r)}),U()),this.itemResize$=this.spineItemsManager.items$.pipe(I(i=>{const r=i.map(o=>ki(o.element).pipe(b(s=>({entries:s,item:o}))));return E(...r)}),U()),this.itemLoaded$=this.spineItemsManager.items$.pipe(I(i=>{const r=i.map(o=>o.loaded$.pipe(b(()=>o)));return E(...r)}))}}const xl=({horizontalOffset:e,verticalOffset:t,context:n,spineItemsManager:i,isGloballyPrePaginated:r,settings:o,index:s,item:a,viewport:u})=>{let l=n.getPageSize().width,c="none";const d=e%u.absoluteViewport.width===0,p=s===i.items.length-1;if(n.state.isUsingSpreadMode){!r&&a.renditionLayout==="reflowable"&&!p&&(l=n.getPageSize().width*2),!r&&a.renditionLayout==="reflowable"&&p&&d&&(l=n.getPageSize().width*2);const f=d&&p&&r;a.item.pageSpreadRight&&d&&!n.isRTL()||a.item.pageSpreadLeft&&d&&n.isRTL()?(c="before",l=n.getPageSize().width*2):f&&(n.isRTL()?c="before":c="after",l=n.getPageSize().width*2)}return a.layout.layout({minimumWidth:l,blankPagePosition:c,spreadPosition:n.state.isUsingSpreadMode?d?n.isRTL()?"right":"left":n.isRTL()?"left":"right":"none"}).pipe(b(({width:f,height:h})=>{if(o.values.computedPageTurnDirection==="vertical"){const m=d?t:t-n.state.visibleAreaRect.height,y=d?0:e;n.isRTL()?a.layout.adjustPositionOfElement({top:m,left:y}):a.layout.adjustPositionOfElement({top:m,left:y});const w=f+y,S=h+m,$=new _t({left:y,right:w,top:m,bottom:S,height:h,width:f,x:y,y:m});return{horizontalOffset:w,verticalOffset:S,layoutPosition:$}}a.layout.adjustPositionOfElement(n.isRTL()?{right:e,top:0}:{left:e,top:0});const g=n.isRTL()?u.absoluteViewport.width-e-f:e,v=new _t({right:n.isRTL()?u.absoluteViewport.width-e:e+f,left:g,x:g,top:t,bottom:h,height:h,width:f,y:t});return{horizontalOffset:e+f,verticalOffset:0,layoutPosition:v}}))};class Pl extends ee{constructor(t,n,i,r){super(),this.spineItemsManager=t,this.context=n,this.settings=i,this.viewport=r,this.layoutSubject=new V,this.spineItemsRelativeLayouts=[],t.items$.pipe(x(()=>{this.spineItemsRelativeLayouts=[]}),I(s=>{const a=s.map(l=>l.needsLayout$.pipe(x(()=>{this.layout()}))),u=s.map(l=>l.loaded$.pipe(x(()=>{l.isUsingVerticalWriting()?this.context.update({hasVerticalWriting:!0}):this.context.update({hasVerticalWriting:!1})})));return E(...a,...u)})).pipe(L(this.destroy$)).subscribe();const o=new Y(!1);this.layout$=this.layoutSubject.pipe(Ee(50),Et(()=>o.pipe(M(s=>!s),B())),Et(()=>{o.next(!0);const s=this.context.manifest,a=Qi(s)??!1;return N(this.spineItemsManager.items).pipe(ns((u,l,c)=>u.pipe(Mn(({horizontalOffset:d,verticalOffset:p,pages:f})=>xl({context:this.context,horizontalOffset:d,index:c,isGloballyPrePaginated:a,item:l,settings:this.settings,spineItemsManager:this.spineItemsManager,verticalOffset:p,viewport:r}).pipe(b(({horizontalOffset:h,verticalOffset:g,layoutPosition:v})=>(this.spineItemsRelativeLayouts[c]=v,{horizontalOffset:h,verticalOffset:g,pages:[...f,v]}))))),P({horizontalOffset:0,verticalOffset:0,pages:[]})),Mn(u=>u),ve(()=>{o.next(!1)}))}),U()),E(this.layout$).pipe(L(this.destroy$)).subscribe()}layout(){this.layoutSubject.next(void 0)}getSpineItemSpineLayoutInfo(t){const n=this.spineItemsManager.getSpineItemIndex(t)??0;return this.spineItemsRelativeLayouts[n]||new _t({left:0,right:0,top:0,bottom:0,width:0,height:0,x:0,y:0})}get numberOfPages(){return this.spineItemsManager.items.reduce((t,n)=>t+n.numberOfPages,0)}destroy(){super.destroy(),this.layoutSubject.complete()}}class $l extends ee{constructor(t,n,i,r,o){super(),this.context=t,this.spineItemsManager=n,this.spineLocator=i,this.settings=r,this.spineLayout=o,this.forcedOpenSubject=new Y([]);const s=this.forcedOpenSubject.pipe(b(a=>[...new Set(a.flat())].sort()),O(Is),Q({bufferSize:1,refCount:!0}));E(this.context.bridgeEvent.navigation$,this.spineLayout.layout$,s,r.watch(["numberOfAdjacentSpineItemToPreLoad"])).pipe(Ee(100,fe),ct(this.context.bridgeEvent.viewportFree$),z(this.context.bridgeEvent.navigation$,s),b(([,a,u])=>{const{numberOfAdjacentSpineItemToPreLoad:l}=r.values,{beginIndex:c=0,endIndex:d=0}=i.getVisibleSpineItemsFromPosition({position:a.position,threshold:0,useAbsoluteViewport:!1})||{},p=c-l,f=d+l,h=Array.from({length:f-p+1},(v,m)=>p+m),g=[...u,...h];n.items.forEach((v,m)=>{g.includes(m)?v.load():v.unload()})})).pipe(L(this.destroy$)).subscribe()}forceOpen(t){const n=t.map(i=>typeof i=="number"?i:i.index);return this.forcedOpenSubject.next([...this.forcedOpenSubject.value,n]),()=>{this.isDestroyed||this.forcedOpenSubject.next(this.forcedOpenSubject.value.filter(i=>i!==n))}}destroy(){super.destroy(),this.forcedOpenSubject.complete()}}const rr=(e,t,n)=>{const i=(n.width-t.width)/2,r=(n.height-t.height)/2;return new cn({x:e.x-i,y:e.y-r})};class Ne extends DOMRect{constructor(){super(...arguments),this.__symbol=Symbol("ViewportPosition")}static from(t,n){if(n){const r=t;return new Ne(r.x,r.y,n.width,n.height)}const i=t;return new Ne(i.x,i.y,i.width,i.height)}}class El{constructor({width:t,height:n}){this.__symbol=Symbol("AbsoluteViewport"),this.width=t,this.height=n}}class Ll{constructor({width:t,height:n}){this.__symbol=Symbol("RelativeViewport"),this.width=t,this.height=n}}const Tl=({pageIndex:e,spineItemOrId:t,spineItemsManager:n})=>{const i=n.items,r=n.get(t);if(!r)return;const{currentAbsolutePage:o}=i.reduce((s,a)=>{if(s.found)return s;const u=a.numberOfPages;return r===a&&e<=u-1?{currentAbsolutePage:s.currentAbsolutePage+e,found:!0}:{...s,currentAbsolutePage:s.currentAbsolutePage+u}},{currentAbsolutePage:0,found:!1});return o},Ml=({itemHeight:e,itemWidth:t,visibleWidthOfItem:n,visibleHeightOfItem:i,threshold:r})=>{const o=n/t,s=i/e;return o>=r&&s>=r},Ol=({visibleWidthOfItem:e,visibleHeightOfItem:t,threshold:n,viewportPosition:i})=>{const r=e/i.width;return t/i.height>=n&&r>=n},or=({itemPosition:{bottom:e,left:t,right:n,top:i,width:r,height:o},threshold:s,viewportPosition:a,restrictToScreen:u})=>{const l=a.x,c=a.x+(a.width-1),d=a.y,p=Math.max(a.y+(a.height-1),0),f=Math.max(0,Math.min(n,c)-Math.max(t,l)),h=Math.max(0,Math.min(e,p)-Math.max(i,d));if(f<=0||h<=0)return{visible:!1};const g=Ol({threshold:s,visibleHeightOfItem:h,visibleWidthOfItem:f,viewportPosition:a});return u?{visible:g}:{visible:Ml({itemHeight:o,itemWidth:r,threshold:s,visibleHeightOfItem:h,visibleWidthOfItem:f})||g}},Al=({absolutePageIndex:e,spineItemsManager:t})=>{const n=t.items,{found:i,currentAbsolutePage:r}=n.reduce((o,s)=>{if(o.found)return o;const a=s.numberOfPages,u=e-o.currentAbsolutePage,l=o.currentAbsolutePage+a;return u<=a-1?{...o,currentAbsolutePage:l,found:{item:s,pageIndex:u}}:{...o,currentAbsolutePage:l}},{currentAbsolutePage:0});if(i)return{spineItem:i.item,pageIndex:i.pageIndex,itemIndex:t.getSpineItemIndex(i.item)??0,currentAbsolutePage:r}},sr=({position:e,spineItemsManager:t,spineLayout:n,settings:i})=>{const r=t.items.find(o=>{const{left:s,right:a,bottom:u,top:l}=n.getSpineItemSpineLayoutInfo(o),c=e.x>=s&&e.x<a;return i.values.computedPageTurnDirection==="horizontal"?c:c&&e.y>=l&&e.y<u});return e.x===0&&!r?t.items[0]:r},vt=({spineItemPosition:e,itemLayout:{left:t,top:n}})=>new _({x:t+e.x,y:n+e.y}),_l=({position:e,threshold:t,restrictToScreen:n,spineItemsManager:i,settings:r,spineLayout:o,useAbsoluteViewport:s=!0,viewport:a})=>{const u=sr({position:e,settings:r,spineItemsManager:i,spineLayout:o})||i.get(0),l=i.items.reduce((h,g)=>{const v=o.getSpineItemSpineLayoutInfo(g),m=s?a.absoluteViewport:a.relativeViewport,y=rr(e,a.absoluteViewport,m),w=Ne.from(y,m),{visible:S}=or({itemPosition:v,threshold:t,viewportPosition:w,restrictToScreen:n});return S?[...h,g]:h},[]),c=l[0]??u,d=l[l.length-1]??c;if(!c||!d)return;const p=i.getSpineItemIndex(c),f=i.getSpineItemIndex(d);return{beginIndex:p??0,endIndex:f??0}},Rl=({spineItemsManager:e,context:t,spineItemLocator:n,settings:i,spineLayout:r,viewport:o})=>{const s=(d,p)=>{const{left:f,top:h}=r.getSpineItemSpineLayoutInfo(p);return new k({x:Math.max(d.x-f,0),y:Math.max(d.y-h,0)})},a=d=>vt({spineItemPosition:new k({x:0,y:0}),itemLayout:r.getSpineItemSpineLayoutInfo(d)}),u=d=>e.items.find(p=>p.renderer.getDocumentFrame()===d),l=(d,p,f)=>{if(typeof f=="number"){const h=e.get(f);return h?n.getSpineItemPageIndexFromNode(d,p||0,h):void 0}return n.getSpineItemPageIndexFromNode(d,p||0,f)},c=({position:d,threshold:p,spineItem:f,restrictToScreen:h,useAbsoluteViewport:g=!0,viewport:v})=>{const m=f.numberOfPages,y=Array.from(Array(m)).map(($,T)=>{const W=n.getSpineItemPositionFromPageIndex({pageIndex:T,spineItem:f}),F=vt({spineItemPosition:W,itemLayout:r.getSpineItemSpineLayoutInfo(f)});return{index:T,absolutePosition:{width:t.getPageSize().width,height:t.getPageSize().height,left:F.x,top:F.y,bottom:F.y+t.getPageSize().height,right:F.x+t.getPageSize().width}}}).reduce(($,{absolutePosition:T,index:W})=>{const F=g?v.absoluteViewport:v.relativeViewport,D=rr(d,v.absoluteViewport,F),X=Ne.from(D,F),{visible:te}=or({viewportPosition:X,restrictToScreen:h,threshold:p,itemPosition:T});return te?[...$,W]:$},[]),w=y[0],S=y[y.length-1]??w;if(!(w===void 0||S===void 0))return{beginPageIndex:w,endPageIndex:S}};return{getSpinePositionFromSpineItemPosition:({spineItem:d,spineItemPosition:p})=>{const f=r.getSpineItemSpineLayoutInfo(d);return vt({itemLayout:f,spineItemPosition:p})},getAbsolutePageIndexFromPageIndex:d=>Tl({...d,spineItemsManager:e}),getSpineInfoFromAbsolutePageIndex:d=>Al({...d,spineItemsManager:e}),getSpinePositionFromSpineItem:a,getSpineItemPositionFromSpinePosition:s,getSpineItemFromPosition:d=>sr({position:d,settings:i,spineItemsManager:e,spineLayout:r}),getSpineItemFromIframe:u,getSpineItemPageIndexFromNode:l,getVisibleSpineItemsFromPosition:d=>_l({settings:i,spineItemsManager:e,spineLayout:r,viewport:o,...d}),getVisiblePagesFromViewportPosition:d=>c({...d,viewport:o}),isPositionWithinSpineItem:(d,p)=>{const{bottom:f,left:h,right:g,top:v}=r.getSpineItemSpineLayoutInfo(p);return d.x>=h&&d.x<=g&&d.y<=f&&d.y>=v},spineItemLocator:n,getSafeSpineItemPositionFromUnsafeSpineItemPosition:(d,p)=>{const{height:f,width:h}=r.getSpineItemSpineLayoutInfo(p);return new k({x:Math.min(Math.max(0,d.x),h),y:Math.min(Math.max(0,d.y),f)})}}};class Fl extends ee{constructor(t,n,i,r,o,s,a,u){super(),this.parentElement$=t,this.context=n,this.pagination=i,this.spineItemsManager=r,this.spineItemLocator=o,this.settings=s,this.hookManager=a,this.viewport=u,this.elementSubject=new Y(Ks()),this.element$=this.elementSubject.asObservable(),this.spineLayout=new Pl(r,n,s,u),this.locator=Rl({context:n,spineItemsManager:r,spineItemLocator:o,settings:s,spineLayout:this.spineLayout,viewport:u}),this.spineItemsLoader=new $l(this.context,r,this.locator,s,this.spineLayout),this.spineItemsObserver=new Sl(r,this.locator);const l=n.manifest$.pipe(x(d=>{this.spineItemsManager.destroyItems();const p=d.spineItems.map((f,h)=>new ir(f,this.elementSubject.getValue(),this.context,this.settings,this.hookManager,h));this.spineItemsManager.addMany(p)})),c=t.pipe(x(d=>{const p=d.ownerDocument.createElement("div");p.style.cssText=`
          height: 100%;
          position: relative;
        `,p.className=`${Le}-spine`,this.elementSubject.next(p)}));E(l,c).pipe(L(this.destroy$)).subscribe()}get element(){return this.elementSubject.getValue()}layout(){this.spineLayout.layout()}destroy(){super.destroy(),this.spineItemsLoader.destroy(),this.elementSubject.getValue().remove(),this.elementSubject.complete()}}class jl extends ee{constructor(t,n){super(),this.context=t,this.settings=n,this.orderedSpineItemsSubject=new Y([]),this.items$=this.orderedSpineItemsSubject.asObservable()}get(t){return typeof t=="number"?this.orderedSpineItemsSubject.value[t]:typeof t=="string"?this.orderedSpineItemsSubject.value.find(({item:n})=>n.id===t):t}comparePositionOf(t,n){const i=this.getSpineItemIndex(t)??0,r=this.getSpineItemIndex(n)??0;return i>r?"after":i===r?"same":"before"}getSpineItemIndex(t){const n=t instanceof ir?t:this.get(t);if(!n)return;const i=this.orderedSpineItemsSubject.value.indexOf(n);return i<0?void 0:i}addMany(t){this.orderedSpineItemsSubject.next([...this.orderedSpineItemsSubject.getValue(),...t])}getSpineItemFromCfi(t){const{itemIndex:n}=dn(t);if(n!==void 0)return this.get(n)}get items(){return this.orderedSpineItemsSubject.value}destroyItems(){this.orderedSpineItemsSubject.value.forEach(t=>t.destroy())}}class Cl extends ze{constructor(t){const n=document.createElement("div");n.style.cssText=`
        background-color: white;
        position: relative;
        -transform: scale(0.2);
        height: 100%;
        width: 100%;
    `,n.className=`${Le}-viewport`,super({element:n,pageSize:{width:1,height:1}}),this.context=t;const i=this.context.watch("visibleAreaRect").pipe(x(()=>{this.mergeCompare({pageSize:this.calculatePageSize()})}));E(i).pipe(L(this.destroy$)).subscribe()}calculatePageSize(){const t=this.absoluteViewport,{isUsingSpreadMode:n}=this.context.state;return{width:n?t.width/2:t.width,height:t.height}}get absoluteViewport(){const t=this.context.state.visibleAreaRect;return new El({width:t.width,height:t.height})}get relativeViewport(){const t=this.absoluteViewport,n=this.value.element.getBoundingClientRect(),i=((n==null?void 0:n.width)??t.width)/t.width;return new Ll({width:t.width/i,height:t.height/i})}}const Dl=e=>{const t=new V,n=new Cu,i=new Fu,r=new yl(e,i),o=new ju(i,r),s=new jl(i,r),a=new Y(void 0),u=new Cl(i),l=a.pipe(M(ge)),c=nr({context:i,settings:r}),d=new gl(i,s),p=new Fl(l,i,d,s,c,r,n,u),f=hl({context:i,spineItemsManager:s,hookManager:n,spine:p,settings:r,viewport:u}),h=new ml(i,d,s,p,c);f.viewportState$.subscribe(i.bridgeEvent.viewportStateSubject),f.navigation$.subscribe(i.bridgeEvent.navigationSubject),f.locker.isLocked$.subscribe(i.bridgeEvent.navigationIsLockedSubject),d.subscribe(i.bridgeEvent.paginationSubject);const g=()=>{var y;const w=(y=a.getValue())==null?void 0:y.parentElement,S=a.getValue();if(!S||!w)return;const $={width:w==null?void 0:w.offsetWidth,height:w==null?void 0:w.offsetHeight},T=0,W=0,F=0;S.style.setProperty("overflow","hidden"),S.style.height=`${$.height-W-F}px`,S.style.width=`${$.width-2*T}px`;const D=S.getBoundingClientRect();i.update({visibleAreaRect:{x:D.x,y:D.y,width:$.width,height:$.height}}),p.layout()},v=y=>{var w;const{containerElement:S,manifest:$}=y;if(i.manifest){q.warn("loading a new book is not supported yet");return}q.log("load",{options:y});const T=Nl(S);S!==((w=a.getValue())==null?void 0:w.parentElement)&&(a.next(T),S.appendChild(T)),i.update({manifest:$,containerElement:S,rootElement:T,forceSinglePageMode:r.values.forceSinglePageMode}),g()},m=()=>{var y;s.destroy(),h.destroy(),r.destroy(),d.destroy(),i.destroy(),f.destroy(),p.destroy(),(y=a.getValue())==null||y.remove(),o.destroy(),t.next(),t.complete(),u.destroy()};return{context:i,spine:p,hookManager:n,cfi:{generateCfiFromRange:tu,generateCfiFromSelection:nu,parseCfi:dn,generateCfiForSpineItemPage:y=>Rt({...y,spineItemLocator:c}),resolveCfi:y=>Zi({...y,spineItemsManager:s})},navigation:f,spineItemsObserver:p.spineItemsObserver,spineItemsManager:s,layout:g,load:v,destroy:m,pagination:{get state(){return d.value},get state$(){return d}},settings:r,viewport:u,element$:l,viewportState$:i.bridgeEvent.viewportState$,viewportFree$:i.bridgeEvent.viewportFree$,state$:i.manifest$.pipe(b(y=>y?"ready":"idle")),features:o,$:{destroy$:t}}},Nl=e=>{const t=e.ownerDocument.createElement("div");return t.style.cssText=`
    background-color: white;
    position: relative;
  `,t.className=`${Le}-reader`,t},Wl=$u(la(za(Tu(ua(zs(wu(Lu(Au(eu(Oa(Ha(Us(Eu(vu(Na(ra(Dl)))))))))))))))));var Nt=function(e,t){return Nt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(n[r]=i[r])},Nt(e,t)};function fn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Nt(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}function kl(e,t,n,i){function r(o){return o instanceof n?o:new n(function(s){s(o)})}return new(n||(n=Promise))(function(o,s){function a(c){try{l(i.next(c))}catch(d){s(d)}}function u(c){try{l(i.throw(c))}catch(d){s(d)}}function l(c){c.done?o(c.value):r(c.value).then(a,u)}l((i=i.apply(e,t||[])).next())})}function ar(e,t){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,r,o,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(l){return function(c){return u([l,c])}}function u(l){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,l[0]&&(n=0)),n;)try{if(i=1,r&&(o=l[0]&2?r.return:l[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,l[1])).done)return o;switch(r=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return n.label++,{value:l[1],done:!1};case 5:n.label++,r=l[1],l=[0];continue;case 7:l=n.ops.pop(),n.trys.pop();continue;default:if(o=n.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){n=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){n.label=l[1];break}if(l[0]===6&&n.label<o[1]){n.label=o[1],o=l;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(l);break}o[2]&&n.ops.pop(),n.trys.pop();continue}l=t.call(e,n)}catch(c){l=[6,c],r=0}finally{i=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function We(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Wt(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var i=n.call(e),r,o=[],s;try{for(;(t===void 0||t-- >0)&&!(r=i.next()).done;)o.push(r.value)}catch(a){s={error:a}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(s)throw s.error}}return o}function kt(e,t,n){if(n||arguments.length===2)for(var i=0,r=t.length,o;i<r;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}function Ie(e){return this instanceof Ie?(this.v=e,this):new Ie(e)}function Vl(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(e,t||[]),r,o=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",s),r[Symbol.asyncIterator]=function(){return this},r;function s(f){return function(h){return Promise.resolve(h).then(f,d)}}function a(f,h){i[f]&&(r[f]=function(g){return new Promise(function(v,m){o.push([f,g,v,m])>1||u(f,g)})},h&&(r[f]=h(r[f])))}function u(f,h){try{l(i[f](h))}catch(g){p(o[0][3],g)}}function l(f){f.value instanceof Ie?Promise.resolve(f.value.v).then(c,d):p(o[0][2],f)}function c(f){u("next",f)}function d(f){u("throw",f)}function p(f,h){f(h),o.shift(),o.length&&u(o[0][0],o[0][1])}}function zl(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],n;return t?t.call(e):(e=typeof We=="function"?We(e):e[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(o){n[o]=e[o]&&function(s){return new Promise(function(a,u){s=e[o](s),r(a,u,s.done,s.value)})}}function r(o,s,a,u){Promise.resolve(u).then(function(l){o({value:l,done:a})},s)}}function Z(e){return typeof e=="function"}function Ul(e){var t=function(i){Error.call(i),i.stack=new Error().stack},n=e(t);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var yt=Ul(function(e){return function(n){e(this),this.message=n?n.length+` errors occurred during unsubscription:
`+n.map(function(i,r){return r+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=n}});function Gn(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var hn=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,n,i,r,o;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=We(s),u=a.next();!u.done;u=a.next()){var l=u.value;l.remove(this)}}catch(g){t={error:g}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}else s.remove(this);var c=this.initialTeardown;if(Z(c))try{c()}catch(g){o=g instanceof yt?g.errors:[g]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var p=We(d),f=p.next();!f.done;f=p.next()){var h=f.value;try{Xn(h)}catch(g){o=o??[],g instanceof yt?o=kt(kt([],Wt(o)),Wt(g.errors)):o.push(g)}}}catch(g){i={error:g}}finally{try{f&&!f.done&&(r=p.return)&&r.call(p)}finally{if(i)throw i.error}}}if(o)throw new yt(o)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)Xn(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(t)}},e.prototype._hasParent=function(t){var n=this._parentage;return n===t||Array.isArray(n)&&n.includes(t)},e.prototype._addParent=function(t){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(t),n):n?[n,t]:t},e.prototype._removeParent=function(t){var n=this._parentage;n===t?this._parentage=null:Array.isArray(n)&&Gn(n,t)},e.prototype.remove=function(t){var n=this._finalizers;n&&Gn(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}();hn.EMPTY;function ur(e){return e instanceof hn||e&&"closed"in e&&Z(e.remove)&&Z(e.add)&&Z(e.unsubscribe)}function Xn(e){Z(e)?e():e.unsubscribe()}var Hl={Promise:void 0},Bl={setTimeout:function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout.apply(void 0,kt([e,t],Wt(n)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function lr(e){Bl.setTimeout(function(){throw e})}function Zn(){}function ql(e){e()}var gn=function(e){fn(t,e);function t(n){var i=e.call(this)||this;return i.isStopped=!1,n?(i.destination=n,ur(n)&&n.add(i)):i.destination=Xl,i}return t.create=function(n,i,r){return new Vt(n,i,r)},t.prototype.next=function(n){this.isStopped||this._next(n)},t.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(n){this.destination.next(n)},t.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(hn),Yl=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var n=this.partialObserver;if(n.next)try{n.next(t)}catch(i){Ge(i)}},e.prototype.error=function(t){var n=this.partialObserver;if(n.error)try{n.error(t)}catch(i){Ge(i)}else Ge(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(n){Ge(n)}},e}(),Vt=function(e){fn(t,e);function t(n,i,r){var o=e.call(this)||this,s;return Z(n)||!n?s={next:n??void 0,error:i??void 0,complete:r??void 0}:s=n,o.destination=new Yl(s),o}return t}(gn);function Ge(e){lr(e)}function Gl(e){throw e}var Xl={closed:!0,next:Zn,error:Gl,complete:Zn},mn=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Zl(e){return e}function Jl(e){return e.length===0?Zl:e.length===1?e[0]:function(n){return e.reduce(function(i,r){return r(i)},n)}}var de=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(t,n,i){var r=this,o=Ql(t)?t:new Vt(t,n,i);return ql(function(){var s=r,a=s.operator,u=s.source;o.add(a?a.call(o,u):u?r._subscribe(o):r._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(n){t.error(n)}},e.prototype.forEach=function(t,n){var i=this;return n=Jn(n),new n(function(r,o){var s=new Vt({next:function(a){try{t(a)}catch(u){o(u),s.unsubscribe()}},error:o,complete:r});i.subscribe(s)})},e.prototype._subscribe=function(t){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(t)},e.prototype[mn]=function(){return this},e.prototype.pipe=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Jl(t)(this)},e.prototype.toPromise=function(t){var n=this;return t=Jn(t),new t(function(i,r){var o;n.subscribe(function(s){return o=s},function(s){return r(s)},function(){return i(o)})})},e.create=function(t){return new e(t)},e}();function Jn(e){var t;return(t=e??Hl.Promise)!==null&&t!==void 0?t:Promise}function Kl(e){return e&&Z(e.next)&&Z(e.error)&&Z(e.complete)}function Ql(e){return e&&e instanceof gn||Kl(e)&&ur(e)}function ec(e){return Z(e==null?void 0:e.lift)}function vn(e){return function(t){if(ec(t))return t.lift(function(n){try{return e(n,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function cr(e,t,n,i,r){return new tc(e,t,n,i,r)}var tc=function(e){fn(t,e);function t(n,i,r,o,s,a){var u=e.call(this,n)||this;return u.onFinalize=s,u.shouldUnsubscribe=a,u._next=i?function(l){try{i(l)}catch(c){n.error(c)}}:e.prototype._next,u._error=o?function(l){try{o(l)}catch(c){n.error(c)}finally{this.unsubscribe()}}:e.prototype._error,u._complete=r?function(){try{r()}catch(l){n.error(l)}finally{this.unsubscribe()}}:e.prototype._complete,u}return t.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;e.prototype.unsubscribe.call(this),!i&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},t}(gn),dr=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function pr(e){return Z(e==null?void 0:e.then)}function fr(e){return Z(e[mn])}function hr(e){return Symbol.asyncIterator&&Z(e==null?void 0:e[Symbol.asyncIterator])}function gr(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function nc(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var mr=nc();function vr(e){return Z(e==null?void 0:e[mr])}function yr(e){return Vl(this,arguments,function(){var n,i,r,o;return ar(this,function(s){switch(s.label){case 0:n=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Ie(n.read())];case 3:return i=s.sent(),r=i.value,o=i.done,o?[4,Ie(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Ie(r)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function br(e){return Z(e==null?void 0:e.getReader)}function yn(e){if(e instanceof de)return e;if(e!=null){if(fr(e))return ic(e);if(dr(e))return rc(e);if(pr(e))return oc(e);if(hr(e))return wr(e);if(vr(e))return sc(e);if(br(e))return ac(e)}throw gr(e)}function ic(e){return new de(function(t){var n=e[mn]();if(Z(n.subscribe))return n.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function rc(e){return new de(function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()})}function oc(e){return new de(function(t){e.then(function(n){t.closed||(t.next(n),t.complete())},function(n){return t.error(n)}).then(null,lr)})}function sc(e){return new de(function(t){var n,i;try{for(var r=We(e),o=r.next();!o.done;o=r.next()){var s=o.value;if(t.next(s),t.closed)return}}catch(a){n={error:a}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}t.complete()})}function wr(e){return new de(function(t){uc(e,t).catch(function(n){return t.error(n)})})}function ac(e){return wr(yr(e))}function uc(e,t){var n,i,r,o;return kl(this,void 0,void 0,function(){var s,a;return ar(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,11]),n=zl(e),u.label=1;case 1:return[4,n.next()];case 2:if(i=u.sent(),!!i.done)return[3,4];if(s=i.value,t.next(s),t.closed)return[2];u.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=u.sent(),r={error:a},[3,11];case 6:return u.trys.push([6,,9,10]),i&&!i.done&&(o=n.return)?[4,o.call(n)]:[3,8];case 7:u.sent(),u.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function me(e,t,n,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var o=t.schedule(function(){n(),r?e.add(this.schedule(null,i)):this.unsubscribe()},i);if(e.add(o),!r)return o}function Ir(e,t){return t===void 0&&(t=0),vn(function(n,i){n.subscribe(cr(i,function(r){return me(i,e,function(){return i.next(r)},t)},function(){return me(i,e,function(){return i.complete()},t)},function(r){return me(i,e,function(){return i.error(r)},t)}))})}function Sr(e,t){return t===void 0&&(t=0),vn(function(n,i){i.add(e.schedule(function(){return n.subscribe(i)},t))})}function lc(e,t){return yn(e).pipe(Sr(t),Ir(t))}function cc(e,t){return yn(e).pipe(Sr(t),Ir(t))}function dc(e,t){return new de(function(n){var i=0;return t.schedule(function(){i===e.length?n.complete():(n.next(e[i++]),n.closed||this.schedule())})})}function pc(e,t){return new de(function(n){var i;return me(n,t,function(){i=e[mr](),me(n,t,function(){var r,o,s;try{r=i.next(),o=r.value,s=r.done}catch(a){n.error(a);return}s?n.complete():n.next(o)},0,!0)}),function(){return Z(i==null?void 0:i.return)&&i.return()}})}function xr(e,t){if(!e)throw new Error("Iterable cannot be null");return new de(function(n){me(n,t,function(){var i=e[Symbol.asyncIterator]();me(n,t,function(){i.next().then(function(r){r.done?n.complete():n.next(r.value)})},0,!0)})})}function fc(e,t){return xr(yr(e),t)}function hc(e,t){if(e!=null){if(fr(e))return lc(e,t);if(dr(e))return dc(e,t);if(pr(e))return cc(e,t);if(hr(e))return xr(e,t);if(vr(e))return pc(e,t);if(br(e))return fc(e,t)}throw gr(e)}function gc(e,t){return t?hc(e,t):yn(e)}function mc(e,t){return vn(function(n,i){var r=0;n.subscribe(cr(i,function(o){i.next(e.call(t,o,r++))}))})}const Pr=no(),vc=Wl({getResource:e=>gc(Pr.getResource(e)).pipe(mc(t=>new Response(t.data,{headers:t.headers}))),forceSinglePageMode:!1,numberOfAdjacentSpineItemToPreLoad:0});io({reader:vc,bridge:Pr,containerElement:document.getElementById("reader")});</script>
    <style rel="stylesheet" crossorigin>body,#reader,html{height:100%;width:100%;box-sizing:border-box;overflow:hidden;margin:0;padding:0}#reader{border:2px solid red}</style>
  </head>
  <body>
    <div id="reader"></div>
  </body>
</html>
