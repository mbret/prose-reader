<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prose Reader</title>
    <script>
      window.__PROSE_READER_DEBUG = true;
    </script>
    <script type="module">function ft(t,e){(e==null||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function Bi(t){if(Array.isArray(t))return ft(t)}function Hi(t,e){return e!=null&&typeof Symbol<"u"&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function qi(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function Xi(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Yi(t){return Bi(t)||qi(t)||Gi(t)||Xi()}function nn(t){"@swc/helpers - typeof";return t&&typeof Symbol<"u"&&t.constructor===Symbol?"symbol":typeof t}function Gi(t,e){if(t){if(typeof t=="string")return ft(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if(n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ft(t,e)}}var Zi=function(){return{events:{},emit:function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];for(var r=this.events[e]||[],s=0,a=r.length;s<a;s++){var u;(u=r)[s].apply(u,Yi(i))}},on:function(e,n){var i=this;if(!this.events[e])this.events[e]=[n];else{var o;(o=this.events[e])===null||o===void 0||o.push(n)}return function(){var r;i.events[e]=(r=i.events[e])===null||r===void 0?void 0:r.filter(function(s){return n!==s})}}}},Ji=function(t){var e=t.emitter,n=t.evaluate,i=t.eventId,o=t.failHandler,r=o===void 0?!1:o,s=t.methodName,a=t.onFallback;return new Promise(function(u,c){var l=e.on("".concat(s,"-").concat(i),function(d,p){l(),p?Hi(r,Error)?(a==null||a(),c(r)):u(void 0):u(d)});n()})},on="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ki=21,Mn=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ki,e=Array.from({length:t},function(){return on[Math.floor(Math.random()*on.length)]});return e.join("")},ht=function(t,e){if(t===e)return!0;if(t&&e&&(typeof t>"u"?"undefined":nn(t))==="object"&&(typeof e>"u"?"undefined":nn(e))==="object"){var n=Array.isArray(t),i=Array.isArray(e),o,r,s;if(n&&i){if(r=t.length,r!==e.length)return!1;for(o=r;o--!==0;)if(!ht(t[o],e[o]))return!1;return!0}if(n!==i)return!1;var a=Object.keys(t);if(r=a.length,r!==Object.keys(e).length)return!1;for(o=r;o--!==0;)if(!Object.prototype.hasOwnProperty.call(e,a[o]))return!1;for(o=r;o--!==0;)if(s=a[o],!ht(t[s],e[s]))return!1;return!0}return t!==t&&e!==e},Qi=function(t){var e=!0,n=!1,i=void 0;try{for(var o=Object.keys(t)[Symbol.iterator](),r;!(e=(r=o.next()).done);e=!0){var s=r.value;t[s]===void 0&&delete t[s]}}catch(a){n=!0,i=a}finally{try{!e&&o.return!=null&&o.return()}finally{if(n)throw i}}return t},eo=function(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return new Promise(function(n,i){setTimeout(function(){e?i(new Error("Timeout")):n(void 0)},t)})};function gt(t,e){(e==null||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function Ln(t){if(Array.isArray(t))return t}function to(t){if(Array.isArray(t))return gt(t)}function no(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Rn(t,e,n){return e=Te(e),lo(t,Ct()?Reflect.construct(e,n||[],Te(t).constructor):e.apply(t,n))}function Mt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ze(t,e,n){return Ct()?ze=Reflect.construct:ze=function(o,r,s){var a=[null];a.push.apply(a,r);var u=Function.bind.apply(o,a),c=new u;return s&&Ee(c,s.prototype),c},ze.apply(null,arguments)}function io(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function oo(t,e,n){return e&&io(t.prototype,e),t}function Lt(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Te(t){return Te=Object.setPrototypeOf?Object.getPrototypeOf:function(n){return n.__proto__||Object.getPrototypeOf(n)},Te(t)}function Cn(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Ee(t,e)}function ro(t){return Function.toString.call(t).indexOf("[native code]")!==-1}function Nn(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function so(t,e){var n=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(n!=null){var i=[],o=!0,r=!1,s,a;try{for(n=n.call(t);!(o=(s=n.next()).done)&&(i.push(s.value),!(e&&i.length===e));o=!0);}catch(u){r=!0,a=u}finally{try{!o&&n.return!=null&&n.return()}finally{if(r)throw a}}return i}}function jn(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function ao(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Je(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{},i=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(o){return Object.getOwnPropertyDescriptor(n,o).enumerable}))),i.forEach(function(o){Lt(t,o,n[o])})}return t}function uo(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);n.push.apply(n,i)}return n}function co(t,e){return e=e??{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):uo(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}),t}function lo(t,e){return e&&(Dn(e)==="object"||typeof e=="function")?e:no(t)}function Ee(t,e){return Ee=Object.setPrototypeOf||function(i,o){return i.__proto__=o,i},Ee(t,e)}function $e(t,e){return Ln(t)||so(t,e)||Rt(t,e)||jn()}function po(t){return Ln(t)||Nn(t)||Rt(t)||jn()}function st(t){return to(t)||Nn(t)||Rt(t)||ao()}function Dn(t){"@swc/helpers - typeof";return t&&typeof Symbol<"u"&&t.constructor===Symbol?"symbol":typeof t}function Rt(t,e){if(t){if(typeof t=="string")return gt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if(n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gt(t,e)}}function Ke(t){var e=typeof Map=="function"?new Map:void 0;return Ke=function(i){if(i===null||!ro(i))return i;if(typeof i!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(i))return e.get(i);e.set(i,o)}function o(){return ze(i,arguments,Te(this).constructor)}return o.prototype=Object.create(i.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),Ee(o,i)},Ke(t)}function Ct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Ct=function(){return!!t})()}var fo=Object.defineProperty,ho=function(t,e,n){return e in t?fo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n},De=function(t,e,n){return ho(t,(typeof e>"u"?"undefined":Dn(e))!=="symbol"?e+"":e,n)},go=function(t){Cn(e,t);function e(n){Mt(this,e);var i;return i=Rn(this,e,["Method ".concat(n," is not defined")]),i.name="MethodNotFoundError",i}return e}(Ke(Error)),mo=function(t){Cn(e,t);function e(n){Mt(this,e);var i;return i=Rn(this,e,["An error occurred in the native bridge: ".concat(n)]),i.name="NativeMethodError",i}return e}(Ke(Error)),vo=function(){return new Proxy({},{get:function(){return function(){return Promise.resolve()}}})},yo=function(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=function(){return o},i=function(u){var c=Je({},o,Qi(u));if(!ht(o,c)){var l=o;o=c,s(o,l)}};t.on("bridgeStateChange",function(u){i(u)});var o=Je({},e),r=new Set,s=function(u,c){var l=!0,d=!1,p=void 0;try{for(var f=r[Symbol.iterator](),h;!(l=(h=f.next()).done);l=!0){var g=h.value;g(u,c)}}catch(v){d=!0,p=v}finally{try{!l&&f.return!=null&&f.return()}finally{if(d)throw p}}},a=function(u){return r.add(u),function(){return r.delete(u)}};return{getState:n,subscribe:a}},Vn=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=t,n=function(){return e},i=function(){return function(){}};return{getState:n,subscribe:i}},bo=function(){function t(e,n,i,o,r){Mt(this,t),this._bridgeId=e,this._options=n,this._emitter=i,this._bridgeMethods=o,this._nativeInitialState=r,De(this,"_defaultTimeoutMs",2e3),De(this,"_isListenerRegistered",!1),De(this,"store",Vn()),De(this,"loose",vo()),this._hydrate(o,r)}return oo(t,[{key:"isReactNativeWebView",get:function(){return!!window.ReactNativeWebView}},{key:"isWebViewBridgeAvailable",get:function(){return this._bridgeMethods.length>0}},{key:"isNativeMethodAvailable",value:function(n){return typeof n=="string"&&this._bridgeMethods.includes(n)}},{key:"addEventListener",value:function(n,i){return this._emitter.on("postMessage/".concat(String(n)),i)}},{key:"_postMessage",value:function(n,i){var o;(o=window.ReactNativeWebView)===null||o===void 0||o.postMessage(JSON.stringify(i?{type:n,body:i,bridgeId:this._bridgeId}:{type:n,bridgeId:this._bridgeId}))}},{key:"_createNativeMethod",value:function(n,i,o,r){var s=this;return function(){for(var a=arguments.length,u=new Array(a),c=0;c<a;c++)u[c]=arguments[c];var l=Mn();return Promise.race([Ji({emitter:s._emitter,methodName:n,eventId:l,evaluate:function(){s._postMessage("bridge",{method:n,eventId:l,args:u})},onFallback:function(){r==null||r(n,u)},failHandler:i&&new mo(n)}),o>0&&eo(o,i)].filter(Boolean))}}},{key:"_willMethodThrowOnError",value:function(n){var i=this._options.throwOnError;return i===!0||Array.isArray(i)&&i.includes(n)}},{key:"_createLoose",value:function(n){var i=this,o=this._options,r=o.timeout,s=r===void 0?this._defaultTimeoutMs:r,a=o.onFallback;return new Proxy(n,{get:function(u,c){return c in u&&!["isWebViewBridgeAvailable","isNativeMethodAvailable"].includes(c)?u[c]:i._createNativeMethod(c,i._willMethodThrowOnError(c),s,a)}})}},{key:"_hydrate",value:function(n){var i=this,o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this._options,s=r.timeout,a=s===void 0?this._defaultTimeoutMs:s,u=r.onFallback,c=r.initialBridge,l=c===void 0?{}:c,d=Object.entries(l).filter(function(C){var z=$e(C,2);z[0];var B=z[1];return typeof B=="function"}),p=d.map(function(C){var z=$e(C,1),B=z[0];return B});Object.defineProperties(this,Object.fromEntries(d.map(function(C){var z=$e(C,2),B=z[0],rt=z[1];return[B,{value:rt,writable:!0}]}))),this._bridgeMethods=st(n).concat(st(p)),this._nativeInitialState=o;var f=n.reduce(function(C,z){if(!i.isReactNativeWebView)return C;var B=i._createNativeMethod(z,i._willMethodThrowOnError(z),a,u);return Object.defineProperty(i,z,{value:B,writable:!1}),Object.assign(C,Lt({},z,B))},l);if(this.loose=this._createLoose(f),this.store=yo(this._emitter,Je({},f,o)),!this._isListenerRegistered){var h=function(){document.visibilityState==="visible"&&i._postMessage("getBridgeState")};document.addEventListener("visibilitychange",h),this._isListenerRegistered=!0}this._postMessage("getBridgeState");var g,v=!0,m=!1,y=void 0;try{for(var w=((g=window.nativeBatchedEvents)!==null&&g!==void 0?g:[])[Symbol.iterator](),I;!(v=(I=w.next()).done);v=!0){var $=po(I.value),E=$[0],R=$.slice(1),V;(V=this._emitter).emit.apply(V,[E].concat(st(R)))}}catch(C){m=!0,y=C}finally{try{!v&&w.return!=null&&w.return()}finally{if(m)throw y}}return window.nativeBatchedEvents=[],!0}}]),t}(),wo=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{timeout:2e3,throwOnError:!1,debug:!1};if(typeof window>"u"){var e,n=(e=t==null?void 0:t.initialBridge)!==null&&e!==void 0?e:{},i=Object.entries(n).filter(function(v){var m=$e(v,2);m[0];var y=m[1];return typeof y=="function"}),o=i.map(function(v){var m=$e(v,1),y=m[0];return y});return{addEventListener:function(v,m){return function(){}},loose:{},isWebViewBridgeAvailable:o.length>0,isNativeMethodAvailable:function(v){return o.includes(v)},store:Vn(t==null?void 0:t.initialBridge)}}t.debug&&!window.ReactNativeWebView&&console.warn("[WebViewBridge] Not in a WebView environment");var r=Mn(),s=Zi();window.nativeEmitterMap=co(Je({},window.nativeEmitterMap||{}),Lt({},r,s)),window.nativeEmitter||(window.nativeEmitter=s);var a,u=(a=window.__bridgeMethods__)!==null&&a!==void 0?a:[],c,l=(c=window.__bridgeInitialState__)!==null&&c!==void 0?c:{},d=new bo(r,t,s,u,l);if(u.length===0)var p=s.on("hydrate",function(v){var m=v.bridgeMethods,y=v.nativeInitialState;d._hydrate(m,y),p()});var f=t.onFallback,h=t.onReady,g=new Proxy(d,{get:function(v,m,y){return m in v?v[m]:(y._postMessage("fallback",{method:m}),y._willMethodThrowOnError(m)?function(){for(var w=arguments.length,I=new Array(w),$=0;$<w;$++)I[$]=arguments[$];return f==null||f(m,I),Promise.reject(new go(m))}:(t.debug&&console.warn("[WebViewBridge] ".concat(m," is not defined, using fallback.")),function(){return Promise.resolve()}))}});return h==null||h(g),g};const So=()=>wo({onReady:async()=>{}}),Io=({bridge:t,reader:e,containerElement:n})=>(t.addEventListener("load",i=>{e.load({containerElement:n,manifest:i.manifest})}),t.addEventListener("turnRight",()=>{e.navigation.turnRight()}),t.addEventListener("turnLeft",()=>{e.navigation.turnLeft()}),e.pagination.state$.subscribe(i=>{t.setPagination(i)}),e);var mt=function(t,e){return mt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(n[o]=i[o])},mt(t,e)};function oe(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");mt(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function Po(t,e,n,i){function o(r){return r instanceof n?r:new n(function(s){s(r)})}return new(n||(n=Promise))(function(r,s){function a(l){try{c(i.next(l))}catch(d){s(d)}}function u(l){try{c(i.throw(l))}catch(d){s(d)}}function c(l){l.done?r(l.value):o(l.value).then(a,u)}c((i=i.apply(t,e||[])).next())})}function kn(t,e){var n={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},i,o,r,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(c){return function(l){return u([c,l])}}function u(c){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(n=0)),n;)try{if(i=1,o&&(r=c[0]&2?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[c[0]&2,r.value]),c[0]){case 0:case 1:r=c;break;case 4:return n.label++,{value:c[1],done:!1};case 5:n.label++,o=c[1],c=[0];continue;case 7:c=n.ops.pop(),n.trys.pop();continue;default:if(r=n.trys,!(r=r.length>0&&r[r.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){n.label=c[1];break}if(c[0]===6&&n.label<r[1]){n.label=r[1],r=c;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(c);break}r[2]&&n.ops.pop(),n.trys.pop();continue}c=e.call(t,n)}catch(l){c=[6,l],o=0}finally{i=r=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function ye(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ie(t,e){var n=typeof Symbol=="function"&&t[Symbol.iterator];if(!n)return t;var i=n.call(t),o,r=[],s;try{for(;(e===void 0||e-- >0)&&!(o=i.next()).done;)r.push(o.value)}catch(a){s={error:a}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(s)throw s.error}}return r}function se(t,e,n){if(n||arguments.length===2)for(var i=0,o=e.length,r;i<o;i++)(r||!(i in e))&&(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}function me(t){return this instanceof me?(this.v=t,this):new me(t)}function xo(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(t,e||[]),o,r=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",s),o[Symbol.asyncIterator]=function(){return this},o;function s(f){return function(h){return Promise.resolve(h).then(f,d)}}function a(f,h){i[f]&&(o[f]=function(g){return new Promise(function(v,m){r.push([f,g,v,m])>1||u(f,g)})},h&&(o[f]=h(o[f])))}function u(f,h){try{c(i[f](h))}catch(g){p(r[0][3],g)}}function c(f){f.value instanceof me?Promise.resolve(f.value.v).then(l,d):p(r[0][2],f)}function l(f){u("next",f)}function d(f){u("throw",f)}function p(f,h){f(h),r.shift(),r.length&&u(r[0][0],r[0][1])}}function $o(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],n;return e?e.call(t):(t=typeof ye=="function"?ye(t):t[Symbol.iterator](),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(r){n[r]=t[r]&&function(s){return new Promise(function(a,u){s=t[r](s),o(a,u,s.done,s.value)})}}function o(r,s,a,u){Promise.resolve(u).then(function(c){r({value:c,done:a})},s)}}function A(t){return typeof t=="function"}function Nt(t){var e=function(i){Error.call(i),i.stack=new Error().stack},n=t(e);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var at=Nt(function(t){return function(n){t(this),this.message=n?n.length+` errors occurred during unsubscription:
`+n.map(function(i,o){return o+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=n}});function Qe(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var Se=function(){function t(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var e,n,i,o,r;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=ye(s),u=a.next();!u.done;u=a.next()){var c=u.value;c.remove(this)}}catch(g){e={error:g}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}else s.remove(this);var l=this.initialTeardown;if(A(l))try{l()}catch(g){r=g instanceof at?g.errors:[g]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var p=ye(d),f=p.next();!f.done;f=p.next()){var h=f.value;try{rn(h)}catch(g){r=r??[],g instanceof at?r=se(se([],ie(r)),ie(g.errors)):r.push(g)}}}catch(g){i={error:g}}finally{try{f&&!f.done&&(o=p.return)&&o.call(p)}finally{if(i)throw i.error}}}if(r)throw new at(r)}},t.prototype.add=function(e){var n;if(e&&e!==this)if(this.closed)rn(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(e)}},t.prototype._hasParent=function(e){var n=this._parentage;return n===e||Array.isArray(n)&&n.includes(e)},t.prototype._addParent=function(e){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(e),n):n?[n,e]:e},t.prototype._removeParent=function(e){var n=this._parentage;n===e?this._parentage=null:Array.isArray(n)&&Qe(n,e)},t.prototype.remove=function(e){var n=this._finalizers;n&&Qe(n,e),e instanceof t&&e._removeParent(this)},t.EMPTY=function(){var e=new t;return e.closed=!0,e}(),t}(),Wn=Se.EMPTY;function Un(t){return t instanceof Se||t&&"closed"in t&&A(t.remove)&&A(t.add)&&A(t.unsubscribe)}function rn(t){A(t)?t():t.unsubscribe()}var _o={Promise:void 0},To={setTimeout:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout.apply(void 0,se([t,e],ie(n)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function zn(t){To.setTimeout(function(){throw t})}function Fe(){}function Be(t){t()}var jt=function(t){oe(e,t);function e(n){var i=t.call(this)||this;return i.isStopped=!1,n?(i.destination=n,Un(n)&&n.add(i)):i.destination=Oo,i}return e.create=function(n,i,o){return new Oe(n,i,o)},e.prototype.next=function(n){this.isStopped||this._next(n)},e.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(n){this.destination.next(n)},e.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(Se),Eo=function(){function t(e){this.partialObserver=e}return t.prototype.next=function(e){var n=this.partialObserver;if(n.next)try{n.next(e)}catch(i){Ve(i)}},t.prototype.error=function(e){var n=this.partialObserver;if(n.error)try{n.error(e)}catch(i){Ve(i)}else Ve(e)},t.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(n){Ve(n)}},t}(),Oe=function(t){oe(e,t);function e(n,i,o){var r=t.call(this)||this,s;return A(n)||!n?s={next:n??void 0,error:i??void 0,complete:o??void 0}:s=n,r.destination=new Eo(s),r}return e}(jt);function Ve(t){zn(t)}function Fo(t){throw t}var Oo={closed:!0,next:Fe,error:Fo,complete:Fe},Dt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function te(t){return t}function Ao(t){return t.length===0?te:t.length===1?t[0]:function(n){return t.reduce(function(i,o){return o(i)},n)}}var L=function(){function t(e){e&&(this._subscribe=e)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(e,n,i){var o=this,r=Lo(e)?e:new Oe(e,n,i);return Be(function(){var s=o,a=s.operator,u=s.source;r.add(a?a.call(r,u):u?o._subscribe(r):o._trySubscribe(r))}),r},t.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(n){e.error(n)}},t.prototype.forEach=function(e,n){var i=this;return n=sn(n),new n(function(o,r){var s=new Oe({next:function(a){try{e(a)}catch(u){r(u),s.unsubscribe()}},error:r,complete:o});i.subscribe(s)})},t.prototype._subscribe=function(e){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(e)},t.prototype[Dt]=function(){return this},t.prototype.pipe=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Ao(e)(this)},t.prototype.toPromise=function(e){var n=this;return e=sn(e),new e(function(i,o){var r;n.subscribe(function(s){return r=s},function(s){return o(s)},function(){return i(r)})})},t.create=function(e){return new t(e)},t}();function sn(t){var e;return(e=t??_o.Promise)!==null&&e!==void 0?e:Promise}function Mo(t){return t&&A(t.next)&&A(t.error)&&A(t.complete)}function Lo(t){return t&&t instanceof jt||Mo(t)&&Un(t)}function Ro(t){return A(t==null?void 0:t.lift)}function D(t){return function(e){if(Ro(e))return e.lift(function(n){try{return t(n,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function N(t,e,n,i,o){return new Co(t,e,n,i,o)}var Co=function(t){oe(e,t);function e(n,i,o,r,s,a){var u=t.call(this,n)||this;return u.onFinalize=s,u.shouldUnsubscribe=a,u._next=i?function(c){try{i(c)}catch(l){n.error(l)}}:t.prototype._next,u._error=r?function(c){try{r(c)}catch(l){n.error(l)}finally{this.unsubscribe()}}:t.prototype._error,u._complete=o?function(){try{o()}catch(c){n.error(c)}finally{this.unsubscribe()}}:t.prototype._complete,u}return e.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;t.prototype.unsubscribe.call(this),!i&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},e}(jt),an={schedule:function(t){var e=requestAnimationFrame,n=cancelAnimationFrame,i=e(function(o){n=void 0,t(o)});return new Se(function(){return n==null?void 0:n(i)})},requestAnimationFrame:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return requestAnimationFrame.apply(void 0,se([],ie(t)))},cancelAnimationFrame:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return cancelAnimationFrame.apply(void 0,se([],ie(t)))},delegate:void 0},No=Nt(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),W=function(t){oe(e,t);function e(){var n=t.call(this)||this;return n.closed=!1,n.currentObservers=null,n.observers=[],n.isStopped=!1,n.hasError=!1,n.thrownError=null,n}return e.prototype.lift=function(n){var i=new un(this,this);return i.operator=n,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new No},e.prototype.next=function(n){var i=this;Be(function(){var o,r;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var s=ye(i.currentObservers),a=s.next();!a.done;a=s.next()){var u=a.value;u.next(n)}}catch(c){o={error:c}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}}})},e.prototype.error=function(n){var i=this;Be(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=n;for(var o=i.observers;o.length;)o.shift().error(n)}})},e.prototype.complete=function(){var n=this;Be(function(){if(n._throwIfClosed(),!n.isStopped){n.isStopped=!0;for(var i=n.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var n;return((n=this.observers)===null||n===void 0?void 0:n.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(n){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,n)},e.prototype._subscribe=function(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)},e.prototype._innerSubscribe=function(n){var i=this,o=this,r=o.hasError,s=o.isStopped,a=o.observers;return r||s?Wn:(this.currentObservers=null,a.push(n),new Se(function(){i.currentObservers=null,Qe(a,n)}))},e.prototype._checkFinalizedStatuses=function(n){var i=this,o=i.hasError,r=i.thrownError,s=i.isStopped;o?n.error(r):s&&n.complete()},e.prototype.asObservable=function(){var n=new L;return n.source=this,n},e.create=function(n,i){return new un(n,i)},e}(L),un=function(t){oe(e,t);function e(n,i){var o=t.call(this)||this;return o.destination=n,o.source=i,o}return e.prototype.next=function(n){var i,o;(o=(i=this.destination)===null||i===void 0?void 0:i.next)===null||o===void 0||o.call(i,n)},e.prototype.error=function(n){var i,o;(o=(i=this.destination)===null||i===void 0?void 0:i.error)===null||o===void 0||o.call(i,n)},e.prototype.complete=function(){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.complete)===null||i===void 0||i.call(n)},e.prototype._subscribe=function(n){var i,o;return(o=(i=this.source)===null||i===void 0?void 0:i.subscribe(n))!==null&&o!==void 0?o:Wn},e}(W),G=function(t){oe(e,t);function e(n){var i=t.call(this)||this;return i._value=n,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(n){var i=t.prototype._subscribe.call(this,n);return!i.closed&&n.next(this._value),i},e.prototype.getValue=function(){var n=this,i=n.hasError,o=n.thrownError,r=n._value;if(i)throw o;return this._throwIfClosed(),r},e.prototype.next=function(n){t.prototype.next.call(this,this._value=n)},e}(W),Vt={now:function(){return(Vt.delegate||Date).now()},delegate:void 0},vt=function(t){oe(e,t);function e(n,i,o){n===void 0&&(n=1/0),i===void 0&&(i=1/0),o===void 0&&(o=Vt);var r=t.call(this)||this;return r._bufferSize=n,r._windowTime=i,r._timestampProvider=o,r._buffer=[],r._infiniteTimeWindow=!0,r._infiniteTimeWindow=i===1/0,r._bufferSize=Math.max(1,n),r._windowTime=Math.max(1,i),r}return e.prototype.next=function(n){var i=this,o=i.isStopped,r=i._buffer,s=i._infiniteTimeWindow,a=i._timestampProvider,u=i._windowTime;o||(r.push(n),!s&&r.push(a.now()+u)),this._trimBuffer(),t.prototype.next.call(this,n)},e.prototype._subscribe=function(n){this._throwIfClosed(),this._trimBuffer();for(var i=this._innerSubscribe(n),o=this,r=o._infiniteTimeWindow,s=o._buffer,a=s.slice(),u=0;u<a.length&&!n.closed;u+=r?1:2)n.next(a[u]);return this._checkFinalizedStatuses(n),i},e.prototype._trimBuffer=function(){var n=this,i=n._bufferSize,o=n._timestampProvider,r=n._buffer,s=n._infiniteTimeWindow,a=(s?1:2)*i;if(i<1/0&&a<r.length&&r.splice(0,r.length-a),!s){for(var u=o.now(),c=0,l=1;l<r.length&&r[l]<=u;l+=2)c=l;c&&r.splice(0,c+1)}},e}(W),jo=function(t){oe(e,t);function e(n,i){return t.call(this)||this}return e.prototype.schedule=function(n,i){return this},e}(Se),cn={setInterval:function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setInterval.apply(void 0,se([t,e],ie(n)))},clearInterval:function(t){return clearInterval(t)},delegate:void 0},Bn=function(t){oe(e,t);function e(n,i){var o=t.call(this,n,i)||this;return o.scheduler=n,o.work=i,o.pending=!1,o}return e.prototype.schedule=function(n,i){var o;if(i===void 0&&(i=0),this.closed)return this;this.state=n;var r=this.id,s=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(s,r,i)),this.pending=!0,this.delay=i,this.id=(o=this.id)!==null&&o!==void 0?o:this.requestAsyncId(s,this.id,i),this},e.prototype.requestAsyncId=function(n,i,o){return o===void 0&&(o=0),cn.setInterval(n.flush.bind(n,this),o)},e.prototype.recycleAsyncId=function(n,i,o){if(o===void 0&&(o=0),o!=null&&this.delay===o&&this.pending===!1)return i;i!=null&&cn.clearInterval(i)},e.prototype.execute=function(n,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var o=this._execute(n,i);if(o)return o;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(n,i){var o=!1,r;try{this.work(n)}catch(s){o=!0,r=s||new Error("Scheduled action threw falsy error")}if(o)return this.unsubscribe(),r},e.prototype.unsubscribe=function(){if(!this.closed){var n=this,i=n.id,o=n.scheduler,r=o.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Qe(r,this),i!=null&&(this.id=this.recycleAsyncId(o,i,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e}(jo),ln=function(){function t(e,n){n===void 0&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(e,n,i){return n===void 0&&(n=0),new this.schedulerActionCtor(this,e).schedule(i,n)},t.now=Vt.now,t}(),Hn=function(t){oe(e,t);function e(n,i){i===void 0&&(i=ln.now);var o=t.call(this,n,i)||this;return o.actions=[],o._active=!1,o}return e.prototype.flush=function(n){var i=this.actions;if(this._active){i.push(n);return}var o;this._active=!0;do if(o=n.execute(n.state,n.delay))break;while(n=i.shift());if(this._active=!1,o){for(;n=i.shift();)n.unsubscribe();throw o}},e}(ln),nt=new Hn(Bn),Do=nt,Vo=function(t){oe(e,t);function e(n,i){var o=t.call(this,n,i)||this;return o.scheduler=n,o.work=i,o}return e.prototype.requestAsyncId=function(n,i,o){return o===void 0&&(o=0),o!==null&&o>0?t.prototype.requestAsyncId.call(this,n,i,o):(n.actions.push(this),n._scheduled||(n._scheduled=an.requestAnimationFrame(function(){return n.flush(void 0)})))},e.prototype.recycleAsyncId=function(n,i,o){var r;if(o===void 0&&(o=0),o!=null?o>0:this.delay>0)return t.prototype.recycleAsyncId.call(this,n,i,o);var s=n.actions;i!=null&&i===n._scheduled&&((r=s[s.length-1])===null||r===void 0?void 0:r.id)!==i&&(an.cancelAnimationFrame(i),n._scheduled=void 0)},e}(Bn),ko=function(t){oe(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.prototype.flush=function(n){this._active=!0;var i;n?i=n.id:(i=this._scheduled,this._scheduled=void 0);var o=this.actions,r;n=n||o.shift();do if(r=n.execute(n.state,n.delay))break;while((n=o[0])&&n.id===i&&o.shift());if(this._active=!1,r){for(;(n=o[0])&&n.id===i&&o.shift();)n.unsubscribe();throw r}},e}(Hn),de=new ko(Vo),ne=new L(function(t){return t.complete()});function qn(t){return t&&A(t.schedule)}function kt(t){return t[t.length-1]}function Wt(t){return A(kt(t))?t.pop():void 0}function Ce(t){return qn(kt(t))?t.pop():void 0}function Wo(t,e){return typeof kt(t)=="number"?t.pop():e}var Ut=function(t){return t&&typeof t.length=="number"&&typeof t!="function"};function Xn(t){return A(t==null?void 0:t.then)}function Yn(t){return A(t[Dt])}function Gn(t){return Symbol.asyncIterator&&A(t==null?void 0:t[Symbol.asyncIterator])}function Zn(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Uo(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Jn=Uo();function Kn(t){return A(t==null?void 0:t[Jn])}function Qn(t){return xo(this,arguments,function(){var n,i,o,r;return kn(this,function(s){switch(s.label){case 0:n=t.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,me(n.read())];case 3:return i=s.sent(),o=i.value,r=i.done,r?[4,me(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,me(o)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function ei(t){return A(t==null?void 0:t.getReader)}function Z(t){if(t instanceof L)return t;if(t!=null){if(Yn(t))return zo(t);if(Ut(t))return Bo(t);if(Xn(t))return Ho(t);if(Gn(t))return ti(t);if(Kn(t))return qo(t);if(ei(t))return Xo(t)}throw Zn(t)}function zo(t){return new L(function(e){var n=t[Dt]();if(A(n.subscribe))return n.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Bo(t){return new L(function(e){for(var n=0;n<t.length&&!e.closed;n++)e.next(t[n]);e.complete()})}function Ho(t){return new L(function(e){t.then(function(n){e.closed||(e.next(n),e.complete())},function(n){return e.error(n)}).then(null,zn)})}function qo(t){return new L(function(e){var n,i;try{for(var o=ye(t),r=o.next();!r.done;r=o.next()){var s=r.value;if(e.next(s),e.closed)return}}catch(a){n={error:a}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}e.complete()})}function ti(t){return new L(function(e){Yo(t,e).catch(function(n){return e.error(n)})})}function Xo(t){return ti(Qn(t))}function Yo(t,e){var n,i,o,r;return Po(this,void 0,void 0,function(){var s,a;return kn(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,11]),n=$o(t),u.label=1;case 1:return[4,n.next()];case 2:if(i=u.sent(),!!i.done)return[3,4];if(s=i.value,e.next(s),e.closed)return[2];u.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=u.sent(),o={error:a},[3,11];case 6:return u.trys.push([6,,9,10]),i&&!i.done&&(r=n.return)?[4,r.call(n)]:[3,8];case 7:u.sent(),u.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function pe(t,e,n,i,o){i===void 0&&(i=0),o===void 0&&(o=!1);var r=e.schedule(function(){n(),o?t.add(this.schedule(null,i)):this.unsubscribe()},i);if(t.add(r),!o)return r}function ni(t,e){return e===void 0&&(e=0),D(function(n,i){n.subscribe(N(i,function(o){return pe(i,t,function(){return i.next(o)},e)},function(){return pe(i,t,function(){return i.complete()},e)},function(o){return pe(i,t,function(){return i.error(o)},e)}))})}function ii(t,e){return e===void 0&&(e=0),D(function(n,i){i.add(t.schedule(function(){return n.subscribe(i)},e))})}function Go(t,e){return Z(t).pipe(ii(e),ni(e))}function Zo(t,e){return Z(t).pipe(ii(e),ni(e))}function Jo(t,e){return new L(function(n){var i=0;return e.schedule(function(){i===t.length?n.complete():(n.next(t[i++]),n.closed||this.schedule())})})}function Ko(t,e){return new L(function(n){var i;return pe(n,e,function(){i=t[Jn](),pe(n,e,function(){var o,r,s;try{o=i.next(),r=o.value,s=o.done}catch(a){n.error(a);return}s?n.complete():n.next(r)},0,!0)}),function(){return A(i==null?void 0:i.return)&&i.return()}})}function oi(t,e){if(!t)throw new Error("Iterable cannot be null");return new L(function(n){pe(n,e,function(){var i=t[Symbol.asyncIterator]();pe(n,e,function(){i.next().then(function(o){o.done?n.complete():n.next(o.value)})},0,!0)})})}function Qo(t,e){return oi(Qn(t),e)}function ri(t,e){if(t!=null){if(Yn(t))return Go(t,e);if(Ut(t))return Jo(t,e);if(Xn(t))return Zo(t,e);if(Gn(t))return oi(t,e);if(Kn(t))return Ko(t,e);if(ei(t))return Qo(t,e)}throw Zn(t)}function j(t,e){return e?ri(t,e):Z(t)}function x(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Ce(t);return j(t,n)}var zt=Nt(function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}});function er(t,e){return new Promise(function(n,i){var o=!1,r;t.subscribe({next:function(s){r=s,o=!0},error:i,complete:function(){o?n(r):i(new zt)}})})}function tr(t){return t instanceof Date&&!isNaN(t)}function b(t,e){return D(function(n,i){var o=0;n.subscribe(N(i,function(r){i.next(t.call(e,r,o++))}))})}var nr=Array.isArray;function ir(t,e){return nr(e)?t.apply(void 0,se([],ie(e))):t(e)}function Bt(t){return b(function(e){return ir(t,e)})}var or=Array.isArray,rr=Object.getPrototypeOf,sr=Object.prototype,ar=Object.keys;function si(t){if(t.length===1){var e=t[0];if(or(e))return{args:e,keys:null};if(ur(e)){var n=ar(e);return{args:n.map(function(i){return e[i]}),keys:n}}}return{args:t,keys:null}}function ur(t){return t&&typeof t=="object"&&rr(t)===sr}function ai(t,e){return t.reduce(function(n,i,o){return n[i]=e[o],n},{})}function K(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Ce(t),i=Wt(t),o=si(t),r=o.args,s=o.keys;if(r.length===0)return j([],n);var a=new L(cr(r,n,s?function(u){return ai(s,u)}:te));return i?a.pipe(Bt(i)):a}function cr(t,e,n){return n===void 0&&(n=te),function(i){dn(e,function(){for(var o=t.length,r=new Array(o),s=o,a=o,u=function(l){dn(e,function(){var d=j(t[l],e),p=!1;d.subscribe(N(i,function(f){r[l]=f,p||(p=!0,a--),a||i.next(n(r.slice()))},function(){--s||i.complete()}))},i)},c=0;c<o;c++)u(c)},i)}}function dn(t,e,n){t?pe(n,t,e):e()}function lr(t,e,n,i,o,r,s,a){var u=[],c=0,l=0,d=!1,p=function(){d&&!u.length&&!c&&e.complete()},f=function(g){return c<i?h(g):u.push(g)},h=function(g){c++;var v=!1;Z(n(g,l++)).subscribe(N(e,function(m){e.next(m)},function(){v=!0},void 0,function(){if(v)try{c--;for(var m=function(){var y=u.shift();s||h(y)};u.length&&c<i;)m();p()}catch(y){e.error(y)}}))};return t.subscribe(N(e,f,function(){d=!0,p()})),function(){}}function ae(t,e,n){return n===void 0&&(n=1/0),A(e)?ae(function(i,o){return b(function(r,s){return e(i,r,o,s)})(Z(t(i,o)))},n):(typeof e=="number"&&(n=e),D(function(i,o){return lr(i,o,t,n)}))}function ui(t){return t===void 0&&(t=1/0),ae(te,t)}function dr(){return ui(1)}function yt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return dr()(j(t,Ce(t)))}function bt(t){return new L(function(e){Z(t()).subscribe(e)})}function pr(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Wt(t),i=si(t),o=i.args,r=i.keys,s=new L(function(a){var u=o.length;if(!u){a.complete();return}for(var c=new Array(u),l=u,d=u,p=function(h){var g=!1;Z(o[h]).subscribe(N(a,function(v){g||(g=!0,d--),c[h]=v},function(){return l--},void 0,function(){(!l||!g)&&(d||a.next(r?ai(r,c):c),a.complete())}))},f=0;f<u;f++)p(f)});return n?s.pipe(Bt(n)):s}var fr=["addListener","removeListener"],hr=["addEventListener","removeEventListener"],gr=["on","off"];function J(t,e,n,i){if(A(n)&&(i=n,n=void 0),i)return J(t,e,n).pipe(Bt(i));var o=ie(yr(t)?hr.map(function(a){return function(u){return t[a](e,u,n)}}):mr(t)?fr.map(pn(t,e)):vr(t)?gr.map(pn(t,e)):[],2),r=o[0],s=o[1];if(!r&&Ut(t))return ae(function(a){return J(a,e,n)})(Z(t));if(!r)throw new TypeError("Invalid event target");return new L(function(a){var u=function(){for(var c=[],l=0;l<arguments.length;l++)c[l]=arguments[l];return a.next(1<c.length?c:c[0])};return r(u),function(){return s(u)}})}function pn(t,e){return function(n){return function(i){return t[n](e,i)}}}function mr(t){return A(t.addListener)&&A(t.removeListener)}function vr(t){return A(t.on)&&A(t.off)}function yr(t){return A(t.addEventListener)&&A(t.removeEventListener)}function et(t,e,n){t===void 0&&(t=0),n===void 0&&(n=Do);var i=-1;return e!=null&&(qn(e)?n=e:i=e),new L(function(o){var r=tr(t)?+t-n.now():t;r<0&&(r=0);var s=0;return n.schedule(function(){o.closed||(o.next(s++),0<=i?this.schedule(void 0,i):o.complete())},r)})}function _(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Ce(t),i=Wo(t,1/0),o=t;return o.length?o.length===1?Z(o[0]):ui(i)(j(o,n)):ne}var be=new L(Fe);function F(t,e){return D(function(n,i){var o=0;n.subscribe(N(i,function(r){return t.call(e,r,o++)&&i.next(r)}))})}function Ae(t){return D(function(e,n){var i=null,o=!1,r;i=e.subscribe(N(n,void 0,void 0,function(s){r=Z(t(s,Ae(t)(e))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0})),o&&(i.unsubscribe(),i=null,r.subscribe(n))})}function br(t,e,n,i,o){return function(r,s){var a=n,u=e,c=0;r.subscribe(N(s,function(l){var d=c++;u=a?t(u,l,d):(a=!0,l)},function(){a&&s.next(u),s.complete()}))}}function wr(t,e){return D(br(t,e,arguments.length>=2,!1,!0))}function fn(t,e){return A(e)?ae(t,e,1):ae(t,1)}function Ie(t,e){return e===void 0&&(e=nt),D(function(n,i){var o=null,r=null,s=null,a=function(){if(o){o.unsubscribe(),o=null;var c=r;r=null,i.next(c)}};function u(){var c=s+t,l=e.now();if(l<c){o=this.schedule(void 0,c-l),i.add(o);return}a()}n.subscribe(N(i,function(c){r=c,s=e.now(),o||(o=e.schedule(u,t),i.add(o))},function(){a(),i.complete()},void 0,function(){r=o=null}))})}function Sr(t){return D(function(e,n){var i=!1;e.subscribe(N(n,function(o){i=!0,n.next(o)},function(){i||n.next(t),n.complete()}))})}function Ne(t){return t<=0?function(){return ne}:D(function(e,n){var i=0;e.subscribe(N(n,function(o){++i<=t&&(n.next(o),t<=i&&n.complete())}))})}function Ir(t){return b(function(){return t})}function Pr(t,e){return ae(function(n,i){return Z(t(n,i)).pipe(Ne(1),Ir(n))})}function He(t,e){e===void 0&&(e=nt);var n=et(t,e);return Pr(function(){return n})}function O(t,e){return e===void 0&&(e=te),t=t??xr,D(function(n,i){var o,r=!0;n.subscribe(N(i,function(s){var a=e(s);(r||!t(o,a))&&(r=!1,o=a,i.next(s))}))})}function xr(t,e){return t===e}function $r(t){return t===void 0&&(t=_r),D(function(e,n){var i=!1;e.subscribe(N(n,function(o){i=!0,n.next(o)},function(){return i?n.complete():n.error(t())}))})}function _r(){return new zt}function _e(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return function(n){return yt(n,x.apply(void 0,se([],ie(t))))}}function wt(t,e){return D(function(n,i){var o=0,r=null,s=!1;n.subscribe(N(i,function(a){r||(r=N(i,void 0,function(){r=null,s&&i.complete()}),Z(t(a,o++)).subscribe(r))},function(){s=!0,!r&&i.complete()}))})}function he(t){return D(function(e,n){try{e.subscribe(n)}finally{n.add(t)}})}function X(t,e){var n=arguments.length>=2;return function(i){return i.pipe(te,Ne(1),n?Sr(e):$r(function(){return new zt}))}}function Tr(){return D(function(t,e){var n,i=!1;t.subscribe(N(e,function(o){var r=n;n=o,i&&e.next([r,o]),i=!0}))})}function H(t){t===void 0&&(t={});var e=t.connector,n=e===void 0?function(){return new W}:e,i=t.resetOnError,o=i===void 0?!0:i,r=t.resetOnComplete,s=r===void 0?!0:r,a=t.resetOnRefCountZero,u=a===void 0?!0:a;return function(c){var l,d,p,f=0,h=!1,g=!1,v=function(){d==null||d.unsubscribe(),d=void 0},m=function(){v(),l=p=void 0,h=g=!1},y=function(){var w=l;m(),w==null||w.unsubscribe()};return D(function(w,I){f++,!g&&!h&&v();var $=p=p??n();I.add(function(){f--,f===0&&!g&&!h&&(d=ut(y,u))}),$.subscribe(I),!l&&f>0&&(l=new Oe({next:function(E){return $.next(E)},error:function(E){g=!0,v(),d=ut(m,o,E),$.error(E)},complete:function(){h=!0,v(),d=ut(m,s),$.complete()}}),Z(w).subscribe(l))})(c)}}function ut(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(e===!0){t();return}if(e!==!1){var o=new Oe({next:function(){o.unsubscribe(),t()}});return Z(e.apply(void 0,se([],ie(n)))).subscribe(o)}}function Q(t,e,n){var i,o,r,s,a=!1;return t&&typeof t=="object"?(i=t.bufferSize,s=i===void 0?1/0:i,o=t.windowTime,e=o===void 0?1/0:o,r=t.refCount,a=r===void 0?!1:r,n=t.scheduler):s=t??1/0,H({connector:function(){return new vt(s,e,n)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}function Ht(t){return F(function(e,n){return t<=n})}function re(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Ce(t);return D(function(i,o){(n?yt(t,i,n):yt(t,i)).subscribe(o)})}function S(t,e){return D(function(n,i){var o=null,r=0,s=!1,a=function(){return s&&!o&&i.complete()};n.subscribe(N(i,function(u){o==null||o.unsubscribe();var c=0,l=r++;Z(t(u,l)).subscribe(o=N(i,function(d){return i.next(e?e(u,d,l,c++):d)},function(){o=null,a()}))},function(){s=!0,a()}))})}function Er(t,e){return D(function(n,i){var o=e;return S(function(r,s){return t(o,r,s)},function(r,s){return o=s,s})(n).subscribe(i),function(){o=null}})}function T(t){return D(function(e,n){Z(t).subscribe(N(n,function(){return n.complete()},Fe)),!n.closed&&e.subscribe(n)})}function P(t,e,n){var i=A(t)||e||n?{next:t,error:e,complete:n}:t;return i?D(function(o,r){var s;(s=i.subscribe)===null||s===void 0||s.call(i);var a=!0;o.subscribe(N(r,function(u){var c;(c=i.next)===null||c===void 0||c.call(i,u),r.next(u)},function(){var u;a=!1,(u=i.complete)===null||u===void 0||u.call(i),r.complete()},function(u){var c;a=!1,(c=i.error)===null||c===void 0||c.call(i,u),r.error(u)},function(){var u,c;a&&((u=i.unsubscribe)===null||u===void 0||u.call(i)),(c=i.finalize)===null||c===void 0||c.call(i)}))}):te}function Fr(t,e){return D(function(n,i){var o=e??{},r=o.leading,s=r===void 0?!0:r,a=o.trailing,u=a===void 0?!1:a,c=!1,l=null,d=null,p=!1,f=function(){d==null||d.unsubscribe(),d=null,u&&(v(),p&&i.complete())},h=function(){d=null,p&&i.complete()},g=function(m){return d=Z(t(m)).subscribe(N(i,f,h))},v=function(){if(c){c=!1;var m=l;l=null,i.next(m),!p&&g(m)}};n.subscribe(N(i,function(m){c=!0,l=m,!(d&&!d.closed)&&(s?v():g(m))},function(){p=!0,!(u&&c&&d&&!d.closed)&&i.complete()}))})}function Or(t,e,n){e===void 0&&(e=nt);var i=et(t,e);return Fr(function(){return i},n)}function U(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Wt(t);return D(function(i,o){for(var r=t.length,s=new Array(r),a=t.map(function(){return!1}),u=!1,c=function(d){Z(t[d]).subscribe(N(o,function(p){s[d]=p,!u&&!a[d]&&(a[d]=!0,(u=a.every(te))&&(a=null))},Fe))},l=0;l<r;l++)c(l);i.subscribe(N(o,function(d){if(u){var p=se([d],ie(s));o.next(n?n.apply(void 0,se([],ie(p))):p)}}))})}const Ar=t=>{var e,n;return((n=(e=t.split(/[#?]/)[0])==null?void 0:e.split(".").pop())==null?void 0:n.trim())||""};function Mr(t){const e=t.split("/");return e.pop(),e.join("/")}const it=t=>{switch(Ar(t)){case"png":return"image/png";case"jpg":return"image/jpg";case"jpeg":return"image/jpeg";case"txt":return"text/plain";case"webp":return"image/webp";case"xhtml":return"application/xhtml+xml"}},Lr=t=>t.length?t.indexOf(";")?t.substring(0,t.indexOf(";")):t:void 0,Rr=Object.prototype.hasOwnProperty,Cr=(t,e)=>t===e?t!==0||e!==0||1/t===1/e:!1,q=(t,e,n)=>{if(t===e)return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;const i=Object.keys(t),o=Object.keys(e);if(i.length!==o.length)return!1;const r=n&&typeof n.customEqual=="function"?n.customEqual:Cr;for(let s=0;s<i.length;s++){const a=i[s]||"";if(!Rr.call(e,a)||!r(t[a],e[a]))return!1}return!0};function qe(t,e){const n={...t};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const o=e[i];(o!==void 0||!(i in t))&&(n[i]=o)}return n}const Nr=()=>{if(!(typeof window>"u"))return window};function jr(){var t;const e=(t=Nr())==null?void 0:t.__PROSE_READER_DEBUG;return e===!0||e==="true"}const xe=t=>`[${t}]`,St=(t,e=jr())=>({namespace:(n,i)=>St(`${t} ${n}`,i),debug:e?t?Function.prototype.bind.call(console.debug,console,xe(t)):Function.prototype.bind.call(console.debug,console):()=>{},info:e?t?Function.prototype.bind.call(console.info,console,xe(t)):Function.prototype.bind.call(console.info,console):()=>{},log:e?t?Function.prototype.bind.call(console.log,console,xe(t)):Function.prototype.bind.call(console.log,console):()=>{},warn:e?t?Function.prototype.bind.call(console.warn,console,xe(t)):Function.prototype.bind.call(console.warn,console):()=>{},error:e?t?Function.prototype.bind.call(console.error,console,xe(t)):Function.prototype.bind.call(console.error,console):()=>{}}),Dr={...St(),namespace:(t,e)=>St(t,e)},Vr=(t,e)=>t===e?!0:t.length!==e.length?!1:t.every((n,i)=>n===e[i]);function kr(t){const e=[t];let n=t;for(;n.parentNode;)e.push(n.parentNode),n=n.parentNode;return e}function Wr(t,e){if(t===e)return t;const n=kr(t),i=new Set(n);let o=e;for(;o;){if(i.has(o))return o;o=o.parentNode}return null}const Ur=/[\[\]\^,();]/g;function we(t){return t.replace(Ur,"^$&")}const zr=/^epubcfi\((.*)\)$/,Xe=t=>t.nodeType===Node.ELEMENT_NODE,Ye=t=>typeof t=="object"&&t!==null&&"nodeType"in t&&(t.nodeType===Node.ELEMENT_NODE||t.nodeType===Node.TEXT_NODE),Br=t=>t.nodeType===Node.TEXT_NODE;function ci(t){if(qt(t))return!1;const e=t[t.length-1];return t.length>1&&(e===void 0||e.length===0)}function qt(t){return t!==null&&typeof t=="object"&&"parent"in t&&"start"in t&&"end"in t}function Hr(t){const e=t.match(zr);return e&&e[1]||t}function qr(t){const e=[];let n=null,i=!1,o="";const r=c=>{e.push(c),n=null,o=""},s=c=>{o+=c,i=!1},a=Hr(t).trim(),u=Array.from(a).concat("");for(let c=0;c<u.length;c++){const l=u[c];if(!l){n==="/"||n===":"?r([n,parseInt(o,10)]):n==="~"?r(["~",parseFloat(o)]):n==="@"?r(["@",parseFloat(o)]):n==="["?r(["[",o]):n===";"||n!=null&&n.startsWith(";")?r([n,o]):n==="!"&&r(["!",0]);break}if(l==="^"&&!i){i=!0;continue}if(n==="!")r(["!",0]);else if(n===",")r([",",0]);else if(n==="/"||n===":"){if(/^\d$/.test(l)){s(l);continue}r([n,parseInt(o,10)])}else if(n==="~"){if(/^\d$/.test(l)||l==="."){s(l);continue}r(["~",parseFloat(o)])}else if(n==="@"){if(l===":"){r(["@",parseFloat(o)]),n="@";continue}if(/^\d$/.test(l)||l==="."){s(l);continue}r(["@",parseFloat(o)])}else if(n==="[")if(l===";"&&!i)r(["[",o]),n=";";else if(l==="]"&&!i)r(["[",o]);else{s(l);continue}else if(n===";")if(l==="="&&!i)n=`;${o}`,o="";else if(l===";"&&!i)r([n,o]),n=";";else if(l==="]"&&!i)r([n,o]);else{s(l);continue}else if(n!=null&&n.startsWith(";"))if(l===";"&&!i)r([n,o]),n=";";else if(l==="]"&&!i)r([n,o]);else{s(l);continue}else n===null&&l===";"&&(n=";");(l==="/"||l===":"||l==="~"||l==="@"||l==="["||l==="!"||l===",")&&(n=l)}return e}function li(t,e){return t?t.map((n,i)=>n[0]===e?i:null).filter(n=>n!==null):[]}function di(t,e){const n=[];let i=0;for(const o of e)n.push(t.slice(i,o)),i=o;return n.push(t.slice(i)),n}function Xr(t){var e;const n=[],i={};let o=-1;for(let r=0;r<t.length;r++){const s=t[r];if(!s)continue;const[a,u]=s;a==="/"?(o++,n[o]={index:u},i[o]=[]):o>=0&&((e=i[o])==null||e.push(s))}for(let r=0;r<n.length;r++){const s=n[r];if(!s)continue;const a=i[r]||[];for(let u=0;u<a.length;u++){const c=a[u];if(!c)continue;const[l,d]=c;if(l===":")s.offset=d;else if(l==="~")s.temporal=d;else if(l==="@")s.spatial=(s.spatial||[]).concat(d);else if(l===";s")s.side=d;else if(l.startsWith(";")&&l!==";s"){const p=l.substring(1);s.extensions||(s.extensions={}),s.extensions[p]=d}else if(l==="["){const p=typeof d=="string"&&!d.includes(" ")&&d.length<50;if(u===0&&p&&!s.id)s.id=d;else if(d!==""){const f=d.split(",").map(h=>h.trim());s.text=f}}}}return n}function ke(t){const e=li(t,"!");return di(t,e).map(Xr)}function Xt(t){if(!t)throw new Error("CFI string cannot be empty");const e=qr(t);if(!e||e.length===0)throw new Error("Failed to tokenize CFI string");const n=li(e,",");if(n.length===0)return ke(e);const[i,o,r]=di(e,n);return{parent:ke(i||[]),start:ke(o||[]),end:ke(r||[])}}function Yr(t,e,n={}){try{const i=typeof t!="string"?t:Xt(t);return Gr(i,e,n)}catch(i){if(n.throwOnError)throw i;return{node:null,isRange:!1}}}function Gr(t,e,n={asRange:!1}){if(qt(t))return Zr(t,e);if(ci(t))return ge(null);const i=t.at(-1);if(i)return Ge(i,e,n);throw new Error("Invalid CFI structure")}function Zr(t,e){const n=t.parent[0]||[],i=t.start[0]||[],o=t.end[0]||[];let r=e.documentElement;if(n.length>0){const d=Ge(n,e);Ye(d.node)&&(r=d.node)}if(!r)throw new Error("Failed to resolve parent node in CFI range");const s=Ge(i,e),a=Ge(o,e);if(!Ye(s.node)||!Ye(a.node))throw new Error("Failed to resolve start or end node in CFI range");const u=s.node,c=a.node,l=e.createRange();return l.setStart(u,(Array.isArray(s.offset)?s.offset[0]:s.offset)??0),l.setEnd(c,(Array.isArray(a.offset)?a.offset[0]:a.offset)??0),{...s,node:l,isRange:!0}}function Jr(t){if(t!=null&&t.side)return t.side;if(t!=null&&t.text&&t.text.length>0){const e=t.text[0];if(e){const n=e.match(/^([ab])$/);if(n)return n[1]}}}function It(t){return t.index%2!==0}function pi(t){const e=Jr(t),n=t==null?void 0:t.extensions;return{offset:t==null?void 0:t.offset,temporal:t==null?void 0:t.temporal,spatial:t==null?void 0:t.spatial,side:e,extensions:n}}function ge(t,e){return{node:t,isRange:!1,...pi(e)}}function We(t,e){return{node:t,isRange:!0,...pi(e)}}function hn(t,e,n){const i=t.createRange();if(i.selectNodeContents(e),n!==void 0){const o=Array.isArray(n)?n[0]:n;Br(e)&&i.setStart(e,o||0)}return i}function gn(t,e,n,i){let o=t;for(let r=n;r<e.length;r++){const s=e[r];if(!o||!s)break;if(It(s)){const a=s.index-1;if(a>=0&&a<o.childNodes.length)o=o.childNodes[a];else{if(i)throw new Error(`Invalid text node index: ${s.index}`);o=null;break}}else{const a=Array.from(o.childNodes).filter(c=>c.nodeType===Node.ELEMENT_NODE),u=Math.floor(s.index/2)-1;if(u>=0&&u<a.length){const c=a[u];c&&(o=c)}else{if(i)throw new Error(`Invalid element step index: ${s.index}`);o=null;break}}}return o}function Ge(t,e,n={}){const{throwOnError:i=!1,asRange:o=!1}=n;if(!e){if(i)throw new Error("Document is not available");return ge(null)}const{node:r,remainingPathIndex:s}=Kr(e,t);if(r&&s>=t.length){const l=t.at(-1);if(l&&It(l)){const d=l.index-1;if(d>=0&&d<r.childNodes.length){const p=r.childNodes[d];return ge(p,l)}}if(o){const d=hn(e,r,l==null?void 0:l.offset);return We(d,l)}return ge(r,l)}let a=r||e.documentElement;const u=r?s:0;if(o&&t.length>0){const l=t[t.length-1];if(l&&!It(l)){if(l.index===0&&a){const p=e.createRange();return p.setStart(a,0),p.setEnd(a,0),We(p,l)}const d=gn(a,t.slice(0,-1),u,i);if(d){const p=Array.from(d.childNodes).filter(f=>f.nodeType===Node.ELEMENT_NODE);if(Math.floor(l.index/2)-1===p.length){const f=e.createRange();return f.selectNodeContents(d),f.collapse(!1),We(f,l)}}}}if(a=gn(a,t,u,i),!a){if(i)throw new Error("Failed to resolve CFI path");return ge(null)}const c=t.at(-1);if(o){const l=hn(e,a,c==null?void 0:c.offset);return We(l,c)}return ge(a,c)}function Kr(t,e){for(let n=e.length-1;n>=0;n--){const i=e[n];if(i!=null&&i.id){const o=t.getElementById(i.id);if(o)return{node:o,remainingPathIndex:n+1}}}return{node:null,remainingPathIndex:0}}function fi(t,e,n={}){if(!t.textContent||t.textContent.trim()==="")return null;const i=t.textContent,o=n.textAssertionLength||10;if(e!==void 0&&e<=i.length){const r=Math.floor(o/2),s=Math.max(0,e-r),a=Math.min(i.length,e+r);return i.substring(s,a)}return i.substring(0,Math.min(i.length,o))}function Qr(t){const[e,n]=t,i=Math.max(0,Math.min(100,e)),o=Math.max(0,Math.min(100,n));return`@${i}:${o}`}function Pt(t,e,n){let i=t;return e!==void 0&&(i+=`~${e}`),n!==void 0&&(i+=Qr(n)),i}function hi(t,e,n){let i=t;if(e&&(i+=`[${we(e)}]`),n){const o=n==="before"?"b":"a";e?i=`${i.substring(0,i.length-1)};s=${o}]`:i+=`[;s=${o}]`}return i}function xt(t,e,n={},i){var o;let r="",s=t,a=null;if((t==null?void 0:t.nodeType)===Node.TEXT_NODE){a=t;const c=t.parentNode;if(!c)throw new Error("Text node doesn't have a parent");const l=Array.from(c.childNodes).indexOf(t);if(l===-1)throw new Error("Node not found in parent's children");if(r=`/${l+1}`,Xe(c)&&c.id){const d=c.id,p=Array.from(((o=c.parentNode)==null?void 0:o.childNodes)||[]);r=`/${p.slice(0,p.indexOf(c)+1).filter(f=>f.nodeType===Node.ELEMENT_NODE).length*2}[${we(d)}]${r}`,s=c.parentNode}else s=c}let u=null;for(a&&n.includeTextAssertions&&(u=fi(a,e,n));s!=null&&s.parentNode;){if(!(a&&s===a.parentNode&&r.includes(`[${Xe(s)?s.id:""}]`))){const c=s.parentNode,l=Array.from(c.childNodes),d=l.indexOf(s);if(d===-1)throw new Error("Node not found in parent's children");const p=l.slice(0,d+1).filter(g=>g.nodeType===Node.ELEMENT_NODE);let f;s.nodeType,f=p.length;const h=f*2;Xe(s)&&s.id?r=`/${h}[${we(s.id)}]${r}`:r=`/${h}${r}`}if(s.parentNode.nodeName.toLowerCase()==="html")break;s=s.parentNode}return e!==void 0&&(r+=`:${e}`),r=Pt(r,i==null?void 0:i.temporal,(i==null?void 0:i.spatial)||n.spatialOffset),r=hi(r,u,n.includeSideBias),r=ve(r,n.extensions),r}function mn(t,e,n,i={},o){if(t===e){let u=n!==void 0?`:${n}`:"";return u=Pt(u,o==null?void 0:o.temporal,o==null?void 0:o.spatial),u}const r=[];let s=e;for(;s&&s!==t;){const u=s.parentNode;if(!u)break;const c=u.childNodes;let l=-1;for(let p=0;p<c.length;p++)if(c[p]===s){l=p;break}if(l===-1)throw new Error("Node not found in parent's children");const d=l+1;Xe(s)&&s.id?r.unshift(`/${d}[${we(s.id)}]`):r.unshift(`/${d}`),s=u}let a=r.join("");if(n!==void 0&&(a+=`:${n}`),a=Pt(a,o==null?void 0:o.temporal,o==null?void 0:o.spatial),i.includeTextAssertions&&e.nodeType===Node.TEXT_NODE){const u=fi(e,n,i);a=hi(a,u,i.includeSideBias)}return a=ve(a,i.extensions),a}const es=t=>Object.entries(t).map(([e,n])=>{const i=we(n);return`${e}=${encodeURIComponent(i)}`}).join(";");function ve(t,e){if(!e||Object.keys(e).length===0)return t;const n=es(e);if(t.endsWith("]")){const i=t.lastIndexOf("["),o=t.substring(i+1,t.length-1);return o.includes(n)?t:`${t.substring(0,t.length-1)}${o.includes(";"),";"}${n}]`}return t.endsWith("!")?t:`${t}[;${n}]`}function ts(t,e,n,i,o={},r,s){const a=Wr(t,n);if(!a)throw new Error("No common ancestor found");const u=xt(a,void 0,o),c=mn(a,t,e,o,r),l=mn(a,n,i,o,s);if(o.extensions&&Object.keys(o.extensions).length>0){const d=ve(u,o.extensions),p=ve(c,o.extensions),f=ve(l,o.extensions);return`${d},${p},${f}`}return`${u},${c},${l}`}const vn=(t,e,n={},i)=>{const o="";let r=`/6/${(t+1)*2}`;return e&&(r+=`[${we(e)}]`),r=i?ve(r,n.extensions):r,`${r}${o}!`};function gi(t,e={}){if(Ye(t))return`epubcfi(${xt(t,void 0,e)})`;let n="";if(!("start"in t))return t.spineIndex!==void 0&&(n=vn(t.spineIndex,t.spineId,e,!t.node),!t.node)?`epubcfi(${n})`:(n+=xt(t.node??null,t.offset,e,t),`epubcfi(${n})`);const{start:i,end:o}=t;return i.spineIndex!==void 0&&(n=vn(i.spineIndex,i.spineId,e,!i.node)),i.node&&o.node&&(n+=ts(i.node,i.offset??0,o.node,o.offset??0,e,i,o)),`epubcfi(${n})`}const yn=(t,e)=>{const n=new RegExp(`${e}\\s*=\\s*([0-9.]+)`,"i"),i=t.match(n)||[],o=i[1]||"0";return i&&Number.parseFloat(o)||0},ns=(t,e,n,i)=>{var o;if((o=t==null?void 0:t.contentDocument)!=null&&o.head){const r=t.contentDocument.createElement("style");r.id=e,r.innerHTML=n,i?t.contentDocument.head.prepend(r):t.contentDocument.head.appendChild(r)}},is=(t,e)=>{var n;if((n=t==null?void 0:t.contentDocument)!=null&&n.head){const i=t.contentDocument.getElementById(e);i&&i.remove()}},ce=(t,e,n,i)=>{t&&(is(t,e),ns(t,e,n,i))},Yt=t=>{if(t!=null&&t.contentDocument){const n=t.contentDocument.querySelector("meta[name='viewport']");if(n){const i=n.getAttribute("content");if(i){const o=yn(i,"width"),r=yn(i,"height");return o>0&&r>0?{hasViewport:!0,width:o,height:r}:{hasViewport:!0}}}}return{hasViewport:!1}},os=t=>t.pipe(S(e=>{var n;return e.src==="about:blank"&&((n=e.contentDocument)==null?void 0:n.readyState)==="complete"&&e.contentDocument.body?x(e):J(e,"load").pipe(Ne(1),b(()=>e))})),rs=t=>t.pipe(S(e=>{var n;return j(((n=e==null?void 0:e.contentDocument)==null?void 0:n.fonts.ready)||x(void 0)).pipe(b(()=>e))})),ss=t=>e=>{const n=t(e),i=new IntersectionObserver(o=>{o.forEach(r=>{r.isIntersecting?r.target.removeAttribute("tab-index"):r.target.setAttribute("tab-index","-1")})},{});return n.hookManager.register("item.onDocumentLoad",({itemId:o,destroy:r})=>{var s;const a=n.spineItemsManager.get(o);if(!a)return;const u=a.renderer.getDocumentFrame();if(!u)return;ce(u,"prose-reader-accessibility",`
              :focus-visible {
                
                outline: -webkit-focus-ring-color auto 1px;
              }
            `);const c=(s=u.contentDocument)==null?void 0:s.body.querySelectorAll("a");c==null||c.forEach(l=>{i.observe(l)}),r(()=>{c==null||c.forEach(l=>{i.unobserve(l)})})}),{...n}},as=t=>e=>{const n=t(e);return n.context.state$.pipe(T(n.$.destroy$)).subscribe(({containerElement:i})=>{if(!i)return;const o=()=>{n.settings.values.computedPageTurnMode==="controlled"&&i.scrollTo(0,0)};i.addEventListener("scroll",o)}),n.hookManager.register("item.onDocumentLoad",({itemId:i})=>{var o;const r=n.spineItemsManager.get(i),s=r==null?void 0:r.renderer.getDocumentFrame();s&&((o=s.contentDocument)==null||o.body.setAttribute("tabindex","-1"))}),n},us="@prose-reader/core",Y=Dr.namespace(us),cs=["pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup"],mi=t=>typeof t=="object"&&!!t&&"nodeType"in t&&(t==null?void 0:t.nodeType)===Node.ELEMENT_NODE;function ls(t,e,n){if("caretPositionFromPoint"in t)return t.caretPositionFromPoint(e,n);if("caretRangeFromPoint"in t&&typeof t.caretRangeFromPoint<"u")return t.caretRangeFromPoint(e,n)}const ds=(t,e)=>{const n="body"in t?$t(t.body,e):$t(t,e),i="createRange"in t?t:t.ownerDocument;if(n){let o,r=0;const s=i.createRange();return Array.from(n.childNodes).some(a=>{s.selectNodeContents(a);const u=s.getClientRects(),c=ps(u,e);if(c){o=s.cloneRange();const l=ls(i,Math.ceil(c.left),Math.ceil(c.top));return l&&"startContainer"in l&&l.startContainer===o.startContainer&&(r=l.startOffset),l&&"offsetNode"in l&&l.offsetNode===o.startContainer&&(r=l.offset),!0}return!1}),o?{node:o.startContainer,offset:r}:{node:n,offset:0}}},$t=(t,e)=>{let n;const i=vi(t.getBoundingClientRect(),e);return i!=="before"&&i!=="after"&&(n=t),Array.from(t.children).some(o=>{const r=$t(o,e);return r?(n=r,!0):!1}),n};function vi(t,{left:e,right:n}){return t.left<=e&&t.right<=e?"before":t.left<=e&&t.right>e&&t.right<=n?"partially-before":t.left<=n&&t.right>n?"partially-after":t.left>n?"after":"within"}function ps(t,e){return Array.from(t).find(n=>{const i=vi(n,e);return i!=="before"&&i!=="after"})}const fs=(t,e)=>{var n;if(t.nodeType!==Node.CDATA_SECTION_NODE&&t.nodeType!==Node.DOCUMENT_TYPE_NODE){const i=(n=t.ownerDocument)==null?void 0:n.createRange();i==null||i.selectNodeContents(t);try{e<=((i==null?void 0:i.endOffset)||0)&&(i==null||i.setStart(t,e||0))}catch(o){Y.error(o)}return i}},Gt=t=>{var e,n,i,o,r;if(t!=null&&t.target&&((n=(e=t==null?void 0:t.target)==null?void 0:e.ownerDocument)!=null&&n.defaultView)){const s=(o=(i=t==null?void 0:t.target)==null?void 0:i.ownerDocument)==null?void 0:o.defaultView;if(s.PointerEvent&&t instanceof s.PointerEvent)return!0}if((r=t==null?void 0:t.view)!=null&&r.window){const s=t==null?void 0:t.view;if(s.PointerEvent&&t instanceof s.PointerEvent)return!0}return!!cs.includes(t.type)},hs=t=>{var e,n,i,o,r;if(Gt(t))return!1;if(t!=null&&t.target&&((n=(e=t==null?void 0:t.target)==null?void 0:e.ownerDocument)!=null&&n.defaultView)){const s=(o=(i=t==null?void 0:t.target)==null?void 0:i.ownerDocument)==null?void 0:o.defaultView;if(s.MouseEvent)return t instanceof s.MouseEvent}if((r=t==null?void 0:t.view)!=null&&r.window){const s=t==null?void 0:t.view;if(s.MouseEvent)return t instanceof s.MouseEvent}return!1},gs=t=>{var e,n,i,o,r;if(t!=null&&t.target&&((n=(e=t==null?void 0:t.target)==null?void 0:e.ownerDocument)!=null&&n.defaultView)){const s=(o=(i=t==null?void 0:t.target)==null?void 0:i.ownerDocument)==null?void 0:o.defaultView;if(s.TouchEvent)return t instanceof s.TouchEvent}if((r=t==null?void 0:t.view)!=null&&r.window){const s=t==null?void 0:t.view;if(s.TouchEvent)return t instanceof s.TouchEvent}return!1},ms=()=>document.createElement("div"),yi=t=>{const e=["img","video","audio","source","link","script"].join(",");return Array.from((t==null?void 0:t.querySelectorAll(e))||[])},vs=t=>{if(yi(t).forEach(n=>{var i;const o=n.getAttribute("src")||n.getAttribute("href");o!=null&&o.startsWith("blob:")&&((i=t==null?void 0:t.defaultView)==null||i.URL.revokeObjectURL(o))}),t){const n=Array.from(t.styleSheets||[]);for(const i of n){const o=Array.from(i.cssRules||[]);for(const r of o)if(t.defaultView&&r instanceof t.defaultView.CSSFontFaceRule){const a=r.style.getPropertyValue("src").match(/blob:[^,\s'")]+/g);a&&a.forEach(u=>{var c;(c=t==null?void 0:t.defaultView)==null||c.URL.revokeObjectURL(u)})}}}};function ys(t,e){return mi(t)&&t.tagName.toLowerCase()===e.toLowerCase()}const ct=({position:t,frameElement:e})=>{const n=e.getBoundingClientRect(),i=n.width/e.offsetWidth,o=n.height/e.offsetHeight,{left:r=0,top:s=0}=n,a=t.clientX*i+r,u=t.clientY*o+s;return{clientX:a,clientY:u}},bs=(t,e,n,i)=>{var o;const r=(o=e==null?void 0:e.view)==null?void 0:o.frameElement;if(!e||!r)return t;const s=n.getSpineItemFromIframe(r),a=r,{height:u,width:c}=i.getPageSize();if(!s||!(a instanceof HTMLIFrameElement))return t;if(Gt(t)){const{clientX:l,clientY:d}=ct({position:t,frameElement:a}),p=new PointerEvent(t.type,{...t,pointerId:t.pointerId,clientX:l,clientY:d});return Object.defineProperty(p,"target",{value:e.target,enumerable:!0}),p}if(hs(t)){const{clientX:l,clientY:d}=ct({position:t,frameElement:a}),p=new MouseEvent(t.type,{...t,clientX:l,clientY:d});return Object.defineProperty(p,"target",{value:e.target,enumerable:!0}),p}if(gs(t)){const l=Array.from(t.touches).map(p=>{const{clientX:f,clientY:h}=ct({position:p,frameElement:a});return new Touch({identifier:p.identifier,target:p.target,clientX:f,clientY:h})}),d=new TouchEvent(t.type,{touches:l,changedTouches:l,targetTouches:l});return Object.defineProperty(d,"target",{value:e.target,enumerable:!0}),d}return t},ws=["pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup"],Ss=[...ws],Is=t=>e=>{const n=t(e);return n.hookManager.register("item.onDocumentLoad",({destroy:i,itemId:o})=>{const r=n.spineItemsManager.get(o),s=r==null?void 0:r.renderer.getDocumentFrame();if(!s||!r)return;const a=Ss.map(u=>{var c;const l=d=>{var p;let f=d;if(Gt(d)&&(f=new PointerEvent(d.type,d)),f!==d){const h=bs(f,d,n.spine.locator,n.context);(p=n.context.state.containerElement)==null||p.dispatchEvent(h)}};return(c=s.contentDocument)==null||c.addEventListener(u,l),()=>{var d;(d=s.contentDocument)==null||d.removeEventListener(u,l)}});i(()=>{a.forEach(u=>u())})}),n},bi=t=>b(e=>Object.entries(e).reduce((n,[i,o])=>t.includes(i)?{...n,[i]:o}:n,{})),Zt=t=>e=>e.pipe(bi(t),O(q));function wi(t){return new L(e=>{const n=new ResizeObserver(i=>{e.next(i)});return n.observe(t),()=>{n.disconnect()}})}const ot=t=>e=>e.pipe(S(n=>t.pipe(X(),b(()=>n)))),Ps=t=>{let e;const n=t.subscribe(i=>{e={result:i}});return()=>(n.unsubscribe(),e?x(e.result):t)};function Si(){return new L(t=>{if(window.requestIdleCallback){const n=window.requestIdleCallback(()=>{t.next(),t.complete()});return()=>cancelIdleCallback(n)}const e=setTimeout(()=>{t.next(),t.complete()},1);return()=>clearTimeout(e)})}function bn(t){return bt(()=>Si().pipe(S(t)))}const wn=(t,e)=>new L(n=>{const i=new MutationObserver(o=>{n.next(o)});return i.observe(t,e),()=>i.disconnect()});class Ii{constructor(e,n){this.settingsManager=n;const i=qe(this.getDefaultSettings(),e);this.outputSettings=this.computeOutputSettings(i),this.inputSettings=qe(this.getDefaultSettings(),e),this.outputSettingsUpdateSubject=new W,this.values$=K([this.settingsManager.values$,this.outputSettingsUpdateSubject.pipe(re(this.outputSettings))]).pipe(b(([o,r])=>({...o,...r})),Q(1)),this.values$.subscribe()}_prepareUpdate(e){const n=this.getCleanedParentInputSettings(e),i=this.settingsManager._prepareUpdate(n),o=qe(this.inputSettings,e),r=this.computeOutputSettings(o),s=this.hasSettingsChanged(r);return{hasChanged:s||i.hasChanged,commit:()=>(this.inputSettings=o,this.outputSettings=r,!i.hasChanged&&s&&this.outputSettingsUpdateSubject.next(r),{...i.commit(),...r})}}update(e){const{commit:n}=this._prepareUpdate(e);n()}get values(){return{...this.settingsManager.values,...this.outputSettings}}watch(e){return Array.isArray(e)?this.values$.pipe(Zt(e)):this.values$.pipe(b(n=>n[e]),O(q))}destroy(){this.outputSettingsUpdateSubject.complete()}}const xs=t=>{const e=new FileReader;return new Promise(n=>{e.addEventListener("load",()=>{n(e.result)},!1),e.readAsDataURL(t)})};let $s=class extends Ii{computeOutputSettings(e){return e}hasSettingsChanged(e){return!q(this.outputSettings,e)}getCleanedParentInputSettings(e){const{fontJustification:n,fontScale:i,fontWeight:o,lineHeight:r,...s}=e;return s}getDefaultSettings(){return{fontScale:1,fontWeight:"publisher",lineHeight:"publisher",fontJustification:"publisher"}}};const _s=t=>e=>{const{fontScale:n,lineHeight:i,fontWeight:o,fontJustification:r}=e,s=new W,a=t(e),u=new $s({fontScale:n,lineHeight:i,fontWeight:o,fontJustification:r},a.settings),c=()=>`
    
    body {
      ${u.values.fontScale!==1?`font-size: ${u.values.fontScale}em !important;`:""}
      ${u.values.lineHeight!=="publisher"?`line-height: ${u.values.lineHeight} !important;`:""}
      ${u.values.fontWeight!=="publisher"?`font-weight: ${u.values.fontWeight} !important;`:""}
      ${u.values.fontJustification!=="publisher"?`text-align: ${u.values.fontJustification} !important;`:""}
    }
  `,l=p=>{a.spineItemsManager.items.forEach(f=>{if(f.renditionLayout!=="pre-paginated"){const h=f.renderer.getDocumentFrame();h&&ce(h,"prose-reader-fonts",c())}}),p&&a.layout()};a.hookManager.register("item.onDocumentLoad",({itemId:p})=>{const f=a.spineItemsManager.get(p);if((f==null?void 0:f.renditionLayout)!=="pre-paginated"){const h=f==null?void 0:f.renderer.getDocumentFrame();h&&ce(h,"prose-reader-fonts",c())}});const d=p=>p.pipe(Tr(),b(([f,h])=>h.fontScale!==f.fontScale||h.lineHeight!==f.lineHeight));return u.values$.pipe(d,P(l),T(a.$.destroy$)).subscribe(),{...a,destroy:()=>{s.complete(),u.destroy(),a.destroy()},settings:u}},Ts=t=>e=>{const n=t(e),i=o=>J(o,"keyup").pipe(U(n.settings.values$),b(([r,{pageTurnDirection:s}])=>{if(s==="horizontal"){if(r.key==="ArrowRight")return n.navigation.turnRight();if(r.key==="ArrowLeft")return n.navigation.turnLeft()}if(s==="vertical"){if(r.key==="ArrowDown")return n.navigation.turnRight();if(r.key==="ArrowUp")return n.navigation.turnLeft()}return r}));return i(document).pipe(T(n.$.destroy$)).subscribe(),n.spineItemsManager.items$.pipe(S(o=>_(...o.map(r=>r.loaded$.pipe(S(()=>{const s=r.renderer.getDocumentFrame();return s instanceof HTMLIFrameElement&&(s!=null&&s.contentDocument)?i(s.contentDocument):ne}))))),T(n.$.destroy$)).subscribe(),n},Es=t=>t.spine.spineItemsManager.items$.pipe(S(e=>_(...e.map(n=>n.loaded$.pipe(S(()=>{const i=n.renderer.getDocumentFrame();if(!i||!(i!=null&&i.contentDocument))return be;const r=Array.from(i.contentDocument.querySelectorAll("a")).map(s=>J(s,"click"));return _(...r)}))))),P(e=>{e.preventDefault()}),H());class ee{constructor(){this.isDestroyed=!1,this.destroySubject=new W,this.destroy$=this.destroySubject.asObservable()}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.destroySubject.next(),this.destroySubject.complete())}}const Pi=class xi extends ee{constructor(e){super(),this.triggerSubject=new W,this.stateSubject=new G("idle"),this.unload$=this.triggerSubject.pipe(U(this.stateSubject),F(([o,r])=>o.type==="unload"&&r!=="idle"&&r!=="unloading"),b(()=>{}),H()),this.load$=this.triggerSubject.pipe(U(this.stateSubject),F(([o,r])=>o.type==="load"&&r!=="loaded"&&r!=="loading"),b(()=>{}),H()),this.context=e.context,this.settings=e.settings,this.hookManager=e.hookManager,this.item=e.item,this.containerElement=e.containerElement,this.resourcesHandler=e.resourcesHandler;const n=this.triggerSubject.pipe(U(this.stateSubject),F(([o,r])=>o.type==="unload"&&r!=="idle"&&r!=="unloading"),b(()=>{}),H());this.load$.pipe(S(()=>(this.stateSubject.next("loading"),this.onCreateDocument().pipe(X()).pipe(ae(r=>(this.hookManager.execute("item.onDocumentCreated",this.item.id,{itemId:this.item.id,documentContainer:r}),this.onLoadDocument().pipe(_e(null),X()).pipe(ot(this.context.bridgeEvent.viewportFree$),S(()=>{const a=this.hookManager.execute("item.onDocumentLoad",this.item.id,{itemId:this.item.id,documentContainer:r}).filter(u=>u instanceof L);return K([x(null),...a]).pipe(X())})))),P(()=>{this.stateSubject.next("loaded")}),T(_(this.destroy$,n)))))).subscribe();const i=n.pipe(S(()=>(this.stateSubject.next("unloading"),this.context.bridgeEvent.viewportFree$.pipe(X(),P(()=>{this.hookManager.destroy("item.onDocumentLoad",this.item.id)}),S(()=>this.onUnload().pipe(_e(null),X())),P(()=>{this.stateSubject.next("idle")}),T(this.load$)))));_(i).pipe(T(this.destroy$)).subscribe()}setDocumentContainer(e){this._documentContainer=e,this._documentContainer.classList.add(xi.DOCUMENT_CONTAINER_CLASS_NAME)}attach(){this.documentContainer&&this.containerElement.appendChild(this.documentContainer)}detach(){var e;(e=this._documentContainer)==null||e.remove(),this._documentContainer=void 0}get state$(){return this.stateSubject}get isLoaded$(){return this.state$.pipe(b(e=>e==="loaded"))}load(){this.triggerSubject.next({type:"load"})}unload(){this.triggerSubject.next({type:"unload"})}renderHeadless(){const e=new W;return bt(()=>this.onRenderHeadless({release:e})).pipe(_e(void 0),X(),b(n=>{if(n)return{doc:n,release:()=>{e.next(void 0)}}}),he(()=>{e.complete()}),Ae(n=>(Y.error(n),x(void 0))))}layout(e){return bt(()=>this.onLayout(e))}destroy(){this.unload(),this.stateSubject.complete(),super.destroy()}get documentContainer(){return this._documentContainer}get writingMode(){}get readingDirection(){}get renditionLayout(){var e;const n=this.item.renditionLayout;if(n)return n;const i=this.getDocumentFrame();if(i){const{hasViewport:o}=Yt(i);if(o)return"pre-paginated"}return((e=this.context.manifest)==null?void 0:e.renditionLayout)??"reflowable"}};Pi.DOCUMENT_CONTAINER_CLASS_NAME="prose-reader-document-container";let Jt=Pi;const Fs=t=>new URL(t.href);class Kt{constructor(e,n){this.item=e,this.settings=n}async getResource(){var e,n;return await er(((n=(e=this.settings.values).getResource)==null?void 0:n.call(e,this.item))??x(void 0))??Fs(this.item)}async fetchResource(){const e=await this.getResource();return e instanceof Response?e:e instanceof URL?fetch(e):e}}const $i=(t,e)=>{const n=t.startsWith("file://"),i=n?t.replace("file://","http://"):t,o=new URL(e,i).toString();return n?o.replace("http://","file://"):o},Os=async(t,e,n,i,o)=>{if(!t||!t.defaultView)return;const r=e.sheet;if(r)try{const s=Array.from(r.cssRules||[]);for(let a=0;a<s.length;a++){const u=s[a];if(t.defaultView&&u instanceof t.defaultView.CSSFontFaceRule){const c=u.style.getPropertyValue("src");if(c.match(/url\(['"]?([^'"]+)['"]?\)/g)){const d=c.split(",").map(h=>h.trim()),p=await Promise.all(d.map(async h=>{var g,v;if(h.startsWith("local("))return h;const m=h.match(/url\(['"]?([^'"]+)['"]?\)/);if(!m)return h;const y=m[1]??"",w=(g=i.manifest)==null?void 0:g.items.find(({href:I})=>`${$i(n,y).toLowerCase()}`.endsWith(`${I.toLowerCase()}`));if(w){const I=new Kt(w,o);try{const $=await I.getResource();if($ instanceof Response){const E=await $.blob(),R=(v=t.defaultView)==null?void 0:v.URL.createObjectURL(E);return h.replace(m[0],`url("${R}")`)}}catch($){console.error("Error loading font:",$)}}return h})),f=u.cssText.replace(/src:\s*[^;]+;/,`src: ${p.join(", ")};`);r.deleteRule(a),r.insertRule(f,a)}}}}catch(s){console.error("Could not access stylesheet rules:",s)}},As=(t,e,n,i,o)=>{var r;const s=e.getAttribute("src")||e.getAttribute("href");if(!s)return x(null);const a=(r=i.manifest)==null?void 0:r.items.find(({href:c})=>`${$i(n,s).toLowerCase()}`.endsWith(`${c.toLowerCase()}`));if(!a)return x(null);const u=new Kt(a,o);return j(u.getResource()).pipe(ae(c=>c instanceof Response?j(c.blob()):x(void 0)),ae(c=>{var l;if(!c)return x(null);const d=((l=t==null?void 0:t.defaultView)==null?void 0:l.URL.createObjectURL(c))??"";if(e.hasAttribute("src"))e.setAttribute("src",d);else if(e.hasAttribute("href")&&(e.setAttribute("href",d),t!=null&&t.defaultView&&e instanceof t.defaultView.HTMLLinkElement))return new L(p=>{e.onload=async()=>{try{e.sheet&&await Os(t,e,n,i,o),p.next(),p.complete()}catch(f){p.error(f)}},e.onerror=p.error});return x(null)}))},Ms=({settings:t,item:e,context:n})=>i=>i.pipe(S(o=>{const r=yi(o.contentDocument),s=Mr(e.href),a=r.map(u=>As(o.contentDocument,u,s,n,t));return K(a).pipe(b(()=>o))})),Ls=t=>{vs(t==null?void 0:t.contentDocument)},Rs=[".xhtml",".html",".htm"],Pe="prose-reader",Cs=t=>new Promise((e,n)=>{const i=new Image;i.src=t,i.onload=()=>{e({height:i.naturalHeight,width:i.naturalWidth})},i.onerror=n}),Ns=async(t,e)=>{if(typeof t=="string")return t;const n=Lr(t.headers.get("Content-Type")||"")||it(e.href);if(["image/jpg","image/jpeg","image/png","image/webp"].some(o=>o===n)){const o=await xs(await t.blob()),{height:r,width:s}=await Cs(o);return`
      <html>
        <head>
          ${e.renditionLayout==="pre-paginated"?`<meta name="viewport" content="width=${s}, height=${r}">`:""}
        </head>
        <body style="margin: 0px;" tab-index="-1;">
          <img
            src="${o}"
            style="max-width: 100%;height:100%;object-fit:contain;"
          >
        </body>
      </html>
        `}return["text/plain"].some(o=>o===n)?`
      <!DOCTYPE html>
      <html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en" lang="en">
        <head>
          <style>
            pre {
              white-space: pre;
              white-space: pre-wrap;
              word-wrap: break-word;
            }
          </style>
        </head>
        <body>
          <pre>${await t.text()}</pre>
        </body>
      </html>
    `:await t.text()},js=({item:t,resourcesHandler:e})=>{const n=i=>Ns(i,t);return i=>i.pipe(S(o=>j(e.getResource()).pipe(S(r=>r instanceof URL&&t.href.startsWith(window.location.origin)&&(t.mediaType&&["application/xhtml+xml","application/xml","text/html","text/xml"].includes(t.mediaType)||!t.mediaType&&Rs.some(a=>t.href.endsWith(a)))?(o==null||o.setAttribute("src",t.href),x(o)):(r instanceof URL?j(e.fetchResource()):x(r)).pipe(S(a=>{if(!(a instanceof Response))throw new Error("Invalid resource");return j(n(a))}),P(a=>{if(a){const u=new Blob([a],{type:"text/html"}),c=URL.createObjectURL(u);o==null||o.setAttribute("src",c)}}),b(()=>o),Ae(a=>(Y.error(`Error while trying to fetch or load resource for item ${t.id}`,r),Y.error(a),x(o))))))))},Ds=()=>{const t=document.createElement("iframe");return t.frameBorder="no",t.tabIndex=0,t.setAttribute("sandbox",`
  allow-same-origin 
  allow-scripts 
  allow-top-navigation-to-custom-protocols
`),t.style.cssText=`
  overflow: hidden;
  background-color: transparent;
  border: 0px none transparent;
  padding: 0px;
`,t.setAttribute("role","main"),t},_i=()=>`
    body {
        margin: 0;
        }
      }
    `,Ti=({pageHeight:t,pageWidth:e,frameElement:n})=>{const i=Yt(n);if(n!=null&&n.contentDocument&&n.contentWindow&&i){const o=e/(i.width??1);return{computedScale:Math.min(o,t/(i.height??1)),computedWidthScale:o,viewportDimensions:i}}},Vs=({columnWidth:t,enableTouch:e,spreadPosition:n},i)=>`
      ${_i()}
      body {
        ${i?"":`
          display: flex;
          justify-content: ${n==="left"?"flex-end":n==="right"?"flex-start":"center"};
        `}
      }
      
      html, body {
        height: 100%;
        width: 100%;
      }
      
      html, body {
        -max-width: ${t}px !important;
      }
      
      html, body {
        ${e?`
          touch-action: none
        `:""}
      }
      
      img {
        user-select: none;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        user-drag: none;
        
        display: flex;
        
        ${i?"":`
          -width: 100%;
          max-width: 100%;
          height:100%;
          object-fit:contain;
        `}
      }
    `,ks=({pageHeight:t,pageWidth:e})=>({columnHeight:t,columnWidth:e}),Sn=(t,e)=>{t.style.width=`${e.width}px`,t.style.height=`${e.height}px`},Ws=({minPageSpread:t,blankPagePosition:e,spreadPosition:n,pageHeight:i,pageWidth:o,frameElement:r,isRTL:s,enableTouch:a})=>{const u=t*o;if(r!=null&&r.contentDocument&&(r!=null&&r.contentWindow)){const{viewportDimensions:c,computedScale:l=1}=Ti({frameElement:r,pageHeight:i,pageWidth:o})??{},d=o,p=i,f=Vs({...ks({pageHeight:i,pageWidth:o}),enableTouch:a,spreadPosition:n},c);if(ce(r,"prose-reader-css",f),c?Sn(r,{width:c.width??1,height:c.height??1}):Sn(r,{width:d,height:p}),c){r==null||r.style.setProperty("position","absolute"),r==null||r.style.setProperty("top","50%"),n==="left"?(r==null||r.style.setProperty("right","0"),r==null||r.style.removeProperty("left")):e==="before"&&s?(r==null||r.style.setProperty("right","50%"),r==null||r.style.removeProperty("left")):n==="right"?(r==null||r.style.setProperty("left","0"),r==null||r.style.removeProperty("right")):(r==null||r.style.setProperty("left",e==="before"?s?"25%":"75%":e==="after"?s?"75%":"25%":"50%"),r==null||r.style.removeProperty("right"));const h=n!=="none"?"0":"-50%",g=n==="right"&&e!=="before"?"left":n==="left"||e==="before"&&s?"right":"center";r==null||r.style.setProperty("transform",`translate(${h}, -50%) scale(${l})`),r==null||r.style.setProperty("transform-origin",`${g} center`)}else e==="before"?s?r==null||r.style.setProperty("margin-right",`${o}px`):r==null||r.style.setProperty("margin-left",`${o}px`):(r==null||r.style.removeProperty("margin-left"),r==null||r.style.removeProperty("margin-right"));return{width:u,height:p}}return{width:u,height:i}},Us=()=>`
      ${_i()}
      html {
        width: 100%;
        height: 100%;
      }
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      
      html, body {
        touch-action: none;
      }
    `,zs=({isScrollable:t,enableTouch:e})=>`
      
      html, body {
        width: 100%;
        margin: 0;
        padding: 0;
        ${e?`
          touch-action: none
        `:""}
      }
      ${t?`
        img {
          height: auto !important;
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          
          width: 100%;
          
          display: block;
        }
      `:""}
    `,Bs=({width:t,columnHeight:e,columnWidth:n})=>`
      parsererror {
        display: none !important;
      }
      
      html, body {
        margin: 0;
        padding: 0 !important;
        -max-width: ${n}px !important;
      }
      
      body {
        padding: 0 !important;
        width: ${t}px !important;
        height: ${e}px !important;
        overflow-y: hidden;
        column-gap: 0px !important;
        column-width: ${n}px !important;
        column-fill: auto !important;
        word-wrap: break-word;
        box-sizing: border-box;
      }
      body {
        margin: 0;
      }
      body:focus-visible {
        
        outline: none;
      }
      
      html, body {
        touch-action: none;
      }
      
      * {
        -max-width: ${n}px !important;
      }
      
      img, video, audio, object, svg {
        max-width: 100%;
        -max-width: ${n}px !important;
        -max-height: ${e}px !important;
        -pointer-events: none;
        -webkit-column-break-inside: avoid;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      figure {
        d-max-width: ${n}px !important;
      }
      img {
        object-fit: contain;
        break-inside: avoid;
        box-sizing: border-box;
        d-max-width: ${n}px !important;
      }
      
      table {
        max-width: ${n}px !important;
        table-layout: fixed;
      }
      td {
        max-width: ${n}px;
      }
    `,Hs=({isUsingVerticalWriting:t,minimumWidth:e,pageHeight:n,pageWidth:i})=>{let s=i-0;const a=n-0*2;let u=i-0*2;return t&&(u=e-0*2,s=a),{columnHeight:a,columnWidth:s,width:u}},Ue=(t,e)=>{t.style.width=`${e.width}px`,t.style.height=`${e.height}px`},qs=({pageHeight:t,pageWidth:e,frameElement:n,manifest:i,latestContentHeightWhenLoaded:o,minPageSpread:r,isRTL:s,blankPagePosition:a,isImageType:u,enableTouch:c,isUsingVerticalWriting:l})=>{const d=r*e;let p=o;const f=(i==null?void 0:i.renditionLayout)==="reflowable"&&(i==null?void 0:i.renditionFlow)==="scrolled-continuous",h=f?Math.min(400,t):t;n==null||n.style.setProperty("width",`${e}px`),f||n==null||n.style.setProperty("height",`${h}px`);const{viewportDimensions:g,computedScale:v=1}=Ti({frameElement:n,pageHeight:h,pageWidth:e})??{},m=(i==null?void 0:i.renditionLayout)==="pre-paginated";if(n!=null&&n.contentDocument&&(n!=null&&n.contentWindow)){let w=e,I=h;if(g!=null&&g.hasViewport)ce(n,"prose-reader-html-renderer-framce-css",Us()),Ue(n,{width:g.width??1,height:g.height??1}),n==null||n.style.setProperty("position","absolute"),n==null||n.style.setProperty("top","50%"),n==null||n.style.setProperty("left",a==="before"?s?"25%":"75%":a==="after"?s?"75%":"25%":"50%"),n==null||n.style.setProperty("transform",`translate(-50%, -50%) scale(${v})`),n==null||n.style.setProperty("transform-origin","center center");else{const E=u?zs({isScrollable:(i==null?void 0:i.renditionFlow)==="scrolled-continuous",enableTouch:c}):Bs(Hs({isUsingVerticalWriting:l,minimumWidth:d,pageHeight:h,pageWidth:e}));if(ce(n,"prose-reader-css",E,!0),l)I=Math.ceil(n.contentDocument.documentElement.scrollHeight/h)*h,Ue(n,{width:d,height:I});else if((i==null?void 0:i.renditionFlow)==="scrolled-continuous")I=n.contentDocument.body.scrollHeight,p=I,Ue(n,{width:d,height:I});else{const R=Math.ceil(n.contentDocument.documentElement.scrollWidth/e);m?w=e:w=R*e,Ue(n,{width:w,height:I})}}return w%d===0?n==null||n.style.setProperty("margin-left","0px"):(w=w+e,s&&!l&&(n==null||n.style.setProperty("margin-left",`${e}px`))),{width:w,height:I}}return{width:d,height:p||h,latestContentHeightWhenLoaded:p}};class Xs extends Jt{constructor(){super(...arguments),this.isImageType=()=>{const e=this.item.mediaType??it(this.item.href);return!!(e!=null&&e.startsWith("image/"))}}onCreateDocument(){const e=Ds();return this.setDocumentContainer(e),x(e)}onLoadDocument(){const e=this.getFrameElement();if(!e)throw new Error("invalid frame");return x(e).pipe(js({item:this.item,resourcesHandler:this.resourcesHandler,settings:this.settings}),ot(this.context.bridgeEvent.viewportFree$),P(()=>{this.attach()}),os,Ms({context:this.context,item:this.item,settings:this.settings}),rs)}onUnload(){return Ls(this.getFrameElement()),this.detach(),ne}onLayout({minPageSpread:e,blankPagePosition:n,spreadPosition:i}){var o,r;const{width:s,height:a}=this.context.getPageSize(),u=this.getFrameElement();if(!u)return x(void 0);const c=!!((o=this.writingMode)!=null&&o.startsWith("vertical"));if(this.item.renditionLayout==="pre-paginated"||!this.item.renditionLayout&&((r=this.context.manifest)==null?void 0:r.renditionLayout)==="pre-paginated"){const p=Ws({blankPagePosition:n,enableTouch:this.settings.values.computedPageTurnMode!=="scrollable",frameElement:u,isRTL:this.context.isRTL(),minPageSpread:e,pageHeight:a,pageWidth:s,spreadPosition:i});return x(p)}const{latestContentHeightWhenLoaded:l,...d}=qs({pageHeight:a,pageWidth:s,frameElement:u,manifest:this.context.manifest,blankPagePosition:n,isUsingVerticalWriting:c,isRTL:this.context.isRTL(),latestContentHeightWhenLoaded:this.latestContentHeightWhenLoaded,minPageSpread:e,isImageType:this.isImageType(),enableTouch:this.settings.values.computedPageTurnMode!=="scrollable"});return this.latestContentHeightWhenLoaded=l,x(d)}onRenderHeadless(){return j(this.resourcesHandler.fetchResource()).pipe(S(e=>{if(e instanceof Response){const n=e.headers.get("content-type")??"";if(["application/xhtml+xml","application/xml","text/html","text/xml"].includes(n))return j(e.text()).pipe(b(o=>new DOMParser().parseFromString(o,n)))}return x(void 0)}))}getFrameElement(){const e=this.documentContainer;if(e instanceof HTMLIFrameElement)return e}getComputedStyleAfterLoad(){var e,n;const i=this.getFrameElement(),o=(e=i==null?void 0:i.contentDocument)==null?void 0:e.body;if(o)return(n=i==null?void 0:i.contentWindow)==null?void 0:n.getComputedStyle(o)}get writingMode(){var e;return(e=this.getComputedStyleAfterLoad())==null?void 0:e.writingMode}get readingDirection(){var e;if(this.writingMode==="vertical-rl")return"rtl";switch((e=this.getComputedStyleAfterLoad())==null?void 0:e.direction){case"ltr":case"inherit":case"initial":return"ltr";case"rtl":return"rtl";default:return}}getDocumentFrame(){return this.getFrameElement()}}const Ys=t=>e=>{const n=t({...e,getRenderer(o){var r;return((r=e.getRenderer)==null?void 0:r.call(e,o))??(a=>new Xs(a))}}),i=Es(n);return i.pipe(T(n.$.destroy$)).subscribe(),{...n,links$:i}};function fe(t){return t!=null}let Gs=class extends Ii{computeOutputSettings(e){return e}hasSettingsChanged(e){return!q(this.outputSettings,e)}getCleanedParentInputSettings(e){const{layoutAutoResize:n,pageHorizontalMargin:i,pageVerticalMargin:o,layoutLayerTransition:r,viewportMode:s,...a}=e;return a}getDefaultSettings(){return{layoutAutoResize:"container",pageHorizontalMargin:24,pageVerticalMargin:24,layoutLayerTransition:!0,viewportMode:"normal"}}};const Zs=t=>{let e;const n=t.context.state$.pipe(S(({containerElement:u})=>u?new L(()=>(e=u.ownerDocument.createElement("div"),e.style.cssText=`
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: hidden;
      `,u.appendChild(e),()=>{e==null||e.remove(),e=void 0})):be)),i=u=>ri(u,de).pipe(P(()=>{e==null||e.style.setProperty("visibility","hidden")})),o=t.context.bridgeEvent.viewportBusy$.pipe(P(()=>{e==null||e.style.setProperty("visibility","visible")})),r=i(t.viewportFree$).pipe(Ne(1)),a=t.settings.values$.pipe(b(()=>t.settings.values.computedPageTurnMode),O()).pipe(S(u=>u==="controlled"?o.pipe(S(()=>r)):i(x(void 0))),T(t.$.destroy$));return _(n,a)},Js=t=>{t.hookManager.register("item.onAfterLayout",({item:e,blankPagePosition:n,minimumWidth:i})=>{const o=t.spineItemsManager.get(e.id),r=o==null?void 0:o.renderer.getDocumentFrame();if((o==null?void 0:o.renditionLayout)!=="reflowable"||!(r instanceof HTMLIFrameElement))return;const{hasViewport:s}=Yt(r),{width:a}=t.context.getPageSize(),u=o==null?void 0:o.renderer.getDocumentFrame();if(s){const c=a<i;n==="none"&&c&&u instanceof HTMLIFrameElement&&(u==null||u.style.setProperty("left",t.context.isRTL()?"75%":"25%"))}})};class Ei{constructor(e){this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.width=e.width,this.height=e.height,this.x=e.x,this.y=e.y}}class _t extends Ei{constructor(){super(...arguments),this.__symbol="SpineItemSpineLayout"}}class Ks extends Ei{constructor(){super(...arguments),this.__symbol="SpineItemPageSpineLayout"}}class M{constructor(e){this.__symbol="SpinePosition",this.x=e.x,this.y=e.y}}class Qt{constructor(e){this.__symbol="UnsafeSpinePosition",this.x=e.x,this.y=e.y}static from(e){return new Qt(e)}}const Qs=({position:t,pageSize:e})=>new Ks({x:t.x,y:t.y,left:t.x,top:t.y,width:e.width,height:e.height,bottom:t.y+e.height,right:t.x+e.width}),ea=t=>{const e=t.spine.spineLayout.layout$.pipe(b(()=>({pages:t.spine.spineItemsManager.items.reduce((r,s,a)=>{const l=new Array(s.numberOfPages).fill(void 0).map((d,p)=>{const f=t.spine.spineItemLocator.getSpineItemPositionFromPageIndex({spineItem:s,pageIndex:p}),h=t.spine.locator.getSpinePositionFromSpineItemPosition({spineItem:s,spineItemPosition:f});return Qs({pageSize:t.context.getPageSize(),position:h})}).map((d,p)=>({itemIndex:a,absolutePageIndex:a+p,absolutePosition:d}));return[...r,...l]},[])})),P(i=>{Y.debug("layout:info",i)}),H()),n=e.pipe(Q({refCount:!0,bufferSize:1}));return n.pipe(T(t.$.destroy$)).subscribe(),{layout$:e,info$:n}},ta=(t,e)=>e.pipe(P(n=>{t.viewport.value.element.style.transition="transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)",t.settings.values.computedPageTurnMode==="scrollable"?t.viewport.value.element.style.transformOrigin="top":t.viewport.value.element.style.transformOrigin="center",n==="thumbnails"?t.viewport.value.element.style.transform="scale(0.5)":t.viewport.value.element.style.transform="scale(1)",t.layout()})),na=t=>e=>{const{pageHorizontalMargin:n,pageVerticalMargin:i,layoutAutoResize:o,layoutLayerTransition:r}=e,s=t(e),a=new Gs({pageHorizontalMargin:n,pageVerticalMargin:i,layoutAutoResize:o,layoutLayerTransition:r},s.settings);s.hookManager.register("onViewportOffsetAdjust",()=>{let v=!1;s.spineItemsManager.items.forEach(m=>{const y=m.renderer.getDocumentFrame();!v&&y&&(y.getBoundingClientRect().left,v=!0)})}),s.hookManager.register("item.onBeforeLayout",({item:v})=>{const m=s.spineItemsManager.get(v.id),y=v.mediaType??it(v.href),w=!!(y!=null&&y.startsWith("image/")),{pageHorizontalMargin:I=0,pageVerticalMargin:$=0}=a.values,E=s.context.getPageSize();if((m==null?void 0:m.renditionLayout)==="reflowable"&&!w){let R=E.width-I*2;const V=E.height-$*2;let C=E.width-I*2,z=I*2;m.isUsingVerticalWriting()&&(C=E.width-I*2,R=V,z=$*2);const B=m==null?void 0:m.renderer.getDocumentFrame();B&&ce(B,"prose-layout-enhancer-css",`
              body {
                width: ${C}px !important;
                margin: ${$}px ${I}px !important;
                column-gap: ${z}px !important;
                column-width: ${R}px !important;
                height: ${V}px !important;
              }
              img, video, audio, object, svg {
                -max-width: ${R}px !important;
                -max-height: ${V}px !important;
              }
              table {
                max-width: ${R}px !important;
              }
              td {
                max-width: ${R}px;
              }
            `)}}),Js(s),s.hookManager.register("item.onDocumentCreated",({documentContainer:v})=>{v.style.opacity="0",a.values.layoutLayerTransition&&(v.style.transition="opacity 300ms")}),s.hookManager.register("item.onBeforeLayout",({item:v})=>{const m=s.spineItemsManager.get(v.id),y=m==null?void 0:m.renderer.documentContainer;s.settings.values.computedPageTurnMode!=="scrollable"&&(y==null||y.setAttribute("tab-index","0"))});const u=s.spineItemsObserver.itemIsReady$.pipe(F(({isReady:v})=>v),P(({item:v})=>{const m=v.renderer.documentContainer;m&&(m.style.opacity="1")})),c=v=>new L(m=>{const y=new ResizeObserver(()=>{m.next()});return y.observe(v),()=>{y.disconnect()}}),l=a.values$.pipe(F(({layoutAutoResize:v})=>v==="container"),S(()=>s.context.containerElement$),F(fe),S(v=>c(v)),Ie(100),P(()=>{s==null||s.layout()})),d=Zs(s);a.watch(["pageHorizontalMargin","pageVerticalMargin"]).pipe(Ht(1),P(()=>{s.layout()}),T(s.$.destroy$)).subscribe();const p=s.spineItemsObserver.itemIsReady$.pipe(P(({item:v,isReady:m})=>{const y="prose-spineItem-ready";m?v.containerElement.classList.add(y):v.containerElement.classList.remove(y)})),{layout$:f,info$:h}=ea(s),g=ta(s,a.watch("viewportMode"));return _(p,u,d,l,g).pipe(T(s.$.destroy$)).subscribe(),{...s,destroy:()=>{a.destroy(),s.destroy()},settings:a,layout$:f,layoutInfo$:h}},ia=`${Pe}-enhancer-loading`,Fi=`${ia}-container`,oa=(t,e)=>{const n=t.ownerDocument.createElement("div");return n.classList.add(Fi),n.style.cssText=`
      height: 100%;
      width: 100%;
      max-width: ${e.state.visibleAreaRect.width}px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      position: absolute;
      left: 0;
      top: 0;
      color: rgb(202, 202, 202);
      background-color: white;
      z-index: 1;
    `,n},ra=({container:t,item:e})=>{const n=t.ownerDocument.createElement("div");n.innerText="prose",n.style.cssText=`
      font-size: 4em;
    `;const i=t.ownerDocument.createElement("div");return i.innerText=`loading ${e.id}`,i.style.cssText=`
      font-size: 1.2em;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      max-width: 300px;
      width: 80%;
    `,t.appendChild(n),t.appendChild(i),t},sa=t=>e=>{const{loadingElementCreate:n=ra}=e,i=t(e),o=u=>x(u.reduce((c,{item:l,element:d})=>{d.style.zIndex="0";const p=d.querySelector(`.${Fi}`);if(p instanceof HTMLElement)return c[l.id]=p,c;const f=n({container:oa(d,i.context),item:l});return d.appendChild(f),c[l.id]=f,c},{})),r=u=>K([i.spine.spineLayout.layout$,i.theme.$.theme$]).pipe(b(([,c])=>({width:i.context.state.visibleAreaRect.width,theme:c})),O(q),P(({width:c,theme:l})=>{Object.values(u).forEach(d=>{d.style.setProperty("max-width",`${c}px`),d.style.setProperty("color",l==="sepia"?"#939393":"rgb(202, 202, 202)")})})),s=u=>i.spineItemsObserver.itemIsReady$.pipe(P(({item:c,isReady:l})=>{var d,p;(d=u[c.item.id])==null||d.style.setProperty("visibility",l?"hidden":"visible"),(p=u[c.item.id])==null||p.style.setProperty("z-index",l?"0":"1")})),a=i.spineItemsManager.items$.pipe(S(u=>o(u)),Q(1),T(i.context.destroy$));return a.pipe(S(u=>_(r(u),s(u))),T(i.$.destroy$)).subscribe(),{...i,loading:{$:{items$:a}}}};class aa extends Jt{getImageElement(){const e=this.documentContainer;if(e instanceof HTMLImageElement)return e}onCreateDocument(){const e=this.containerElement.ownerDocument.createElement("img");return j(this.resourcesHandler.getResource()).pipe(S(n=>{if(this.setDocumentContainer(e),e.style.objectFit="contain",e.style.userSelect="none",n instanceof URL)return x(n.href);if(n instanceof Response)return j(n.blob()).pipe(b(i=>URL.createObjectURL(i)));throw new Error("Invalid resource")}),b(n=>{const i=this.getImageElement();return i&&(i.src=n),e}))}onLoadDocument(){const e=this.getImageElement();if(!e)throw new Error("invalid element");return this.attach(),J(e,"load")}onUnload(){const e=this.getImageElement();return e&&URL.revokeObjectURL(e.src),this.detach(),ne}onLayout({spreadPosition:e}){const n=this.getImageElement(),{height:i,width:o}=this.context.getPageSize();let r=i;const s=o;if(!n)return x(void 0);const a=n.naturalWidth||1,u=n.naturalHeight||1,c=a/u;return this.settings.values.computedPageTurnDirection==="vertical"&&this.settings.values.computedPageTurnMode==="scrollable"&&!this.context.state.isUsingSpreadMode&&(r=Math.ceil(o/c)),n.style.height=`${r}px`,n.style.width=`${s}px`,n.style.objectPosition=e==="left"?"right":e==="right"?"left":"center",x({width:s,height:r})}onRenderHeadless(){return ne}getDocumentFrame(){}}const ua=t=>e=>{const n=t({...e,getRenderer(s){var a;const u=(a=e.getRenderer)==null?void 0:a.call(e,s),c=s.mediaType??it(s.href),l=!!(c!=null&&c.startsWith("image/"));return!u&&l?d=>new aa(d):u}}),i=new IntersectionObserver(s=>{s.forEach(a=>{var u;const c=a.target,l=Array.from(((u=c.contentDocument)==null?void 0:u.body.getElementsByTagName("audio"))||[]);a.isIntersecting?l.forEach(d=>{d.hasAttribute("autoplay")&&d.paused&&d.readyState>=2&&d.play().catch(console.error)}):l.forEach(d=>{d.pause(),d.currentTime=0})})},{threshold:.01}),o=new IntersectionObserver(s=>{s.forEach(a=>{if(a.target.tagName==="video"){const u=a.target;a.isIntersecting?u.hasAttribute("autoplay")&&u.paused&&u.readyState>=2&&u.play().catch(console.error):(u.pause(),u.currentTime=0)}})},{threshold:.5});return n.hookManager.register("item.onDocumentLoad",({destroy:s,itemId:a})=>{var u,c;const l=(u=n.spineItemsManager.get(a))==null?void 0:u.renderer.getDocumentFrame();if(!l)return;i.observe(l);const d=(c=l.contentDocument)==null?void 0:c.body.getElementsByTagName("video"),p=Array.from(d||[]).map(f=>(o.observe(f),()=>o.unobserve(f)));s(()=>{i.unobserve(l),p.forEach(f=>f())})}),{...n,destroy:()=>{i.disconnect(),o.disconnect(),n.destroy()}}},ca=(t,e)=>t.links$.pipe(P(n=>{var i;if(!ys(n.target,"a")||n.type!=="click")return;const o=new URL(n.target.href),r=`${o.origin}${o.pathname}`;((i=t.context.manifest)==null?void 0:i.spineItems.some(a=>a.href===r))&&e.goToUrl(o)})),le=Y.namespace("navigation");class k{constructor(e){this.__symbol=Symbol("SpineItemPosition"),this.x=e.x,this.y=e.y}}const la=({position:t,spineItem:e,pageHeight:n,pageWidth:i,spineItemLocator:o})=>{let r=new k({x:t.x-i,y:t.y});return e.isUsingVerticalWriting()&&(r=new k({x:t.x,y:t.y+n})),o.getSpineItemClosestPositionFromUnsafePosition(r,e)},In=({position:t,navigationResolver:e,computedPageTurnDirection:n,spineItemsManager:i,spineLocator:o,context:r})=>{const s=n,a=o.getSpineItemFromPosition(t)||i.get(0),u=t;if(!a)return u;const c=o.getSpineItemPositionFromSpinePosition(t,a),l=la({position:c,spineItem:a,pageHeight:r.getPageSize().height,pageWidth:r.getPageSize().width,spineItemLocator:o.spineItemLocator});return e.arePositionsDifferent(l,c)?o.getSpinePositionFromSpineItemPosition({spineItemPosition:l,spineItem:a}):e.getAdjustedPositionWithSafeEdge(s==="horizontal"?new M({x:t.x-r.getPageSize().width,y:0}):new M({y:t.y-r.getPageSize().height,x:0}))},da=({position:t,spineItem:e,context:n,navigationResolver:i,spineItemsManager:o,spineLocator:r,computedPageTurnDirection:s})=>{const a=In({position:t,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:o,spineLocator:r});if(e!=null&&e.isUsingVerticalWriting()&&t.x===a.x)return i.getAdjustedPositionForSpread(a);if(n.state.isUsingSpreadMode){if(e!=null&&e.isUsingVerticalWriting()&&t.x!==a.x)return i.getAdjustedPositionForSpread(i.getAdjustedPositionWithSafeEdge(n.isRTL()?{...a,x:a.x+n.getPageSize().width}:{...a,x:a.x-n.getPageSize().width}));if(s==="vertical"&&t.y!==a.y)return i.getAdjustedPositionForSpread(a);const u=In({position:a,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:o,spineLocator:r});return i.getAdjustedPositionForSpread(u)}return i.getAdjustedPositionForSpread(a)},pa=({position:t,spineItem:e,pageHeight:n,pageWidth:i,spineItemLocator:o})=>{let r=new k({x:t.x+i,y:t.y});return e.isUsingVerticalWriting()&&(r=new k({x:t.x,y:t.y-n})),o.getSpineItemClosestPositionFromUnsafePosition(r,e)},Pn=({position:t,navigationResolver:e,computedPageTurnDirection:n,spineItemsManager:i,spineLocator:o,context:r})=>{const s=n,a=o.getSpineItemFromPosition(t)||i.get(0),u=t;if(!a)return u;const c=o.getSpineItemPositionFromSpinePosition(t,a),l=pa({position:c,spineItem:a,pageHeight:r.getPageSize().height,pageWidth:r.getPageSize().width,spineItemLocator:o.spineItemLocator});return e.arePositionsDifferent(l,c)?o.getSpinePositionFromSpineItemPosition({spineItemPosition:l,spineItem:a}):e.getAdjustedPositionWithSafeEdge(s==="horizontal"?new M({x:t.x+r.getPageSize().width,y:0}):new M({y:t.y+r.getPageSize().height,x:0}))},fa=({position:t,spineItem:e,context:n,navigationResolver:i,spineItemsManager:o,spineLocator:r,computedPageTurnDirection:s})=>{const a=Pn({position:t,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:o,spineLocator:r});if(e!=null&&e.isUsingVerticalWriting()&&t.x===a.x)return i.getAdjustedPositionForSpread(a);if(n.state.isUsingSpreadMode){if(e!=null&&e.isUsingVerticalWriting()&&t.x!==a.x)return i.getAdjustedPositionForSpread(i.getAdjustedPositionWithSafeEdge(n.isRTL()?{...a,x:a.x-n.getPageSize().width}:{...a,x:a.x+n.getPageSize().width}));if(s==="vertical"&&t.y!==a.y)return i.getAdjustedPositionForSpread(a);const u=Pn({position:a,context:n,navigationResolver:i,computedPageTurnDirection:s,spineItemsManager:o,spineLocator:r});return i.getAdjustedPositionForSpread(u)}return i.getAdjustedPositionForSpread(a)};class ha{constructor(e){this.reader=e,this.movingLastDelta={x:0,y:0},this.movingLastPosition=new M({x:0,y:0}),this.unlock=void 0}turnRight(){return this.turnRightOrBottom()}turnLeft(){return this.turnLeftOrTop()}turnTop(){return this.turnLeftOrTop()}turnBottom(){return this.turnRightOrBottom()}turnRightOrBottom(){const e=this.reader.navigation.getNavigation(),n=this.reader.spineItemsManager.get(e.spineItem);if(!n)return;const i=fa({context:this.reader.context,navigationResolver:this.reader.navigation.navigationResolver,position:e.position,computedPageTurnDirection:this.reader.settings.values.computedPageTurnDirection,spineItem:n,spineItemsManager:this.reader.spineItemsManager,spineLocator:this.reader.spine.locator});return this.reader.navigation.navigate({position:i})}turnLeftOrTop(){const e=this.reader.navigation.getNavigation(),n=this.reader.spineItemsManager.get(e.spineItem);if(!n)return;const i=da({context:this.reader.context,navigationResolver:this.reader.navigation.navigationResolver,position:e.position,computedPageTurnDirection:this.reader.settings.values.computedPageTurnDirection,spineItem:n,spineItemsManager:this.reader.spineItemsManager,spineLocator:this.reader.spine.locator});return this.reader.navigation.navigate({position:i})}goToCfi(e,n={animate:!0}){return this.reader.navigation.navigate({animation:n.animate?"turn":!1,cfi:e})}goToSpineItem({indexOrId:e,...n}){const i=this.reader.spineItemsManager.get(e);if(i===void 0){le.warn("goToSpineItem",`Ignore navigation to ${e} since the item does not exist`);return}this.reader.navigation.navigate({spineItem:i.index,...n})}goToNextSpineItem(){const{endIndex:e=0}=this.reader.spine.locator.getVisibleSpineItemsFromPosition({position:this.reader.navigation.getNavigation().position,threshold:.5})||{};this.goToSpineItem({indexOrId:e+1})}goToPreviousSpineItem(){const{beginIndex:e=0}=this.reader.spine.locator.getVisibleSpineItemsFromPosition({position:this.reader.navigation.getNavigation().position,threshold:.5})??{};this.goToSpineItem({indexOrId:e-1})}goToUrl(e){this.reader.navigation.navigate({url:e,animation:!1})}goToRightSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="vertical"){le.warn("You cannot call this navigation method on vertical direction");return}return this.reader.context.isRTL()?this.goToPreviousSpineItem():this.goToNextSpineItem()}goToRightOrBottomSpineItem(){return this.reader.settings.values.computedPageTurnDirection==="vertical"?this.goToBottomSpineItem():this.goToRightSpineItem()}goToLeftOrTopSpineItem(){return this.reader.settings.values.computedPageTurnDirection==="vertical"?this.goToTopSpineItem():this.goToLeftSpineItem()}goToLeftSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="vertical"){le.warn("You cannot call this navigation method on vertical direction");return}return this.reader.context.isRTL()?this.goToNextSpineItem():this.goToPreviousSpineItem()}goToTopSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="horizontal"){le.warn("You cannot call this navigation method on horizontal direction");return}return this.goToPreviousSpineItem()}goToBottomSpineItem(){if(this.reader.settings.values.computedPageTurnDirection==="horizontal"){le.warn("You cannot call this navigation method on horizontal direction");return}return this.goToNextSpineItem()}goToPageOfSpineItem({pageIndex:e,spineItemId:n,...i}){const o=this.reader.navigation.navigationResolver.getNavigationForSpineItemPage({pageIndex:e,spineItemId:n});le.debug(".goToPageOfSpineItem()",{pageIndex:e,spineItemId:n,...i,position:o}),this.reader.navigation.navigate({position:o,...i})}goToAbsolutePageIndex({absolutePageIndex:e,...n}){const i=this.reader.spine.locator.getSpineInfoFromAbsolutePageIndex({absolutePageIndex:e});if(le.debug(".goToAbsolutePageIndex()",{absolutePageIndex:e,...n,foundInfo:i}),i){const o=this.reader.navigation.navigationResolver.getNavigationForSpineItemPage({pageIndex:i.pageIndex,spineItemId:i.itemIndex});return this.reader.navigation.navigate({position:o,...n})}}}class ga{constructor(e){this.reader=e,this.lastDelta={x:0,y:0},this.lastPosition=new M({x:0,y:0}),this.lastStartPosition=new M({x:0,y:0}),this.unlock=void 0}moveTo(e,{final:n,start:i}={}){var o,r,s,a;if(this.reader.settings.values.computedPageTurnMode==="scrollable"){le.warn("pan control is not available on free page turn mode");return}const u=this.reader.settings.values.computedPageTurnDirection;i&&((o=this.unlock)==null||o.call(this),this.unlock=this.reader.navigation.lock(),this.lastDelta={x:0,y:0},this.lastStartPosition=this.reader.navigation.controlledNavigationController.viewportPosition,this.lastPosition=this.lastStartPosition);let c=this.reader.navigation.getNavigation().position;if(e){const l=this.reader.viewport.absoluteViewport.width/this.reader.viewport.relativeViewport.width,d=Math.floor(e.x)-(((r=this.lastDelta)==null?void 0:r.x)||0),p=Math.floor(e.y)-(((s=this.lastDelta)==null?void 0:s.y)||0),f=Math.floor(u==="horizontal"?this.lastPosition.x-d/l:0),h=Math.floor(u==="horizontal"?0:this.lastPosition.y-p/l);c=new M({x:f,y:h}),this.lastDelta=e}else c=this.lastPosition;if(this.lastPosition=c,n){this.lastDelta={x:0,y:0},this.reader.navigation.navigate({position:c,animation:!1}),(a=this.unlock)==null||a.call(this);return}this.reader.navigation.navigate({position:c,animation:!1})}}const ma=t=>t.pagination.state$.pipe(U(t.context.manifest$,t.settings.values$),b(([e,{spineItems:n,readingDirection:i},{computedPageTurnDirection:o}])=>{const r=n.length??0,s=e.beginSpineItemIndex===0,a=e.endSpineItemIndex===Math.max(r-1,0),u=e.endSpineItemIndex===Math.max(r-1,0),c=e.beginSpineItemIndex===0,l=e.beginPageIndexInSpineItem===0,d=e.endPageIndexInSpineItem===e.endNumberOfPagesInSpineItem-1;return{canTurnLeft:o==="vertical"?!1:!l,canTurnRight:o==="vertical"?!1:!d,canGoTopSpineItem:o==="vertical"&&!s,canGoBottomSpineItem:o==="vertical"&&!a,canGoLeftSpineItem:o!=="vertical"&&(i==="ltr"&&!s||i==="rtl"&&!u),canGoRightSpineItem:o!=="vertical"&&(i==="ltr"&&!a||i==="rtl"&&!c)}}),O(q)),va=({reader:t,duration:e})=>n=>{let i;const o=()=>{i==null||i(),i=void 0};return n.pipe(P(()=>{i||(i=t==null?void 0:t.navigation.lock())}),Or(e,de,{trailing:!0,leading:!0}),P(o),he(o))},ya=t=>e=>{const n=t(e),i=ma(n),o=new ha(n),r=new ga(n),s=u=>{const{cfi:c,...l}=u;n.load(l),c&&o.goToCfi(c,{animate:!1})};return ca(n,o).pipe(T(n.$.destroy$)).subscribe(),{...n,load:s,navigation:{...n.navigation,state$:i,throttleLock:({duration:u,trigger:c})=>c.pipe(va({duration:u,reader:n})),moveTo:r.moveTo.bind(r),turnBottom:o.turnBottom.bind(o),turnTop:o.turnTop.bind(o),turnLeftOrTop:o.turnLeftOrTop.bind(o),turnRightOrBottom:o.turnRightOrBottom.bind(o),turnLeft:o.turnLeft.bind(o),turnRight:o.turnRight.bind(o),goToCfi:o.goToCfi.bind(o),goToUrl:o.goToUrl.bind(o),goToSpineItem:o.goToSpineItem.bind(o),goToNextSpineItem:o.goToNextSpineItem.bind(o),goToPreviousSpineItem:o.goToPreviousSpineItem.bind(o),goToLeftOrTopSpineItem:o.goToLeftOrTopSpineItem.bind(o),goToRightOrBottomSpineItem:o.goToRightOrBottomSpineItem.bind(o),goToTopSpineItem:o.goToTopSpineItem.bind(o),goToBottomSpineItem:o.goToBottomSpineItem.bind(o),goToLeftSpineItem:o.goToLeftSpineItem.bind(o),goToRightSpineItem:o.goToRightSpineItem.bind(o),goToPageOfSpineItem:o.goToPageOfSpineItem.bind(o),goToAbsolutePageIndex:o.goToAbsolutePageIndex.bind(o)}}},Me=t=>gi({spineIndex:t.index,spineId:t.id}),Le=(t,e,n)=>{var i;return!t.ownerDocument||!((i=t.ownerDocument)!=null&&i.documentElement)||t===t.ownerDocument?Me(n):gi({node:t,offset:e,spineIndex:n.index,spineId:n.id})},Tt=({pageIndex:t,spineItem:e,spineItemLocator:n})=>{var i;const o=n.getFirstNodeOrRangeAtPage(t,e),r=e.renderer.getDocumentFrame();return o&&r instanceof HTMLIFrameElement&&((i=r.contentWindow)!=null&&i.document)?Le(o.node,o.offset,e.item).trim():Me(e.item)},ba=(t,e)=>{const n=Le(t.startContainer,t.startOffset,e),i=Le(t.endContainer,t.endOffset,e);return{start:n,end:i}},wa=({item:t,selection:e})=>{const n=e.anchorNode?Le(e.anchorNode,e.anchorOffset,t):void 0,i=e.focusNode?Le(e.focusNode,e.focusOffset,t):void 0;return{anchorCfi:n,focusCfi:i}},xn=t=>{var e;return((e=t[0])==null?void 0:e.index)===6&&t.length>1},Et=t=>{const e=Xt(t);return ci(e)},Sa=t=>Array.isArray(t)?t[0]&&xn(t[0])?t[0]:void 0:t.parent[0]&&xn(t.parent[0])?t.parent[0]:void 0,en=t=>{var e,n,i,o;const r=Xt(t),a=(Sa(r)??[])[1],c=((a==null?void 0:a.index)??2)/2-1,l=qt(r)?(n=(e=r.end.at(-1))==null?void 0:e.at(-1))==null?void 0:n.offset:(o=(i=r.at(-1))==null?void 0:i.at(-1))==null?void 0:o.offset;return{cleanedCfi:t,itemIndex:c,offset:l??0}},Oi=({cfi:t,spineItemsManager:e})=>{var n,i;if(!t)return;const{itemIndex:o}=en(t),r=e.get(o);if(!r)return;const s=r.renderer.getDocumentFrame();if(s instanceof HTMLIFrameElement){console.log("FIII",t);const a=(n=s.contentWindow)==null?void 0:n.document;if(a)try{const u=Yr(t,a,{throwOnError:!0});return{node:u.isRange?(i=u.node)==null?void 0:i.startContainer:u.node,offset:Array.isArray(u.offset)?u.offset.at(-1):u.offset,spineItem:r}}catch(u){return Y.error(u),{spineItem:r}}}return{spineItem:r}},Ia=(t,e)=>{if("cfi"in e)return e;const n=t.spineItemsManager.get(e);if(!n)throw new Error("Spine item not found");return{cfi:Me(n.item)}},Pa=(t,e)=>{let n=t==null?void 0:t.itemPageIndex;const{itemIndex:i}=e.cfi.parseCfi(t.cfi),o=e.spineItemsManager.get(i);return o?Si().pipe(U(o.isReady$),b(([,r])=>{var s;let a;const{node:u,offset:c}=e.cfi.resolveCfi({cfi:t.cfi})??{};if(o.renditionLayout!=="pre-paginated"&&u&&(n=e.spine.locator.spineItemLocator.getSpineItemPageIndexFromNode(u,c??0,o)??n),u&&t.endCfi){const{node:p,offset:f}=e.cfi.resolveCfi({cfi:t.cfi})??{};p&&r&&(a=(s=u==null?void 0:u.ownerDocument)==null?void 0:s.createRange(),a==null||a.setStart(u,c??0),a==null||a.setEnd(p,f??0))}let d=t==null?void 0:t.absolutePageIndex;return n===void 0&&(n=0),d=e.spine.locator.getAbsolutePageIndexFromPageIndex({pageIndex:n,spineItemOrId:o})??(t==null?void 0:t.absolutePageIndex),{...t,range:a,itemIndex:i,startNode:u??void 0,startOffset:c,absolutePageIndex:d,itemPageIndex:n}})):x({...t,itemIndex:i})};class xa{constructor(e){this.reader=e,this.locate=(n,i)=>{const o={resource:n,meta:Ia(this.reader,n)};return bn(()=>{var r;const s=this.reader.spine.spineLayout.layout$.pipe(Ie(10),re(o),Er(d=>Pa(d.meta,this.reader).pipe(b(p=>({...d,meta:p}))),o)),a=(r=this.reader.cfi.parseCfi(o.meta.cfi))==null?void 0:r.itemIndex,u=this.reader.spineItemsManager.get(a),c=(u==null?void 0:u.renditionLayout)==="reflowable",l=i.mode==="shallow"||!c||!u?()=>{}:this.reader.spine.spineItemsLoader.forceOpen([u.index]);return s.pipe(he(()=>{setTimeout(()=>{l()},1e3)}))})}}locateResource(e,n){return Array.isArray(e)?bn(()=>K(e.map(i=>this.locate(i,n??{})))):this.locate(e,n??{})}}const Ai=(t,e,n)=>{const i=n.spineItems.findIndex(o=>o.href===t);return e.reduce((o,r)=>{const s=r.href.indexOf("#"),a=s>0?r.href.substr(0,s):r.href,u=a.substring(0,a.lastIndexOf("/")),c=t.substring(0,t.lastIndexOf("/")),l=t.endsWith(a),d=c!==""&&c.endsWith(u);if(l||d){const f=n.spineItems.findIndex(m=>m.href===r.href);if(i<f)return o;const g={title:r.title,path:r.path},v=Ai(t,r.contents,n);return v?{...g,subChapter:v}:g}return o},void 0)},$a=(t,e)=>{var n;const{href:i}=e;return Ai(i,((n=t.nav)==null?void 0:n.toc)??[],t)},_a=t=>{const e=t.context.manifest,n=t.spineItemsManager.items;return e?n.reduce((i,{item:o})=>(i[o.id]=$a(e,o),i),{}):{}},Ta=t=>t.spineItemsManager.items$.pipe(re([]),b(()=>_a(t))),Ea=(t,e,n)=>t+e*n,Fa=(t,e,n)=>{const i=t.context,{height:o,width:r}=n.layout.layoutInfo,{top:s,left:a}=t.spine.spineLayout.getSpineItemSpineLayoutInfo(n);return t.settings.values.computedPageTurnDirection==="vertical"?Math.max(0,Math.min(1,(e.y-s+i.state.visibleAreaRect.height)/o)):Math.max(0,Math.min(1,(e.x-a+i.state.visibleAreaRect.width)/r))},Oa=(t,e,n,i,o)=>o.isReady$.pipe(X(),U(t.layoutInfo$),b(([r,s])=>{var a,u,c,l,d,p,f;const h=t.context,g=((a=h.manifest)==null?void 0:a.renditionLayout)==="pre-paginated",v=((u=h.manifest)==null?void 0:u.spineItems.length)||0,m=((c=h.manifest)==null?void 0:c.spineItems.slice(0,e).reduce((V,C)=>V+(C.progressionWeight??0),0))||0,y=t.spineItemsManager.getSpineItemIndex(o)??0,w=((l=t.context.manifest)==null?void 0:l.spineItems.length)??0,I=s.pages.filter(V=>V.itemIndex===y).length??0,$=((p=(d=h.manifest)==null?void 0:d.spineItems[e])==null?void 0:p.progressionWeight)??(y+1)/w;let E=(n+1)*($/I);!g&&o.renditionLayout==="reflowable"&&!r&&(E=0);let R=m+E;return((f=h.manifest)==null?void 0:f.renditionFlow)==="scrolled-continuous"&&(r?E=Fa(t,i,o):E=0,R=Ea(m,$,E)),e===v-1&&n===I-1&&R>.99?1:R})),Aa=t=>t.spine.spineLayout.layout$.pipe(Ie(10,de),U(t.pagination.state$),b(()=>({numberOfPagesPerItems:t.spineItemsManager.items.reduce((n,i)=>[...n,i.numberOfPages],[]),numberOfTotalPages:t.spine.spineLayout.numberOfPages})),O(q),re({numberOfPagesPerItems:[],numberOfTotalPages:0})),Ma=(t,e,n,i)=>{const o=t.context,r=e.beginSpineItemIndex!==void 0?t.spineItemsManager.get(e.beginSpineItemIndex):void 0,s=e.endSpineItemIndex!==void 0?t.spineItemsManager.get(e.endSpineItemIndex):void 0;return x({...e,beginChapterInfo:r?n[r.item.id]:void 0,beginSpineItemReadingDirection:r==null?void 0:r.readingDirection,endChapterInfo:s?n[s.item.id]:void 0,endSpineItemReadingDirection:s==null?void 0:s.readingDirection,percentageEstimateOfBook:i,isUsingSpread:o.state.isUsingSpreadMode??!1})},La=t=>K([t.pagination.state$,t.layout$]).pipe(S(([e])=>{const n=e.endSpineItemIndex!==void 0?t.spineItemsManager.get(e.endSpineItemIndex):void 0;return n?Oa(t,e.endSpineItemIndex??0,e.endPageIndexInSpineItem||0,t.navigation.getNavigation().position,n):x(0)})),Ra=t=>{const e=Ta(t),n=Aa(t),i=new G({...t.pagination.state,beginChapterInfo:void 0,beginCfi:void 0,beginPageIndexInSpineItem:void 0,isUsingSpread:!1,beginAbsolutePageIndex:0,endAbsolutePageIndex:0,numberOfTotalPages:0,beginSpineItemReadingDirection:void 0,beginSpineItemIndex:void 0,endCfi:void 0,endChapterInfo:void 0,endSpineItemReadingDirection:void 0,percentageEstimateOfBook:0}),o=K([t.pagination.state$,e,La(t)]).pipe(S(([s,a,u])=>Ma(t,s,a,u).pipe(b(c=>({...s,...c})))),O(q));return{paginationInfo$:K([o,n]).pipe(b(([s,a])=>({...s,...a,beginAbsolutePageIndex:a.numberOfPagesPerItems.slice(0,s.beginSpineItemIndex).reduce((u,c)=>u+c,s.beginPageIndexInSpineItem??0),endAbsolutePageIndex:a.numberOfPagesPerItems.slice(0,s.endSpineItemIndex).reduce((u,c)=>u+c,s.endPageIndexInSpineItem??0)})),P(s=>{i.next(s)}),Q(1)),getPaginationInfo:()=>i.value}},Ca=t=>e=>{const n=t(e),{paginationInfo$:i,getPaginationInfo:o}=Ra(n);i.pipe(T(n.$.destroy$)).subscribe();const r=new xa(n);return{...n,locateResource:r.locateResource.bind(r),pagination:{...n.pagination,get state(){return o()},get state$(){return i}}}},Na=t=>({put:(r,s)=>new Promise((a,u)=>{const c=t.transaction(["store"],"readwrite");c.onerror=p=>{u(p)},c.oncomplete=()=>{a()};const d=c.objectStore("store").put(s,r);d.onsuccess=()=>{a()},d.onerror=p=>{u(p)}}),keys:()=>new Promise((r,s)=>{const a=t.transaction(["store"],"readonly");a.onerror=d=>{s(d)};const c=a.objectStore("store").openKeyCursor(),l=[];c.onsuccess=()=>{const d=c.result;if(!d){r(l);return}l.push(d.key),d.continue()},c.onerror=()=>{s(c.error)}}),get:r=>new Promise((s,a)=>{const u=t.transaction(["store"],"readwrite"),l=u.objectStore("store").get(r);l.onsuccess=()=>{let d=l.result;d===void 0&&(d=null),s(d)},u.onerror=()=>{a(l.error)}}),remove:r=>new Promise((s,a)=>{const u=t.transaction(["store"],"readwrite"),l=u.objectStore("store").delete(r);u.onerror=()=>{a(l.error)},u.oncomplete=()=>{s()},u.onabort=()=>{var d;const p=l.error?l.error:(d=l.transaction)==null?void 0:d.error;a(p)}})}),lt=async t=>new Promise((e,n)=>{const i=window.indexedDB.open(t);i.onerror=o=>{n(o)},i.onsuccess=()=>{e(Na(i.result))},i.onupgradeneeded=()=>{i.result.createObjectStore("store")}}),ja=t=>{let e=Date.now().toString();const n=new W,i=u=>{var c,l;if(typeof u=="string"||typeof u=="object"){const d=typeof u=="object"?u.id:u;return(c=t.manifest)==null?void 0:c.spineItems.find(p=>p.id===d)}return(l=t.manifest)==null?void 0:l.spineItems[u]},o=async(u,c)=>{const l=i(u);if(!l)return new Response("Item not found",{status:404});const p=await(await lt("prose-reader")).get(`${e}_${l.id}`);if(p)return new Response(p,{status:200});const f=c&&await c(l)||await fetch(l.href);return r(l,f.clone()),f},r=(u,c)=>{n.next({id:u,data:c})};n.asObservable().pipe(ae(({id:u,data:c})=>{const l=i(u);return l?j(pr([lt("prose-reader"),j(c.blob())])).pipe(S(([d,p])=>j(d.put(`${e}_${l.id}`,p))),Ae(d=>(Y.error(d),ne))):ne}),T(t.destroy$)).subscribe();const s=t.manifest$.pipe(P(()=>{e=Date.now().toString()}));return _(s).pipe(S(()=>(Y.debug("Cleanup up old cache..."),j(lt("prose-reader")).pipe(S(u=>j(u.keys()).pipe(b(c=>c.filter(l=>!l.toString().startsWith(e))),S(c=>{const l=c.map(d=>u.remove(d));return j(Promise.all(l))}))),Ae(u=>(Y.error(u),ne))))),T(t.destroy$)).subscribe(),{get:o,destroy:()=>{n.complete()}}},Da=t=>e=>{const n=t(e),i=ja(n.context);return{...n,destroy:()=>{i.destroy(),n.destroy()}}},Va=(t,e)=>{var n;const i=(n=t.node.ownerDocument)==null?void 0:n.createRange(),o=t.node.compareDocumentPosition(e.node);if(i){try{if(o&Node.DOCUMENT_POSITION_PRECEDING)i.setStart(e.node,e.offset||0),i.setEnd(t.node,t.offset||0);else if(o&Node.DOCUMENT_POSITION_FOLLOWING)i.setStart(t.node,t.offset||0),i.setEnd(e.node,e.offset||0);else{const r=Math.min(t.offset||0,e.offset||0),s=Math.max(t.offset||0,e.offset||0);i.setStart(t.node,r),i.setEnd(t.node,s)}}catch(r){Y.warn("Failed to create range from selection",r,{anchor:t,focus:e})}return i}},ka=({selection:t,spineItem:e})=>{const{anchorNode:n,anchorOffset:i,focusNode:o,focusOffset:r}=t;if(!(!n||!o))try{return Va({node:n,offset:i},{node:o,offset:r})}catch(s){Y.warn("Failed to create range from selection",s,{selection:t,spineItem:e});return}};class Wa extends ee{constructor(e){var n;super();const i=e.contentDocument||((n=e.contentWindow)==null?void 0:n.document);if(!i)this.selectionChange$=be,this.selectionOver$=be;else{const o=wn(i.body,{childList:!0,subtree:!0}).pipe(F(s=>!!s.find(a=>a.type==="childList"&&a.removedNodes.length))),r=e.parentElement?wn(e.parentElement,{childList:!0}).pipe(F(s=>!!s.find(a=>Array.from(a.removedNodes).includes(e)))):x(null);this.selectionChange$=_(J(i,"selectionchange"),o).pipe(b(()=>i.getSelection()),T(_(r,this.destroy$)),_e(null)),this.selectionOver$=J(i,"pointerdown").pipe(S(()=>_(J(i,"pointerup"),J(i,"pointercancel"),J(i,"contextmenu")).pipe(X(),He(0),b(s=>{const a=i.getSelection();return a&&!a.isCollapsed?[s,a]:void 0}),F(fe))),T(_(r,this.destroy$)))}}}const Ua=t=>t.loaded$.pipe(S(()=>{var e;const n=t.renderer.getDocumentFrame(),i=(n==null?void 0:n.contentDocument)||((e=n==null?void 0:n.contentWindow)==null?void 0:e.document);if(!n||!i)return be;const o=new Wa(n);return _(o.selectionChange$.pipe(b(r=>{if(r!=null&&r.toString())return{type:"change",selection:r}})),o.selectionOver$.pipe(b(([r,s])=>({type:"over",event:r,selection:s})))).pipe(T(t.unloaded$),_e(void 0),he(()=>{o.destroy()}))}),O()),za=t=>e=>{const n=t(e);let i;const o=n.spineItemsManager.items$.pipe(S(l=>{const d=l.map(p=>{const f=n.spineItemsManager.getSpineItemIndex(p)??0;return Ua(p).pipe(b(h=>{if(h)return{...h,itemIndex:f}}))});return _(...d)}),re(void 0),O(),P(l=>{i=l}),Q({refCount:!0,bufferSize:1})),r=o,s=o.pipe(b(l=>!!l),O(),F(l=>l),H()),a=s.pipe(S(()=>r),O(),F(l=>!l),H()),u=o.pipe(F(l=>(l==null?void 0:l.type)==="over"),H()),c=n.context.containerElement$.pipe(S(l=>J(l,"pointerdown")),U(r),b(([,l])=>l),re(void 0),Q({refCount:!0,bufferSize:1}));return _(r,c).pipe(T(n.$.destroy$)).subscribe(),{...n,selection:{selection$:r,selectionStart$:s,selectionEnd$:a,selectionOver$:u,lastSelectionOnPointerdown$:c,getSelection:()=>i,createOrderedRangeFromSelection:ka}}},$n=[{name:"bright",backgroundColor:"white"},{name:"sepia",backgroundColor:"#eaddc7",foregroundColor:"black"},{name:"night",backgroundColor:"#191717",foregroundColor:"#f1ebeb"}],Ba=t=>e=>{const n=t(e),i=new G(e.theme??"bright"),o=()=>{const a=$n.find(u=>u.name===i.value);return`
      body {
        ${a!==void 0?`background-color: ${a.backgroundColor} !important;`:""}
      }
      ${a!=null&&a.foregroundColor?`
          body * {
            
            color: ${a.foregroundColor};
          }
        `:""}
    `},r=({container:a})=>{const u=$n.find(c=>c.name===i.value);return u&&a.style.setProperty("background-color",u.backgroundColor),()=>{}},s=()=>{n.spineItemsManager.items.forEach(a=>{const u=a.renderer.getDocumentFrame();u&&ce(u,"prose-reader-theme",o()),r({container:a.element})})};return n.hookManager.register("item.onDocumentLoad",({itemId:a})=>{const u=n.spineItemsManager.get(a);if((u==null?void 0:u.renditionLayout)!=="pre-paginated"){const c=u==null?void 0:u.renderer.getDocumentFrame();c&&ce(c,"prose-reader-theme",o())}}),n.spineItemsManager.items$.pipe(P(a=>a.map(({element:u})=>r({container:u}))),T(n.$.destroy$)).subscribe(),i.pipe(P(()=>{s()}),T(n.$.destroy$)).subscribe(),{...n,theme:{set:a=>{a!==i.value&&i.next(a)},get:()=>i.value,$:{theme$:i.asObservable()}}}},Ha=t=>e=>({...t(e),utils:{isOrIsWithinValidLink:o=>{if(mi(o)){const r=o.nodeName==="a"?o:o.closest("a");if(r!=null&&r.getAttribute("href"))return!0}return!1}}});navigator.userAgent.indexOf("")>-1&&navigator.userAgent.indexOf("Chrome")<=-1;const qa=t=>e=>t(e);class Mi{constructor(e){this.reader=e}}class Xa extends Mi{constructor(){super(...arguments),this.isZooming$=new G(!1),this.currentScale=1,this.currentPosition={x:0,y:0}}enter(e){if(!e){console.warn("You need an image to enter zoom");return}this.currentPosition={x:0,y:0},this.currentScale=1;const n=this.reader.context.state.containerElement;if(n){this.element=n.ownerDocument.createElement("div"),this.element.style.cssText=`
          top: 0;
          left: 0;
          display: block;
          position: absolute;
          z-index: 1;
          background: black;
          width: 100%;
          height: 100%;
          user-select: none;
        `;const i=e.cloneNode();i.src=e.src,i.style.setProperty("height","100%"),i.style.setProperty("width","100%"),i.style.setProperty("object-fit","contain"),i.style.setProperty("pointer-events","none"),this.element.appendChild(i),n.appendChild(this.element),this.isZooming$.next(!0)}}exit(){var e;(e=this.element)==null||e.remove(),this.element=void 0,this.currentPosition={x:0,y:0},this.currentScale=1,this.isZooming$.next(!1)}moveAt(e){var n;const i=(n=this.element)==null?void 0:n.querySelector("img");i==null||i.style.setProperty("transform",`translate3d(${e.x}px, ${e.y}px, 0px) scale3d(${this.currentScale}, ${this.currentScale}, 1)`),this.currentPosition=e}scaleAt(e){var n;const i=Math.max(.01,e),o=(n=this.element)==null?void 0:n.querySelector("img");o==null||o.style.setProperty("transform",`translate3d(${this.currentPosition.x}px, ${this.currentPosition.y}px, 0px) scale3d(${i}, ${i}, 1)`),this.currentScale=i}}const tt=({newScale:t,oldScale:e,screenSize:n,scrollOffset:i})=>{const o=n*t/2-n+n/2,r=n*e/2-n+n/2,s=t/e,a=i-r;return Math.max(o+a*s,0)};class Ya extends Mi{constructor(){super(...arguments),this.isZooming$=new G(!1),this.currentScale=1,this.currentPosition={x:0,y:0}}enter(){this.currentScale=1,this.currentPosition={x:0,y:0};const e=this.reader.spine.element;e&&(e.style.transformOrigin="0 0"),this.isZooming$.next(!0)}exit(){this.scaleAt(1),this.isZooming$.next(!1)}moveAt(){}scaleAt(e){const n=this.reader.spine.element,i=this.reader.navigation.scrollNavigationController.value.element;if(!n||!i)return;const o=Math.ceil(e*100)/100,r=Math.max(o,1),s=n.getBoundingClientRect().width/n.offsetWidth,a=i.scrollTop;n.style.transform=`scale(${r})`,i.scrollLeft=tt({newScale:r,oldScale:s,pageSize:i.clientWidth,screenSize:n.offsetWidth,scrollOffset:i.scrollLeft}),i.scrollTop=tt({newScale:r,oldScale:s,pageSize:i.clientHeight,screenSize:n.offsetHeight,scrollOffset:a}),this.currentScale=o}}const Ga=t=>e=>{const n=t(e),i=new Xa(n),o=new Ya(n),r=new G(o);return{...n,destroy:()=>{i.exit(),o.exit(),r.complete(),n.destroy()},zoom:{enter:u=>{const c=n.settings.values.computedPageTurnMode==="scrollable"?o:i;r.next(c),c.enter(u)},scaleAt:u=>r.getValue().scaleAt(u),moveAt:u=>r.getValue().moveAt(u),exit:()=>r.getValue().exit(),get currentPosition(){return r.getValue().currentPosition},get currentScale(){return r.getValue().currentScale},isZooming$:r.pipe(S(u=>u.isZooming$)),get zoomContainerElement(){return r.getValue().element},get isZooming(){return r.getValue().isZooming$.getValue()}}}},Li=t=>(t==null?void 0:t.renditionLayout)==="pre-paginated"||(t==null?void 0:t.spineItems.every(e=>e.renditionLayout==="pre-paginated"));class je extends L{constructor(e){super(n=>this.stateSubject.pipe(T(this.destroy$)).subscribe(n)),this.destroy$=new W,this.stateSubject=new G(e)}next(e){this.stateSubject.next(e)}mergeCompare(e){const n={...this.value,...e};q(this.value,n)||this.stateSubject.next(n)}watch(e){return Array.isArray(e)?this.stateSubject.pipe(Zt(e)):this.stateSubject.pipe(b(n=>n[e]),O(q))}get value(){return this.stateSubject.value}destroy(){this.stateSubject.complete(),this.destroy$.complete()}}class Za{constructor(){this.navigationSubject=new vt(1),this.viewportStateSubject=new G("free"),this.paginationSubject=new vt,this.navigationIsLockedSubject=new G(!1),this.pagination$=this.paginationSubject.asObservable(),this.navigationUnlocked$=this.navigationIsLockedSubject.pipe(O(),F(e=>!e)),this.viewportState$=this.viewportStateSubject.asObservable(),this.viewportFree$=this.viewportState$.pipe(F(e=>e==="free")),this.viewportBusy$=this.viewportState$.pipe(F(e=>e==="busy")),this.navigation$=this.navigationSubject.asObservable()}}const Ja=({manifest:t,visibleAreaRect:e,forceSinglePageMode:n})=>{const{height:i,width:o}=e,r=o>i;return n||(t==null?void 0:t.renditionFlow)==="scrolled-continuous"?!1:!r&&(t==null?void 0:t.renditionSpread)==="portrait"?!0:r&&((t==null?void 0:t.renditionSpread)===void 0||(t==null?void 0:t.renditionSpread)==="auto"||(t==null?void 0:t.renditionSpread)==="landscape"||(t==null?void 0:t.renditionSpread)==="both")};class Ka extends je{constructor(){super({marginBottom:0,marginTop:0,calculatedInnerMargin:0,assumedRenditionLayout:"reflowable",visibleAreaRect:{width:0,height:0,x:0,y:0}}),this.bridgeEvent=new Za,this.destroy$=new W,this.state$=this.pipe(O(q)),this.manifest$=this.pipe(b(e=>e.manifest),F(fe),O()),this.containerElement$=this.pipe(b(e=>e.containerElement),F(fe),O()),this.hasVerticalWriting$=this.pipe(b(e=>e.hasVerticalWriting),F(fe),O()),this.isUsingSpreadMode$=this.pipe(b(e=>e.isUsingSpreadMode),O()),this.isRTL=()=>{var e;return((e=this.value.manifest)==null?void 0:e.readingDirection)==="rtl"}}update(e){const n=this.value,i=e.manifest??n.manifest,o=e.forceSinglePageMode??n.forceSinglePageMode,r=e.visibleAreaRect??n.visibleAreaRect,s=e.marginTop??n.marginTop,a=e.marginBottom??n.marginBottom,u={...n,...e,...e.visibleAreaRect&&{...e.visibleAreaRect,height:e.visibleAreaRect.height-s-a},...e.manifest&&{isFullyPrePaginated:Li(i),assumedRenditionLayout:(i==null?void 0:i.renditionLayout)??"reflowable"},isUsingSpreadMode:Ja({manifest:i,visibleAreaRect:r,forceSinglePageMode:o})};q(u,n)||this.next(u)}get state(){return this.value}get manifest(){return this.value.manifest}get readingDirection(){var e;return(e=this.manifest)==null?void 0:e.readingDirection}getPageSize(){const{isUsingSpreadMode:e,visibleAreaRect:n}=this.value;return{width:e?n.width/2:n.width,height:n.height}}}class Qa extends je{constructor(e,n){super({supportedPageTurnAnimation:["fade","none","slide"],supportedPageTurnMode:["controlled","scrollable"],supportedPageTurnDirection:["horizontal","vertical"],supportedComputedPageTurnDirection:["horizontal","vertical"]}),_(e.state$,n.values$).pipe(U(e.state$),b(([,{hasVerticalWriting:i}])=>{const o=e.manifest;return{hasVerticalWriting:i,renditionFlow:o==null?void 0:o.renditionFlow,renditionLayout:o==null?void 0:o.renditionLayout,computedPageTurnMode:n.values.computedPageTurnMode}}),O(q),b(({hasVerticalWriting:i,renditionFlow:o,renditionLayout:r,computedPageTurnMode:s})=>({...this.value,supportedPageTurnMode:o==="scrolled-continuous"?["scrollable"]:["controlled","scrollable"],supportedPageTurnAnimation:o==="scrolled-continuous"||s==="scrollable"?["none"]:i?["fade","none"]:["fade","none","slide"],supportedPageTurnDirection:s==="scrollable"?["vertical"]:r==="reflowable"?["horizontal"]:["horizontal","vertical"]})),T(this.destroy$)).subscribe(this.next.bind(this))}}class eu{constructor(){this._hooks=[],this._hookExecutions=[]}deregister(e){return this._hooks=this._hooks.filter(n=>n!==e),this.destroy(e.name,void 0,e)}register(e,n){const i={name:e,runFn:n};return this._hooks.push(i),()=>{this.deregister(i)}}execute(e,n,i){return this._hooks.filter(s=>e===s.name).map(s=>{let a=()=>x(void 0);const u=new W,c=p=>{a=p},l=()=>(u.next(),u.complete(),a()??x(void 0)),d=s.runFn({...i,destroy$:u.asObservable(),destroy:c});return this._hookExecutions.push({name:e,id:n,destroyFn:l,ref:s}),d})}destroy(e,n,i){const o=this._hookExecutions.filter(s=>i&&s.ref===i||e===s.name&&(!n||n&&n===s.id));this._hookExecutions=this._hookExecutions.filter(s=>!o.includes(s));const r=o.map(({destroyFn:s})=>s());return K(r)}}class Ri{constructor(){this.isLockedSubject=new G(0),this.isLocked$=this.isLockedSubject.pipe(b(e=>!!e),O())}lock(){let e=!1;return this.isLockedSubject.next(this.isLockedSubject.getValue()+1),()=>{e||(e=!0,this.isLockedSubject.next(this.isLockedSubject.getValue()-1))}}}const tu=()=>t=>t.pipe(b(({navigation:e,pagination:n,...i})=>({navigation:{...e,paginationBeginCfi:n.beginCfi},...i}))),nu=(t,e,n)=>t.bridgeEvent.pagination$.pipe(U(e),F(([i,o])=>i.navigationId===o.id),S(([i,o])=>{const r=n.spineItemsManager.get(o.spineItem);return((r==null?void 0:r.isReady$.pipe(X()))??x(!1)).pipe(F(s=>s),b(()=>({pagination:i,navigation:o})))}),tu(),O((i,o)=>i.navigation.paginationBeginCfi===o.navigation.paginationBeginCfi),b(({navigation:i})=>({...i,meta:{triggeredBy:"pagination"}}))),iu=t=>t.pipe(b(([e,n])=>{const i={type:"api",meta:{triggeredBy:"user"},id:Symbol(),animation:"turn",...e};return{previousNavigation:n,navigation:i}})),ou=({navigationResolver:t})=>e=>e.pipe(b(n=>{if(n.navigation.cfi){const i=t.getNavigationForCfi(n.navigation.cfi);if(i)return{...n,navigation:{...n.navigation,position:i}}}return n})),ru=({navigation:t,previousNavigation:e,settings:n})=>t.directionFromLastNavigation?t.directionFromLastNavigation:t.url!==void 0||t.cfi!==void 0?"anchor":e.spineItem===void 0||t.spineItem||!t.position?"forward":n.values.computedPageTurnDirection==="vertical"?t.position.y>e.position.y||t.position.y===e.position.y&&e.directionFromLastNavigation!=="backward"?"forward":"backward":Math.abs(t.position.x)>Math.abs(e.position.x)||t.position.x===e.position.x&&e.directionFromLastNavigation!=="backward"?"forward":"backward",su=({context:t,settings:e})=>n=>n.pipe(b(({navigation:i,previousNavigation:o})=>{const r=ru({navigation:i,previousNavigation:o,settings:e}),s={...i,directionFromLastNavigation:r};return{previousNavigation:o,navigation:s,direction:r}})),au=({spineItemsManager:t,navigationResolver:e})=>n=>n.pipe(b(({navigation:i,...o})=>{const r=t.get(i.spineItem);return i.position?{navigation:{...i,position:e.getAdjustedPositionWithSafeEdge(i.position)},...o}:r?{navigation:{...i,position:e.getNavigationForSpineIndexOrId(r)},...o}:{navigation:{...i,position:new M({x:0,y:0})},...o}})),_n=({settings:t,spineItemsManager:e,navigationResolver:n,spineLocator:i})=>o=>{const r=s=>{const{position:a,spineItem:u,cfi:c,directionFromLastNavigation:l}=s,{navigationSnapThreshold:d,computedPageTurnMode:p}=t.values;if(u!==void 0){const f=e.get(u);if(f)return f}if(typeof u=="number")return u>e.items.length-1?e.get(e.items.length-1):e.get(0);if(c){const f=e.getSpineItemFromCfi(c);if(f)return f}if(a&&p==="controlled"){const{beginIndex:f,endIndex:h}=i.getVisibleSpineItemsFromPosition({position:a,threshold:d,restrictToScreen:!1})??{},g=(l==="forward"||l==="anchor"?h:f)??f,v=e.get(g);if(!v)return;const{endPageIndex:m,beginPageIndex:y}=i.getVisiblePagesFromViewportPosition({position:a,spineItem:v,threshold:d,restrictToScreen:!1})??{},w=(l==="forward"||l==="anchor"?m:y)??0,I=n.getNavigationForSpineItemPage({pageIndex:w,spineItemId:v}),$=i.getVisibleSpineItemsFromPosition({position:I,threshold:d,restrictToScreen:!1}),E=l==="forward"||l==="anchor"?$==null?void 0:$.beginIndex:$==null?void 0:$.endIndex;return e.get(E)}return a&&p==="scrollable"?i.getSpineItemFromPosition(a):e.get(0)};return o.pipe(b(({navigation:s,...a})=>{const u=r(s);return{navigation:{...s,spineItem:e.getSpineItemIndex(u)},...a}}))},Tn=({spine:t})=>e=>e.pipe(S(({navigation:n,...i})=>{const o=t.spineLayout.getSpineItemSpineLayoutInfo(n.spineItem),r=t.spineItemsManager.get(n.spineItem);return((r==null?void 0:r.isReady$)??x(!1)).pipe(X(),b(s=>({navigation:{...n,spineItemHeight:o==null?void 0:o.height,spineItemWidth:o==null?void 0:o.width,spineItemLeft:o.left,spineItemTop:o.top,spineItemIsUsingVerticalWriting:r==null?void 0:r.isUsingVerticalWriting(),spineItemIsReady:s},...i})))})),dt=({settings:t,spineItemsManager:e,spineLocator:n,navigationResolver:i})=>o=>{const r=s=>{const{navigationSnapThreshold:a,computedPageTurnMode:u}=t.values,c=e.get(s.spineItem);if(!(!c||!s.position)){if(u==="controlled"){const{endPageIndex:l,beginPageIndex:d}=n.getVisiblePagesFromViewportPosition({position:s.position,spineItem:c,threshold:a,restrictToScreen:!1})??{},p=(s.directionFromLastNavigation==="forward"||s.directionFromLastNavigation==="anchor"?l:d)??0,f=i.getNavigationForSpineItemPage({pageIndex:p,spineItemId:c}),h=n.getVisiblePagesFromViewportPosition({position:f,spineItem:c,threshold:0,restrictToScreen:!0}),g=(s.directionFromLastNavigation==="forward"||s.directionFromLastNavigation==="anchor"?h==null?void 0:h.beginPageIndex:h==null?void 0:h.endPageIndex)??0;return n.spineItemLocator.getSpineItemPositionFromPageIndex({pageIndex:g,spineItem:c})}return n.getSpineItemPositionFromSpinePosition(s.position,c)}};return o.pipe(b(({navigation:s,...a})=>({navigation:{...s,positionInSpineItem:r(s)},...a})))},uu=({navigationResolver:t})=>e=>e.pipe(b(n=>{if(n.navigation.url){const i=t.getNavigationForUrl(n.navigation.url);if(i)return{...n,navigation:{...n.navigation,position:i.position,spineItem:i.spineItemId}}}return n})),cu=({spineLocator:t,navigation:e,navigationResolver:n,spineItemsManager:i,spineLayout:o})=>{const r=i.get(e.spineItem);return r?r.isReady$.pipe(X(),b(s=>{var a,u;const c=o.getSpineItemSpineLayoutInfo(r),l=t.isPositionWithinSpineItem(e.position,r),d=c.width-(e.spineItemWidth??0),p=c.height-(e.spineItemHeight??0),f=d!==0||p!==0;if(e.url!==void 0&&(d||p||s&&!e.spineItemIsReady)){const g=n.getNavigationForUrl(e.url);if(g)return g.position}const h=e.cfi??e.paginationBeginCfi;if(h!==void 0&&!Et(h)&&(d||p||s&&!e.spineItemIsReady)){const g=n.getNavigationForCfi(h);if(g)return g}if(l&&f&&e.directionFromLastNavigation==="backward"){const g=new k({x:(((a=e.positionInSpineItem)==null?void 0:a.x)??0)+d,y:(((u=e.positionInSpineItem)==null?void 0:u.y)??0)+p});return n.getNavigationFromSpineItemPosition({spineItem:r,spineItemPosition:g})}if(e.positionInSpineItem&&e.spineItemHeight&&e.spineItemWidth){const g=t.spineItemLocator.getSpineItemPageIndexFromPosition({itemWidth:e.spineItemWidth,itemHeight:e.spineItemHeight,isUsingVerticalWriting:!!e.spineItemIsUsingVerticalWriting,position:e.positionInSpineItem});return n.getNavigationForSpineItemPage({pageIndex:g,spineItemId:r})}return l?n.getNavigationForPosition(e.position):n.getNavigationForSpineIndexOrId(r)})):x(new M({x:0,y:0}))},lu=({navigation:t,spineLocator:e,spineItemsManager:n,settings:i,navigationResolver:o,spineLayout:r})=>{const{spineItem:s}=t,a=n.get(s);if(!a)return new M({x:0,y:0});const{height:u,top:c}=r.getSpineItemSpineLayoutInfo(a),l=e.isPositionWithinSpineItem(t.position,a),d=t.positionInSpineItem??new k({y:0,x:0});if(i.values.computedPageTurnDirection==="vertical"){if(c===t.spineItemTop&&u===t.spineItemHeight&&l)return t.position;if(c===t.spineItemTop&&u===t.spineItemHeight&&!l)return o.getNavigationForSpineIndexOrId(a);if(c!==t.spineItemTop){const p=e.getSafeSpineItemPositionFromUnsafeSpineItemPosition(t.positionInSpineItem??new k({x:0,y:0}),a);return e.getSpinePositionFromSpineItemPosition({spineItemPosition:p,spineItem:a})}if(c===t.spineItemTop&&u!==t.spineItemHeight){const p=(t.spineItemHeight??d.y)-d.y,f=new k({y:t.directionFromLastNavigation==="backward"?u-p:d.y,x:t.position.x});if(l){const h=e.getSafeSpineItemPositionFromUnsafeSpineItemPosition(f,a);return e.getSpinePositionFromSpineItemPosition({spineItemPosition:h,spineItem:a})}if(!l){if(!(t.position.y<c)){const g=new k({y:u-p,x:t.position.x});return e.getSpinePositionFromSpineItemPosition({spineItemPosition:e.getSafeSpineItemPositionFromUnsafeSpineItemPosition(g,a),spineItem:a})}return o.getNavigationForSpineIndexOrId(a)}}}return t.position},du=({navigation:t,spineItemsManager:e,settings:n,spineLocator:i,navigationResolver:o,spineLayout:r})=>n.values.computedPageTurnMode==="scrollable"?x(lu({navigation:t,spineLocator:i,navigationResolver:o,settings:n,spineItemsManager:e,spineLayout:r})):cu({navigation:t,spineLocator:i,navigationResolver:o,spineItemsManager:e,spineLayout:r}),En=({settings:t,navigationResolver:e,context:n,spine:i})=>o=>o.pipe(S(r=>du({spineLocator:i.locator,navigation:r.navigation,navigationResolver:e,settings:t,spineItemsManager:i.spineItemsManager,spineItemLocator:i.locator.spineItemLocator,spineLayout:i.spineLayout}).pipe(b(s=>({...r,navigation:{...r.navigation,position:s}}))))),pu="navigation/InternalNavigator",fu=Y.namespace(pu);class hu extends ee{constructor(e,n,i,o,r,s,a,u){super(),this.settings=e,this.context=n,this.userNavigation$=i,this.viewportController=o,this.scrollNavigationController=r,this.navigationResolver=s,this.spine=a,this.isUserLocked$=u,this.navigationSubject=new G({animation:!1,position:new M({x:0,y:0}),meta:{triggeredBy:"user"},spineItemIsReady:!1,type:"api",id:Symbol()}),this.navigated$=this.navigationSubject.pipe(Ht(1)),this.navigation$=this.navigationSubject.pipe(b(({position:m,id:y})=>({position:m,id:y})),O(({position:m,...y},{position:w,...I})=>q(y,I)&&q(m,w)),Q(1)),this.locker=new Ri;const c=i.pipe(U(this.navigationSubject),iu,uu({navigationResolver:s}),ou({navigationResolver:s}),su({context:n,settings:e}),_n({navigationResolver:s,settings:e,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),dt({navigationResolver:s,settings:e,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),Tn({spine:a})).pipe(au({navigationResolver:s,spineItemsManager:a.spineItemsManager}),U(u),S(([m,y])=>{const w=m.navigation.cfi||m.navigation.url||e.values.computedPageTurnMode==="scrollable"||y;return x(m).pipe(w?te:En({navigationResolver:s,settings:e,spine:a,context:n}))}),dt({spineItemsManager:a.spineItemsManager,spineLocator:a.locator,settings:e,navigationResolver:s}),b(m=>m.navigation),H()),l=c.pipe(U(u),F(([,m])=>m),S(([m])=>{const y=this.locker.lock();return u.pipe(F(w=>!w),X(),b(()=>({...m,animation:"snap"})),he(()=>{y()}),T(c))}),H()),d=_(o.layout$,a.spineLayout.layout$).pipe(S(()=>x(null).pipe(S(()=>u.pipe(F(m=>!m),X())),b(()=>({...this.navigationSubject.getValue(),animation:!1})),T(_(l,c))))),p=_(d,l).pipe(b(m=>({navigation:m})),En({navigationResolver:s,settings:e,context:n,spine:a}),b(m=>{const y={...m.navigation,meta:{triggeredBy:"restoration"}};return{...m,navigation:y}}),_n({navigationResolver:s,settings:e,spineItemsManager:a.spineItemsManager,spineLocator:a.locator}),Tn({spine:a}),dt({spineItemsManager:a.spineItemsManager,spineLocator:a.locator,settings:e,navigationResolver:s}),b(({navigation:m})=>m),H()),f=nu(n,this.navigationSubject,a),h=_(p,c,f),g=m=>m.pipe(P(([y,w])=>{fu.info(`navigation updated from ${y.meta.triggeredBy} of type ${y.type}`,{previousNavigation:w,currentNavigation:y}),this.navigationSubject.next(y)})),v=m=>m.pipe(P(([y,w])=>{const I=y.type==="scroll",$=y.meta.triggeredBy==="pagination",E=y.meta.triggeredBy==="restoration",R=q(w.position,y.position);if(I&&!E||$||R)return;const V={position:y.position,animation:y.animation};e.values.computedPageTurnMode==="scrollable"?this.scrollNavigationController.navigate(V):this.viewportController.navigate(V)}));h.pipe(U(this.navigationSubject),v,g,T(this.destroy$)).subscribe()}get navigation(){return this.navigationSubject.getValue()}}const Ci=({position:{x:t,y:e},spineElement:n,element:i})=>{if(!n)throw new Error("Invalid spine element");const o=n.getBoundingClientRect().width/n.offsetWidth;return new M({x:tt({newScale:1,oldScale:o,screenSize:i.clientWidth??0,pageSize:n.scrollWidth,scrollOffset:t}),y:tt({newScale:1,oldScale:o,screenSize:i.clientHeight??0,pageSize:n.scrollHeight,scrollOffset:e})})},gu=500;class mu extends ee{constructor(e,n,i,o,r){super(),this.settings=e,this.context=n,this.spine=i,this.scrollNavigationController=o,this.locker=r,this.navigationSubject=new W,this.navigation$=this.navigationSubject.asObservable();const s=this.scrollNavigationController.userScroll$.pipe(wt(a=>{const u=this.locker.lock();return _(this.scrollNavigationController.userScroll$,x(a)).pipe(Ie(gu,de),X(),P(()=>{const c=a.target,l=Ci({element:c,position:new M({x:c.scrollLeft??0,y:c.scrollTop??0}),spineElement:this.spine.element});this.navigationSubject.next({animation:!1,type:"scroll",position:l})}),he(()=>{u()}))}));_(s).pipe(T(this.destroy$)).subscribe()}}const vu=t=>({x:-t.x,y:-t.y}),yu=t=>t instanceof DOMMatrix?new M({x:-t.e,y:-t.f}):new M({x:-t.x,y:-t.y}),bu="navigation/ViewportNavigator",Fn=Y.namespace(bu);class wu extends ee{constructor(e,n,i,o,r){super(),this.settings=e,this.hookManager=n,this.context=i,this.spine=o,this.viewport=r,this.navigateSubject=new W,this.element$=new G(document.createElement("div"));const s=this.spine.element$.pipe(U(this.element$),P(([l,d])=>{d.style.cssText=`
          height: 100%;
          width: 100%;
          position: relative;
        `,d.className=`${Pe}-controlled-navigator`,d.innerHTML="",d.appendChild(l),this.viewport.value.element.appendChild(d),this.element$.next(d)})),a=e.watch(["computedPageTurnDirection","computedPageTurnMode","numberOfAdjacentSpineItemToPreLoad"]),u=K([a,this.element$]).pipe(P(([,l])=>{e.values.computedPageTurnMode==="scrollable"?l.style.display="contents":l.style.display="block"}));this.layout$=u.pipe(P(()=>{Fn.info("layout",e.values)}),H());const c=this.navigateSubject.pipe(P(l=>{Fn.info("Navigation requested",l)}));this.isNavigating$=c.pipe(b(({animation:l,position:d})=>({type:"manualAdjust",shouldAnimate:!(!l||l==="turn"&&e.values.computedPageTurnAnimation==="none"),animation:l,position:d})),S(l=>{const d=this.element$.getValue();return d.style.setProperty("transition","none"),d.style.setProperty("opacity","1"),_(x(!0),x(null).pipe(ae(()=>{if((l==null?void 0:l.type)!=="manualAdjust")return x(!1);const p=l.animation==="snap"?e.values.snapAnimationDuration:e.values.computedPageTurnAnimationDuration,f=l.animation==="snap"?"slide":e.values.computedPageTurnAnimation;return x(l).pipe(l.shouldAnimate?He(1,de):te,P(h=>{const g=this.element$.getValue();h.shouldAnimate?f==="fade"?(g.style.setProperty("transition",`opacity ${p/2}ms`),g.style.setProperty("opacity","0")):(l.animation==="snap"||f==="slide")&&(g.style.setProperty("transition",`transform ${p}ms`),g.style.setProperty("opacity","1")):(g.style.setProperty("transition","none"),g.style.setProperty("opacity","1"))}),P(h=>{f!=="fade"&&this.setViewportPosition(h.position)}),l.shouldAnimate?He(p/2,de):te,P(h=>{const g=this.element$.getValue();f==="fade"&&(this.setViewportPosition(h.position),g.style.setProperty("opacity","1"))}),l.shouldAnimate?He(p/2,de):te,P(h=>{f==="fade"&&this.setViewportPosition(h.position)}))}),b(()=>!1)))}),re(!1),Q(1)),_(s,this.isNavigating$,this.layout$).pipe(T(this.destroy$)).subscribe()}setViewportPosition(e){const n=this.element$.getValue(),i=vu(e);n.style.transform=`translate(${i.x}px, ${i.y}px)`,this.hookManager.execute("onViewportOffsetAdjust",void 0,{})}navigate(e){this.navigateSubject.next(e)}get viewportPosition(){const e=this.element$.getValue(),n=window.getComputedStyle(e),i=n.transform||n.webkitTransform;if(!i||i==="none")return new M({x:0,y:0});const o=new DOMMatrix(i);return yu(o)}}class Su extends je{constructor(e,n,i,o,r){super({element:void 0}),this.viewport=e,this.settings=n,this.hookManager=i,this.spine=o,this.context=r,this.navigateSubject=new W,this.scrollingSubject=new G(!1),this.isScrolling$=this.scrollingSubject.asObservable(),this.setViewportPosition=({position:d})=>{const p=this.value.element;this.scrollingSubject.next(!0),p==null||p.scrollTo({left:d.x,top:d.y,behavior:"instant"}),et(1).pipe(P(()=>{this.scrollingSubject.next(!1)}),T(_(this.scrollingSubject.pipe(Ht(1)),this.destroy$))).subscribe(),this.hookManager.execute("onViewportOffsetAdjust",void 0,{})};const s=this.context.pipe(Zt(["rootElement"]),P(({rootElement:d})=>{if(!d)return;const p=document.createElement("div");p.style.cssText=`
          height: 100%;
          width: 100%;
          position: relative;
          overflow-y: scroll;
          overflow-x: hidden;
        `,p.className=`${Pe}-scroll-navigator`,p.appendChild(this.viewport.value.element),d.appendChild(p),this.update({element:p})})),a=K([n.watch(["computedPageTurnMode"]),this.watch("element")]).pipe(P(([{computedPageTurnMode:d},p])=>{p&&(d==="scrollable"?p.style.display="block":p.style.display="contents")})),u=this.navigateSubject.pipe(P(this.setViewportPosition));this.isNavigating$=this.navigateSubject.pipe(re(!1),S(()=>_(x(!0),x(!1))),Q(1));const c=_(o.element$.pipe(S(d=>wi(d))),o.element$.pipe(S(d=>J(d,"scroll"))),o.spineItemsObserver.itemResize$).pipe(S(()=>et(10).pipe(b(()=>!1),re(!0))),O(),re(!1)),l=K([c,this.isScrolling$]).pipe(b(([d,p])=>d||p),Q(1));this.userScroll$=this.watch("element").pipe(F(fe),S(d=>n.watch(["computedPageTurnMode"]).pipe(S(({computedPageTurnMode:p})=>p==="controlled"?be:J(d,"scroll").pipe(U(l),F(([,f])=>!f),b(([f])=>f))))),H()),_(s,a,u).pipe(T(this.destroy$)).subscribe()}update(e){this.mergeCompare(e)}navigate(e){this.navigateSubject.next(e)}get viewportPosition(){const e=this.value.element;return e?Ci({element:e,position:new M({x:(e==null?void 0:e.scrollLeft)??0,y:(e==null?void 0:e.scrollTop)??0}),spineElement:this.spine.element}):new M({x:0,y:0})}}const On=(t,e,n)=>{const i=n-t,o=n*(e*t)/(n||1);return Math.max(0,Math.min(i,o))},Ft=(t,e)=>(e||0)===0||(t||0)===0?1:Math.floor(Math.max(1,t/e)),Ze=(t,e,n)=>{const i=Ft(n,e),o=[...Array(i)].map((r,s)=>s*e);return t>=i*e?o[o.length-1]||0:o.find(r=>t<r+e)||0},tn=({itemHeight:t,itemWidth:e,isUsingVerticalWriting:n,settings:i,context:o})=>{const{pageTurnDirection:r,pageTurnMode:s}=i.values;return r==="vertical"&&s==="scrollable"?1:n||r==="vertical"?Ft(t,o.getPageSize().height):Ft(e,o.getPageSize().width)},Ot=({pageIndex:t,itemLayout:e,context:n,isUsingVerticalWriting:i})=>{if(i){const r=On(n.getPageSize().height,t,e.height);return new k({x:0,y:r})}const o=On(n.getPageSize().width,t,e.width);return n.isRTL()?new k({x:e.width-o-n.getPageSize().width,y:0}):new k({x:o,y:0})},Iu=({context:t,isUsingVerticalWriting:e,settings:n,itemLayout:i})=>{const o=tn({context:t,isUsingVerticalWriting:e,itemHeight:i.height,itemWidth:i.width,settings:n});return new Array(o).fill(void 0).map((r,s)=>Ot({context:t,isUsingVerticalWriting:e,itemLayout:i,pageIndex:s}))},Ni=({context:t,settings:e})=>{const n=({itemWidth:c,itemHeight:l,spineItemPosition:d})=>new k({x:Math.min(c,Math.max(0,d.x)),y:Math.min(l,Math.max(0,d.y))}),i=({itemWidth:c,itemHeight:l,position:d,isUsingVerticalWriting:p})=>{const f=t.getPageSize().width,h=t.getPageSize().height,g=n({spineItemPosition:d,itemHeight:l,itemWidth:c}),v=t.isRTL()?c-g.x-t.getPageSize().width:g.x,m=tn({isUsingVerticalWriting:p,itemHeight:l,itemWidth:c,context:t,settings:e});return p?u(d.y,h,m):u(v,f,m)},o=(c,l,d)=>{var p;let f;if((c==null?void 0:c.nodeName)==="img"||(c==null?void 0:c.textContent)===""&&c.nodeType===Node.ELEMENT_NODE)f=c.getBoundingClientRect().x;else if(c){const v=c?fs(c,l):void 0;f=(v==null?void 0:v.getBoundingClientRect().x)||f}const h=((p=d.layout.layoutInfo)==null?void 0:p.width)||0,g=t.getPageSize().width;if(f!==void 0){const v=Ze(f,g,h);return new k({x:v,y:0})}},r=(c,l)=>{var d,p;const f=t.getPageSize(),h=(d=l.renderer)==null?void 0:d.getDocumentFrame();if(h&&((p=h==null?void 0:h.contentWindow)!=null&&p.document)&&h.contentWindow.document.body!==null){const{x:g,y:v}=Ot({pageIndex:c,itemLayout:l.layout.layoutInfo,context:t,isUsingVerticalWriting:!!l.isUsingVerticalWriting()}),m={left:g,right:g+f.width,bottom:v+f.height};return ds(h.contentWindow.document,m)}},s=(c,l)=>{const{width:d,height:p}=l.layout.layoutInfo;return new k({x:Ze(c.x,t.getPageSize().width,d),y:Ze(c.y,t.getPageSize().height,p)})},a=(c,l,d)=>{const p=o(c,l,d),{height:f,width:h}=d.layout.layoutInfo;return p?i({isUsingVerticalWriting:!!d.isUsingVerticalWriting(),position:p,itemHeight:f,itemWidth:h}):void 0},u=(c,l,d)=>{const p=[...Array(d)].map((f,h)=>h*l);return c<=0?0:c>=d*l?d-1:Math.max(0,p.findIndex(f=>c<f+l))};return{getSpineItemPositionFromNode:o,getSpineItemPositionFromPageIndex:({pageIndex:c,spineItem:l})=>Ot({context:t,isUsingVerticalWriting:!!l.isUsingVerticalWriting(),itemLayout:l.layout.layoutInfo,pageIndex:c}),getSpineItemPageIndexFromPosition:i,getSpineItemPageIndexFromNode:a,getSpineItemClosestPositionFromUnsafePosition:s,getFirstNodeOrRangeAtPage:r,getSpineItemPagesPosition:({item:c})=>Iu({context:t,isUsingVerticalWriting:!!c.isUsingVerticalWriting(),settings:e,itemLayout:c.layout.layoutInfo})}},Pu=({context:t,settings:e})=>{const n=Ni({context:t,settings:e});return{getNavigationForLastPage:s=>{const a=s.numberOfPages;return n.getSpineItemPositionFromPageIndex({pageIndex:a-1,spineItem:s})},getNavigationForPosition:(s,a)=>n.getSpineItemClosestPositionFromUnsafePosition(a,s),getNavigationFromNode:(s,a,u)=>n.getSpineItemPositionFromNode(a,u,s)||new k({x:0,y:0})}},ue=({position:{x:t,y:e},pageSizeWidth:n,visibleAreaRectWidth:i})=>{const r=t%i!==0?t-n:t;return new M({x:r,y:e})},An=({position:t,isRTL:e,pageSizeHeight:n,spineItemsManager:i,visibleAreaRectWidth:o,spineLayout:r})=>{const s=i.get(i.items.length-1),a=r.getSpineItemSpineLayoutInfo(s||0),u=a.bottom-n,c=Math.min(Math.max(0,t.y),u);if(e)return new M({x:Math.max(Math.min(0,t.x),a.left),y:c});const l=a.right-o;return new M({x:Math.min(Math.max(0,t.x),l),y:c})},At=({viewportPosition:t,spineLocator:e,context:n,spineItemNavigationResolver:i})=>{const o=e.getSpineItemFromPosition(t);if(o){const r=e.getSpineItemPositionFromSpinePosition(t,o),s=i.getNavigationForPosition(o,r),a=e.getSpinePositionFromSpineItemPosition({spineItemPosition:s,spineItem:o});return ue({position:a,pageSizeWidth:n.getPageSize().width,visibleAreaRectWidth:n.state.visibleAreaRect.width})}return new M({x:0,y:0})},xu=({pageIndex:t,spineItemsManager:e,spineItemId:n,context:i,spineLocator:o,spineItemNavigationResolver:r})=>{const s=e.get(n);if(!s){const c=t*i.getPageSize().width;return At({viewportPosition:new M({x:c,y:0}),context:i,spineItemNavigationResolver:r,spineLocator:o})}const a=o.spineItemLocator.getSpineItemPositionFromPageIndex({pageIndex:t,spineItem:s}),u=o.getSpinePositionFromSpineItemPosition({spineItemPosition:a,spineItem:s});return ue({position:u,pageSizeWidth:i.getPageSize().width,visibleAreaRectWidth:i.state.visibleAreaRect.width})},$u=({anchor:t,spineItem:e,context:n})=>{var i;const o=((i=e.layout.layoutInfo)==null?void 0:i.width)||0,r=n.getPageSize().width,s=e.getBoundingRectOfElementFromSelector(t),a=(s==null?void 0:s.x)||0;return Ze(a,r,o)},_u=({anchor:t,context:e,spineItem:n,spineLocator:i})=>{const o=$u({anchor:t,spineItem:n,context:e});return i.getSpinePositionFromSpineItemPosition({spineItemPosition:new k({x:o,y:0}),spineItem:n})},Tu=({anchor:t,spineItem:e,spineLocator:n,context:i,pageSizeWidth:o,visibleAreaRectWidth:r})=>{const s=_u({anchor:t,context:i,spineItem:e,spineLocator:n});return ue({position:s,pageSizeWidth:o,visibleAreaRectWidth:r})},Eu=({context:t,spineItemsManager:e,spineLocator:n,url:i,pageSizeWidth:o,visibleAreaRectWidth:r})=>{var s;try{const a=i instanceof URL?i:new URL(i),u=`${a.origin}${a.pathname}`,c=(s=t.manifest)==null?void 0:s.spineItems.find(l=>l.href===u);if(c){const l=e.get(c.id);if(l){const d=Tu({anchor:a.hash,spineItem:l,context:t,spineLocator:n,pageSizeWidth:o,visibleAreaRectWidth:r});return{position:ue({position:d,pageSizeWidth:o,visibleAreaRectWidth:r}),spineItemId:c.id}}}return}catch(a){console.error(a);return}},Fu=({spineItem:t,spineItemPosition:e,spineLocator:n,spineItemLocator:i,context:o})=>{const r=i.getSpineItemClosestPositionFromUnsafePosition(e,t),s=n.getSpinePositionFromSpineItemPosition({spineItemPosition:r,spineItem:t});return ue({position:s,pageSizeWidth:o.getPageSize().width,visibleAreaRectWidth:o.state.visibleAreaRect.width})},Ou="spineNavigator",Au=({context:t,spineItemsManager:e,locator:n,settings:i,spineLayout:o})=>{const r=Pu({context:t,settings:i});return{getNavigationForUrl:p=>Eu({context:t,spineItemsManager:e,spineLocator:n,url:p,pageSizeWidth:t.getPageSize().width,visibleAreaRectWidth:t.state.visibleAreaRect.width}),getNavigationForSpineItemPage:p=>xu({...p,context:t,spineItemsManager:e,spineItemNavigationResolver:r,spineLocator:n}),getNavigationFromSpineItemPosition:p=>Fu({...p,spineItemLocator:n.spineItemLocator,spineLocator:n,context:t}),getNavigationForCfi:p=>{const f=e.getSpineItemFromCfi(p),{node:h,offset:g=0}=Oi({cfi:p,spineItemsManager:e})||{};if(!f){Y.warn(Ou,`unable to detect item id from cfi ${p}`);return}const v=h?r.getNavigationFromNode(f,h,g):new k({x:0,y:0}),m=n.getSpinePositionFromSpineItemPosition({spineItemPosition:v,spineItem:f});return ue({position:m,pageSizeWidth:t.getPageSize().width,visibleAreaRectWidth:t.state.visibleAreaRect.width})},getNavigationForLastPage:p=>{const f=r.getNavigationForLastPage(p),h=n.getSpinePositionFromSpineItemPosition({spineItemPosition:f,spineItem:p});return ue({position:h,pageSizeWidth:t.getPageSize().width,visibleAreaRectWidth:t.state.visibleAreaRect.width})},getNavigationForSpineIndexOrId:p=>{const f=e.get(p);if(f){const h=n.getSpinePositionFromSpineItem(f);return ue({position:h,pageSizeWidth:t.getPageSize().width,visibleAreaRectWidth:t.state.visibleAreaRect.width})}return new M({x:0,y:0})},getNavigationForPosition:p=>At({viewportPosition:p,context:t,spineItemNavigationResolver:r,spineLocator:n}),getMostPredominantNavigationForPosition:p=>{const f=i.values.computedPageTurnDirection,h=.5,g=f==="horizontal"?p.x+t.state.visibleAreaRect.width*h:0,v=f==="horizontal"?0:p.y+t.state.visibleAreaRect.height*h,m=An({position:new M({x:g,y:v}),isRTL:t.isRTL(),pageSizeHeight:t.getPageSize().height,visibleAreaRectWidth:t.state.visibleAreaRect.width,spineItemsManager:e,spineLayout:o});return At({context:t,spineItemNavigationResolver:r,spineLocator:n,viewportPosition:m})},getAdjustedPositionWithSafeEdge:p=>An({position:p,isRTL:t.isRTL(),pageSizeHeight:t.getPageSize().height,visibleAreaRectWidth:t.state.visibleAreaRect.width,spineItemsManager:e,spineLayout:o}),isNavigationGoingForwardFrom:(p,f)=>i.values.computedPageTurnDirection==="vertical"?p.y>f.y:p.x>f.x,arePositionsDifferent:(p,f)=>p.x!==f.x||p.y!==f.y,getAdjustedPositionForSpread:p=>ue({position:p,pageSizeWidth:t.getPageSize().width,visibleAreaRectWidth:t.state.visibleAreaRect.width}),spineItemNavigator:r}},Mu=({spineItemsManager:t,context:e,hookManager:n,spine:i,settings:o,viewport:r})=>{const s=new W,a=new Ri,u=Au({context:e,settings:o,spineItemsManager:t,locator:i.locator,spineLayout:i.spineLayout}),c=new wu(o,n,e,i,r),l=new Su(r,o,n,i,e),d=new mu(o,e,i,l,a),p=_(s,d.navigation$),f=new hu(o,e,p,c,l,u,i,a.isLocked$),h=K([c.isNavigating$,l.isNavigating$,a.isLocked$,f.locker.isLocked$]).pipe(b(m=>m.some(y=>y)?"busy":"free"),O(),Q(1));return{destroy:()=>{d.destroy(),c.destroy(),f.destroy()},getNavigation:()=>f.navigation,internalNavigator:f,scrollNavigationController:l,controlledNavigationController:c,locker:a,viewportState$:h,navigate:m=>{s.next(m)},lock(){return a.lock()},navigationResolver:u,navigation$:f.navigation$}};class Lu extends je{constructor(e,n){super({beginPageIndexInSpineItem:void 0,beginNumberOfPagesInSpineItem:0,beginCfi:void 0,beginSpineItemIndex:void 0,endPageIndexInSpineItem:void 0,endNumberOfPagesInSpineItem:0,endCfi:void 0,endSpineItemIndex:void 0,navigationId:void 0}),this.context=e,this.spineItemsManager=n}update(e){this.mergeCompare(e)}}class Ru extends ee{constructor(e,n,i,o,r){super(),this.context=e,this.pagination=n,this.spineItemsManager=i,this.spine=o,this.spineItemLocator=r;const s=_(this.context.bridgeEvent.navigation$,o.spineLayout.layout$).pipe(S(()=>{const u=({spineItem:c,position:l})=>this.spine.locator.getVisiblePagesFromViewportPosition({spineItem:c,position:l,threshold:.5});return this.context.bridgeEvent.navigationUnlocked$.pipe(Ne(1),U(this.context.bridgeEvent.navigation$),P(([,c])=>{const{position:l}=c,d=this.pagination.value,{beginIndex:p,endIndex:f}=this.spine.locator.getVisibleSpineItemsFromPosition({position:l,threshold:.5})??{},h=this.spineItemsManager.get(p),g=this.spineItemsManager.get(f);if(!h||!g)return;const v=d.beginCfi,m=d.endCfi,{beginPageIndex:y=0}=u({spineItem:h,position:l})??{},{endPageIndex:w=0}=u({spineItem:g,position:l})??{},I=v===void 0||Et(v)||d.beginSpineItemIndex!==p,$=d.endSpineItemIndex!==f||m===void 0||Et(m),E=I?Me(h.item):v,R=$?Me(g.item):m,V=h.numberOfPages,C=g.numberOfPages;this.pagination.update({beginCfi:E,beginNumberOfPagesInSpineItem:V,beginPageIndexInSpineItem:y,beginSpineItemIndex:p,endCfi:R,endNumberOfPagesInSpineItem:C,endPageIndexInSpineItem:w,endSpineItemIndex:f,navigationId:c.id})}))})),a=s.pipe(ot(this.context.bridgeEvent.viewportFree$),P(()=>{const{beginSpineItemIndex:u,endSpineItemIndex:c,beginPageIndexInSpineItem:l,endPageIndexInSpineItem:d}=this.pagination.value;if(l===void 0||d===void 0||u===void 0||c===void 0)return;const p=this.spineItemsManager.get(u),f=this.spineItemsManager.get(c);p===void 0||f===void 0||this.pagination.update({beginCfi:Tt({pageIndex:l,spineItem:p,spineItemLocator:r}),endCfi:Tt({pageIndex:d,spineItem:f,spineItemLocator:r})})}));_(s,a).pipe(T(this.destroy$)).subscribe()}}class Cu extends ee{constructor(e){super();const n={...this.getDefaultSettings(),...e};this.inputSettings=n,this.outputSettingsUpdateSubject=new W,this._settings$=this.outputSettingsUpdateSubject.asObservable().pipe(Q(1)),this._settings$.subscribe()}_prepareUpdate(e){const n=qe(this.inputSettings,e),i=this.getOutputSettings(n),o=!q(this.outputSettings,i);return{hasChanged:o,state:i,commit:()=>(this.inputSettings=n,this.outputSettings=i,o&&this.outputSettingsUpdateSubject.next(i),i)}}update(e){const{commit:n}=this._prepareUpdate(e);n()}get values(){if(!this.outputSettings){const{commit:e}=this._prepareUpdate(this.inputSettings);return e()}return this.outputSettings}get values$(){if(!this.outputSettings){const{commit:e}=this._prepareUpdate(this.inputSettings);e()}return this._settings$}watch(e){return this.values$.pipe(bi(e),O(q))}destroy(){super.destroy(),this.outputSettingsUpdateSubject.complete()}}class Nu extends Cu{constructor(e,n){super(e),this.context=n;const i=K([n.hasVerticalWriting$,n.manifest$]).pipe(P(()=>{this.update(this.values)})),o=this.values$.pipe(P(({forceSinglePageMode:r})=>{n.update({forceSinglePageMode:r})}));_(i,o).pipe(T(n.destroy$)).subscribe()}getComputedSettings(e){const n=this.context.manifest,i=this.context.state.hasVerticalWriting??!1,o={computedPageTurnDirection:e.pageTurnDirection,computedPageTurnAnimation:e.pageTurnAnimation,computedPageTurnMode:e.pageTurnMode,computedPageTurnAnimationDuration:0};return(n==null?void 0:n.renditionFlow)==="scrolled-continuous"&&(o.computedPageTurnMode="scrollable"),o.computedPageTurnMode==="scrollable"&&(o.computedPageTurnDirection="vertical"),i&&o.computedPageTurnAnimation==="slide"&&(Y.warn(`pageTurnAnimation ${o.computedPageTurnAnimation} incompatible with current book, switching back to default`),o.computedPageTurnAnimation="none"),o.computedPageTurnMode==="scrollable"?(o.computedPageTurnAnimationDuration=0,o.computedPageTurnAnimation="none"):o.computedPageTurnAnimationDuration=e.pageTurnAnimationDuration!==void 0?e.pageTurnAnimationDuration:300,o}getOutputSettings(e){const n=this.getComputedSettings(e);return{...this.outputSettings,...e,...n}}getDefaultSettings(){return{forceSinglePageMode:!1,pageTurnAnimation:"slide",pageTurnDirection:"horizontal",pageTurnAnimationDuration:void 0,pageTurnMode:"controlled",snapAnimationDuration:300,navigationSnapThreshold:.3,numberOfAdjacentSpineItemToPreLoad:3}}}class ju extends ee{constructor(e,n,i,o,r,s){super(),this.item=e,this.containerElement=n,this.context=i,this.hookManager=o,this.renderer=r,this.settings=s,this.layoutTriggerSubject=new W,this.lastLayout=null,this.applyDimsAfterLayout=({blankPagePosition:a,minimumWidth:u})=>c=>c.pipe(b(l=>{var d;const p=q((d=this.lastLayout)==null?void 0:d.pageSize,this.context.getPageSize())?this.lastLayout:void 0,{width:f,height:h}=p??{},{width:g=f,height:v=h}=l??{},{width:m,height:y}=this.context.getPageSize(),w=this.validateDimension(g??m,m,u),I=this.settings.values.computedPageTurnMode==="scrollable"?v??y:this.validateDimension(v??y,y,y);return this.lastLayout={width:w,height:I,pageSize:this.context.getPageSize()},this.containerElement.style.width=`${w}px`,this.containerElement.style.height=`${I}px`,this.hookManager.execute("item.onAfterLayout",void 0,{blankPagePosition:a,item:this.item,minimumWidth:u}),{width:w,height:I}})),this.layout=a=>{const u=Ps(this.layout$.pipe(X()));return this.layoutTriggerSubject.next(a),u()},this.adjustPositionOfElement=({right:a,left:u,top:c})=>{a!==void 0?this.containerElement.style.right=`${a}px`:this.containerElement.style.removeProperty("right"),u!==void 0?this.containerElement.style.left=`${u}px`:this.containerElement.style.removeProperty("left"),c!==void 0?this.containerElement.style.top=`${c}px`:this.containerElement.style.removeProperty("top")},this.layoutProcess$=this.layoutTriggerSubject.pipe(S(a=>{const{blankPagePosition:u,minimumWidth:c,spreadPosition:l}=a;this.hookManager.execute("item.onBeforeLayout",void 0,{blankPagePosition:u,item:this.item,minimumWidth:c});const d=this.renderer.layout({blankPagePosition:u,minPageSpread:c/this.context.getPageSize().width,minimumWidth:c,spreadPosition:l});return _(x({type:"start"}),d.pipe(this.applyDimsAfterLayout(a),b(p=>({type:"end",data:p}))))}),H()),this.layout$=this.layoutProcess$.pipe(F(a=>a.type==="end"),b(a=>a.data),H())}validateDimension(e,n,i){if(e<=0)return i;const o=Math.max(e,i),s=Math.ceil(o/n)*n;return Math.max(s,n)}get layoutInfo(){const e=this.containerElement.style,n=e.width?parseFloat(e.width):0,i=e.height?parseFloat(e.height):0;return{width:n,height:i}}}class Du extends Jt{onUnload(){return ne}onCreateDocument(){return x(document.createElement("div"))}onLoadDocument(){return ne}onLayout(){return x(void 0)}onRenderHeadless(){return ne}getDocumentFrame(){}}class ji extends ee{constructor(e,n,i,o,r,s){var a,u;super(),this.item=e,this.parentElement=n,this.context=i,this.settings=o,this.hookManager=r,this.index=s,this.getBoundingRectOfElementFromSelector=d=>{var p,f,h,g;const v=this.renderer.getDocumentFrame();if(v&&v instanceof HTMLIFrameElement&&d)return d.startsWith("#")?(f=(p=v.contentDocument)==null?void 0:p.getElementById(d.replace("#","")))==null?void 0:f.getBoundingClientRect():(g=(h=v.contentDocument)==null?void 0:h.querySelector(d))==null?void 0:g.getBoundingClientRect()},this.load=()=>{this.renderer.load()},this.unload=()=>{this.renderer.unload()},this.destroy=()=>{super.destroy(),this.containerElement.remove(),this.renderer.destroy()},this.isUsingVerticalWriting=()=>{var d;return!!((d=this.renderer.writingMode)!=null&&d.startsWith("vertical"))},this.containerElement=Vu(n,e,r),n.appendChild(this.containerElement);const c=(u=(a=this.settings.values).getRenderer)==null?void 0:u.call(a,e);this.resourcesHandler=new Kt(e,this.settings);const l={context:i,settings:o,hookManager:r,item:e,containerElement:this.containerElement,resourcesHandler:this.resourcesHandler};this.renderer=c?c(l):new Du(l),this.layout=new ju(e,this.containerElement,i,r,this.renderer,this.settings),this.isReady$=this.layout.layoutProcess$.pipe(U(this.renderer.isLoaded$),b(([d,p])=>!!(d.type==="end"&&p)),re(!1),O(),P(d=>{this.containerElement.dataset.isReady=d.toString()}),Q({refCount:!0,bufferSize:1})),this.needsLayout$=_(this.unloaded$,this.loaded$),_(this.isReady$,this.layout.layout$).pipe(T(this.destroy$)).subscribe()}get element(){return this.containerElement}get readingDirection(){return this.renderer.readingDirection}get loaded$(){return this.renderer.state$.pipe(O(),F(e=>e==="loaded"))}get unloaded$(){return this.renderer.state$.pipe(O(),F(e=>e!=="idle"),S(()=>this.renderer.state$.pipe(F(e=>e==="idle"),X())))}get renditionLayout(){return this.renderer.renditionLayout}get numberOfPages(){return tn({isUsingVerticalWriting:!!this.isUsingVerticalWriting(),itemHeight:this.layout.layoutInfo.height,itemWidth:this.layout.layoutInfo.width,context:this.context,settings:this.settings})}}const Vu=(t,e,n)=>{const i=t.ownerDocument.createElement("div");return i.classList.add("spineItem"),i.classList.add(`spineItem-${e.renditionLayout??"reflowable"}`),i.style.cssText=`
    position: absolute;
    overflow: hidden;
  `,i.dataset.isReady="false",n.execute("item.onBeforeContainerCreated",void 0,{element:i}),i};class ku extends ee{constructor(e,n){super(),this.spineItemsManager=e,this.spineLocator=n,this.itemIsReady$=this.spineItemsManager.items$.pipe(S(i=>{const o=i.map(r=>r.isReady$.pipe(b(s=>({item:r,isReady:s}))));return _(...o)}),H()),this.itemResize$=this.spineItemsManager.items$.pipe(S(i=>{const o=i.map(r=>wi(r.element).pipe(b(s=>({entries:s,item:r}))));return _(...o)}),H()),this.itemLoaded$=this.spineItemsManager.items$.pipe(S(i=>{const o=i.map(r=>r.loaded$.pipe(b(()=>r)));return _(...o)}))}}const Wu=({horizontalOffset:t,verticalOffset:e,context:n,spineItemsManager:i,isGloballyPrePaginated:o,settings:r,index:s,item:a,viewport:u})=>{let c=n.getPageSize().width,l="none";const d=t%u.absoluteViewport.width===0,p=s===i.items.length-1;if(n.state.isUsingSpreadMode){!o&&a.renditionLayout==="reflowable"&&!p&&(c=n.getPageSize().width*2),!o&&a.renditionLayout==="reflowable"&&p&&d&&(c=n.getPageSize().width*2);const h=d&&p&&o;a.item.pageSpreadRight&&d&&!n.isRTL()||a.item.pageSpreadLeft&&d&&n.isRTL()?(l="before",c=n.getPageSize().width*2):h&&(n.isRTL()?l="before":l="after",c=n.getPageSize().width*2)}return a.layout.layout({minimumWidth:c,blankPagePosition:l,spreadPosition:n.state.isUsingSpreadMode?d?n.isRTL()?"right":"left":n.isRTL()?"left":"right":"none"}).pipe(b(({width:h,height:g})=>{if(r.values.computedPageTurnDirection==="vertical"){const y=d?e:e-n.state.visibleAreaRect.height,w=d?0:t;n.isRTL()?a.layout.adjustPositionOfElement({top:y,left:w}):a.layout.adjustPositionOfElement({top:y,left:w});const I=h+w,$=g+y,E=new _t({left:w,right:I,top:y,bottom:$,height:g,width:h,x:w,y});return{horizontalOffset:I,verticalOffset:$,layoutPosition:E}}a.layout.adjustPositionOfElement(n.isRTL()?{right:t,top:0}:{left:t,top:0});const v=n.isRTL()?u.absoluteViewport.width-t-h:t,m=new _t({right:n.isRTL()?u.absoluteViewport.width-t:t+h,left:v,x:v,top:e,bottom:g,height:g,width:h,y:e});return{horizontalOffset:t+h,verticalOffset:0,layoutPosition:m}}))};class Uu extends ee{constructor(e,n,i,o){super(),this.spineItemsManager=e,this.context=n,this.settings=i,this.viewport=o,this.layoutSubject=new W,this.spineItemsRelativeLayouts=[],e.items$.pipe(P(()=>{this.spineItemsRelativeLayouts=[]}),S(s=>{const a=s.map(c=>c.needsLayout$.pipe(P(()=>{this.layout()}))),u=s.map(c=>c.loaded$.pipe(P(()=>{c.isUsingVerticalWriting()?this.context.update({hasVerticalWriting:!0}):this.context.update({hasVerticalWriting:!1})})));return _(...a,...u)})).pipe(T(this.destroy$)).subscribe();const r=new G(!1);this.layout$=this.layoutSubject.pipe(Ie(50),wt(()=>r.pipe(F(s=>!s),X())),wt(()=>{r.next(!0);const s=this.context.manifest,a=Li(s)??!1;return j(this.spineItemsManager.items).pipe(wr((c,l,d)=>c.pipe(fn(({horizontalOffset:p,verticalOffset:f,pages:h})=>Wu({context:this.context,horizontalOffset:p,index:d,isGloballyPrePaginated:a,item:l,settings:this.settings,spineItemsManager:this.spineItemsManager,verticalOffset:f,viewport:o}).pipe(b(({horizontalOffset:g,verticalOffset:v,layoutPosition:m})=>(this.spineItemsRelativeLayouts[d]=m,{horizontalOffset:g,verticalOffset:v,pages:[...h,m]}))))),x({horizontalOffset:0,verticalOffset:0,pages:[]})),fn(c=>c),he(()=>{r.next(!1)}))}),H()),_(this.layout$).pipe(T(this.destroy$)).subscribe()}layout(){this.layoutSubject.next(void 0)}getSpineItemSpineLayoutInfo(e){const n=this.spineItemsManager.getSpineItemIndex(e)??0;return this.spineItemsRelativeLayouts[n]||new _t({left:0,right:0,top:0,bottom:0,width:0,height:0,x:0,y:0})}get numberOfPages(){return this.spineItemsManager.items.reduce((e,n)=>e+n.numberOfPages,0)}destroy(){super.destroy(),this.layoutSubject.complete()}}class zu extends ee{constructor(e,n,i,o,r){super(),this.context=e,this.spineItemsManager=n,this.spineLocator=i,this.settings=o,this.spineLayout=r,this.forcedOpenSubject=new G([]);const s=this.forcedOpenSubject.pipe(b(c=>[...new Set(c.flat())].sort()),O(Vr),Q({bufferSize:1,refCount:!0}));_(this.context.bridgeEvent.navigation$,this.spineLayout.layout$,s,o.watch(["numberOfAdjacentSpineItemToPreLoad"])).pipe(Ie(100,de),ot(this.context.bridgeEvent.viewportFree$),U(this.context.bridgeEvent.navigation$,s),b(([,c,l])=>{const{numberOfAdjacentSpineItemToPreLoad:d}=o.values,{beginIndex:p=0,endIndex:f=0}=i.getVisibleSpineItemsFromPosition({position:c.position,threshold:0,useAbsoluteViewport:!1})||{},h=p-d,g=f+d,v=Array.from({length:g-h+1},(y,w)=>h+w),m=[...l,...v];n.items.forEach((y,w)=>{m.includes(w)?y.load():y.unload()})})).pipe(T(this.destroy$)).subscribe()}forceOpen(e){const n=e.map(i=>typeof i=="number"?i:i.index);return this.forcedOpenSubject.next([...this.forcedOpenSubject.value,n]),()=>{this.isDestroyed||this.forcedOpenSubject.next(this.forcedOpenSubject.value.filter(i=>i!==n))}}destroy(){super.destroy(),this.forcedOpenSubject.complete()}}const Di=(t,e,n)=>{const i=(n.width-e.width)/2,o=(n.height-e.height)/2;return new Qt({x:t.x-i,y:t.y-o})};class Re extends DOMRect{constructor(){super(...arguments),this.__symbol=Symbol("ViewportPosition")}static from(e,n){if(n){const o=e;return new Re(o.x,o.y,n.width,n.height)}const i=e;return new Re(i.x,i.y,i.width,i.height)}}class Bu{constructor({width:e,height:n}){this.__symbol=Symbol("AbsoluteViewport"),this.width=e,this.height=n}}class Hu{constructor({width:e,height:n}){this.__symbol=Symbol("RelativeViewport"),this.width=e,this.height=n}}const qu=({pageIndex:t,spineItemOrId:e,spineItemsManager:n})=>{const i=n.items,o=n.get(e);if(!o)return;const{currentAbsolutePage:r}=i.reduce((s,a)=>{if(s.found)return s;const u=a.numberOfPages;return o===a&&t<=u-1?{currentAbsolutePage:s.currentAbsolutePage+t,found:!0}:{...s,currentAbsolutePage:s.currentAbsolutePage+u}},{currentAbsolutePage:0,found:!1});return r},Xu=({itemHeight:t,itemWidth:e,visibleWidthOfItem:n,visibleHeightOfItem:i,threshold:o})=>{const r=n/e,s=i/t;return r>=o&&s>=o},Yu=({visibleWidthOfItem:t,visibleHeightOfItem:e,threshold:n,viewportPosition:i})=>{const o=t/i.width;return e/i.height>=n&&o>=n},Vi=({itemPosition:{bottom:t,left:e,right:n,top:i,width:o,height:r},threshold:s,viewportPosition:a,restrictToScreen:u})=>{const c=a.x,l=a.x+(a.width-1),d=a.y,p=Math.max(a.y+(a.height-1),0),f=Math.max(0,Math.min(n,l)-Math.max(e,c)),h=Math.max(0,Math.min(t,p)-Math.max(i,d));if(f<=0||h<=0)return{visible:!1};const v=Yu({threshold:s,visibleHeightOfItem:h,visibleWidthOfItem:f,viewportPosition:a});return u?{visible:v}:{visible:Xu({itemHeight:r,itemWidth:o,threshold:s,visibleHeightOfItem:h,visibleWidthOfItem:f})||v}},Gu=({absolutePageIndex:t,spineItemsManager:e})=>{const n=e.items,{found:i,currentAbsolutePage:o}=n.reduce((r,s)=>{if(r.found)return r;const a=s.numberOfPages,u=t-r.currentAbsolutePage,c=r.currentAbsolutePage+a;return u<=a-1?{...r,currentAbsolutePage:c,found:{item:s,pageIndex:u}}:{...r,currentAbsolutePage:c}},{currentAbsolutePage:0});if(i)return{spineItem:i.item,pageIndex:i.pageIndex,itemIndex:e.getSpineItemIndex(i.item)??0,currentAbsolutePage:o}},ki=({position:t,spineItemsManager:e,spineLayout:n,settings:i})=>{const o=e.items.find(r=>{const{left:s,right:a,bottom:u,top:c}=n.getSpineItemSpineLayoutInfo(r),l=t.x>=s&&t.x<a;return i.values.computedPageTurnDirection==="horizontal"?l:l&&t.y>=c&&t.y<u});return t.x===0&&!o?e.items[0]:o},pt=({spineItemPosition:t,itemLayout:{left:e,top:n}})=>new M({x:e+t.x,y:n+t.y}),Zu=({position:t,threshold:e,restrictToScreen:n,spineItemsManager:i,settings:o,spineLayout:r,useAbsoluteViewport:s=!0,viewport:a})=>{const u=ki({position:t,settings:o,spineItemsManager:i,spineLayout:r})||i.get(0),c=i.items.reduce((h,g)=>{const v=r.getSpineItemSpineLayoutInfo(g),m=s?a.absoluteViewport:a.relativeViewport,y=Di(t,a.absoluteViewport,m),w=Re.from(y,m),{visible:I}=Vi({itemPosition:v,threshold:e,viewportPosition:w,restrictToScreen:n});return I?[...h,g]:h},[]),l=c[0]??u,d=c[c.length-1]??l;if(!l||!d)return;const p=i.getSpineItemIndex(l),f=i.getSpineItemIndex(d);return{beginIndex:p??0,endIndex:f??0}},Ju=({spineItemsManager:t,context:e,spineItemLocator:n,settings:i,spineLayout:o,viewport:r})=>{const s=(f,h)=>{const{left:g,top:v}=o.getSpineItemSpineLayoutInfo(h);return new k({x:Math.max(f.x-g,0),y:Math.max(f.y-v,0)})},a=f=>pt({spineItemPosition:new k({x:0,y:0}),itemLayout:o.getSpineItemSpineLayoutInfo(f)}),u=f=>t.items.find(h=>h.renderer.getDocumentFrame()===f),c=(f,h,g)=>{if(typeof g=="number"){const v=t.get(g);return v?n.getSpineItemPageIndexFromNode(f,h||0,v):void 0}return n.getSpineItemPageIndexFromNode(f,h||0,g)},l=({position:f,threshold:h,spineItem:g,restrictToScreen:v,useAbsoluteViewport:m=!0,viewport:y})=>{const w=g.numberOfPages,$=Array.from(Array(w)).map((V,C)=>{const z=n.getSpineItemPositionFromPageIndex({pageIndex:C,spineItem:g}),B=pt({spineItemPosition:z,itemLayout:o.getSpineItemSpineLayoutInfo(g)});return{index:C,absolutePosition:{width:e.getPageSize().width,height:e.getPageSize().height,left:B.x,top:B.y,bottom:B.y+e.getPageSize().height,right:B.x+e.getPageSize().width}}}).reduce((V,{absolutePosition:C,index:z})=>{const B=m?y.absoluteViewport:y.relativeViewport,rt=Di(f,y.absoluteViewport,B),Ui=Re.from(rt,B),{visible:zi}=Vi({viewportPosition:Ui,restrictToScreen:v,threshold:h,itemPosition:C});return zi?[...V,z]:V},[]),E=$[0],R=$[$.length-1]??E;if(!(E===void 0||R===void 0))return{beginPageIndex:E,endPageIndex:R}};return{getSpinePositionFromSpineItemPosition:({spineItem:f,spineItemPosition:h})=>{const g=o.getSpineItemSpineLayoutInfo(f);return pt({itemLayout:g,spineItemPosition:h})},getAbsolutePageIndexFromPageIndex:f=>qu({...f,spineItemsManager:t}),getSpineInfoFromAbsolutePageIndex:f=>Gu({...f,spineItemsManager:t}),getSpinePositionFromSpineItem:a,getSpineItemPositionFromSpinePosition:s,getSpineItemFromPosition:f=>ki({position:f,settings:i,spineItemsManager:t,spineLayout:o}),getSpineItemFromIframe:u,getSpineItemPageIndexFromNode:c,getVisibleSpineItemsFromPosition:f=>Zu({settings:i,spineItemsManager:t,spineLayout:o,viewport:r,...f}),getVisiblePagesFromViewportPosition:f=>l({...f,viewport:r}),isPositionWithinSpineItem:(f,h)=>{const{bottom:g,left:v,right:m,top:y}=o.getSpineItemSpineLayoutInfo(h);return f.x>=v&&f.x<=m&&f.y<=g&&f.y>=y},spineItemLocator:n,getSafeSpineItemPositionFromUnsafeSpineItemPosition:(f,h)=>{const{height:g,width:v}=o.getSpineItemSpineLayoutInfo(h);return new k({x:Math.min(Math.max(0,f.x),v),y:Math.min(Math.max(0,f.y),g)})}}};class Ku extends ee{constructor(e,n,i,o,r,s,a,u){super(),this.parentElement$=e,this.context=n,this.pagination=i,this.spineItemsManager=o,this.spineItemLocator=r,this.settings=s,this.hookManager=a,this.viewport=u,this.elementSubject=new G(ms()),this.element$=this.elementSubject.asObservable(),this.spineLayout=new Uu(o,n,s,u),this.locator=Ju({context:n,spineItemsManager:o,spineItemLocator:r,settings:s,spineLayout:this.spineLayout,viewport:u}),this.spineItemsLoader=new zu(this.context,o,this.locator,s,this.spineLayout),this.spineItemsObserver=new ku(o,this.locator);const c=n.manifest$.pipe(P(d=>{this.spineItemsManager.destroyItems();const p=d.spineItems.map((f,h)=>new ji(f,this.elementSubject.getValue(),this.context,this.settings,this.hookManager,h));this.spineItemsManager.addMany(p)})),l=e.pipe(P(d=>{const p=d.ownerDocument.createElement("div");p.style.cssText=`
          height: 100%;
          position: relative;
        `,p.className=`${Pe}-spine`,this.elementSubject.next(p)}));_(c,l).pipe(T(this.destroy$)).subscribe()}get element(){return this.elementSubject.getValue()}layout(){this.spineLayout.layout()}destroy(){super.destroy(),this.spineItemsLoader.destroy(),this.elementSubject.getValue().remove(),this.elementSubject.complete()}}class Qu extends ee{constructor(e,n){super(),this.context=e,this.settings=n,this.orderedSpineItemsSubject=new G([]),this.items$=this.orderedSpineItemsSubject.asObservable()}get(e){return typeof e=="number"?this.orderedSpineItemsSubject.value[e]:typeof e=="string"?this.orderedSpineItemsSubject.value.find(({item:n})=>n.id===e):e}comparePositionOf(e,n){const i=this.getSpineItemIndex(e)??0,o=this.getSpineItemIndex(n)??0;return i>o?"after":i===o?"same":"before"}getSpineItemIndex(e){const n=e instanceof ji?e:this.get(e);if(!n)return;const i=this.orderedSpineItemsSubject.value.indexOf(n);return i<0?void 0:i}addMany(e){this.orderedSpineItemsSubject.next([...this.orderedSpineItemsSubject.getValue(),...e])}getSpineItemFromCfi(e){const{itemIndex:n}=en(e);if(n!==void 0)return this.get(n)}get items(){return this.orderedSpineItemsSubject.value}destroyItems(){this.orderedSpineItemsSubject.value.forEach(e=>e.destroy())}}class ec extends je{constructor(e){const n=document.createElement("div");n.style.cssText=`
        background-color: white;
        position: relative;
        -transform: scale(0.2);
        height: 100%;
        width: 100%;
    `,n.className=`${Pe}-viewport`,super({element:n,pageSize:{width:1,height:1}}),this.context=e;const i=this.context.watch("visibleAreaRect").pipe(P(()=>{this.mergeCompare({pageSize:this.calculatePageSize()})}));_(i).pipe(T(this.destroy$)).subscribe()}calculatePageSize(){const e=this.absoluteViewport,{isUsingSpreadMode:n}=this.context.state;return{width:n?e.width/2:e.width,height:e.height}}get absoluteViewport(){const e=this.context.state.visibleAreaRect;return new Bu({width:e.width,height:e.height})}get relativeViewport(){const e=this.absoluteViewport,n=this.value.element.getBoundingClientRect(),i=((n==null?void 0:n.width)??e.width)/e.width;return new Hu({width:e.width/i,height:e.height/i})}}const tc=t=>{const e=new W,n=new eu,i=new Ka,o=new Nu(t,i),r=new Qa(i,o),s=new Qu(i,o),a=new G(void 0),u=new ec(i),c=a.pipe(F(fe)),l=Ni({context:i,settings:o}),d=new Lu(i,s),p=new Ku(c,i,d,s,l,o,n,u),f=Mu({context:i,spineItemsManager:s,hookManager:n,spine:p,settings:o,viewport:u}),h=new Ru(i,d,s,p,l);f.viewportState$.subscribe(i.bridgeEvent.viewportStateSubject),f.navigation$.subscribe(i.bridgeEvent.navigationSubject),f.locker.isLocked$.subscribe(i.bridgeEvent.navigationIsLockedSubject),d.subscribe(i.bridgeEvent.paginationSubject);const g=()=>{var y;const w=(y=a.getValue())==null?void 0:y.parentElement,I=a.getValue();if(!I||!w)return;const $={width:w==null?void 0:w.offsetWidth,height:w==null?void 0:w.offsetHeight},E=0,R=0,V=0;I.style.setProperty("overflow","hidden"),I.style.height=`${$.height-R-V}px`,I.style.width=`${$.width-2*E}px`;const C=I.getBoundingClientRect();i.update({visibleAreaRect:{x:C.x,y:C.y,width:$.width,height:$.height}}),p.layout()},v=y=>{var w;const{containerElement:I,manifest:$}=y;if(i.manifest){Y.warn("loading a new book is not supported yet");return}Y.log("load",{options:y});const E=nc(I);I!==((w=a.getValue())==null?void 0:w.parentElement)&&(a.next(E),I.appendChild(E)),i.update({manifest:$,containerElement:I,rootElement:E,forceSinglePageMode:o.values.forceSinglePageMode}),g()},m=()=>{var y;s.destroy(),h.destroy(),o.destroy(),d.destroy(),i.destroy(),f.destroy(),p.destroy(),(y=a.getValue())==null||y.remove(),r.destroy(),e.next(),e.complete(),u.destroy()};return{context:i,spine:p,hookManager:n,cfi:{generateCfiFromRange:ba,generateCfiFromSelection:wa,parseCfi:en,generateCfiForSpineItemPage:y=>Tt({...y,spineItemLocator:l}),resolveCfi:y=>Oi({...y,spineItemsManager:s})},navigation:f,spineItemsObserver:p.spineItemsObserver,spineItemsManager:s,layout:g,load:v,destroy:m,pagination:{get state(){return d.value},get state$(){return d}},settings:o,viewport:u,element$:c,viewportState$:i.bridgeEvent.viewportState$,viewportFree$:i.bridgeEvent.viewportFree$,state$:i.manifest$.pipe(b(y=>y?"ready":"idle")),features:r,$:{destroy$:e}}},nc=t=>{const e=t.ownerDocument.createElement("div");return e.style.cssText=`
    background-color: white;
    position: relative;
  `,e.className=`${Pe}-reader`,e},ic=za(Ts(sa(qa(_s(ss(Da(Ha(Ga(ya(Ys(ua(as(Ba(Ca(na(Is(tc))))))))))))))))),Wi=So(),oc=ic({getResource:t=>j(Wi.getResource(t)).pipe(b(e=>new Response(e.data,{headers:e.headers}))),forceSinglePageMode:!1,numberOfAdjacentSpineItemToPreLoad:0});Io({reader:oc,bridge:Wi,containerElement:document.getElementById("reader")});</script>
    <style rel="stylesheet" crossorigin>body,#reader,html{height:100%;width:100%;box-sizing:border-box;overflow:hidden;margin:0;padding:0}#reader{border:2px solid red}</style>
  </head>
  <body>
    <div id="reader"></div>
  </body>
</html>
